unit ufrmBancosE;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseEdicao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.ExtCtrls, uTipos, Vcl.Mask, Vcl.DBCtrls, uBiblioteca, ufrmPesquisaPessoa,
  ufrmPessoasE;

type
  TfrmBancosE = class(TfrmBaseEdicao)
    pnl_dados: TPanel;
    Label1: TLabel;
    Label2: TLabel;
    Label4: TLabel;
    Label5: TLabel;
    Label7: TLabel;
    Label8: TLabel;
    Label9: TLabel;
    Label10: TLabel;
    Label11: TLabel;
    Label12: TLabel;
    Label13: TLabel;
    Label14: TLabel;
    Label15: TLabel;
    Label16: TLabel;
    Label17: TLabel;
    btn_busca_pessoa: TBitBtn;
    btnIncluirPessoa: TBitBtn;
    rg_pessoa: TDBRadioGroup;
    pnl_id: TPanel;
    pnl_rg_ie: TPanel;
    pnl_alterado_em: TPanel;
    pnl_cpf_cnpj: TPanel;
    pnl_cadastrado_em: TPanel;
    pnl_telefone: TPanel;
    pnl_celular: TPanel;
    pnl_nome: TPanel;
    pnl_endereco: TPanel;
    pnl_numero: TPanel;
    pnl_bairro: TPanel;
    pnl_cidade: TPanel;
    pnl_uf: TPanel;
    pnl_cep: TPanel;
    pnl_email: TPanel;
    Label3: TLabel;
    edt_cod_banco: TEdit;
    cb_ativo: TCheckBox;

    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);

    procedure btnOkClick(Sender: TObject);
    procedure btn_busca_pessoaClick(Sender: TObject);
    procedure btnIncluirPessoaClick(Sender: TObject);

  private
    FOperacao: uTipos.TOperacao;
    FTabela: string;
    FCodigo: integer;
    procedure prc_salvar;
    procedure prc_incluir_alterar(operacao: TOperacao);
    procedure prc_busca_pessoa(pessoa_id: integer);

  protected
    procedure prc_componentes;
    procedure prc_inicializar;
    procedure prc_ler_dados;
    function prc_validar: boolean;

  public
    property Codigo   :integer read FCodigo write FCodigo;
    property Operacao :uTipos.TOperacao read FOperacao write FOperacao;
    property Tabela   :string read FTabela write FTabela;

  end;


  procedure prc_incluir;
  procedure prc_alterar(ACodigo :integer);
  procedure prc_excluir(ACodigo :integer);

implementation

procedure prc_incluir;
var
  loForm : TfrmBancosE;
begin
  loForm := TfrmBancosE.Create(Application);
  try
    loForm.Operacao := uTipos.opIncluir;
    loForm.Codigo   := 0;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

procedure prc_alterar(ACodigo :integer);
var
  loForm : TfrmBancosE;
begin
  loForm := TfrmBancosE.Create(Application);
  try
    loForm.Operacao := uTipos.opAlterar;
    loForm.Codigo   := ACodigo;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

procedure prc_excluir(ACodigo :integer);
var
  loForm : TfrmBancosE;
begin
  loForm := TfrmBancosE.Create(Application);
  try
    loForm.Operacao := uTipos.opExcluir;
    loForm.Codigo   := ACodigo;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;
{$R *.dfm}

procedure TfrmBancosE.btnIncluirPessoaClick(Sender: TObject);
var
  pessoa: integer;
begin
  inherited;
  pessoa := ufrmPessoasE.incluir;
//  ShowMessage(inttostr(pessoa));
  qry.SQL.Clear;
  qry.SQL.Add('select * from bancos where pessoa_id = :pessoa_id');
  uBiblioteca.FilterCds(qry, uTipos.fsInteger, inttostr(pessoa));


end;

procedure TfrmBancosE.btnOkClick(Sender: TObject);
begin
  inherited;
  prc_salvar;

end;

procedure TfrmBancosE.btn_busca_pessoaClick(Sender: TObject);
begin
  inherited;
  if frmPesquisaPessoa = nil  then
  frmPesquisaPessoa := TfrmPesquisaPessoa.Create(Application);
  try
    frmPesquisaPessoa.ShowModal;

    //ShowMessage(inttostr(frmPesquisaPessoa.Codigo));
    if frmPesquisaPessoa.Confirmado then
    begin
      prc_busca_pessoa(frmPesquisaPessoa.Codigo);
    end
    else
      ShowMessage('Pessoa não encontrada')
  finally
    FreeAndNil(frmPesquisaPessoa);

  end;

end;

procedure TfrmBancosE.prc_busca_pessoa(pessoa_id: integer);
var
 loQry: TFDQuery;
begin

  try
    loQry := TFDQuery.Create(Self);
    loQry.Connection := Conexao;;
    loqry.SQL.Clear;
    {carrega a pessoa}
    loQry.sql.Add('select * from pessoas where id =:id');
    loQry.ParamByName('id').AsInteger := pessoa_id;
    loQry.Open;
    pnl_Id.Caption            := loQry.FieldByName('id').AsString;
    pnl_cadastrado_em.Caption := loQry.FieldByName('data_cad').AsString;
    pnl_alterado_em.Caption   := loQry.FieldByName('data_alt').AsString;
    cb_ativo.Checked          := uBiblioteca.SeSenao(loQry.FieldByName('ativo').AsString ='S', true, false);
    rg_pessoa.ItemIndex       := uBiblioteca.SeSenao(loQry.FieldByName('fis_jur').AsString ='F', 0, 1);
    pnl_cpf_cnpj.Caption      := loQry.FieldByName('cpf_cnpj').AsString;
    pnl_rg_ie.Caption         := loQry.FieldByName('rg_ie').AsString;
    pnl_telefone.Caption      := loQry.FieldByName('telefone').AsString;
    pnl_celular.Caption       := loQry.FieldByName('celular').AsString;
    pnl_endereco.Caption      := loQry.FieldByName('endereco').AsString;
    pnl_numero.Caption        := loQry.FieldByName('numero').AsString;
    pnl_bairro.Caption        := loQry.FieldByName('bairro').AsString;
    pnl_cidade.Caption        := loQry.FieldByName('cidade').AsString;
    pnl_uf.Caption            := loQry.FieldByName('uf').AsString;
    pnl_cep.Caption           := loQry.FieldByName('cep').AsString;
    pnl_email.Caption         := loQry.FieldByName('email').AsString;
    loqry.Close;
  finally
    freeandnil(loqry);
  end;
end;

procedure TfrmBancosE.FormCreate(Sender: TObject);
begin
  inherited;
  Tabela := 'BANCOS';

end;

procedure TfrmBancosE.FormShow(Sender: TObject);
begin
  inherited;
  prc_componentes;
  prc_inicializar;

end;

procedure TfrmBancosE.prc_componentes;
begin
  {qry de principal}
  qry.Connection := Conexao;

end;

procedure TfrmBancosE.prc_inicializar;
begin
  pnTitulo.Caption := 'CADASTRO DE BANCOS';

  case self.Operacao of
  uTipos.opIncluir: begin

                       lbl_sub_titulo.Caption    := 'INCLUSÃO';
                       pnl_Id.Caption            := '-1';
                       pnl_cadastrado_em.Caption := datetostr(date);
                       btnOk.Caption             := 'Incluir';

                     end;
  uTipos.opAlterar: begin

                      prc_ler_dados;
                      lbl_sub_titulo.Caption    := 'ALTERAÇÃO';
                      btnOk.Caption             := 'Alterar';
                      pnl_alterado_em.Caption   := datetostr(date);
                      btnOk.SetFocus;

                    end;
  uTipos.opExcluir: begin

                      prc_ler_dados;
                      lbl_sub_titulo.Caption := 'EXCLUIR';
                      pnDados.Enabled        := false;
                      btnOk.Caption          := 'Excluir';
                      btnFechar.SetFocus;

                    end;
  else
    begin
      pnDados.Enabled   := false;
      if btnFechar.CanFocus then btnFechar.SetFocus;
    end;
  end;

end;

procedure TfrmBancosE.prc_ler_dados;
begin

    prc_busca_pessoa(codigo);

    {carrega o banco}
    qry.SQL.Clear;
    Qry.sql.Add('select * from ' + Self.Tabela + ' where pessoa_id =:pessoa_id');
    Qry.ParamByName('pessoa_id').AsInteger := Codigo;
    Qry.Open;
    if not Qry.IsEmpty then
    begin
      edt_cod_banco.Text := Qry.FieldByName('cod_banco').AsString;
    end
    else
    begin
      ShowMessage('Banco não encontrado')
    end;

end;

procedure TfrmBancosE.prc_salvar;
begin
  if not prc_validar then Exit;

  if not Self.Conexao.InTransaction then Self.Conexao.StartTransaction;
  //***
  try
    prc_incluir_alterar(Operacao);
    if Self.Conexao.InTransaction then Self.Conexao.Commit;
    ModalResult := mrOk;
  except
    conexao.Rollback;
    ShowMessage('Não foi possível salvar o registro');
  end;

end;

function TfrmBancosE.prc_validar: boolean;
begin
  result := false;

  if edt_cod_banco.Text = '' then
  begin
    ShowMessage('Informe o CÓDIGO DO BANCO');
    edt_cod_banco.SetFocus;
    exit;
  end;


  result := true;
end;

procedure TfrmBancosE.prc_incluir_alterar(operacao: TOperacao);
begin

  qry.sql.clear;
  if operacao = opExcluir then
  begin

    qry.SQL.Add('update '+ self.Tabela + ' set ATIVO = ''N'' where id =:id');
    qry.ParamByName('id').AsInteger := Codigo;
    qry.ExecSQL;
    exit;

  end;

  if operacao = OpIncluir then
  begin
    qry.sql.clear;
    qry.SQL.Add('insert into ' + self.Tabela );
    qry.SQL.Add('(');
    qry.SQL.Add('  PESSOA_ID,               ');
    qry.SQL.Add('  COD_BANCO               ');
    //qry.SQL.Add('  ATIVO                    ');
    qry.SQL.Add(')                          ');
    qry.SQL.Add('VALUES                     ');
    qry.SQL.Add('(                          ');
    qry.SQL.Add('  :PESSOA_ID,               ');
    qry.SQL.Add('  :COD_BANCO               ');
    //qry.SQL.Add('  :ATIVO                   ');
    qry.SQL.Add(')                          ');
    //qry.SQL.Add('returning ID      ');

  end
  else
  begin
    qry.sql.clear;
    qry.SQL.Add('UPDATE                        ');
    qry.SQL.Add(Tabela);
    qry.SQL.Add('SET                           ');
    qry.SQL.Add('  COD_BANCO = :COD_BANCO     ');
    //qry.SQL.Add('  ATIVO = :ATIVO              ');
    qry.SQL.Add('WHERE                         ');
    qry.SQL.Add('  PESSOA_ID = :PESSOA_ID      ');
    //
    qry.ParamByName('PESSOA_ID').AsInteger       := Codigo;

  end;
  ShowMessage(QRY.SQL.Text);

  qry.ParamByName('pessoa_id').AsInteger := strtoint(pnl_id.Caption);
  qry.ParamByName('COD_BANCO').AsString  := edt_cod_banco.Text;
  //qry.ParamByName('ATIVO').AsString      := ubiblioteca.SeSenao(cb_ativo.Checked  , 'S','N');

  qry.ExecSQL;

end;

end.
