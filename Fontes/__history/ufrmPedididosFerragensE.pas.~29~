unit ufrmPedididosFerragensE;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseEdicao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Vcl.DBCtrls, Vcl.StdCtrls, Vcl.ComCtrls, Data.DB, FireDAC.Comp.DataSet,
  FireDAC.Comp.Client, Vcl.Buttons, Vcl.ExtCtrls, uTipos;

type
  TfrmPedididosFerragensE = class(TfrmBaseEdicao)
    gbDobras: TGroupBox;
    Label2: TLabel;
    Label5: TLabel;
    Label7: TLabel;
    Label8: TLabel;
    edCorpo: TEdit;
    edComprimento: TEdit;
    gbVergalhao: TGroupBox;
    cbxFerro: TDBLookupComboBox;
    Label9: TLabel;
    Label3: TLabel;
    Label4: TLabel;
    edQtde: TEdit;
    edCustoMetro: TEdit;
    edVendaMetro: TEdit;
    lbPosicao: TLabel;
    DBText1: TDBText;
    qryFerros: TFDQuery;
    dsFerros: TDataSource;
    Label6: TLabel;
    edCustoFinal: TEdit;
    Bevel1: TBevel;
    edInicio: TComboBox;
    edFinal: TComboBox;
    cbxPosicao: TComboBox;
    procedure btnOkClick(Sender: TObject);
    procedure dsFerrosDataChange(Sender: TObject; Field: TField);
    procedure edFinal_Change(Sender: TObject);
    procedure edInicioChange(Sender: TObject);
    procedure edFinalChange(Sender: TObject);
    procedure edCorpoEnter(Sender: TObject);
    procedure edCorpoExit(Sender: TObject);


    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
  private
    FTitulo: string;
    //FTabela: string;
    FCodigo: integer;
    FTabelaOrigem: string;
    FTabelaId: integer;
    Fcorpo: double;
    Fdescricao: string;
    FcustoMetro: double;
    FdobraFim: double;
    FPosicao: string;
    FdobraInicio: double;
    FvendaMetro: double;
    FIdProduto: integer;
    Fquantidade: integer;
    Fconfirmado: boolean;
    Foperacao: TOperacao;
    FTamanhoDaViga: double;

    procedure salvar;
    procedure AtualizaEdits;
    function CalculaComprimento: double;

  protected
    procedure Componentes;
    procedure Inicializar;
    function valida: boolean;
    procedure LerDados;

  public
    property Titulo   :string read FTitulo write FTitulo;

    {dados da tabela de origem}
    property codigo: integer read FCodigo write FCodigo;// pedido
    property TabelaOrigem   :string read FTabelaOrigem write FTabelaOrigem;
    property TabelaId: integer read FTabelaId write FTabelaId;
    property idProduto: integer read FIdProduto write FidProduto;
    property descricao: string read Fdescricao write Fdescricao;
    property quantidade: integer read Fquantidade write Fquantidade;
    property dobraInicio: double read FdobraInicio write FdobraInicio;
    property corpo: double read Fcorpo write Fcorpo;
    property dobraFim: double read FdobraFim write FdobraFim;
    property custoMetro: double read FcustoMetro write FcustoMetro;
    property vendaMetro: double read FvendaMetro write FvendaMetro;
    property Posicao: string read FPosicao write FPosicao;
    property TamanhoDaViga: double read FTamanhoDaViga write FTamanhoDaViga;

    property confirmado: boolean read Fconfirmado write Fconfirmado;
    property operacao: TOperacao read Foperacao write Foperacao;

  end;
var
  frmPedididosFerragensE : TfrmPedididosFerragensE;

implementation

uses  uBiblioteca;



{$R *.dfm}


procedure TfrmPedididosFerragensE.btnOkClick(Sender: TObject);
begin
  inherited;
  Salvar();

end;

procedure TfrmPedididosFerragensE.Componentes;
begin
  {qry principal onde sera gravado na tabela}

  {lista de ferros cadastrados}
  qryFerros.SQL.Clear;
  qryFerros.SQL.Add('select ');
  qryFerros.SQL.Add('  ID, ');
  qryFerros.SQL.Add('  NOME_FANTASIA, ');
  qryFerros.SQL.Add('  PRECO_CUSTO, ');
  qryFerros.SQL.Add('  PRECO_VENDA, ');
  qryFerros.SQL.Add('  CUSTO_BRUTO ');
  qryFerros.SQL.Add('from ');
  qryFerros.SQL.Add('  PRODUTOS ');
  qryFerros.SQL.Add('where ');
  qryFerros.SQL.Add('  VERGALHAO = ' + QuotedStr('S') + ' ');
  qryFerros.SQL.Add('order by ');
  qryFerros.SQL.Add('  NOME_FANTASIA ');
  qryFerros.Open();

  //cbxPosicao.ItemIndex := 0;
end;

procedure TfrmPedididosFerragensE.dsFerrosDataChange(Sender: TObject;
  Field: TField);
begin
  inherited;
  AtualizaEdits;
end;

procedure TfrmPedididosFerragensE.edCorpoEnter(Sender: TObject);
begin
  inherited;
  edComprimento.Text := FormatFloat('0.00', CalculaComprimento);

end;

procedure TfrmPedididosFerragensE.edCorpoExit(Sender: TObject);
begin
  inherited;
  edComprimento.Text := FormatFloat('0.00', CalculaComprimento);
end;

procedure TfrmPedididosFerragensE.edFinalChange(Sender: TObject);
begin
  inherited;
  edComprimento.Text := FormatFloat('0.00', CalculaComprimento);
end;

procedure TfrmPedididosFerragensE.edFinal_Change(Sender: TObject);
begin
  inherited;
//  edFinal.Text := formatfloat('0.00',strtofloat(edfinal_.text)/100);

end;

procedure TfrmPedididosFerragensE.edInicioChange(Sender: TObject);
begin
  inherited;
  edComprimento.Text := FormatFloat('0.00', CalculaComprimento);

end;

procedure TfrmPedididosFerragensE.AtualizaEdits;
begin
  {carrega componentes}
  edCustoMetro.Text := FormatFloat('0.00', qryFerros.FieldByName('PRECO_CUSTO').AsFloat);
  edCustoFinal.Text := FormatFloat('0.00', qryFerros.FieldByName('CUSTO_BRUTO').AsFloat);
  edVendaMetro.Text := FormatFloat('0.00', qryFerros.FieldByName('PRECO_VENDA').AsFloat);
end;

procedure TfrmPedididosFerragensE.FormCreate(Sender: TObject);
begin
  inherited;
  //self.Tabela := 'PEDIDOS_FERRAGENS';
  qryFerros.Connection := self.Conexao;
  confirmado := false;
end;

procedure TfrmPedididosFerragensE.FormShow(Sender: TObject);
begin
  inherited;
  Componentes;
  Inicializar;
end;

procedure TfrmPedididosFerragensE.Inicializar;
begin
  case self.Operacao of
  uTipos.opIncluir: begin
                      //ShowMessage('op incluir');
                      pnTitulo.Caption := 'Manutenção de reforço de viga [Inclusão]';
                      //frmPedididosFerragensE.corpo := tamanhoDaViga;
                      //frmPedididosFerragensE.edCorpo.Text := FormatFloat('0.00', TamanhoDaViga);
                      corpo := tamanhoDaViga;
                      edCorpo.Text := FormatFloat('0.00', TamanhoDaViga);
                      edQtde.Text          := '1';
                      edInicio.ItemIndex   := 0;
                      edFinal.ItemIndex    := 0;
                      cbxPosicao.ItemIndex := 0;
                      btnOk.Caption := 'Incluir';

                     end;
  uTipos.opAlterar: begin
                      //ShowMessage('op alterar');
                      self.LerDados;
                      pnTitulo.Caption := 'Manutenção de reforço de viga [Alteração]';
                      btnOk.Caption := 'Alterar';

                    end;


  uTipos.opExcluir: begin
                      self.LerDados;
                      pnTitulo.Caption        := 'Manutenção de reforço de viga [Exclusão]';
                      pnDados.Enabled   := false;
                      btnOk.Caption := 'Excluir';
                      btnFechar.SetFocus;
                    end;
  else
    begin
      pnDados.Enabled   := false;
      if btnFechar.CanFocus then btnFechar.SetFocus;
    end;
  end;

end;

procedure TfrmPedididosFerragensE.LerDados;
begin

  cbxFerro.KeyValue := idProduto;
  edQtde.Text       := IntToStr(quantidade);
  edInicio.Text     := FormatFloat('0.00', dobraInicio);
  edCorpo.Text      := FormatFloat('0.00', corpo);
  edFinal.Text      := FormatFloat('0.00', dobraFim);
  edCustoMetro.Text := FormatFloat('0.00', custoMetro);
  edVendaMetro.Text := FormatFloat('0.00', vendaMetro);
  cbxPosicao.Text   := Posicao;

end;

procedure TfrmPedididosFerragensE.salvar;
begin
  if not Valida then Exit;
  {atualiza as propriedades}

  idProduto   := qryFerros.FieldByName('ID').AsInteger;
  descricao   := qryFerros.FieldByName('NOME_FANTASIA').AsString;
  quantidade  := strtoint(edQtde.Text);
  dobraInicio := StrToFloat(edInicio.Text);
  corpo       := StrToFloat(edCorpo.Text);
  dobraFim    := StrToFloat(edFinal.Text);
  custoMetro  := StrToFloat(edCustoFinal.Text);
  vendaMetro  := StrToFloat(edVendaMetro.Text);
  Posicao     := cbxPosicao.Text;
  confirmado  := true;
      //
  close;
end;

function TfrmPedididosFerragensE.valida: boolean;
begin
  result := false;

  if cbxFerro.Text = '' then
  begin
    ShowMessage('selecione um vergalhão');
    cbxFerro.SetFocus;
    exit;
  end;


  if strtofloatdef(edInicio.Text,0) < 0 then
  begin
    ShowMessage('informe um valor válido ou digite "0"');
    edInicio.Text := '0';
    edInicio.SetFocus;
    exit;
  end;

  if ((strtofloatdef(edCorpo.Text,0) <= 0) or (strtofloatdef(edCorpo.Text,0) > 12)) then
  begin
    ShowMessage('informe um valor válido!');
    edCorpo.SetFocus;
    exit;
  end;
  (*
  ShowMessage(floattostr(corpo));

  if strtofloatdef(edCorpo.Text,0) > corpo+0.001 then // 0.001 = sujeira
  begin
    ShowMessage('corpo do ferro maior que a viga');
    edCorpo.SetFocus;
    exit;
  end;
  *)
  if strtofloatdef(edFinal.Text,0) < 0 then
  begin
    ShowMessage('informe um valor válido ou digite "0"');
    edFinal.Text := '0';
    edFinal.SetFocus;
    exit;
  end;

  if CalculaComprimento > 12  then
  begin
    ShowMessage('valores inválidos');
    edCorpo.SetFocus;
    exit;
  end;

  if strtointdef(edQtde.Text,0) <= 0 then
  begin
    ShowMessage('informe uma Quantidade válida');
    edQtde.SetFocus;
    exit;
  end;

  if StrToFloatDef(edCustoFinal.Text,0) <= 0 then
  begin
    ShowMessage('informe um valor válido');
    edCustoFinal.SetFocus;
    exit;
  end;

  if StrToFloatDef(edVendaMetro.Text,0) < StrToFloatDef(edCustoFinal.Text,0) then
  begin
    ShowMessage('informe um valor válido');
    edVendaMetro.SetFocus;
    exit;
  end;

  result := true;

end;

function  TfrmPedididosFerragensE.CalculaComprimento: double;
begin
  result := StrToFloatDef(edCorpo.Text,0) + StrToFloatDef(edInicio.Text,0) +StrToFloatDef(edFinal.Text,0);

end;



end.
