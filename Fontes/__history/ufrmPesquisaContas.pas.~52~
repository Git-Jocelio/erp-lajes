unit ufrmPesquisaContas;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseConexao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Vcl.ExtCtrls, Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client,
  Vcl.StdCtrls, Vcl.Buttons, Vcl.DBCtrls, Vcl.Grids, Vcl.DBGrids, udmConn,
  unit_funcoes, uBiblioteca, Vcl.ComCtrls;

type
  TfrmPesquisaContas = class(TfrmBaseConexao)
    Panel1: TPanel;
    pnl_cabecalho: TPanel;
    btn_fechar: TSpeedButton;
    lbl_titulo: TLabel;
    pnl_separa_topo: TPanel;
    Panel2: TPanel;
    lbl_pessoa: TLabel;
    pnl_dbgrid: TPanel;
    dbg_registros: TDBGrid;
    pnl_resultado: TPanel;
    lbl_resultado: TLabel;
    btn_Selecionar: TButton;
    ds: TDataSource;
    Label1: TLabel;
    mtb_contas: TFDMemTable;
    mtb_contasID: TIntegerField;
    mtb_contasNR_DOCUMENTO: TStringField;
    mtb_contasDESCRICAO: TStringField;
    mtb_contasTOTAL_PARCELA: TFloatField;
    mtb_contasVALOR_PAGO: TFloatField;
    rg_tipo_documento: TRadioGroup;
    cbx_situacao: TComboBox;
    lbl_situacao: TLabel;
    btn_filtrar: TBitBtn;
    mtb_contas_selecionadas: TFDMemTable;
    mtb_contas_selecionadasID: TIntegerField;
    mtb_contas_selecionadasNR_DOCUMENTO: TStringField;
    mtb_contas_selecionadasDESCRICAO: TStringField;
    mtb_contas_selecionadasTOTAL_PARCELA: TFloatField;
    mtb_contas_selecionadasVALOR_PAGO: TFloatField;
    DBGrid1: TDBGrid;
    DataSource1: TDataSource;
    mtb_contas_selecionadasBAIXAR: TFloatField;
    mtb_contasBAIXAR: TFloatField;
    Label2: TLabel;
    mtb_contasTABELA_ORIGEM: TStringField;
    mtb_contas_selecionadasTABELA_ORIGEM: TStringField;
    procedure dsDataChange(Sender: TObject; Field: TField);
    procedure btn_fecharClick(Sender: TObject);
    procedure btn_SelecionarClick(Sender: TObject);

    procedure btn_filtrarClick(Sender: TObject);
    procedure rg_tipo_documentoClick(Sender: TObject);

    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
  private
    Fp_conta_id: integer;
    Fp_confirmado: boolean;
    Fp_pessoa_id: integer;
    Fp_sql: string;
    Fp_R_OU_P: string;
    Fp_cds: TFDMemTable;
    procedure prc_carregar_memTable_contas;
    { Private declarations }
  public
    { Public declarations }
    procedure prc_componentes;
    function fnc_validar : boolean;
    property p_confirmado :boolean read Fp_confirmado write Fp_confirmado;
    property p_conta_id :integer read Fp_conta_id write Fp_conta_id;
    property p_pessoa_id :integer read Fp_pessoa_id write Fp_pessoa_id;
    property p_sql :string read Fp_sql write Fp_sql;
    property p_R_OU_P :string read Fp_R_OU_P write Fp_R_OU_P;

    property p_cds : TFDMemTable read Fp_cds write Fp_cds;
  end;

var
  frmPesquisaContas: TfrmPesquisaContas;

implementation

{$R *.dfm}

{ TfrmPesquisaContas }

procedure TfrmPesquisaContas.btn_filtrarClick(Sender: TObject);
begin

  qry.close;
  qry.SQL.Clear;
  if rg_tipo_documento.ItemIndex = 0 then // pedidos
  begin
    // validação da pesquisa
    if cbx_situacao.Text = '' then
    begin
      criarmensagem('AVISO', 'INFORME A SITUAÇÃO DO PEDIDO.');
      cbx_situacao.SetFocus;
      exit;
    end;

    if (cbx_situacao.Text = 'ABERTO') or (cbx_situacao.Text = 'AGUARDANDO') then
    begin
      qry.SQL.Add('select                                ');
      qry.SQL.Add('  r.id,                               ');
      qry.SQL.Add('  r.tabela_origem,                    ');
      qry.SQL.Add('  r.id_origem,                        ');
      qry.SQL.Add('  r.descricao,                        ');
      qry.SQL.Add('  r.total,                            ');
      qry.SQL.Add('  r.valor_pago                        ');
      qry.SQL.Add('from                                  ');
      qry.SQL.Add('  contas_receber r, pedidos p         ');
      qry.SQL.Add('where                                 ');
      qry.SQL.Add('  r.pago          =:pago and          ');
      qry.SQL.Add('  p.id            = r.id_origem and   ');
      qry.SQL.Add('  r.tabela_origem =:tabela_origem and ');
      qry.SQL.Add('  p.situacao      =:situacao and      ');
      qry.SQL.Add('  r.pessoa_id     =:pessoa_id         ');

      qry.ParamByName('tabela_origem').AsString := 'PEDIDOS';
      qry.ParamByName('situacao').AsString      := cbx_situacao.Text;
    end else
    // tratar situacao entregue e retirou
    if cbx_situacao.Text = 'ENTREGUE E RETIROU' then
    begin
      qry.SQL.Add('select                                 ');
      qry.SQL.Add('  r.id,                                ');
      qry.SQL.Add('  r.tabela_origem,                     ');
      qry.SQL.Add('  r.id_origem,                         ');
      qry.SQL.Add('  r.descricao,                         ');
      qry.SQL.Add('  r.total,                             ');
      qry.SQL.Add('  r.valor_pago                         ');
      qry.SQL.Add('from                                   ');
      qry.SQL.Add('  contas_receber r, pedidos p          ');
      qry.SQL.Add('where                                  ');
      qry.SQL.Add('  r.pago          =:pago and           ');
      qry.SQL.Add('  p.id            = r.id_origem and    ');
      qry.SQL.Add('  r.tabela_origem =:tabela_origem and  ');
      qry.SQL.Add('  ((p.situacao    <> :ABERTO) and      ');
      qry.SQL.Add('  (p.situacao     <> :AGUARDANDO)) and ');
      qry.SQL.Add('  r.pessoa_id     =:pessoa_id          ');

      qry.ParamByName('tabela_origem').AsString := 'PEDIDOS';
      qry.ParamByName('ABERTO').AsString        := 'ABERTO';
      qry.ParamByName('AGUARDANDO').AsString    := 'AGUARDANDO';

    end;

  end else
  if rg_tipo_documento.ItemIndex = 1 then // todos
  begin
    qry.SQL.Add('select                   ');
    qry.SQL.Add('  r.id,                  ');
    qry.SQL.Add('  r.tabela_origem,       ');
    qry.SQL.Add('  r.id_origem,           ');
    qry.SQL.Add('  r.descricao,           ');
    qry.SQL.Add('  r.total,               ');
    qry.SQL.Add('  r.valor_pago           ');
    qry.SQL.Add('from                     ');
    qry.SQL.Add('  contas_receber r       ');
    qry.SQL.Add('where                    ');
    qry.SQL.Add('  r.pago      =:pago and ');
    qry.SQL.Add('  r.pessoa_id =:pessoa_id');
  end;

  qry.ParamByName('pago').AsString       := 'N';
  qry.ParamByName('pessoa_id').AsInteger := p_pessoa_id;
  qry.Open;

  prc_carregar_memTable_contas;


end;

procedure TfrmPesquisaContas.prc_carregar_memTable_contas;
begin
  if qry.IsEmpty then
  begin
    CriarMensagem('AVISO','NENHUMA CONTA FOI ENCONTARADA PARA ESSA PESSOA.');
    close;
  end else
  if qry.RecordCount > 0 then
  begin

    //limpar memtable
    mtb_contas.close;
    mtb_contas.Open;

    qry.First;
    while not qry.eof do
    begin
      mtb_contas.insert;

      {preencher o memtable(solução que achei para usar formulario para as
      pesquisas no contas a pagar e contas a receber, devido as tabelas ter campos com nome diferentes}
      if p_R_OU_P = 'P' then
      begin
        mtb_contas.fieldbyname('id').AsInteger          := qry.fieldbyname('id').AsInteger;
        mtb_contas.fieldbyname('tabela_origem').Asstring:= qry.fieldbyname('tabela_origem').Asstring;
        mtb_contas.fieldbyname('nr_documento').Asstring := qry.fieldbyname('nr_documento').Asstring;
        mtb_contas.fieldbyname('descricao').Asstring    := qry.fieldbyname('descricao').Asstring;
        mtb_contas.fieldbyname('total_parcela').Asfloat := qry.fieldbyname('total_parcela').Asfloat ;
        mtb_contas.fieldbyname('valor_pago').Asfloat    := qry.fieldbyname('valor_pago').Asfloat;
        mtb_contas.fieldbyname('baixar').Asfloat        := qry.fieldbyname('total_parcela').Asfloat - qry.fieldbyname('valor_pago').Asfloat;
      end else
      if p_R_OU_P = 'R' then
      begin
        mtb_contas.fieldbyname('id').AsInteger          := qry.fieldbyname('id').AsInteger;
        mtb_contas.fieldbyname('tabela_origem').Asstring:= qry.fieldbyname('tabela_origem').Asstring;
        mtb_contas.fieldbyname('nr_documento').Asstring := qry.fieldbyname('id_origem').Asstring;
        mtb_contas.fieldbyname('descricao').Asstring    := qry.fieldbyname('descricao').Asstring;
        mtb_contas.fieldbyname('total_parcela').Asfloat := qry.fieldbyname('TOTAL').AsFLOAT ;
        mtb_contas.fieldbyname('valor_pago').Asfloat    := qry.fieldbyname('valor_pago').Asfloat;
        mtb_contas.fieldbyname('baixar').Asfloat        := qry.fieldbyname('total').Asfloat - qry.fieldbyname('valor_pago').Asfloat;
      end;
      //grava
      mtb_contas.post;

      // proximo registro da qry
      qry.Next;
    end;

    dbg_registros.SetFocus;
  end;

end;

procedure TfrmPesquisaContas.btn_fecharClick(Sender: TObject);
begin
  close;
end;

procedure TfrmPesquisaContas.btn_SelecionarClick(Sender: TObject);
var
 i :integer;
 aBookmark: TBookmarkStr;
begin

  inherited;
  if fnc_validar then
  begin

    if p_R_OU_P = 'R' then // CONTAS A RECEBER
    begin
      if dbg_registros.SelectedRows.Count > 0  then
      begin
        for i := 0 to  dbg_registros.SelectedRows.Count -1 do
        begin

          mtb_contas.GotoBookmark(TBookmark( dbg_registros.SelectedRows.items[i]) );

          mtb_contas_selecionadas.Append;
          mtb_contas_selecionadas.CopyRecord(mtb_contas); // Copia os dados do registro atual
          mtb_contas_selecionadas.Post;

        end;
        //
        mtb_contas_selecionadas.Refresh;
        p_cds        := mtb_contas_selecionadas;
        p_confirmado := true;
      end;
    end else
    if p_R_OU_P = 'P' then // CONTAS A PAGAR
    begin
      {devolve o id da conta}
      p_conta_id := mtb_contas.FieldByName('id').AsInteger;
      p_confirmado := true;
    end;

  end;

  if p_confirmado = true then
   close;

end;


procedure TfrmPesquisaContas.dsDataChange(Sender: TObject; Field: TField);
begin
  btn_Selecionar.Enabled := not qry.IsEmpty;
end;

function TfrmPesquisaContas.fnc_validar: boolean;
begin
  result := false;

  if p_R_OU_P = 'R' then
   if not qry.IsEmpty then
    if not ( dbg_registros.SelectedRows.Count > 0 )  then
  begin
    criarmensagem('AVISO','SELECIONE UMA CONTA.');
    exit;
  end;

  result := true;

end;

procedure TfrmPesquisaContas.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
//  inherited;

end;

procedure TfrmPesquisaContas.FormCreate(Sender: TObject);
begin
  inherited;
  p_confirmado := false;

end;

procedure TfrmPesquisaContas.FormShow(Sender: TObject);
begin
  inherited;
  prc_componentes;


end;

procedure TfrmPesquisaContas.prc_componentes;
begin
  DBGrid1.Visible := false;

  mtb_contas.Open;
  mtb_contas_selecionadas.Open;

  if p_R_OU_P = 'R' then
  begin
    lbl_situacao.Visible := false;
    cbx_situacao.Visible := false;
  end else
  if p_R_OU_P = 'P' then
  begin
    lbl_situacao.Visible := false;
    cbx_situacao.Visible := false;
    btn_filtrar.Visible  := false;
    rg_tipo_documento.Visible  := false;

    qry.Close;
    qry.SQL.Clear;
    qry.SQL.Add('select id, tabela_origem, nr_documento, descricao, total_parcela, valor_pago from contas_pagar where pago =:pago and pessoa_id =:pessoa_id');
    qry.ParamByName('pago').AsString := 'N';
    QRY.ParamByName('pessoa_id').AsInteger := p_pessoa_id;
    qry.Open;

    prc_carregar_memTable_contas;

  end;


end;


procedure TfrmPesquisaContas.rg_tipo_documentoClick(Sender: TObject);
begin
  if rg_tipo_documento.ItemIndex = 0 then
  begin
    lbl_situacao.Visible := true;
    cbx_situacao.Visible := true;
  end else
  if rg_tipo_documento.ItemIndex = 1 then
  begin
    lbl_situacao.Visible := false;
    cbx_situacao.Visible := false;

  end;
end;

end.
