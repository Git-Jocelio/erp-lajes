unit ufrmCartaoMaquinasE;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseEdicao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.ExtCtrls, uTipos, Vcl.DBCtrls, Vcl.ComCtrls, Vcl.Mask, uBiblioteca;

type
  TfrmCartaoMaquinasE = class(TfrmBaseEdicao)
    Label2: TLabel;
    lbl_Id: TLabel;
    cb_ativo: TCheckBox;
    Label4: TLabel;
    lbl_cadastrado_em: TLabel;
    Label5: TLabel;
    lbl_alterado_em: TLabel;
    Label8: TLabel;
    edt_nr_maquina: TEdit;
    Label3: TLabel;
    Label9: TLabel;
    edt_posse: TEdit;
    GroupBox1: TGroupBox;
    rg_selecao: TRadioGroup;
    gb_forncedor: TGroupBox;
    cbx_fornecedor: TDBLookupComboBox;
    cbx_operadora: TDBLookupComboBox;
    edt_id_fornecedor: TDBEdit;
    edt_id_operadora: TDBEdit;
    qry_fornecedor: TFDQuery;
    ds_fornecedor: TDataSource;
    ds_operadora: TDataSource;
    qry_operadora: TFDQuery;
    gb_custos_maquina: TGroupBox;
    Label6: TLabel;
    edt_vr_aluguel: TEdit;
    Label7: TLabel;
    edt_dia_vencimento: TEdit;

    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);

    procedure rg_selecaoClick(Sender: TObject);
    procedure btnOkClick(Sender: TObject);

  private
    FOperacao: uTipos.TOperacao;
    FTabela: string;
    FCodigo: integer;
    Fp_empresa: integer;
    procedure prc_salvar;
    procedure prc_incluir_alterar(operacao: TOperacao);

  protected
    procedure prc_componentes;
    procedure prc_inicializar;
    procedure prc_ler_dados;
    function prc_validar: boolean;

  public
    property Codigo   :integer read FCodigo write FCodigo;
    property Operacao :uTipos.TOperacao read FOperacao write FOperacao;
    property Tabela   :string read FTabela write FTabela;

    property p_empresa   :integer read Fp_empresa write Fp_empresa;

  end;

  procedure prc_incluir;
  procedure prc_alterar(ACodigo :integer);
  procedure prc_excluir(ACodigo :integer);

implementation

procedure prc_incluir;
var
  loForm : TfrmCartaoMaquinasE;
begin
  loForm := TfrmCartaoMaquinasE.Create(Application);
  try
    loForm.Operacao := uTipos.opIncluir;
    loForm.Codigo   := 0;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

procedure prc_alterar(ACodigo :integer);
var
  loForm : TfrmCartaoMaquinasE;
begin
  loForm := TfrmCartaoMaquinasE.Create(Application);
  try
    loForm.Operacao := uTipos.opAlterar;
    loForm.Codigo   := ACodigo;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

procedure prc_excluir(ACodigo :integer);
var
  loForm : TfrmCartaoMaquinasE;
begin
  loForm := TfrmCartaoMaquinasE.Create(Application);
  try
    loForm.Operacao := uTipos.opExcluir;
    loForm.Codigo   := ACodigo;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

{$R *.dfm}

procedure TfrmCartaoMaquinasE.btnOkClick(Sender: TObject);
begin
  inherited;
  prc_salvar;
end;

procedure TfrmCartaoMaquinasE.FormCreate(Sender: TObject);
var
  loQry : TFDQuery;
begin
  inherited;
  Tabela := 'CARTAO_MAQUINAS';

  {pega o id da empresa}
  if rg_selecao.ItemIndex = 0 then
  begin
    try
      loQry := TFDQuery.Create(self);
      loQry.Connection := conexao;
      loqry.Open('select * from EMPRESA');
      p_empresa := loQry.FieldByName('PESSOA_ID').AsInteger;

    finally
      freeandnil(loqry);
    end;
  end;


end;

procedure TfrmCartaoMaquinasE.FormShow(Sender: TObject);
begin
  inherited;
  prc_componentes;
  prc_inicializar;
end;

procedure TfrmCartaoMaquinasE.prc_componentes;
begin
  {qry de principal}
  qry.Connection := Conexao;

  {qry fornecedor}
  qry_fornecedor.Connection := Conexao;
  qry_fornecedor.SQL.Add('select p.id, p.nome from pessoas p, fornecedores f where p.id = f.pessoa_id order by p.nome');

  {qry operadoras}
  qry_operadora.Connection := Conexao;
  qry_operadora.SQL.Add('select id, descricao from cartao_operadoras order by descricao');
  qry_operadora.Open;
end;

procedure TfrmCartaoMaquinasE.prc_inicializar;
begin
  pnTitulo.Caption := 'CADASTRO DE MÁQUININHAS DE CARTÃO DE CRÉDITO';

  case self.Operacao of
  uTipos.opIncluir: begin

                       lbl_sub_titulo.Caption    := 'INCLUSÃO';
                       lbl_Id.Caption            := '-1';
                       lbl_cadastrado_em.Caption := datetostr(date);
                       btnOk.Caption             := 'Incluir';

                     end;
  uTipos.opAlterar: begin

                      prc_ler_dados;
                      lbl_sub_titulo.Caption    := 'ALTERAÇÃO';
                      btnOk.Caption             := 'Alterar';
                      lbl_alterado_em.Caption   := datetostr(date);
                      btnOk.SetFocus;

                    end;
  uTipos.opExcluir: begin

                      prc_ler_dados;
                      lbl_sub_titulo.Caption := 'EXCLUIR';
                      pnDados.Enabled        := false;
                      btnOk.Caption          := 'Excluir';
                      btnFechar.SetFocus;

                    end;
  else
    begin
      pnDados.Enabled   := false;
      if btnFechar.CanFocus then btnFechar.SetFocus;
    end;
  end;

end;

procedure TfrmCartaoMaquinasE.prc_ler_dados;
var
 loQry: TFDQuery;
begin

  try

    loQry := TFDQuery.Create(Self);
    try
      with loQry, loQry.Sql do
      begin
        Connection := Self.Conexao;
        Add('SELECT * FROM ' + Self.Tabela + ' WHERE ID =:ID');
        ParamByName('ID').AsInteger := Codigo;
        Open;
      end;
      if not loQry.IsEmpty then
      begin
        //Carrega dados da pessoas
        lbl_Id.Caption            := loQry.FieldByName('ID').AsString;
        lbl_cadastrado_em.Caption := loQry.FieldByName('CADASTRADO_EM').AsString;
        lbl_alterado_em.Caption   := loQry.FieldByName('ALTERADO_EM').AsString;
        cb_ativo.Checked          := loQry.FieldByName('ATIVO').AsString = 'S';
        rg_selecao.ItemIndex := uBiblioteca.SeSenao(loQry.FieldByName('MAQUINA_DA_EMPRESA').AsString = 'S', 0, 1);
        if rg_selecao.ItemIndex = 1 then
          cbx_fornecedor.KeyValue := loQry.FieldByName('PROPRIETARIO_ID').AsInteger;

        cbx_operadora.KeyValue    := loQry.FieldByName('CARTAO_OPERADORAS_ID').AsInteger;
        edt_nr_maquina.Text       := loQry.FieldByName('NR_MAQUINA').AsString;
        edt_vr_aluguel.Text       := FormatFloat('0.00', loQry.FieldByName('VALOR_ALUGUEL').AsFloat);
        edt_posse.Text            := loQry.FieldByName('MAQUINA_EM_POSSE_DE').AsString;
        edt_dia_vencimento.Text   := IntToStr( loQry.FieldByName('DIA_VENCIMENTO').AsInteger);

      end
      else
      begin
        ShowMessage('conta NÃO encontrada!');

      end;
    finally
      FreeAndNil(loQry);
    end;
  except
    on E : Exception do
       Raise Exception.Create(E.Message + Self.Name + '.prc_ler_dados');
  end;
end;

function TfrmCartaoMaquinasE.prc_validar: boolean;
begin
  result := false;

  if rg_selecao.ItemIndex = 1 then
    if cbx_fornecedor.Text = '' then
    begin
      ShowMessage('Selecione um FORNECEDOR');
      cbx_fornecedor.SetFocus;
      exit;
    end;

  if cbx_operadora.Text = '' then
  begin
    ShowMessage('Selecione uma OPERADORA DE CARTÃO DE CRÉDITO');
    cbx_operadora.SetFocus;
    exit;
  end;

  if edt_nr_maquina.Text = '' then
  begin
    ShowMessage('informe o número da MÁQUININHA DE CARTÃO DE CRÉDITO');
    edt_nr_maquina.SetFocus;
    exit;
  end;

  if rg_selecao.ItemIndex = 0 then
  begin
    if StrToFloat(edt_nr_maquina.Text) < 0 then
    begin
      ShowMessage('Informe um VALOR VÁLIDO');
      edt_nr_maquina.SetFocus;
      exit;
    end;

    if ((StrToInt(edt_dia_vencimento.Text) <= 0) or (StrToInt(edt_dia_vencimento.Text) > 30)) then
    begin
      ShowMessage('Informe um DIA VÁLIDO entre 1 e 30');
      edt_nr_maquina.SetFocus;
      exit;
    end;


  end;
  result := true;
end;

procedure TfrmCartaoMaquinasE.rg_selecaoClick(Sender: TObject);
begin
  inherited;
  if rg_selecao.ItemIndex = 1 then // fornecedor
  begin
    gb_forncedor.Visible      := true;
    gb_custos_maquina.Enabled := false;
    edt_vr_aluguel.Text := '0,00';
    qry_fornecedor.Open;
  end
  else
  begin                           // empresa
    gb_forncedor.Visible      := false;
    gb_custos_maquina.Enabled := true;
    qry_fornecedor.close;
  end
end;

procedure TfrmCartaoMaquinasE.prc_salvar;
begin
  if not prc_validar then Exit;

  if not Self.Conexao.InTransaction then Self.Conexao.StartTransaction;
  //***
  try
    prc_incluir_alterar(Operacao);
    if Self.Conexao.InTransaction then Self.Conexao.Commit;
    ModalResult := mrOk;
  except
    conexao.Rollback;
    ShowMessage('Não foi possível salvar o registro');
  end;

end;


procedure TfrmCartaoMaquinasE.prc_incluir_alterar(operacao: TOperacao);
begin


  qry.sql.clear;
  if operacao = opExcluir then
  begin
    qry.SQL.Add('update '+ self.Tabela + ' set ATIVO = ''N'' where id =:id');
    qry.ParamByName('id').AsInteger := Codigo;
    qry.ExecSQL;
    exit;
  end;


  if operacao = OpIncluir then
  begin
    qry.SQL.Add('insert into ' + self.Tabela );
    qry.SQL.Add('(');
    qry.SQL.Add('  CADASTRADO_EM,        ');
    qry.SQL.Add('  CARTAO_OPERADORAS_ID, ');
    qry.SQL.Add('  PROPRIETARIO_ID,      ');
    qry.SQL.Add('  NR_MAQUINA,           ');
    qry.SQL.Add('  VALOR_ALUGUEL,        ');
    qry.SQL.Add('  DIA_VENCIMENTO,    ');
    qry.SQL.Add('  MAQUINA_EM_POSSE_DE,  ');
    qry.SQL.Add('  MAQUINA_DA_EMPRESA,  ');
    qry.SQL.Add('  ATIVO                 ');
    qry.SQL.Add(')                       ');
    qry.SQL.Add('VALUES                  ');
    qry.SQL.Add('(                       ');
    qry.SQL.Add('  :CADASTRADO_EM,       ');
    qry.SQL.Add('  :CARTAO_OPERADORAS_ID,');
    qry.SQL.Add('  :PROPRIETARIO_ID,     ');
    qry.SQL.Add('  :NR_MAQUINA,          ');
    qry.SQL.Add('  :VALOR_ALUGUEL,       ');
    qry.SQL.Add('  :DIA_VENCIMENTO,   ');
    qry.SQL.Add('  :MAQUINA_EM_POSSE_DE, ');
    qry.SQL.Add('  :MAQUINA_DA_EMPRESA, ');
    qry.SQL.Add('  :ATIVO                ');
    qry.SQL.Add(')                       ');
   // qry.SQL.Add('returning ID          ');

    qry.ParamByName('CADASTRADO_EM').AsDate := Date;
  end
  else
  begin
    qry.SQL.Add('UPDATE                                         ');
    qry.SQL.Add(Tabela);
    qry.SQL.Add('SET                                            ');
    qry.SQL.Add('  ALTERADO_EM = :ALTERADO_EM,                  ');
    qry.SQL.Add('  CARTAO_OPERADORAS_ID = :CARTAO_OPERADORAS_ID,');
    qry.SQL.Add('  PROPRIETARIO_ID = :PROPRIETARIO_ID,          ');
    qry.SQL.Add('  NR_MAQUINA = :NR_MAQUINA,                    ');
    qry.SQL.Add('  VALOR_ALUGUEL = :VALOR_ALUGUEL,              ');
    qry.SQL.Add('  DIA_VENCIMENTO = :DIA_VENCIMENTO,      ');
    qry.SQL.Add('  MAQUINA_EM_POSSE_DE = :MAQUINA_EM_POSSE_DE,  ');
    qry.SQL.Add('  MAQUINA_DA_EMPRESA = :MAQUINA_DA_EMPRESA,  ');
    qry.SQL.Add('  ATIVO = :ATIVO                               ');
    qry.SQL.Add('WHERE                                          ');
    qry.SQL.Add('  ID = :ID                                     ');
    //
    qry.ParamByName('ID').AsInteger       := Codigo;
    qry.ParamByName('ALTERADO_EM').AsDate := Date;

  end;
  //ShowMessage(QRY.SQL.Text);

  qry.ParamByName('CARTAO_OPERADORAS_ID').AsInteger := cbx_operadora.KeyValue;
  qry.ParamByName('PROPRIETARIO_ID').AsInteger      := ubiblioteca.SeSenao( rg_selecao.ItemIndex = 1, cbx_fornecedor.KeyValue, p_empresa );;
  qry.ParamByName('NR_MAQUINA').AsString            := edt_nr_maquina.Text;
  qry.ParamByName('VALOR_ALUGUEL').AsFloat          := strtofloat( edt_vr_aluguel.Text );
  qry.ParamByName('DIA_VENCIMENTO').AsInteger       := strtoint(edt_dia_vencimento.Text);
  qry.ParamByName('MAQUINA_EM_POSSE_DE').AsString   := edt_posse.Text;
  qry.ParamByName('MAQUINA_DA_EMPRESA').AsString    := ubiblioteca.SeSenao(rg_selecao.ItemIndex = 0  , 'S','N');
  qry.ParamByName('ATIVO').AsString                 := ubiblioteca.SeSenao(cb_ativo.Checked  , 'S','N');

  qry.ExecSQL;
  (*
  //exemplo de como pegar o id do registro gerado
  if operacao = OpIncluir then
  begin
    qry.Open;
    Codigo := qry.FieldByName('id').AsInteger;

  end
  else
  begin
    qry.ExecSQL;
  end;
  *)
end;



end.
