unit ufrmProdutosBomba;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseGrade, Data.DB,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,
  FireDAC.Stan.Async, FireDAC.DApt, System.Actions, Vcl.ActnList,
  System.ImageList, Vcl.ImgList, Vcl.Menus, FireDAC.Comp.DataSet,
  FireDAC.Comp.Client, Vcl.ComCtrls, Vcl.ToolWin, Vcl.Grids, Vcl.DBGrids,
  Vcl.StdCtrls, Vcl.Buttons, uBiblioteca, Vcl.ExtCtrls;

type
  TfrmProdutosBomba = class(TfrmBaseGrade)
    cbDescricao: TCheckBox;
    edNome: TEdit;
    rgSituacao: TRadioGroup;
    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure actIncluirExecute(Sender: TObject);
    procedure actLocalizarExecute(Sender: TObject);
    procedure actAlterarExecute(Sender: TObject);
    procedure actExcluirExecute(Sender: TObject);
  private
    { Private declarations }
    procedure ASql();
    function ValidarPesquisa(): boolean;
    procedure Pesquisar();
  public
    { Public declarations }
  end;

procedure executa;

implementation

procedure executa;
var
  loForm : TfrmProdutosBomba;
begin
 try
   loForm:= TfrmProdutosBomba.Create(Application);
   loForm.ShowModal;
 finally
   FreeAndNil(loForm);
 end;

end;

{$R *.dfm}

procedure TfrmProdutosBomba.actAlterarExecute(Sender: TObject);
begin
  inherited;
 // ufrmProdutosBombaE.Alterar(qry.FieldByName('ID').AsInteger);
  uBiblioteca.AtualizaQuery(qry);

end;

procedure TfrmProdutosBomba.actExcluirExecute(Sender: TObject);
begin
  inherited;
  //ufrmProdutosBombaE.Excluir(qry.FieldByName('ID').AsInteger);
  uBiblioteca.AtualizaQuery(qry);

end;

procedure TfrmProdutosBomba.actIncluirExecute(Sender: TObject);
begin
  inherited;
//  ufrmProdutosBombaE.Incluir;
  uBiblioteca.AtualizaQuery(qry);

end;

procedure TfrmProdutosBomba.actLocalizarExecute(Sender: TObject);
begin
  inherited;
  if ValidarPesquisa() then
    Pesquisar();

  // mensagem para o usuario
  StatusBar.Panels[0].Text := 'Encontrado(s) : ' + inttostr(qry.RecordCount) + ' registro(s)';

end;

procedure TfrmProdutosBomba.ASql;
begin
  qry.Open('select * from ' + Self.Tabela + ' P, PRODUTOS_BOMBA B where P.ID = B.PRODUTO_ID and P.ID = -1');
end;

procedure TfrmProdutosBomba.FormCreate(Sender: TObject);
begin
  inherited;
  // property tabela no form BaseGrade
  self.Tabela := 'PRODUTOS';
  self.Titulo := 'Cadastro de Produtos [' + self.Tabela + ']' + ' Bomba de Concreto';
  Caption := Titulo;
  ASql();

end;

procedure TfrmProdutosBomba.FormShow(Sender: TObject);
begin
  inherited;
  btnLocalizar.Click;
end;

procedure TfrmProdutosBomba.Pesquisar;
var
  situacao, Condicao : string;
begin
  {Situação da pessoa}


  if rgSituacao.ItemIndex = 0 then
    situacao := 'P.ATIVO =' + QuotedStr('S') + ' and ';
  if rgSituacao.ItemIndex = 1 then
    situacao := 'P.ATIVO =' + QuotedStr('N') + ' and ';
  if rgSituacao.ItemIndex = 2 then
    situacao := 'P.ATIVO <>' + QuotedStr('') + ' and ';

  Condicao := '';


  if cbDescricao.Checked then
    if trim(edNome.Text) <> '' then
    Condicao := Condicao + 'and P.DESCRICAO like :DESCRICAO ';


  if Condicao <> '' then
  begin
    Condicao := copy(Condicao,4,length(Condicao)-4);

    qry.SQL.Clear;
    qry.SQL.Add('select P.* from ' + self.Tabela + ' P, PRODUTOS_BOMBA C where P.ID = C.PRODUTO_ID and ' + situacao + Condicao);
    self.ssql := qry.SQL.Text;

    {Carregar parametros}

     if cbDescricao.Checked then
      begin
        qry.Params.ParamByName('DESCRICAO').AsString := '%' + edNome.Text + '%';
      end;


    //ShowMessage(qry.SQL.Text);
    qry.Open;
  end
  else
  begin
    qry.SQL.Clear;
    if rgSituacao.ItemIndex = 2 then // todos
    begin
      qry.SQL.Add('select P.* from '+ self.Tabela + ' P, PRODUTOS_BOMBA C where P.ID = C.PRODUTO_ID');
      self.ssql := qry.SQL.Text;
    end
    else
    begin
      // retira o and final
      situacao := copy(situacao,1,length(situacao)-4);
      qry.SQL.Add('select P.* from '+ self.Tabela + ' P, PRODUTOS_BOMBA C where P.ID = C.PRODUTO_ID and ' + situacao);
      self.ssql := qry.SQL.Text;
  end;
    //ShowMessage(qry.SQL.Text);
    qry.Open;
  end;
end;

function TfrmProdutosBomba.ValidarPesquisa: boolean;
begin
   result := true;
end;

end.
