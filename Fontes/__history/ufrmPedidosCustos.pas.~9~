unit ufrmPedidosCustos;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseConexao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.ExtCtrls, Vcl.Grids,
  Vcl.DBGrids, Vcl.StdCtrls;

type
  TfrmPedidosCustos = class(TfrmBaseConexao)
    pnl_topo: TPanel;
    pnl_comissao_totais: TPanel;
    Label32: TLabel;
    lbl_data_contabil: TLabel;
    Label65: TLabel;
    lbl_valor_venda: TLabel;
    Label66: TLabel;
    lbl_custo_pedido: TLabel;
    Label67: TLabel;
    lbl_taxa_adm: TLabel;
    Label73: TLabel;
    lbl_comissao_adm: TLabel;
    Label74: TLabel;
    lbl_margem: TLabel;
    Label75: TLabel;
    lbl_margem_vendedor: TLabel;
    Label76: TLabel;
    lbl_comissao_vendedor: TLabel;
    labelOutrasdespesas: TLabel;
    lbl_outras_despesas: TLabel;
    GroupBox1: TGroupBox;
    dsLancamentos: TDataSource;
    dbg_comissao_itens: TDBGrid;
    procedure FormShow(Sender: TObject);
  private
    Fp_pedido_id: integer;
    procedure prc_ler_dados;
  public
    property p_pedido_id : integer read Fp_pedido_id write Fp_pedido_id;
  end;

procedure prc_executa(APedidoId :integer);

implementation

{$R *.dfm}

procedure prc_executa(APedidoId :integer);
var
  loForm : TfrmPedidosCustos;
begin
  loForm := TfrmPedidosCustos.Create(Application);
  try
    loForm.p_pedido_id := APedidoId;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

{ TfrmPedidosCustos }

procedure TfrmPedidosCustos.FormShow(Sender: TObject);
begin
  inherited;
  prc_ler_dados;
end;

procedure TfrmPedidosCustos.prc_ler_dados;
var
  loQry :TFDQuery;
begin
  try
    loQry := TFDQuery.Create(self);
    loQry.Connection := conexao;

    loQry.SQL.Clear;
    loQry.SQL.Add('select ');
    loQry.SQL.Add('  DATA_CONTABIL, ');
    loQry.SQL.Add('  TOTAL_VENDA, ');
    loQry.SQL.Add('  TOTAL_CUSTO, ');
    loQry.SQL.Add('  OUTRAS_DESPESAS, ');
    loQry.SQL.Add('  COMISSAO_ADM_TAXA, ');
    loQry.SQL.Add('  COMISSAO_ADM, ');
    loQry.SQL.Add('  COMISSAO_BRUTA, ');
    loQry.SQL.Add('  COMISSAO_LIQUIDA ');
    loQry.SQL.Add('from ');
    loQry.SQL.Add('  COMISSAO ');
    loQry.SQL.Add('where ');
    loQry.SQL.Add('  PEDIDO_ID = :PEDIDO_ID ');
    loqry.Params.ParamByName('PEDIDO_ID').AsInteger := p_pedido_id;
    loqry.Open;

  {titulo}
  pnl_topo.Caption := pnl_topo.Caption + ' ' + inttostr(p_pedido_id);

  {comissão}
  lbl_data_contabil.Caption     := loqry.fieldByName('DATA_CONTABIL').AsString;
  lbl_valor_venda.Caption       := formatfloat('0.00', loqry.fieldByName('TOTAL_VENDA').AsFloat);
  lbl_custo_pedido.Caption      := formatfloat('0.00', loqry.fieldByName('TOTAL_CUSTO').AsFloat);
  lbl_outras_despesas.Caption   := formatfloat('0.00', loqry.fieldByName('OUTRAS_DESPESAS').AsFloat);
  lbl_taxa_adm.Caption          := formatfloat('0.00', loqry.fieldByName('COMISSAO_ADM_TAXA').AsFloat);
  lbl_margem_vendedor.Caption   := '50,00';
  lbl_margem.Caption            := formatfloat('0.00', loqry.fieldByName('COMISSAO_BRUTA').Asfloat);
  lbl_comissao_vendedor.Caption := formatfloat('0.00', loqry.fieldByName('COMISSAO_LIQUIDA').AsFloat);
  lbl_comissao_adm.Caption      := formatfloat('0.00', loqry.fieldByName('COMISSAO_ADM').Asfloat);

  {material entregue}
  Qry.SQL.Clear;
  Qry.SQL.Add('select');
  Qry.SQL.Add(' i.produto_id,');
  Qry.SQL.Add(' pr.nome_fantasia,');
  Qry.SQL.Add(' sum(i.quantidade) as quantidade,');
  Qry.SQL.Add(' sum(i.quantidade* i.custo_forn) as custo_total ');
  Qry.SQL.Add('from ');
  Qry.SQL.Add('  comissao_item i, ');
  Qry.SQL.Add('  pedidos p, ');
  Qry.SQL.Add('  produtos pr ');
  Qry.SQL.Add('where  ');
  Qry.SQL.Add('  p.id = i.pedido_id and  ');
  Qry.SQL.Add('  i.produto_id = pr.id and  ');
  Qry.SQL.Add('  p.id = :PEDIDO_ID  ');
  Qry.SQL.Add('group by  ');
  Qry.SQL.Add('  i.produto_id, ');
  Qry.SQL.Add('  pr.descricao  ');
  Qry.SQL.Add('order by pr.descricao  ');

  Qry.Params.ParamByName('PEDIDO_ID').AsInteger := p_pedido_id;
  Qry.Open;



  finally
    freeandnil(loQry);
  end;
end;


end.
