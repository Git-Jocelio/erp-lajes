unit ufrmPrestadoresServicosE;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseEdicao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.ExtCtrls, Vcl.DBCtrls, Vcl.Mask, uTipos;

type
  TfrmPrestadoresServicosE = class(TfrmBaseEdicao)
    Panel1: TPanel;
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    Label6: TLabel;
    Label7: TLabel;
    Label8: TLabel;
    Label9: TLabel;
    Label10: TLabel;
    Label11: TLabel;
    Label12: TLabel;
    Label13: TLabel;
    Label14: TLabel;
    Label15: TLabel;
    Label16: TLabel;
    Label17: TLabel;
    btn_busca_pessoa: TBitBtn;
    btnIncluirPessoa: TBitBtn;
    DBEdit1: TDBEdit;
    DBEdit2: TDBEdit;
    DBEdit3: TDBEdit;
    DBEdit6: TDBEdit;
    DBEdit7: TDBEdit;
    DBEdit8: TDBEdit;
    DBEdit9: TDBEdit;
    DBEdit10: TDBEdit;
    DBEdit11: TDBEdit;
    DBEdit12: TDBEdit;
    DBEdit13: TDBEdit;
    DBEdit14: TDBEdit;
    DBEdit15: TDBEdit;
    DBEdit16: TDBEdit;
    DBEdit17: TDBEdit;
    DBCheckBox1: TDBCheckBox;
    rgPessoa: TDBRadioGroup;
    pn_fornecedor: TPanel;
    Label22: TLabel;
    Label23: TLabel;
    Label24: TLabel;
    edt_contato: TEdit;
    edt_telefones: TEdit;
    edt_servicos: TEdit;
    cb_fornecedor_ativo: TDBCheckBox;
    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure btnOkClick(Sender: TObject);
    procedure btn_busca_pessoaClick(Sender: TObject);
    procedure btnIncluirPessoaClick(Sender: TObject);
  private
    FOperacao: uTipos.TOperacao;
    FTabela: string;
    FCodigo: integer;
    { Private declarations }

  protected
    procedure prc_componentes;
    procedure prc_inicializar;
    procedure prc_ler_dados;

    function fnc_validar: boolean;
    procedure prc_incluir_alterar;
    procedure prc_salvar;


  public
    property Codigo   :integer read FCodigo write FCodigo;
    property Operacao :uTipos.TOperacao read FOperacao write FOperacao;
    property Tabela   :string read FTabela write FTabela;

  end;

  procedure prc_incluir;
  procedure prc_alterar(ACodigo :integer);
  procedure prc_excluir(ACodigo :integer);


var
  frmPrestadoresServicosE: TfrmPrestadoresServicosE;

implementation




{$R *.dfm}

uses uBiblioteca, unit_funcoes, ufrmPesquisaPessoa, ufrmPessoasE;

procedure prc_incluir;
var
  loForm : TfrmPrestadoresServicosE;
begin
  loForm := TfrmPrestadoresServicosE.Create(Application);
  try
    loForm.Operacao := uTipos.opIncluir;
    loForm.Codigo   := 0;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

procedure prc_alterar(ACodigo :integer);
var
  loForm : TfrmPrestadoresServicosE;
begin
  loForm := TfrmPrestadoresServicosE.Create(Application);
  try
    loForm.Operacao := uTipos.opAlterar;
    loForm.Codigo   := ACodigo;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

procedure prc_excluir(ACodigo :integer);
var
  loForm : TfrmPrestadoresServicosE;
begin
  loForm := TfrmPrestadoresServicosE.Create(Application);
  try
    loForm.Operacao := uTipos.opExcluir;
    loForm.Codigo   := ACodigo;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;


procedure TfrmPrestadoresServicosE.FormCreate(Sender: TObject);
begin
  inherited;
  Tabela := 'PRESTADORES_SERVICOS';
  // titulo do lbl_titulo
  titulo := 'CADASTRO DE FORNECEDORES';
end;

procedure TfrmPrestadoresServicosE.FormShow(Sender: TObject);
begin
  prc_componentes;
  prc_inicializar;
end;

procedure TfrmPrestadoresServicosE.prc_componentes;
begin
  {qry de pessoas}
  qry.SQL.Add('select * from PESSOAS where ID =:ID');
end;

procedure TfrmPrestadoresServicosE.prc_incluir_alterar;
var
  loQry : TFDQuery;
begin
  try
    loQry := TFDQuery.Create(self);
    loQry.Connection := Conexao;

    if operacao = opExcluir then
    begin
      loQry.SQL.Add('update PRESTADORES_SERVICOS set ATIVO = ' + QuotedStr('N') + ' where ID =:ID');
      loQry.ParamByName('ID').AsInteger := Codigo;
      loQry.ExecSQL;
      exit;
    end;


    if operacao = OpIncluir then
    begin
      loQry.SQL.Add('insert into PRESTADORES_SERVICOS ');
      loQry.SQL.Add('(                        ');
      //loQry.SQL.Add('  ID,                    ');
      loQry.SQL.Add('  PESSOA_ID,             ');
      loQry.SQL.Add('  CONTATO,              ');
      loQry.SQL.Add('  CELULAR,               ');
      loQry.SQL.Add('  SERVICOS_PRESTADOS,    ');
      loQry.SQL.Add('  ATIVO                  ');
      loQry.SQL.Add(')                        ');
      loQry.SQL.Add('VALUES                   ');
      loQry.SQL.Add('(                        ');
  //    loQry.SQL.Add('  :ID,                   ');
      loQry.SQL.Add('  :PESSOA_ID,            ');
      loQry.SQL.Add('  :CONTATO,             ');
      loQry.SQL.Add('  :CELULAR,              ');
      loQry.SQL.Add('  :SERVICOS_PRESTADOS,   ');
      loQry.SQL.Add('  :ATIVO                 ');
      loQry.SQL.Add(')                        ');

      loQry.ParamByName('PESSOA_ID').AsInteger := qry.FieldByName('ID').AsInteger;

    end
    else
    begin
      loQry.SQL.Add('UPDATE                                   ');
      loQry.SQL.Add('  PRESTADORES_SERVICOS                           ');
      loQry.SQL.Add('SET                                      ');
      loQry.SQL.Add('  CONTATO   = :CONTATO,                ');
      loQry.SQL.Add('  CELULAR = :CELULAR,');
      loQry.SQL.Add('  SERVICOS_PRESTADOS  = :SERVICOS_PRESTADOS,                 ');
      loQry.SQL.Add('  ATIVO  = :ATIVO                        ');
      loQry.SQL.Add('WHERE                                    ');
      loQry.SQL.Add('  PESSOA_ID = :PESSOA_ID                 ');

      loQry.ParamByName('PESSOA_ID').AsInteger := Codigo;

    end;
    //ShowMessage(loqry.SQL.text);

    loQry.ParamByName('CONTATO').AsString          := edt_contato.Text;
    loQry.ParamByName('CELULAR').AsString           := edt_telefones.Text;
    loQry.ParamByName('SERVICOS_PRESTADOS').AsString:= edt_servicos.Text;
    loQry.ParamByName('ATIVO').AsString             := SeSenao(cb_fornecedor_ativo.Checked, 'S','N');
    loQry.ExecSQL;
  finally
     FreeAndNil(loQry);
  end;
end;


procedure TfrmPrestadoresServicosE.prc_inicializar;
begin
  case self.Operacao of
  uTipos.opIncluir: begin
                       pnDados.Enabled        := true;
                       lbl_sub_titulo.Caption := 'Incluir um novo prestador de serviço';
                       btnOk     .Caption     := 'Incluir';
                       btn_busca_pessoa.SetFocus;
                       qry.Close;
                     end;
  uTipos.opAlterar: begin
                      self.prc_ler_dados;
                      lbl_sub_titulo.Caption := 'Alterar dados do prestador de serviço';
                      btnOk.Caption          := 'Alterar';
                      //
                      btnOk.SetFocus;
                    end;
  uTipos.opExcluir: begin
                      self.prc_ler_dados;
                      lbl_sub_titulo.Caption := 'Marcar o prestador de serviço como INATIVO';
                      pn_fornecedor.Enabled  := false;
                      btnOk.Caption          := 'Excluir';
                      btnFechar.SetFocus;
                    end;
  else
    begin
      pnDados.Enabled       := false;
      pn_fornecedor.Enabled := false;
      if btnFechar.CanFocus then btnFechar.SetFocus;
    end;
  end;

end;

procedure TfrmPrestadoresServicosE.prc_ler_dados;
var
  loQry: TFDQuery;
begin
  pnDados.Enabled := false;
  try
    loQry:= TFDQuery.Create(self);
    loQry.Connection := conexao;
    loqry.sql.Add('select P.*, S.* from PESSOAS P, PRESTADORES_SERVICOS S where P.ID = S.PESSOA_ID and P.ID = :ID');
    loQry.Params.ParamByName('ID').AsInteger := Codigo;
    loQry.Open;

    //pessoa
    FilterCds(qry, fsInteger, inttostr(loQry.FieldByName('pessoa_id').AsInteger));
    edt_contato.Text   := loQry.FieldByName('contato').AsString;
    edt_telefones.Text := loQry.FieldByName('CELULAR').AsString;
    edt_servicos.Text  := loQry.FieldByName('SERVICOS_PRESTADOS').AsString;
  finally
    FreeAndNil(loQry)
  end;
end;

procedure TfrmPrestadoresServicosE.prc_salvar;
begin
  if not Self.Conexao.InTransaction then Self.Conexao.StartTransaction;
  //***
  try
    prc_incluir_alterar;

    if Self.Conexao.InTransaction then Self.Conexao.Commit;
      CriarMensagem('AVISO','PRESTADOR DE SERVIÇO salvo com sucesso!');

    ModalResult := mrOk;
  except
//    Self.Conexao.Rollback;
//    CriarMensagem('AVISO','Não foi possível salvar o registro');
 on E : Exception do
   Raise Exception.Create(E.Message +  slinebreak +' NÃO FOI POSSIVEL SALVAR O REGISTRO! ' );

  end;

end;

procedure TfrmPrestadoresServicosE.btnIncluirPessoaClick(Sender: TObject);
var
  pessoa: integer;
begin
  inherited;
  pessoa := ufrmPessoasE.incluir;
//  ShowMessage(inttostr(pessoa));

  uBiblioteca.FilterCds(qry, uTipos.fsInteger, inttostr(pessoa));

end;

procedure TfrmPrestadoresServicosE.btnOkClick(Sender: TObject);
begin
  if fnc_validar then
  begin
    prc_salvar;
  end;
end;

procedure TfrmPrestadoresServicosE.btn_busca_pessoaClick(Sender: TObject);
begin
  if frmPesquisaPessoa = nil  then
  frmPesquisaPessoa := TfrmPesquisaPessoa.Create(Application);
  try
    frmPesquisaPessoa.ShowModal;

    //ShowMessage(inttostr(frmPesquisaPessoa.Codigo));
    if frmPesquisaPessoa.Confirmado then
    begin
      uBiblioteca.FilterCds(qry, uTipos.fsInteger, inttostr(frmPesquisaPessoa.Codigo));
    end
    else
      qry.Close;
  finally
    FreeAndNil(frmPesquisaPessoa);

  end;
end;

function TfrmPrestadoresServicosE.fnc_validar: boolean;
var
  loQuery: TFDQuery;
begin
  result := false;


  if qry.IsEmpty then
  begin
    CriarMensagem('AVISO','SELECIONE OU CADASTRE UMA PESSOA');
    btn_busca_pessoa.SetFocus;
    exit;
  end;

  {verifica duplicidade}
  if self.Operacao = uTipos.OpIncluir then
  begin
    try
      try
        loQuery := TFDQuery.Create(self);
        loQuery.Connection := Self.Conexao;
        loQuery.SQL.Add('select PESSOA_ID from PRESTADORES_SERVICO where PESSOA_ID =:PESSOA_ID');
        loQuery.Params[0].AsInteger := qry.fieldbyname('ID').AsInteger;
        loQuery.Open;
        if not loQuery.IsEmpty then
        begin
          CriarMensagem('AVISO','Cliente já está cadastrado no sistema');
          exit;
        end;
      finally
        FreeAndNil(loQuery);
      end;
    except
      on E : Exception do
      Raise Exception.Create(E.Message + Self.Name +'.Valida : ' + self.Caption );
    end;
  end;

  if edt_contato.Text = '' then
  begin
    CriarMensagem('AVISO','Informe o nome do vendedor(a) desse prestador de serviço.');
    edt_contato.SetFocus;
    exit;
  end;

  if edt_telefones.Text = '' then
  begin
    CriarMensagem('AVISO','Informe pelo menos um telefone de contato');
    edt_telefones.SetFocus;
    exit;
  end;

  if edt_servicos.Text = '' then
  begin
    CriarMensagem('AVISO','Informe a descrição dos serviços que o prestador de serviço.');
    edt_servicos.SetFocus;
    exit;
  end;

  result := true;

end;




end.
