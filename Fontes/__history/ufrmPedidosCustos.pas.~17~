unit ufrmPedidosCustos;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseConexao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.ExtCtrls, Vcl.Grids,
  Vcl.DBGrids, Vcl.StdCtrls, Vcl.Buttons;

type
  TfrmPedidosCustos = class(TfrmBaseConexao)
    pnl_comissao_totais: TPanel;
    Label32: TLabel;
    lbl_data_contabil: TLabel;
    Label65: TLabel;
    lbl_valor_venda: TLabel;
    Label66: TLabel;
    lbl_custo_pedido: TLabel;
    Label67: TLabel;
    lbl_taxa_adm: TLabel;
    Label73: TLabel;
    lbl_comissao_adm: TLabel;
    Label74: TLabel;
    lbl_margem: TLabel;
    Label75: TLabel;
    lbl_margem_vendedor: TLabel;
    Label76: TLabel;
    lbl_comissao_vendedor: TLabel;
    labelOutrasdespesas: TLabel;
    lbl_outras_despesas: TLabel;
    dsLancamentos: TDataSource;
    qryproduto_id: TIntegerField;
    qrynome_fantasia: TStringField;
    qryqtde: TFMTBCDField;
    qrycusto: TBCDField;
    pnl_topo: TPanel;
    btn_fechar: TSpeedButton;
    lbl_titulo: TLabel;
    pnl_separa_topo: TPanel;
    Panel5: TPanel;
    dbg_comissao_itens: TDBGrid;
    pnl_resultado: TPanel;
    lbl_resultado: TLabel;
    procedure FormShow(Sender: TObject);
    procedure btn_fecharClick(Sender: TObject);
    procedure dbg_comissao_itensTitleClick(Column: TColumn);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
  private
    Fp_pedido_id: integer;
    procedure prc_ler_dados;
    procedure prc_componentes;
  public
    property p_pedido_id : integer read Fp_pedido_id write Fp_pedido_id;
  end;
var
  loForm : TfrmPedidosCustos;
procedure prc_executa(APedidoId :integer);

implementation

{$R *.dfm}

uses unit_funcoes, unit_principal;

procedure prc_executa(APedidoId :integer);

begin
  loForm := TfrmPedidosCustos.Create(Application);
  try
    loForm.p_pedido_id := APedidoId;
    loForm.Show;
  finally
  //  FreeAndNil(loForm);
  end;
end;

{ TfrmPedidosCustos }

procedure TfrmPedidosCustos.prc_componentes;
begin
  Qry.SQL.Clear;
  Qry.SQL.Add('select');
  Qry.SQL.Add(' i.produto_id,');
  Qry.SQL.Add(' pr.nome_fantasia,');
  Qry.SQL.Add(' sum(i.quantidade) as qtde,');
  Qry.SQL.Add(' sum(i.quantidade* i.custo_vend) as custo ');
  Qry.SQL.Add('from ');
  Qry.SQL.Add('  comissao_item i, ');
  Qry.SQL.Add('  pedidos p, ');
  Qry.SQL.Add('  produtos pr ');
  Qry.SQL.Add('where  ');
  Qry.SQL.Add('  p.id = i.pedido_id and  ');
  Qry.SQL.Add('  i.produto_id = pr.id and  ');
  Qry.SQL.Add('  p.id = :PEDIDO_ID  ');
  Qry.SQL.Add('group by  ');
  Qry.SQL.Add('  i.produto_id, ');
  Qry.SQL.Add('  pr.nome_fantasia  ');
  //Qry.SQL.Add('order by pr.nome_fantasia  ');
  Qry.SQL.Add('order by custo desc  ');

end;

procedure TfrmPedidosCustos.btn_fecharClick(Sender: TObject);
begin
  inherited;
  close;
end;

procedure TfrmPedidosCustos.dbg_comissao_itensTitleClick(Column: TColumn);
begin
  inherited;
  prc_ordenar_dgrid( dsLancamentos, dbg_comissao_itens, Column );
end;

procedure TfrmPedidosCustos.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
  inherited;

  form_principal.prc_controla_menu(true);
  freeandnil ( loForm );


end;

procedure TfrmPedidosCustos.FormShow(Sender: TObject);
begin
  inherited;
  prc_componentes;
  prc_ler_dados;
end;

procedure TfrmPedidosCustos.prc_ler_dados;
var
  loQry :TFDQuery;
begin
  try
    loQry := TFDQuery.Create(self);
    loQry.Connection := conexao;

    loQry.SQL.Clear;
    loQry.SQL.Add('select ');
    loQry.SQL.Add('  DATA_CONTABIL, ');
    loQry.SQL.Add('  TOTAL_VENDA, ');
    loQry.SQL.Add('  TOTAL_CUSTO, ');
    loQry.SQL.Add('  OUTRAS_DESPESAS, ');
    loQry.SQL.Add('  COMISSAO_ADM_TAXA, ');
    loQry.SQL.Add('  COMISSAO_ADM, ');
    loQry.SQL.Add('  COMISSAO_BRUTA, ');
    loQry.SQL.Add('  COMISSAO_LIQUIDA ');
    loQry.SQL.Add('from ');
    loQry.SQL.Add('  COMISSAO ');
    loQry.SQL.Add('where ');
    loQry.SQL.Add('  PEDIDO_ID = :PEDIDO_ID ');
    loqry.Params.ParamByName('PEDIDO_ID').AsInteger := p_pedido_id;
    loqry.Open;

    {titulo}
   // pnl_topo.Caption := pnl_topo.Caption + ' ' + inttostr(p_pedido_id);
    lbl_titulo.Caption := 'CUSTO DO PEDIDO N. ' + inttostr(p_pedido_id);

    {comissão}
    lbl_data_contabil.Caption     := loqry.fieldByName('DATA_CONTABIL').AsString;
    lbl_valor_venda.Caption       := formatfloat('0.00', loqry.fieldByName('TOTAL_VENDA').AsFloat);
    lbl_custo_pedido.Caption      := formatfloat('0.00', loqry.fieldByName('TOTAL_CUSTO').AsFloat);
    lbl_outras_despesas.Caption   := formatfloat('0.00', loqry.fieldByName('OUTRAS_DESPESAS').AsFloat);
    lbl_taxa_adm.Caption          := formatfloat('0.00', loqry.fieldByName('COMISSAO_ADM_TAXA').AsFloat);
    lbl_margem_vendedor.Caption   := '50,00'; {consertar depois}
    lbl_margem.Caption            := formatfloat('0.00', loqry.fieldByName('COMISSAO_BRUTA').Asfloat);
    //lbl_comissao_vendedor.Caption := formatfloat('0.00', loqry.fieldByName('COMISSAO_LIQUIDA').AsFloat + loqry.fieldByName('OUTRAS_DESPESAS').AsFloat );
    lbl_comissao_vendedor.Caption := formatfloat('0.00', loqry.fieldByName('COMISSAO_LIQUIDA').AsFloat );
    lbl_comissao_adm.Caption      := formatfloat('0.00', loqry.fieldByName('COMISSAO_ADM').Asfloat);

    {material entregue}
    Qry.Params.ParamByName('PEDIDO_ID').AsInteger := p_pedido_id;
    Qry.Open;

    //ajustas as colunas do dbgrid
    prc_ajustar_colunas_grid( dbg_comissao_itens );

    //aumenta o tamanho da linha do ddgrid
    prc_ajusta_tamanho_linha( dbg_comissao_itens );


  finally
    freeandnil(loQry);
  end;
end;


end.
