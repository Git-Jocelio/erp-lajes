unit ufrmEmpresaE;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseEdicao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.ExtCtrls, ufrmPesquisaPessoa, uBiblioteca, uTipos, ufrmPessoasE,
  Vcl.DBCtrls, Vcl.Mask, udmConn;

type
  TfrmEmpresaE = class(TfrmBaseEdicao)
    Panel1: TPanel;
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    Label6: TLabel;
    Label7: TLabel;
    Label8: TLabel;
    Label9: TLabel;
    Label10: TLabel;
    Label11: TLabel;
    Label12: TLabel;
    Label13: TLabel;
    Label14: TLabel;
    Label15: TLabel;
    Label16: TLabel;
    Label17: TLabel;
    btnBuscaPessoa: TBitBtn;
    btnIncluirPessoa: TBitBtn;
    DBEdit1: TDBEdit;
    DBEdit2: TDBEdit;
    DBEdit3: TDBEdit;
    DBEdit6: TDBEdit;
    DBEdit7: TDBEdit;
    DBEdit8: TDBEdit;
    DBEdit9: TDBEdit;
    DBEdit10: TDBEdit;
    DBEdit11: TDBEdit;
    DBEdit12: TDBEdit;
    DBEdit13: TDBEdit;
    DBEdit14: TDBEdit;
    DBEdit15: TDBEdit;
    DBEdit16: TDBEdit;
    DBEdit17: TDBEdit;
    DBCheckBox1: TDBCheckBox;
    rgPessoa: TDBRadioGroup;
    pnCliente: TPanel;
    Label18: TLabel;
    Label19: TLabel;
    Label20: TLabel;
    Label22: TLabel;
    Label23: TLabel;
    Label24: TLabel;
    edt_nome_fantasia: TEdit;
    edt_site: TEdit;
    edt_celular: TEdit;
    edt_telefone_fixo: TEdit;
    edt_crea: TEdit;
    edt_frase: TEdit;
    procedure FormShow(Sender: TObject);
    procedure FormCreate(Sender: TObject);

    procedure btnBuscaPessoaClick(Sender: TObject);
    procedure btnIncluirPessoaClick(Sender: TObject);
    procedure btnOkClick(Sender: TObject);
  private
    FOperacao: uTipos.TOperacao;
    FCodigo: integer;
    FTabela: string;
    function  fnc_validar: Boolean;
    procedure prc_salvar;
    procedure prc_incluir_alterar;

  protected
    procedure prc_componentes;
    procedure prc_inicializar;
    procedure prc_lerDados;

  public
    { Public declarations }
    property Codigo   :integer read FCodigo write FCodigo;
    property Operacao :uTipos.TOperacao read FOperacao write FOperacao;
    property Tabela   :string read FTabela write FTabela;

  end;

  procedure Incluir;
  procedure Alterar(ACodigo :integer);
  procedure Excluir(ACodigo :integer);

implementation

procedure Incluir;
var
  loForm : TfrmEmpresaE;
begin
  loForm := TfrmEmpresaE.Create(Application);
  try
    loForm.Operacao := uTipos.opIncluir;
    loForm.Codigo   := 0;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

procedure Alterar(ACodigo :integer);
var
  loForm : TfrmEmpresaE;
begin
  loForm := TfrmEmpresaE.Create(Application);
  try
    loForm.Operacao := uTipos.opAlterar;
    loForm.Codigo   := ACodigo;
    ShowMessage('ALTERAR')  ;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

procedure Excluir(ACodigo :integer);
var
  loForm : TfrmEmpresaE;
begin
  loForm := TfrmEmpresaE.Create(Application);
  try
    loForm.Operacao := uTipos.opExcluir;
    loForm.Codigo   := ACodigo;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;


{$R *.dfm}

procedure TfrmEmpresaE.btnBuscaPessoaClick(Sender: TObject);
begin
  inherited;
  if frmPesquisaPessoa = nil  then
  frmPesquisaPessoa := TfrmPesquisaPessoa.Create(Application);
  try
    frmPesquisaPessoa.ShowModal;

    //ShowMessage(inttostr(frmPesquisaPessoa.Codigo));
    if frmPesquisaPessoa.Confirmado then
    begin
      uBiblioteca.FilterCds(qry, uTipos.fsInteger, inttostr(frmPesquisaPessoa.Codigo));
     // qryClientes.FieldByName('PESSOA_ID').AsInteger := frmPesquisaPessoa.Codigo;
    end
    else
      qry.Close;
  finally
    FreeAndNil(frmPesquisaPessoa);

  end;

end;

procedure TfrmEmpresaE.btnIncluirPessoaClick(Sender: TObject);
begin
  inherited;
  ufrmPessoasE.incluir;

end;

procedure TfrmEmpresaE.btnOkClick(Sender: TObject);
begin
  inherited;
  if fnc_validar then
  begin
    prc_salvar;
  end;

end;

procedure TfrmEmpresaE.prc_componentes;
begin
  qry.SQL.Add('select * from PESSOAS where ID =:ID');
end;


procedure TfrmEmpresaE.FormCreate(Sender: TObject);

begin
  inherited;
  Tabela := 'EMPRESA';

end;

procedure TfrmEmpresaE.FormShow(Sender: TObject);
begin
  inherited;
  prc_componentes;
  prc_inicializar;
end;

function TfrmEmpresaE.fnc_validar: Boolean;
begin
  result := false;

  if DS.DataSet.IsEmpty then
  begin
    ShowMessage('Selecione uma Pessoa');
    btnBuscaPessoa.Click;
    exit;
  end;

  if edt_nome_fantasia.Text = '' then
  begin
    ShowMessage('Informe o NOME FANTASIA da empresa');
    edt_nome_fantasia.SetFocus;
    exit;
  end;

  if edt_site.Text = '' then
  begin
    ShowMessage('Informe o SITE da empresa');
    edt_site.SetFocus;
    exit;
  end;

  if edt_celular.Text = '' then
  begin
    ShowMessage('Informe o CELULAR da empresa');
    edt_celular.SetFocus;
    exit;
  end;

  if edt_telefone_fixo.Text = '' then
  begin
    ShowMessage('Informe o TELEFONE FIXO da empresa');
    edt_telefone_fixo.SetFocus;
    exit;
  end;

  if edt_crea.Text = '' then
  begin
    ShowMessage('Informe o número do CREA da empresa');
    edt_crea.SetFocus;
    exit;
  end;

  if edt_frase.Text = '' then
  begin
    ShowMessage('Informe uma FRASE DE BOAS VINDAS da empresa');
    edt_frase.SetFocus;
    exit;
  end;

  {carrega a classe}
  dmConn.empresa.PessoaId      := ds.DataSet.FieldByName('ID').AsInteger;
  dmConn.empresa.Nome_Fantasia := edt_nome_fantasia.Text;
  dmConn.empresa.Site          := edt_site.Text;
  dmConn.empresa.Crea          := edt_crea.Text;
  dmConn.empresa.Frase         := edt_frase.Text;
  dmConn.empresa.Telefone1     := edt_celular.Text;
  dmConn.empresa.Telefone2     := edt_telefone_fixo.Text;


  result := true;
end;

procedure TfrmEmpresaE.prc_inicializar;
begin
  Self.Caption := 'SYSLAJES - SISTEMA DE GERENCIEMENTO DE LAJES';
  case self.Operacao of
  uTipos.opIncluir: begin
                       pnDados.Enabled := true;
                       pnTitulo.Caption   := 'Manutenção de ' + Tabela + ' [Inclusão]';
                       btnOk     .Caption := 'Incluir';

                       btnBuscaPessoa.SetFocus;
                       qry.Close;
                     end;

  uTipos.opAlterar: begin
                      self.prc_lerDados;
                      pnTitulo.Caption   := 'Manutenção de ' + Tabela + ' [Alteração]';
                      btnOk.Caption      := 'Alterar';
                      //
                      btnBuscaPessoa.Enabled := false;
                      btnIncluirPessoa.Enabled := false;

                      btnOk.SetFocus;
                    end;

  uTipos.opExcluir: begin
                      self.prc_lerDados;
                      pnTitulo.Caption   := 'Manutenção de ' + Tabela + ' [Exclusão]';
                      pnDados.Enabled    := false;
                      btnOk.Caption      := 'Excluir';
                      btnFechar.SetFocus;
                    end;
  else
    begin
      pnDados.Enabled   := false;
      //pnCliente.Enabled   := false;
      if btnFechar.CanFocus then btnFechar.SetFocus;
    end;
  end;
end;

procedure TfrmEmpresaE.prc_lerDados;
var
  loQry : TFDQuery;
begin
  try
    // pessoa
    qry.Close;
    qry.ParamByName('id').AsInteger := codigo;
    qry.Open;

    loQry := TFDQuery.Create(self);
    loQry.Connection := conexao;
    loqry.SQL.Clear;
    loQry.SQL.Add('select p.*, e.id as empresa_id, e.nome_fantasia, e.site, e.telefone1, e.telefone2, e.crea, e.frase ');
    loQry.SQL.Add('  from ');
    loQry.SQL.Add('pessoas p, empresa e ');
    loQry.SQL.Add('  where ');
    loQry.SQL.Add(' p.id = :id  ');
    loqry.ParamByName('id').AsInteger := codigo;
    loqry.Open;

    edt_nome_fantasia.Text := loQry.FieldByName('NOME_FANTASIA').AsString;
    edt_site.Text          := loQry.FieldByName('SITE').AsString;
    edt_celular.Text       := loQry.FieldByName('TELEFONE1').AsString;
    edt_telefone_fixo.Text := loQry.FieldByName('TELEFONE2').AsString;;
    edt_crea.Text          := loQry.FieldByName('CREA').AsString;;
    edt_frase.Text         := loQry.FieldByName('FRASE').AsString;;

  finally
    freeandnil(loqry);
  end;

end;

procedure TfrmEmpresaE.prc_salvar;
begin
  if not Self.Conexao.InTransaction then Self.Conexao.StartTransaction;
  //***
  try
    prc_incluir_alterar;

    if Self.Conexao.InTransaction then Self.Conexao.Commit;
      ShowMessage('EMPRESA salvo com sucesso!');

    self.Close;
  //  ModalResult := mrOk;
  except
    Self.Conexao.Rollback;
    ShowMessage('Não foi possível salvar o registro');

  end;


end;

procedure TfrmEmpresaE.prc_incluir_alterar;
var
  loQry : TFDQuery;
begin
  try
    loQry := TFDQuery.Create(self);
    loQry.Connection := Conexao;

    if operacao = opExcluir then
    begin
      loQry.SQL.Add('update EMPRESA set ATIVO = ' + QuotedStr('N') + ' where ID =:ID');
      loQry.ParamByName('ID').AsInteger := Codigo;
      loQry.ExecSQL;
      exit;
    end;


    if operacao = OpIncluir then
    begin
      loQry.SQL.Add('insert into EMPRESA ');
      loQry.SQL.Add('(                        ');
      loQry.SQL.Add('  ID,                    ');
      loQry.SQL.Add('  PESSOA_ID,             ');
      loQry.SQL.Add('  NOME_FANTASIA,              ');
      loQry.SQL.Add('  SITE,     ');
      loQry.SQL.Add('  CREA,              ');
      loQry.SQL.Add('  TELEFONE1,              ');
      loQry.SQL.Add('  TELEFONE2,              ');
      loQry.SQL.Add('  COND,              ');
      loQry.SQL.Add('  IMG_LOGO,              ');
      loQry.SQL.Add('  ATIVO                  ');
      loQry.SQL.Add(')                        ');
      loQry.SQL.Add('VALUES                   ');
      loQry.SQL.Add('(                        ');
      loQry.SQL.Add('  :ID,                   ');
      loQry.SQL.Add('  :PESSOA_ID,            ');
      loQry.SQL.Add('  :NOME_FANTASIA,             ');
      loQry.SQL.Add('  :SITE,    ');
      loQry.SQL.Add('  :CREA,             ');
      loQry.SQL.Add('  :TELEFONE1,             ');
      loQry.SQL.Add('  :TELEFONE2,             ');
      loQry.SQL.Add('  :COND,             ');
      loQry.SQL.Add('  :IMG_LOGO,             ');
      loQry.SQL.Add('  :ATIVO                 ');
      loQry.SQL.Add(')                        ');

      Codigo := uBiblioteca.AutoIncremento(conexao, 'EMPRESA');
      loQry.ParamByName('ID').AsInteger        := Codigo;
      loQry.ParamByName('PESSOA_ID').AsInteger := qry.FieldByName('ID').AsInteger;

    end
    else
    begin
      loQry.SQL.Add('UPDATE                              ');
      loQry.SQL.Add('  EMPRESA                           ');
      loQry.SQL.Add('SET                                 ');
      loQry.SQL.Add('  NOME_FANTASIA   = :NOME_FANTASIA, ');
      loQry.SQL.Add('  SITE = :SITE,                     ');
      loQry.SQL.Add('  CREA  = :CREA,                    ');
      loQry.SQL.Add('  TELEFONE1  = :TELEFONE1,          ');
      loQry.SQL.Add('  TELEFONE2  = :TELEFONE2,          ');
      loQry.SQL.Add('  COND  = :COND,                    ');
      loQry.SQL.Add('  IMG_LOGO  = :IMG_LOGO,            ');
      loQry.SQL.Add('  ATIVO  = :ATIVO                   ');
      loQry.SQL.Add('WHERE                               ');
      loQry.SQL.Add('  PESSOA_ID = :ID                          ');

      loQry.ParamByName('ID').AsInteger := Codigo;

    end;
    //ShowMessage(loqry.SQL.text);

    loQry.ParamByName('NOME_FANTASIA').AsString := edt_nome_fantasia.Text;
    loQry.ParamByName('SITE').AsString          := edt_site.Text;
    loQry.ParamByName('CREA').AsString          := edt_crea.Text;
    loQry.ParamByName('TELEFONE1').AsString     := edt_telefone_fixo.Text;
    loQry.ParamByName('TELEFONE2').AsString     := edt_celular.Text;
    loQry.ParamByName('COND').AsString          := edt_frase.Text;
    loQry.ParamByName('IMG_LOGO').AsString      := '';
    loQry.ParamByName('ATIVO').AsString         := 'S';

    ShowMessage(loQry.SQL.TEXT);
    loQry.ExecSQL;
  finally
     FreeAndNil(loQry);
  end;
end;



end.
