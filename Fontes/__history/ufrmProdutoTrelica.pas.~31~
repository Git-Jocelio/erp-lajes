unit ufrmProdutoTrelica;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseGrade, Data.DB,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,
  FireDAC.Stan.Async, FireDAC.DApt, System.Actions, Vcl.ActnList,
  System.ImageList, Vcl.ImgList, Vcl.Menus, FireDAC.Comp.DataSet,
  FireDAC.Comp.Client, Vcl.ComCtrls, Vcl.ToolWin, Vcl.Grids, Vcl.DBGrids,
  Vcl.StdCtrls, Vcl.Buttons, Vcl.ExtCtrls, Vcl.DBCtrls;

type
  TfrmProdutoTrelica = class(TfrmBaseGrade)
    cbDescricao: TCheckBox;
    rgSituacao: TRadioGroup;
    edNome: TEdit;
    qryATIVO: TStringField;
    qryID: TIntegerField;
    qryNOME_FANTASIA: TStringField;
    qryPRECO_CUSTO_12MT: TCurrencyField;
    qryPERCA: TCurrencyField;
    qryKGS_METRO: TCurrencyField;
    qryCUSTO_LIQUIDO: TFMTBCDField;
    procedure FormCreate(Sender: TObject);
    procedure actLocalizarExecute(Sender: TObject);
    procedure actAlterarExecute(Sender: TObject);
    procedure actIncluirExecute(Sender: TObject);
    procedure actExcluirExecute(Sender: TObject);
    procedure DBGrid1DblClick(Sender: TObject);
  private
    procedure ASql();
    function ValidarPesquisa(): boolean;
    procedure Pesquisar();
  public
    { Public declarations }
  end;

  procedure executa;

implementation

uses ufrmProdutosTrelicaE, uBiblioteca, udmConn;

procedure executa;
var
  loForm : TfrmProdutoTrelica;
begin
  loForm := TfrmProdutoTrelica.Create(Application);
  try
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;


end;

{$R *.dfm}

procedure TfrmProdutoTrelica.actAlterarExecute(Sender: TObject);
begin
  inherited;
  ufrmProdutosTrelicaE.Alterar(qry.fieldbyname('ID').AsInteger);
  uBiblioteca.AtualizaQuery(qry);

end;

procedure TfrmProdutoTrelica.actExcluirExecute(Sender: TObject);
begin
  inherited;
  if not qry.IsEmpty then
  begin
    ufrmProdutosTrelicaE.Excluir(qry.fieldbyname('ID').AsInteger);
    uBiblioteca.AtualizaQuery(qry);
  end;

end;

procedure TfrmProdutoTrelica.actIncluirExecute(Sender: TObject);
begin
  inherited;
  ufrmProdutosTrelicaE.Incluir;
  uBiblioteca.AtualizaQuery(qry);

end;

procedure TfrmProdutoTrelica.actLocalizarExecute(Sender: TObject);
begin
  inherited;
  if ValidarPesquisa() then
    Pesquisar();

  // mensagem para o usuario
  StatusBar.Panels[0].Text := 'Encontrado(s) : ' + inttostr(qry.RecordCount) + ' registro(s)';

end;

procedure TfrmProdutoTrelica.ASql;
begin
  {Como são poucos registros, ja abre a tabela mostrando todos}
  qry.Open('select P.ATIVO,P.ID, P.NOME_FANTASIA,T.PRECO_CUSTO_12MT,P.PERCA,P.CUSTO_LIQUIDO*T.KGS_METRO*12 as CUSTO_LIQUIDO, T.KGS_METRO, T.PRECO_CUSTO_12MT  from ' + Self.Tabela + ' P, PRODUTOS_TRELICA T where P.ID=T.PRODUTO_ID ');
end;

procedure TfrmProdutoTrelica.DBGrid1DblClick(Sender: TObject);
begin
  inherited;
  if not qry.IsEmpty then
    btnAlterar.Click;
end;

procedure TfrmProdutoTrelica.FormCreate(Sender: TObject);
begin
  inherited;
  // property tabela no form BaseGrade
  self.Tabela := 'PRODUTOS';
  self.Titulo := 'Cadastro de Produtos [' + self.Tabela + ']' + ' Treliça';
  Caption := Titulo;
  ASql();

end;

procedure TfrmProdutoTrelica.Pesquisar;
var
  situacao, Condicao : string;
begin
  {Situação da pessoa}


  if rgSituacao.ItemIndex = 0 then
    situacao := 'P.ATIVO =' + QuotedStr('S') + ' and ';
  if rgSituacao.ItemIndex = 1 then
    situacao := 'P.ATIVO =' + QuotedStr('N') + ' and ';
  if rgSituacao.ItemIndex = 2 then
    situacao := 'P.ATIVO <>' + QuotedStr('') + ' and ';

  Condicao := '';


  if cbDescricao.Checked then
    if trim(edNome.Text) <> '' then
    Condicao := Condicao + 'and P.DESCRICAO like :DESCRICAO ';


  if Condicao <> '' then
  begin
    Condicao := copy(Condicao,4,length(Condicao)-4);

    qry.SQL.Clear;
    qry.SQL.Add('select P.ATIVO,P.ID, P.NOME_FANTASIA,T.PRECO_CUSTO_12MT,P.PERCA,P.CUSTO_LIQUIDO*T.KGS_METRO*12 as CUSTO_LIQUIDO, T.KGS_METRO, T.PRECO_CUSTO_12MT  from ' + self.Tabela + ' P, PRODUTOS_TRELICA T where P.ID = T.PRODUTO_ID and ' + situacao + Condicao);
    self.ssql := qry.SQL.Text;

    {Carregar parametros}

     if cbDescricao.Checked then
      begin
        qry.Params.ParamByName('DESCRICAO').AsString := '%' + edNome.Text + '%';
      end;


    //ShowMessage(qry.SQL.Text);
    qry.Open;
  end
  else
  begin
    qry.SQL.Clear;
    if rgSituacao.ItemIndex = 2 then // todos
    begin
      qry.SQL.Add('select P.ATIVO,P.ID, P.NOME_FANTASIA,T.PRECO_CUSTO_12MT,P.PERCA,P.CUSTO_LIQUIDO*T.KGS_METRO*12 as CUSTO_LIQUIDO, T.KGS_METRO, T.PRECO_CUSTO_12MT from '+ self.Tabela + ' P, PRODUTOS_TRELICA T where P.ID = T.PRODUTO_ID');
      self.ssql := qry.SQL.Text;
    end
    else
    begin
      // retira o and final
      situacao := copy(situacao,1,length(situacao)-4);
      //qry.SQL.Add('select P.*, T.KGS_METRO, T.PRECO_CUSTO_12MT from '+ self.Tabela + ' P, PRODUTOS_TRELICA T where P.ID = T.PRODUTO_ID and ' + situacao);
      qry.SQL.Add('select P.ATIVO,P.ID, P.NOME_FANTASIA,T.PRECO_CUSTO_12MT,P.PERCA,P.CUSTO_LIQUIDO*T.KGS_METRO*12 as CUSTO_LIQUIDO, T.KGS_METRO, T.PRECO_CUSTO_12MT from '+ self.Tabela + ' P, PRODUTOS_TRELICA T where P.ID = T.PRODUTO_ID and ' + situacao);
      self.ssql := qry.SQL.Text;
    end;
    //ShowMessage(qry.SQL.Text);
    qry.Open;
  end;


end;

function TfrmProdutoTrelica.ValidarPesquisa: boolean;
begin
  result := true;
end;

end.
