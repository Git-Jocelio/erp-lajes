unit ufrmProdutos;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseGrade, Data.DB,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,
  FireDAC.Stan.Async, FireDAC.DApt, System.Actions, Vcl.ActnList,
  System.ImageList, Vcl.ImgList, Vcl.Menus, FireDAC.Comp.DataSet,
  FireDAC.Comp.Client, Vcl.ComCtrls, Vcl.ToolWin, Vcl.Grids, Vcl.DBGrids,
  Vcl.StdCtrls, Vcl.Buttons, Vcl.ExtCtrls, Vcl.DBCtrls;

type
  TfrmProdutos = class(TfrmBaseGrade)
    cbDescricao: TCheckBox;
    rgSituacao: TRadioGroup;
    edNome: TEdit;
    procedure FormCreate(Sender: TObject);
    procedure actLocalizarExecute(Sender: TObject);
    procedure actIncluirExecute(Sender: TObject);
    procedure actAlterarExecute(Sender: TObject);
    procedure actExcluirExecute(Sender: TObject);
    procedure DBGrid1DblClick(Sender: TObject);
  private
    procedure ASql();
    function ValidarPesquisa(): boolean;
    procedure Pesquisar();
  public
    { Public declarations }
  end;

  procedure executa;

implementation

uses uBiblioteca, ufrmProdutosE, ufrmProdutosTrelicaE;

procedure executa;
var
  loForm : TfrmProdutos;
begin
  loForm := TfrmProdutos.Create(Application);
  try
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;


{$R *.dfm}

procedure TfrmProdutos.actAlterarExecute(Sender: TObject);
var
  id: integer;
begin
  inherited;
  id := qry.fieldbyname('ID').AsInteger;

  ufrmProdutosE.Alterar(id);
  uBiblioteca.AtualizaQuery(qry);

  {volta pro registro}
  QRY.Locate('ID',id,[]);

end;

procedure TfrmProdutos.actExcluirExecute(Sender: TObject);
begin
  inherited;
  if not qry.IsEmpty then
  begin
    ufrmProdutosE.Excluir(qry.fieldbyname('ID').AsInteger);
    uBiblioteca.AtualizaQuery(qry);
  end;

end;

procedure TfrmProdutos.actIncluirExecute(Sender: TObject);
begin
  inherited;
  ufrmProdutosE.Incluir;
  uBiblioteca.AtualizaQuery(qry);

end;

procedure TfrmProdutos.actLocalizarExecute(Sender: TObject);
begin
  inherited;
  if ValidarPesquisa() then
    Pesquisar();

  // mensagem para o usuario
  StatusBar.Panels[0].Text := 'Encontrado(s) : ' + inttostr(qry.RecordCount) + ' registro(s)';

end;

procedure TfrmProdutos.ASql;
begin
  qry.Open('select * from ' + Self.Tabela + ' where REVENDA = ' + QuotedStr('S'));
  self.sSql := qry.SQL.Text;

end;

procedure TfrmProdutos.DBGrid1DblClick(Sender: TObject);
begin
  inherited;
  btnAlterar.Click;
end;

procedure TfrmProdutos.FormCreate(Sender: TObject);
begin
  inherited;
  // property tabela no form BaseGrade
  self.Tabela := 'PRODUTOS';
  self.Titulo := 'Cadastro de '+ self.Tabela + '[' + self.Tabela + ']';
  Caption := Titulo;
  ASql();

end;

procedure TfrmProdutos.Pesquisar;
var
  situacao, Condicao : string;
begin
  {Situação da pessoa}


  if rgSituacao.ItemIndex = 0 then
    situacao := 'ATIVO =' + QuotedStr('S') + ' and ';
  if rgSituacao.ItemIndex = 1 then
    situacao := 'ATIVO =' + QuotedStr('N') + ' and ';
  if rgSituacao.ItemIndex = 2 then
    situacao := 'ATIVO <>' + QuotedStr('') + ' and ';

  Condicao := '';


  if cbDescricao.Checked then
    if trim(edNome.Text) <> '' then
    Condicao := Condicao + 'and DESCRICAO like :DESCRICAO ';

  if Condicao <> '' then
  begin
    condicao := condicao + 'and REVENDA = :REVENDA ';

    Condicao := copy(Condicao,4,length(Condicao)-4);

    qry.SQL.Clear;
    qry.SQL.Add('select * from ' + self.Tabela + ' where ' + situacao + Condicao);
    self.ssql := qry.SQL.Text;

    {Carregar parametros}
    qry.Params.ParamByName('REVENDA').AsString  := 'S';

    if cbDescricao.Checked then
    begin
      qry.Params.ParamByName('DESCRICAO').AsString := '%' + edNome.Text + '%';
    end;

    qry.Open;
  end
  else
  begin
    qry.SQL.Clear;
    if rgSituacao.ItemIndex = 2 then // todos
    begin
      qry.SQL.Add('select * from '+ self.Tabela+ ' where REVENDA ='+ QuotedStr('S'));
      self.sSql := qry.SQL.Text;
    end
    else
    begin
      // retira o and final
      situacao := copy(situacao,1,length(situacao)-4);
      qry.SQL.Add('select * from '+ self.Tabela + ' where ' + situacao + ' and REVENDA ='+ QuotedStr('S'));
      self.sSql := qry.SQL.Text;
  end;
    //ShowMessage(qry.SQL.Text);
    qry.Open;
  end;


end;

function TfrmProdutos.ValidarPesquisa: boolean;
begin
   result := false;

   if (cbDescricao.Checked) and (edNome.Text = '') then
   begin
     ShowMessage('Infome um Nome');
     edNome.SetFocus;
     exit;
   end;

   result := true;
end;

end.
