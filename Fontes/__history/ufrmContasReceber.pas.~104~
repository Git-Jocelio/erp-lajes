
unit ufrmContasReceber;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseGrade, Data.DB,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,
  FireDAC.Stan.Async, FireDAC.DApt, System.Actions, Vcl.ActnList,
  System.ImageList, Vcl.ImgList, Vcl.Menus, FireDAC.Comp.DataSet,
  FireDAC.Comp.Client, Vcl.ComCtrls, Vcl.ToolWin, Vcl.Grids, Vcl.DBGrids,
  Vcl.StdCtrls, Vcl.Buttons, uBiblioteca, Vcl.ExtCtrls, UImpressao, Vcl.DBCtrls,
  ufrmContaReceberE, ufrmContasReceber_Baixa, uTipos, frxClass, frxDBSet;

type
  TfrmContasReceber = class(TfrmBaseGrade)
    actBaixar: TAction;
    PrintDialog1: TPrintDialog;
    pnl_rodape: TPanel;
    edQtdeRegistros: TEdit;
    edTotalAcum: TEdit;
    edTotalPago: TEdit;
    edTotalAberto: TEdit;
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    Label4: TLabel;
    rgOrdem: TRadioGroup;
    rgSituacaoPagto: TRadioGroup;
    gbEmissao: TGroupBox;
    Label7: TLabel;
    cbEmissao: TCheckBox;
    dtpEmissaoIni: TDateTimePicker;
    dtpEmissaoFim: TDateTimePicker;
    qryPessoas: TFDQuery;
    dsPessoas: TDataSource;
    gbPessoa: TGroupBox;
    cbPessoa: TCheckBox;
    cbxClientes: TDBLookupComboBox;
    GroupBox1: TGroupBox;
    cbxSituacao: TComboBox;
    gb_data_contabil: TGroupBox;
    Label5: TLabel;
    cb_data_contabil: TCheckBox;
    dtp_data_contabil_ini: TDateTimePicker;
    dtp_data_contabil_fim: TDateTimePicker;
    ToolButton1: TToolButton;
    gb_historico: TGroupBox;
    cb_historico: TCheckBox;
    edt_historico: TEdit;
    tbs_contas_receber_baixa: TTabSheet;
    pnl_dados_da_conta: TPanel;
    Label8: TLabel;
    Label9: TLabel;
    Label10: TLabel;
    Label11: TLabel;
    Label12: TLabel;
    Label13: TLabel;
    Label14: TLabel;
    Label15: TLabel;
    lbl_nr_documento: TLabel;
    lbl_cadastrado_em: TLabel;
    lbl_data_contabil: TLabel;
    lbl_nome_pessoa: TLabel;
    lbl_historico: TLabel;
    lbl_valor: TLabel;
    lbl_valor_pago: TLabel;
    lbl_valor_aberto: TLabel;
    ds_contas_receber_baixa: TDataSource;
    qry_contas_receber_baixa: TFDQuery;
    pnl_contas_receber_baixa: TPanel;
    DBGrid2: TDBGrid;
    Panel4: TPanel;
    btn_incluir_recebimento: TSpeedButton;
    btn_alterar_recebimento: TSpeedButton;
    qryID: TIntegerField;
    qryDATA_EMI: TDateField;
    qryDATA_CONTABIL: TDateField;
    qryNOME: TStringField;
    qryDESCRICAO: TStringField;
    qryTOTAL: TCurrencyField;
    qryVALOR_PAGO: TCurrencyField;
    qrySALDO_ABERTO: TCurrencyField;
    rel_contas_receber: TfrxReport;
    frxDBContasReceber: TfrxDBDataset;

    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure FormActivate(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);

    procedure actIncluirExecute(Sender: TObject);
    procedure actAlterarExecute(Sender: TObject);
    procedure actExcluirExecute(Sender: TObject);
    procedure actLocalizarExecute(Sender: TObject);
    procedure actPesquisarExecute(Sender: TObject);
    procedure actBaixarExecute(Sender: TObject);

    procedure dsDataChange(Sender: TObject; Field: TField);
    procedure ds_contas_receber_baixaDataChange(Sender: TObject; Field: TField);


    procedure tbs_contas_receber_baixaShow(Sender: TObject);
    procedure btn_alterar_recebimentoClick(Sender: TObject);
    procedure DBGrid1TitleClick(Column: TColumn);
    procedure actImprimirExecute(Sender: TObject);
    procedure rel_contas_receberBeforePrint(Sender: TfrxReportComponent);

  private
    function fnc_validar_pesquisa: boolean;

    procedure Totais;
    procedure controlaBotoes;
  protected

    procedure SQL(AQry : TFDQuery);
    procedure prc_pesquisar;

  public
    { Public declarations }

  end;

var
  frmContasReceber: TfrmContasReceber;
  conta_id: integer;
procedure prc_executa;

implementation

{$R *.dfm}

uses unit_principal, udmConn, unit_funcoes;

procedure prc_executa;
begin

  if frmContasReceber = nil then
  begin

    frmContasReceber := TfrmContasReceber.Create(Application);
  //  form_principal.prc_controla_menu(false);

    // se abrir dentro no painel principal não funciona os edites :(
    //loform.Parent := form_principal.pnl_principal;

    frmContasReceber.top    :=  form_principal.pnl_Principal.Top;
    frmContasReceber.Left   := form_principal.pnl_menulateral.Width;

    frmContasReceber.Width  := form_principal.pnl_principal.Width;
    frmContasReceber.Height := form_principal.pnl_principal.Height;

  end;
  frmContasReceber.Showmodal;

end;

procedure TfrmContasReceber.actAlterarExecute(Sender: TObject);
begin
  inherited;
  ufrmContaReceberE.Alterar(qry.fieldbyname('ID').AsInteger);
  uBiblioteca.AtualizaQuery(qry);

  //ajustas as colunas do dbgrid
  prc_ajustar_colunas_grid( DBGrid1 );

  //aumenta o tamanho da linha do ddgrid
  prc_ajusta_tamanho_linha( DBGrid1 );


end;

procedure TfrmContasReceber.actBaixarExecute(Sender: TObject);

begin
  inherited;
  ufrmContasReceber_Baixa.executa(utipos.OpIncluir,
                                  -1,                               // conta_receber_baixa_id
                                  date,                             // cadastrado em
                                  qry.FieldByName('ID').AsInteger,  // id conta receber
                                  qry.FieldByName('NOME').AsString, // pessoa
                                  '',                               // histórico
                                  0,                                // saldo aberto
                                  strtofloatdef(lbl_valor_aberto.Caption,0) // valor que esta sendo pago );
                                  );
  {atualiza a qry}

  qry_contas_receber_baixa.close;
  qry_contas_receber_baixa.ParamByName('CONTAS_RECEBER_ID').AsInteger := conta_id;
  qry_contas_receber_baixa.OPEN;

  {atualiza o panel rodapé}
  Totais;
  //


 // tbs_contas_receber_baixaShow(sender);
  // volta pro registro
  qry.First;
  qry.Locate('ID',conta_id,[]);


  //ajustas as colunas do dbgrid
  prc_ajustar_colunas_grid( DBGrid1 );

  //aumenta o tamanho da linha do ddgrid
  prc_ajusta_tamanho_linha( DBGrid1 );

end;

procedure TfrmContasReceber.actExcluirExecute(Sender: TObject);
begin
  inherited;
  if not qry.IsEmpty then
  begin
    ufrmContaReceberE.Excluir(qry.fieldbyname('ID').AsInteger);
    uBiblioteca.AtualizaQuery(qry);
  end;

  //ajustas as colunas do dbgrid
  prc_ajustar_colunas_grid( DBGrid1 );

  //aumenta o tamanho da linha do ddgrid
  prc_ajusta_tamanho_linha( DBGrid1 );


end;

procedure TfrmContasReceber.actImprimirExecute(Sender: TObject);
begin
  inherited;
  if not qry.IsEmpty then
    rel_contas_receber.ShowReport;

end;

procedure TfrmContasReceber.actIncluirExecute(Sender: TObject);
begin

  inherited;
  ufrmContaReceberE.Incluir(-1);
  SQL(qry);
  uBiblioteca.AtualizaQuery(qry);
  Totais;

  //ajustas as colunas do dbgrid
  prc_ajustar_colunas_grid( DBGrid1 );

  //aumenta o tamanho da linha do ddgrid
  prc_ajusta_tamanho_linha( DBGrid1 );


 end;

procedure TfrmContasReceber.actLocalizarExecute(Sender: TObject);
begin
  inherited;

  if fnc_validar_pesquisa then
  begin
    prc_pesquisar;
    Totais();
  end;

  //ajustas as colunas do dbgrid
  prc_ajustar_colunas_grid( DBGrid1 );

  //aumenta o tamanho da linha do ddgrid
  prc_ajusta_tamanho_linha( DBGrid1 );


  // mensagem para o usuario
  StatusBar.Panels[0].Text := 'Encontrado(s) : ' + inttostr(qry.RecordCount) + ' registro(s)';

end;



procedure TfrmContasReceber.actPesquisarExecute(Sender: TObject);
begin
  //inherited;
  if btnPesquisar.Caption = 'Pesquisa >>' then
  begin
    btnPesquisar.Caption    := '<< Ocultar';
    GroupBoxPesquisa.Height := 161;
  end
  else
   begin
     btnPesquisar.Caption    := 'Pesquisa >>';
     GroupBoxPesquisa.Height := 0;
   end;

end;

procedure TfrmContasReceber.btn_alterar_recebimentoClick(Sender: TObject);
begin
  inherited;

  ufrmContasReceber_Baixa.executa(
                          utipos.opAlterar,                 // operação
                          qry_contas_receber_baixa.FieldByName('ID').AsInteger, // conta_receber_baixa_id
                          qry_contas_receber_baixa.FieldByName('CADASTRADO_EM').AsDateTime, // cadastrado em
                          qry.FieldByName('ID').AsInteger,  // id conta receber
                          qry.FieldByName('NOME').AsString, // pessoa
                          qry_contas_receber_baixa.FieldByName('historico').AsString, // histórico
                          //strtofloatdef(lbl_valor_aberto.Caption,0),
                          qry_contas_receber_baixa.FieldByName('valor').AsFloat, // vr que esta sendo pago
                          strtofloatdef(lbl_valor_aberto.Caption,0));            // saldo aberto

  {atualiza o panel rodapé}
  Totais;
  //
  tbs_contas_receber_baixaShow(sender);



end;

function TfrmContasReceber.fnc_validar_pesquisa: boolean;
begin

  result := false;
  if cbPessoa.Checked then
    if cbxClientes.Text = '' then
    begin
      criarmensagem('AVISO','INFORME UMA PESSOA');
      cbxClientes.SetFocus;
      exit;
    end;

  if ((rgOrdem.ItemIndex = 0) and (cbxSituacao.Text = '')) then
  begin
    criarmensagem('AVISO','INFORME A SITUAÇÃO DO PEDIDO');
    cbxSituacao.SetFocus;
    exit;
  end;
  (*
  if cbValor.Checked then
  begin
    if StrToFloatDef(edValor1.Text,0) < 0 then
    begin
      ShowMessage('Informe um valor válido');
      edValor1.SetFocus;
      exit;
    end;

    if StrToFloatDef(edValor2.Text,0) < 0 then
    begin
      ShowMessage('Informe um valor válido');
      edValor2.SetFocus;
      exit;
    end;
  end;
  *)
  if cbEmissao.Checked then
  begin
    if dtpEmissaoFim.date < dtpEmissaoIni.Date then
    begin
      criarmensagem('AVISO','INFORME UM PERIODO VÁLIDO.');
      dtpEmissaofim.SetFocus;
      exit;
    end;
  end;

  if cb_data_contabil.Checked then
  begin
    if dtp_data_contabil_fim.date < dtp_data_contabil_ini.Date then
    begin
      criarmensagem('AVISO','INFORME UM PERIODO CONTÁBIL VÁLIDO.');
      dtp_data_contabil_fim.SetFocus;
      exit;
    end;
  end;

  if cb_historico.Checked then
  begin
    if edt_historico.Text = '' then
    begin
      criarmensagem('AVISO','INFORME UM TEXTO PARA A PESQUISA.');
      edt_historico.SetFocus;
      exit;
    end;
  end;


  result := true;
//  prc_Pesquisar;
//  Totais();
end;

procedure TfrmContasReceber.FormActivate(Sender: TObject);
begin
  inherited;
  totais;
end;

procedure TfrmContasReceber.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
  inherited;

  // libera o formulario da memória
//  form_principal.prc_controla_menu(true);
//  FreeAndNil(frmContasReceber);

 // ShowMessage('form liberado')

end;

procedure TfrmContasReceber.FormCreate(Sender: TObject);
begin
  // não vou usar a pesquisa no frmBaseGrade(não usar o inherited)

  //inherited;
  // então vou ter que trazer a conexao do frmBase pra ca

  Conexao        := dmConn.FDConnection;
  qry.Connection := self.Conexao;


  // property tabela no form BaseGrade
  self.Tabela := 'CONTAS_RECEBER';

  qryPessoas.Connection := self.Conexao;
  qryPessoas.Close;
  qryPessoas.SQL.Clear;
  qryPessoas.SQL.Add('select * from pessoas where ativo = ' + QuotedStr('S') + ' order by nome');

  PageControl1.ActivePage := TabSheet1;
  qry_contas_receber_baixa.Connection := self.Conexao;
  qry_contas_receber_baixa.Close;
  qry_contas_receber_baixa.SQL.Clear;
  qry_contas_receber_baixa.SQL.Add('select * from CONTAS_RECEBER_BAIXA where CONTAS_RECEBER_ID = :CONTAS_RECEBER_ID');
  SQL(qry);

  edt_consulta.Visible := false;
end;

procedure TfrmContasReceber.FormShow(Sender: TObject);
begin
  inherited;
  qryPessoas.open;

  // Abertura padrão
  GroupBoxPesquisa.Height    := 0;
  rgSituacaoPagto.ItemIndex  := 1;

  dtpEmissaoIni.Date         := date;
  dtpEmissaoFim.Date         := date;

  dtp_data_contabil_ini.Date := date;
  dtp_data_contabil_fim.Date := date;

end;

procedure TfrmContasReceber.Totais;
var
 acumulado : double;
 TotPago : double;
begin
  if qry.IsEmpty then
  begin
    edQtdeRegistros.Text := '0';
    edTotalAcum.Text     := '0.00';
    edTotalPago.Text     := '0.00';
    edTotalAberto.Text   := '0.00';
    exit;
  end;

  acumulado := 0;
  TotPago   := 0;

  ds.DataSet.DisableControls;
  {atualiza a qry}
  qry.Close; qry.Open;
  qry.First;
  while not qry.Eof do
  begin
    acumulado := acumulado + qry.fieldbyname('TOTAL').AsFloat;
    TotPago   := TotPago + qry.fieldbyname('VALOR_PAGO').AsFloat;
    qry.Next;
  end;
  //
  edQtdeRegistros.Text := inttostr(qry.RecordCount);
  edTotalAcum.Text     := FormatCurr('0.00',acumulado);
  edTotalPago.Text     := FormatCurr('0.00',TotPago);
  edTotalAberto.Text   := FormatCurr('0.00',acumulado - TotPago);

  ds.DataSet.EnableControls;

end;




procedure TfrmContasReceber.dsDataChange(Sender: TObject; Field: TField);
begin
  inherited;
  controlaBotoes;
end;


procedure TfrmContasReceber.ds_contas_receber_baixaDataChange(Sender: TObject;
  Field: TField);
begin
  inherited;
  btn_alterar_recebimento.Enabled := not qry_contas_receber_baixa.IsEmpty;
  //btn_excluir_recebimento.Enabled := not qry_contas_receber_baixa.IsEmpty;
//  btn_incluir_recebimento.Enabled := not (strtofloat(lbl_valor_aberto.Caption) > 0);
end;

procedure TfrmContasReceber.controlaBotoes;
begin
  btnalterar.Enabled  := not qry.IsEmpty;
  btnexcluir.Enabled  := not qry.IsEmpty;
  btnImprimir.Enabled := not qry.IsEmpty;
  tbs_contas_receber_baixa.TabVisible := not qry.IsEmpty;

end;

procedure TfrmContasReceber.DBGrid1TitleClick(Column: TColumn);
begin
 // não usarei a herança do formBAse padrao
 // inherited;

 prc_ordenar_dgrid( ds, DBGrid1, column ) ;

end;

procedure TfrmContasReceber.SQL(AQry: TFDQuery);
begin

  AQry.SQL.Clear;
  AQry.SQL.Add('select             ');
  //AQry.SQL.Add(' CR.ID, PS.ID, PS.NOME, CR.DATA_EMI, CR.DATA_VENC, CR.DESCRICAO, P.ID AS NUMERO, CR.TOTAL, CR.VALOR_PAGO, CR.SALDO_ABERTO, CR.MARCA, CR.PAGO ');
  AQry.SQL.Add('  CR.ID,           ');
  AQry.SQL.Add('  PS.ID,           ');
  AQry.SQL.Add('  PS.NOME,         ');
  AQry.SQL.Add('  CR.DATA_EMI,     ');
  AQry.SQL.Add('  CR.DATA_CONTABIL,');
  AQry.SQL.Add('  CR.DATA_VENC,    ');
  AQry.SQL.Add('  CR.DESCRICAO,    ');
  AQry.SQL.Add('  P.ID AS NUMERO,  ');
  AQry.SQL.Add('  CR.TOTAL,        ');
  AQry.SQL.Add('  CR.VALOR_PAGO,   ');
  AQry.SQL.Add('  CR.SALDO_ABERTO, ');
  AQry.SQL.Add('  CR.MARCA,        ');
  AQry.SQL.Add('  CR.PAGO         ');
  AQry.SQL.Add('from ');
  AQry.SQL.Add('  CONTAS_RECEBER CR, PEDIDOS P, PESSOAS PS ');
  AQry.SQL.Add('where                                      ');
  AQry.SQL.Add(' CR.PESSOA_ID = PS.ID and                  ');
  AQry.SQL.Add(' CR.PAGO = ' + QuotedStr('N') + ' and      ');
  AQry.SQL.Add(' P.ID = CR.ID_ORIGEM and                   ');
  AQry.SQL.Add(' CR.TABELA_ORIGEM = ' + QuotedStr('PEDIDOS') + ' and');
  AQry.SQL.Add(' P.SITUACAO = :SITUACAO and                ');
  AQry.SQL.Add(' CR.PESSOA_ID = :PESSOA                    ');

  //ShowMessage(AQry.SQL.Text);
  AQry.Open;

end;


procedure TfrmContasReceber.tbs_contas_receber_baixaShow(Sender: TObject);
var
  vr_pago: double;
begin
  inherited;
  conta_id := qry.FieldByName('ID').Asinteger;

  {preeenche cabeçalho}
  lbl_nr_documento.Caption  := qry.FieldByName('ID').AsString;
  lbl_cadastrado_em.Caption := qry.FieldByName('DATA_EMI').AsString;
  lbl_data_contabil.Caption := qry.FieldByName('DATA_CONTABIL').AsString;
  lbl_nome_pessoa.Caption   := qry.FieldByName('NOME').AsString;
  lbl_historico.Caption     := qry.FieldByName('DESCRICAO').AsString;
  lbl_valor.Caption         := formatfloat ('0.00', qry.FieldByName('TOTAL').AsFloat);

  {busca recebimentos, se houver}
  uBiblioteca.FilterCds(qry_contas_receber_baixa, utipos.fsInteger, qry.FieldByName('ID').AsString);
  if qry.IsEmpty then
  begin
    criarmensagem('AVISO','NENHUM RECEBIMENTO ENCONTRADO.');
  end;

  {calcular valor pago}
  vr_pago := 0;
  qry_contas_receber_baixa.First;
  while not qry_contas_receber_baixa.eof do
  begin
    vr_pago := vr_pago + qry_contas_receber_baixa.FieldByName('VALOR').AsFloat;
    qry_contas_receber_baixa.Next;
  end;

  {carrega os labels}
  lbl_valor_pago.Caption    := formatfloat ('0.00',  vr_pago);
  lbl_valor_aberto.Caption  := formatfloat ('0.00', qry.FieldByName('TOTAL').AsFloat - vr_pago);
  //
  btn_incluir_recebimento.Enabled := strtofloat(lbl_valor_aberto.Caption) > 0;


end;

procedure TfrmContaSReceber.prc_pesquisar;
var
  sql : string;
  pago: string;

begin
   sql  := '';
   pago := uBiblioteca.SeSenao(rgSituacaoPagto.ItemIndex = 0, 'S','N');


   {Dependendo do tipo de filtro selecionado a instrução sql muda...}
   {Pedidos}
   if rgOrdem.ItemIndex = 0 then
   begin
     {instrução sql só para pedidos}

     // só passa os parametros se for para uma situação especicica

     if cbxSituacao.Text <> 'ENTREGUE E RETIROU' then
      if rgSituacaoPagto.ItemIndex <> 2 then
        sql := 'select CR.*, PS.ID AS PS_ID, PS.NOME, P.ID AS NUMERO from CONTAS_RECEBER CR, PEDIDOS P, PESSOAS PS where CR.PESSOA_ID = PS.ID and CR.PAGO = ' + QuotedStr(pago) + ' and P.ID = CR.ID_ORIGEM and CR.TABELA_ORIGEM = ' + QuotedStr('PEDIDOS') + ' and P.SITUACAO=:SITUACAO'
      else
        sql := 'select CR.*, PS.ID AS PS_ID, PS.NOME, P.ID AS NUMERO from CONTAS_RECEBER CR, PEDIDOS P, PESSOAS PS where CR.PESSOA_ID = PS.ID and CR.PAGO <> ' + QuotedStr('') + ' and P.ID = CR.ID_ORIGEM and CR.TABELA_ORIGEM = ' + QuotedStr('PEDIDOS') + ' and P.SITUACAO=:SITUACAO'
     else//= ENTREGUE ou RETIROU
     if rgSituacaoPagto.ItemIndex <> 2 then
       sql := 'select CR.*, PS.ID AS PS_ID, PS.NOME, P.ID AS NUMERO from CONTAS_RECEBER CR, PEDIDOS P, PESSOAS PS where CR.PESSOA_ID = PS.ID and CR.PAGO = ' + QuotedStr(pago) + ' and P.ID = CR.ID_ORIGEM and CR.TABELA_ORIGEM = ' + QuotedStr('PEDIDOS') + ' and ( P.SITUACAO = ' + QuotedStr('ENTREGUE') + ' or P.SITUACAO = ' + QuotedStr('RETIROU') + ')'
     else
       sql := 'select CR.*, PS.ID AS PS_ID, PS.NOME, P.ID AS NUMERO from CONTAS_RECEBER CR, PEDIDOS P, PESSOAS PS where CR.PESSOA_ID = PS.ID and CR.PAGO <> ' + QuotedStr('') + ' and P.ID = CR.ID_ORIGEM and CR.TABELA_ORIGEM = ' + QuotedStr('PEDIDOS') + ' and ( P.SITUACAO = ' + QuotedStr('ENTREGUE') + ' or P.SITUACAO = ' + QuotedStr('RETIROU') + ')';

     if cbPessoa.Checked then
       sql := sql + ' and CR.PESSOA_ID = :PESSOA';
   end;

   {Lançamentos avulsos}
   if rgOrdem.ItemIndex = 1 then
   begin
     {instrução sql só para contas diferente de pedidos}

     if rgSituacaoPagto.ItemIndex <> 2 then
     begin
       sql := 'select CR.ID,PS.ID AS PS_ID,PS.NOME,CR.DATA_EMI,CR.DATA_CONTABIL,CR.DESCRICAO,CR.TABELA_ORIGEM,CR.ID_ORIGEM AS NUMERO,CR.TOTAL,CR.VALOR_PAGO,CR.SALDO_ABERTO,CR.PAGO,CR.MARCA';
       sql := sql + ' from CONTAS_RECEBER CR, PESSOAS PS where CR.PESSOA_ID = PS.ID and PAGO = ' + QuotedStr(pago) + ' and TABELA_ORIGEM = ' + QuotedStr('CONTAS_RECEBER');
     end
     else
     begin
       sql := 'select CR.ID,PS.ID AS PS_ID,PS.NOME,CR.DATA_EMI,CR.DATA_CONTABIL,CR.DESCRICAO,CR.TABELA_ORIGEM,CR.ID_ORIGEM AS NUMERO,CR.TOTAL,CR.VALOR_PAGO,CR.SALDO_ABERTO,CR.PAGO,CR.MARCA';
       sql := sql + ' from CONTAS_RECEBER CR, PESSOAS PS where CR.PESSOA_ID = PS.ID and PAGO <> ' + QuotedStr('') + ' and TABELA_ORIGEM = ' + QuotedStr('CONTAS_RECEBER');
     end;

     if cbPessoa.Checked then
       sql := sql + ' and PESSOA_ID = :PESSOA';
   end;

   {todos}
   if rgOrdem.ItemIndex = 2 then
   begin
     {instrução sql geral}
     if rgSituacaoPagto.ItemIndex <> 2 then
     begin
       sql := 'select CR.ID, PS.ID AS PS_ID, PS.NOME, CR.DATA_EMI, CR.DATA_CONTABIL, CR.DESCRICAO, CR.TABELA_ORIGEM, CR.ID_ORIGEM AS NUMERO, CR.TOTAL, CR.VALOR_PAGO, CR.SALDO_ABERTO, CR.PAGO, CR.MARCA' ;
       sql := sql + ' from CONTAS_RECEBER CR, PESSOAS PS where CR.PESSOA_ID = PS.ID and PAGO = ' + QuotedStr(pago);
     end
     else
     begin
       sql := 'select CR.ID, PS.ID AS PS_ID, PS.NOME, CR.DATA_EMI, CR.DATA_CONTABIL, CR.DESCRICAO, CR.TABELA_ORIGEM, CR.ID_ORIGEM AS NUMERO, CR.TOTAL, CR.VALOR_PAGO, CR.SALDO_ABERTO, CR.PAGO, CR.MARCA' ;
       sql := sql + ' from CONTAS_RECEBER CR, PESSOAS PS where CR.PESSOA_ID = PS.ID and PAGO <> ' + QuotedStr('');
     end;
     if cbPessoa.Checked then
       sql := sql + ' and PESSOA_ID = :PESSOA';
   end;

   {Vales em dinheiro}
   if rgOrdem.ItemIndex = 3 then
   begin
     {instrução sql só para vale em dinheiro}
     if rgSituacaoPagto.ItemIndex <> 2 then
     begin
       sql := 'select CR.ID, PS.ID AS PS_ID, PS.NOME, CR.DATA_EMI, CR.DATA_CONTABIL,CR.DESCRICAO, CR.TABELA_ORIGEM, CR.ID_ORIGEM AS NUMERO, CR.TOTAL, CR.VALOR_PAGO, CR.SALDO_ABERTO, CR.PAGO, CR.MARCA ';
       sql := sql + ' from CONTAS_RECEBER CR, PESSOAS PS where CR.PESSOA_ID = PS.ID and CR.PAGO = ' + QuotedStr(pago) + ' and TABELA_ORIGEM = ' + QuotedStr('SAIDA_DINHEIRO');
     end
     else
     begin
       sql := 'select CR.ID, PS.ID AS PS_ID, PS.NOME, CR.DATA_EMI, CR.DATA_CONTABIL,CR.DESCRICAO, CR.TABELA_ORIGEM, CR.ID_ORIGEM AS NUMERO, CR.TOTAL, CR.VALOR_PAGO, CR.SALDO_ABERTO, CR.PAGO, CR.MARCA ';
       sql := sql + ' from CONTAS_RECEBER CR, PESSOAS PS where CR.PESSOA_ID = PS.ID and CR.PAGO <> ' + QuotedStr('') + ' and TABELA_ORIGEM = ' + QuotedStr('SAIDA_DINHEIRO');
     end;


     if cbPessoa.Checked then
       sql := sql + ' and PESSOA_ID = :PESSOA';
   end;


   if cbEmissao.Checked then
     sql := sql + ' and DATA_EMI between :dtEmissaoIni and :dtEmissaoFim';

   if cb_data_contabil.Checked then
     sql := sql + ' and DATA_CONTABIL between :dtContabilIni and :dtContabilFim';

   if cb_historico.Checked then
   begin
     sql := sql + ' and DESCRICAO like :DESCRICAO' ;
   end;

   sSql := sql;

   qry.Close;
   qry.SQL.Clear;

   qry.SQL.Add(sql);
  // ShowMessage(qryDados.SQL.Text);
   if (rgOrdem.ItemIndex = 0) then
   begin
     // só passa os parametros se for para uma situação especicica
     if cbxSituacao.Text <> 'ENTREGUE E RETIROU' then
     begin
       qry.Params[0].DataType := ftString;
       qry.ParamByName('SITUACAO').AsString := cbxSituacao.Text;
     end;

     if cbPessoa.Checked then
     begin
       qry.ParamByName('PESSOA').AsInteger := cbxClientes.KeyValue;
     end;
   end
   else
   begin
     if cbPessoa.Checked then
     begin
       qry.Params[0].DataType := ftInteger;
       qry.ParamByName('PESSOA').AsInteger := cbxClientes.KeyValue;
     end;
   end;

   if cbEmissao.Checked then
   begin
     qry.Params.ParamByName('dtEmissaoIni').AsDate := dtpEmissaoIni.Date;
     qry.Params.ParamByName('dtEmissaoFim').AsDate := dtpEmissaoFim.Date;
   end;

   if cb_data_contabil.Checked then
   begin
     qry.Params.ParamByName('dtContabilIni').AsDate := dtp_data_contabil_ini.Date;
     qry.Params.ParamByName('dtContabilFim').AsDate := dtp_data_contabil_fim.Date;
   end;

   if cb_historico.Checked then
   begin
     qry.Params.ParamByName('DESCRICAO').AsString := '%' + edt_historico.Text + '%';
   end;


   qry.Open;


   if qry.IsEmpty then
   begin
     criarmensagem('AVISO','NÃO FOI ENCONTRADO NENHUMA CONTA DA PESSOA : "' + cbxClientes.Text + '"');
     cbxClientes.SetFocus;
     exit;
   end
   else
   begin
    //
   end;


end;



procedure TfrmContasReceber.rel_contas_receberBeforePrint(
  Sender: TfrxReportComponent);
var
  MemoView: TFrxMemoView;
  TextValue: string;
begin
  if cbPessoa.Checked = false then
  {selecionou NENHUMA pessoa}
  begin
    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_titulo_relatorio') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Text := 'RELATÓRIO DE CONTAS A RECEBER - GERAL';
      MemoView.Visible := true;
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_pessoa_titulo') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Text := 'PESSOA : TODOS';
      MemoView.Visible := true;
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_pessoa') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Visible := true;
      MemoView.Left := 0
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_coluna_pessoa') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Visible := true;
      MemoView.Left := 0
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_emissao') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Left := 4.70*37.83;
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_coluna_emissao') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Left := 4.70*37.83;
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_descricao') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Left := 6.85*37.83;
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_coluna_descricao') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Left := 6.85*37.83;
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_total') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Left := 13.14*37.83;
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_coluna_total') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Left := 12.40*37.83;
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_valor_pago') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Left := 15.05*37.83;
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_coluna_valor_pago') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Left := 14.12*37.83;
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_saldo_aberto') as TFrxMemoView;
    if MemoView <> nil then
    begin                 //630
      MemoView.Left := 16.68*37.83;
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_coluna_saldo_aberto') as TFrxMemoView;
    if MemoView <> nil then
    begin                 //630
      MemoView.Left := 16.65*37.83;
    end;

  end else
  if cbPessoa.Checked = true then
  begin
    {SELECIONOU UMA PESSOA}
    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_titulo_relatorio') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Text := 'RELATÓRIO DE CONTAS A RECEBER - POR PESSOA';
      MemoView.Visible := true;
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_pessoa_titulo') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Text := 'PESSOA :';
      MemoView.Visible := true;
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_pessoa') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Visible := FALSE;
      MemoView.Left := 0
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_coluna_pessoa') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Visible := FALSE;
      MemoView.Left := 0
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_emissao') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Left := 4.70*37.83;
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_coluna_emissao') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Left := 4.70*37.83;
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_descricao') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Left := 6.85*37.83;
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_coluna_descricao') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Left := 6.85*37.83;
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_total') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Left := 13.14*37.83;
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_coluna_total') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Left := 12.40*37.83;
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_valor_pago') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Left := 15.05*37.83;
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_coluna_valor_pago') as TFrxMemoView;
    if MemoView <> nil then
    begin
      MemoView.Left := 14.12*37.83;
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_saldo_aberto') as TFrxMemoView;
    if MemoView <> nil then
    begin                 //630
      MemoView.Left := 16.68*37.83;
    end;

    // Encontra o componente TFrxMemoView no relatório
    MemoView := rel_contas_receber.FindObject('lbl_coluna_saldo_aberto') as TFrxMemoView;
    if MemoView <> nil then
    begin                 //630
      MemoView.Left := 16.65*37.83;
    end;

  end;
end;



end.
