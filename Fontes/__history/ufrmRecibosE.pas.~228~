unit ufrmRecibosE;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseEdicao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.ExtCtrls, Vcl.DBCtrls, Vcl.ComCtrls, uTipos, Vcl.Grids, Vcl.DBGrids,
  udmConn, Vcl.Mask, uBiblioteca, ufrmChequesClientesE, ufrmCartaoVendasE,
  ufrmPesquisaContas, unit_funcoes, ufrmRecibosAterarValorConta, uFinanceiro;

type
  TfrmRecibosE = class(TfrmBaseEdicao)
    pnl_totais: TPanel;
    Label1: TLabel;
    pnl_topo: TPanel;
    Label3: TLabel;
    cbx_pessoa: TDBLookupComboBox;
    pnl_page_controls: TPanel;
    gbx_debitos_clientes: TGroupBox;
    gbx_creditos_clientes: TGroupBox;
    PageControlCreditos: TPageControl;
    PageControl2: TPageControl;
    tbs_dinheiro: TTabSheet;
    tbs_pix: TTabSheet;
    tbs_cheque: TTabSheet;
    tbs_cartao_credito: TTabSheet;
    tbs_contas_pagar: TTabSheet;
    pnl_botoes_debitos: TPanel;
    btn_incluir_conta_receber: TSpeedButton;
    btn_alterar_valor_debito: TSpeedButton;
    btn_excluir_conta_receber: TSpeedButton;
    Label4: TLabel;
    pnl_dinheiro: TPanel;
    Label5: TLabel;
    pnl_pix: TPanel;
    Label6: TLabel;
    pnl_cheques: TPanel;
    Label7: TLabel;
    pnl_cartao_credito: TPanel;
    Label8: TLabel;
    pnl_contas_pagar: TPanel;
    Label10: TLabel;
    pnl_total_creditos: TPanel;
    Label11: TLabel;
    pnl_contas_receber: TPanel;
    Label12: TLabel;
    pnl_saldo: TPanel;
    dbg_debitos_cliente: TDBGrid;
    pnl_entrada_dinheiro: TPanel;
    pnl_entrada_pix: TPanel;
    Label15: TLabel;
    Label16: TLabel;
    edt_valor_pix: TEdit;
    edt_obs_pix: TEdit;
    cbx_conta_bancaria: TDBLookupComboBox;
    pnl_entrada_cheque: TPanel;
    pnl_botoes_cheque: TPanel;
    btn_incluir_cheque: TSpeedButton;
    btn_excluir_cheque: TSpeedButton;
    dbg_cheques: TDBGrid;
    pnl_entrada_cartao: TPanel;
    pnl_botoes_cartao: TPanel;
    btn_incluir_cartao: TSpeedButton;
    btn_excluir_cartao: TSpeedButton;
    dbg_cartao: TDBGrid;
    pnl_incluir_conta_pagar: TPanel;
    pnl_botoes_contas_pagar: TPanel;
    btn_incluir_conta_pagar: TSpeedButton;
    btn_excluir_conta_pagar: TSpeedButton;
    dbg_contas_pagar: TDBGrid;
    qry_bancos: TFDQuery;
    ds_bancos: TDataSource;
    Label20: TLabel;
    cbx_bancos: TDBLookupComboBox;
    edt_cod_Banco: TDBEdit;
    ds_contas_bancarias: TDataSource;
    qry_contas_bancarias: TFDQuery;
    DBEdit1: TDBEdit;
    mtb_cheque_cliente: TFDMemTable;
    mtb_cheque_clienteID: TIntegerField;
    mtb_cheque_clienteCADASTRADO_EM: TDateField;
    mtb_cheque_clienteNR_CHEQUE: TStringField;
    mtb_cheque_clienteCORRENTISTA_CONTA_ID: TIntegerField;
    mtb_cheque_clientePRE_DATADO_PARA: TDateField;
    mtb_cheque_clienteVALOR: TFloatField;
    mtb_cheque_clienteREPASSADO: TStringField;
    mtb_cheque_clienteRECIBO_ID: TIntegerField;
    mtb_cheque_clienteHISTORICO: TStringField;
    mtb_cheque_clienteAGENCIA: TStringField;
    mtb_cheque_clienteCONTA: TStringField;
    ds_cheque_cliente: TDataSource;
    mtb_cheque_clienteBANCO: TStringField;
    mtb_cheque_clienteTOTAL: TAggregateField;
    mtb_cartao: TFDMemTable;
    ds_cartao: TDataSource;
    mtb_cartaoID: TIntegerField;
    mtb_cartaoCADASTRADO_EM: TDateField;
    mtb_cartaoALTERADO_EM: TDateField;
    mtb_cartaoDATA_VENDA: TDateField;
    mtb_cartaoCARTAO_OPERADORA_ID: TIntegerField;
    mtb_cartaoCARTAO_MAQUINA_ID: TIntegerField;
    mtb_cartaoCARTAO_BANDEIRA_ID: TIntegerField;
    mtb_cartaoCARTAO_FORMA_PAGTO_ID: TIntegerField;
    mtb_cartaoTAXA: TFloatField;
    mtb_cartaoVALOR_VENDA: TFloatField;
    mtb_cartaoVALOR_LIQUIDO: TFloatField;
    mtb_cartaoCV: TStringField;
    mtb_cartaoNM_OEPRADORA: TStringField;
    mtb_cartaoNM_BANDEIRA: TStringField;
    mtb_cartaoQTDE_PARCELAS: TIntegerField;
    mtb_cartaoTOTAL: TAggregateField;
    mtb_conta_pagar: TFDMemTable;
    ds_contas_pagar: TDataSource;
    mtb_conta_pagarID: TIntegerField;
    mtb_conta_pagarNR_DOCUMENTO: TStringField;
    mtb_conta_pagarDESCRICAO: TStringField;
    mtb_conta_pagarTOTAL_PARCELA: TFloatField;
    mtb_conta_pagarVALOR_PAGO: TFloatField;
    mtb_conta_pagarTOTAL: TAggregateField;
    btn_fechar: TSpeedButton;
    mtb_conta_receber: TFDMemTable;
    ds_conta_receber: TDataSource;
    mtb_conta_receberID: TIntegerField;
    mtb_conta_receberNR_DOCUMENTO: TStringField;
    mtb_conta_receberDESCRICAO: TStringField;
    mtb_conta_receberTOTAL_PARCELA: TFloatField;
    mtb_conta_receberVALOR_PAGO: TFloatField;
    mtb_conta_receberBAIXAR: TFloatField;
    Splitter1: TSplitter;
    btn_alterar_valor_credito: TSpeedButton;
    Label17: TLabel;
    edt_observacoes: TEdit;
    mtb_conta_pagarBAIXAR: TFloatField;
    mtb_cartaoTAXA_ID: TIntegerField;
    Label18: TLabel;
    lbl_emissao: TLabel;
    mtb_cartaoPROPRIETARIO_ID: TIntegerField;
    mtb_conta_receberTABELA_ORIGEM: TStringField;
    pnl_botoes_dinheiro: TPanel;
    btn_incluir_dinheiro: TSpeedButton;
    btn_excluir_dinheiro: TSpeedButton;
    dbg_dinheiro: TDBGrid;
    gbx_entrada_dinheiro: TGroupBox;
    edt_obs_dinheiro: TEdit;
    edt_valor_dinheiro: TEdit;
    Label13: TLabel;
    Label14: TLabel;
    btn_dinheiro_confirma: TBitBtn;
    btn_dinheiro_cancela: TBitBtn;
    mtb_dinheiro: TFDMemTable;
    mtb_dinheiroID: TIntegerField;
    mtb_dinheiroRECIBO_ID: TIntegerField;
    mtb_dinheiroVALOR: TFloatField;
    mtb_dinheiroOBSERVACAO: TStringField;
    ds_dinheiro: TDataSource;
    mtb_dinheiroTOTAL: TAggregateField;
    Label2: TLabel;
    lbl_nr_recibo: TLabel;

    procedure cbx_bancosCloseUp(Sender: TObject);
    procedure edt_valor_dinheiroKeyPress(Sender: TObject; var Key: Char);
    procedure edt_valor_dinheiroExit(Sender: TObject);
    procedure edt_valor_pixKeyPress(Sender: TObject; var Key: Char);
    procedure edt_valor_pixExit(Sender: TObject);

    procedure btn_incluir_chequeClick(Sender: TObject);
    procedure btn_incluir_cartaoClick(Sender: TObject);
    procedure btn_incluir_conta_pagarClick(Sender: TObject);
    procedure btn_fecharClick(Sender: TObject);
    procedure btn_incluir_conta_receberClick(Sender: TObject);
    procedure cbx_pessoaCloseUp(Sender: TObject);
    procedure btn_excluir_conta_receberClick(Sender: TObject);
    procedure ds_conta_receberDataChange(Sender: TObject; Field: TField);
    procedure ds_contas_pagarDataChange(Sender: TObject; Field: TField);
    procedure btn_excluir_conta_pagarClick(Sender: TObject);
    procedure btn_alterar_valor_debitoClick(Sender: TObject);
    procedure btn_alterar_valor_creditoClick(Sender: TObject);
    procedure btnOkClick(Sender: TObject);

    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);

    procedure ds_cartaoDataChange(Sender: TObject; Field: TField);
    procedure ds_cheque_clienteDataChange(Sender: TObject; Field: TField);
    procedure btn_excluir_cartaoClick(Sender: TObject);
    procedure btn_excluir_chequeClick(Sender: TObject);
    procedure btn_incluir_dinheiroClick(Sender: TObject);
    procedure btn_dinheiro_cancelaClick(Sender: TObject);
    procedure btn_dinheiro_confirmaClick(Sender: TObject);
    procedure ds_dinheiroDataChange(Sender: TObject; Field: TField);
    procedure btn_excluir_dinheiroClick(Sender: TObject);
  private
    Fp_operacao : utipos.Toperacao;
    Fpessoa_id: integer;
    Fcodigo   : integer;
    Ftabela: string;

    procedure prc_componentes;
    procedure prc_inicializar;
    procedure prc_atualiza_painel_totais;

    function  fnc_validar: boolean;
    procedure prc_salvar;
    procedure prc_ler_dados;

    procedure prc_incluir_alterar(operacao: TOperacao);
    procedure prc_incluir_alterar_dinheiro(operacao: TOperacao);
    procedure prc_incluir_alterar_pix(operacao: TOperacao);
    procedure prc_incluir_alterar_cheque( operacao : TOperacao;
              conta_bancaria_id :integer; banco, agencia, nr_conta, nr_cheque :string;
              data : TDate; valor: double; historico: string);
    procedure prc_incluir_alterar_cartao( operacao : TOperacao; data_venda:TDate;
          cartao_operadoras_id :integer; cartao_bandeira_id : integer; cartao_taxas_itens_id :integer;
          qtde_parcelas: integer; taxa :double; valor_venda :double ;valor_liquido :double ;cv :string);
     procedure prc_incluir_alterar_contas_pagar(operacao: TOperacao;
          contas_pagar_id: integer; historico: string; valor_parcela, valor_pago, baixar: double);
    procedure prc_incluir_alterar_contas_receber(operacao: TOperacao;
          contas_receber_id: integer; historico: string; valor_parcela, valor_pago, baixar: double);

    procedure prc_salva_entrada_dinheiro(_operacao: TOperacao);
    procedure prc_salvar_entrada_pix;
    procedure prc_salvar_entrada_cheque;
    procedure prc_salvar_entrada_cartao;
    procedure prc_atualizar_saldo_contas_pagar(valor_pago: double);
    procedure prc_salvar_baixa_conta_pagar;
    procedure prc_salvar_baixa_conta_receber;
  public
    property codigo    :integer read Fcodigo write Fcodigo;
    property p_operacao  :utipos.Toperacao read Fp_operacao write Fp_operacao;
    property pessoa_id :integer read Fpessoa_id write Fpessoa_id;
    property tabela : string read Ftabela write Ftabela;


  end;

var
  frmRecibosE: TfrmRecibosE;

implementation


{$R *.dfm}

function TfrmRecibosE.fnc_validar : boolean;
begin
  result := false;

  if cbx_pessoa.Text = '' then
  begin
    criarmensagem('AVISO','INFORME UMA PESSOA.');
    cbx_pessoa.SetFocus;
    exit;
  end;

  if edt_observacoes.Text = '' then
  begin
    criarmensagem('AVISO','PREENCHA O CAMPO OBSERVAÇÃO.');
    edt_observacoes.SetFocus;
    exit;
  end;

  if mtb_conta_receber.IsEmpty  then
  begin
    criarmensagem('AVISO','NENHUMA CONTA FOI SELECIONADA.' + slinebreak + slinebreak +
                  'SELECIONE UMA OU MAIS CONTAS E TENTE NOVAMENTE.');
    btn_incluir_conta_receber.Click;
    exit;
  end;

  // se tiver algum valor lançado em dinheiro, posiciono na tab dinheiro e
  // faço as verificações
  if strtofloatdef(pnl_dinheiro.Caption,0) > 0 then
  begin
    PageControlCreditos.ActivePage := tbs_dinheiro;

    if edt_obs_dinheiro.Text = '' then
    begin
      criarmensagem('AVISO','ENTRADA EM DINHEIRO.' + sLineBreak + slinebreak +
                    ' PREENCHA O CAMPO OBSERVAÇÃO.');
      edt_obs_dinheiro.SetFocus;
      exit;
    end;
  end;

  // se tiver algum valor lançado em pix, posiciono na tab pix e
  // faço as verificações
  if strtofloatdef(pnl_pix.Caption,0) > 0 then
  begin
    PageControlCreditos.ActivePage := tbs_pix;

    if cbx_bancos.Text = '' then
    begin
      criarmensagem('AVISO','ENTRADA EM PIX.' + sLineBreak + slinebreak +
                    ' SELECIONE UM BANCO.');
      cbx_bancos.SetFocus;
      exit;
    end;

    if cbx_conta_bancaria.Text = '' then
    begin
      criarmensagem('AVISO','ENTRADA EM PIX.' + sLineBreak + slinebreak +
                    ' SELECIONE EM QUAL CONTA O PIX SERÁ CREDITADO.');
      cbx_conta_bancaria.SetFocus;
      exit;
    end;

    if edt_obs_pix.Text = '' then
    begin
      criarmensagem('AVISO','ENTRADA EM PIX.' + sLineBreak + slinebreak +
                    ' PREENCHA O CAMPO OBSERVAÇÃO.');
      edt_obs_pix.SetFocus;
      exit;
    end;
  end;

  // agora se não houve nenhum pagamento, não a como emitir um recibo
  if strtofloatdef(pnl_total_creditos.Caption,0) <= 0 then
  begin
    criarmensagem('AVISO','NENHUM PAGAMENTO FOI INFORMADO.' + slinebreak + slinebreak +
                  'INFORME O(S) PAGAMENTO(S) E TENTE NOVAMENTE.');
    exit;

  end;

  // se o valor dos pagamentos for maior que as contas que estão sendo pagas
  // avisar o usuario se quer continuar com a emissão do recibo. se sim
  // avisar que uma conta de crédito sera emitida em nome do cliente.
  if strtofloatdef(pnl_saldo.Caption,0) >= 0.01 then
  begin
    if criarmensagem('CONFIRMACAO','O VALOR QUE ESTA SENDO PAGO É MAIOR QUE A(S) CONTA(S) SELECIONADA(S).' + slinebreak + slinebreak +
                  'DESEJA CONTINUAR?.') = TRUE then
    begin
      criarmensagem('AVISO','UMA CONTA DE CRÉDITO DE R$ ' + pnl_saldo.Caption  + ' SERÁ EMITIDA EM NOME DE : ' + slinebreak + slinebreak +
                  cbx_pessoa.Text );

    end else
    begin
      criarmensagem('AVISO','CORRIJA OS DADOS E TENTE NOVAMENTE.');
      exit;
    end;

  end;

  // agora se o saldo estiver negatido, avisar ao usuario que a ultima conta
  // será baixada parcial
  if strtofloatdef(pnl_saldo.Caption,0) < 0 then
  begin
    if criarmensagem('CONFIRMACAO','O VALOR QUE ESTA SENDO PAGO É MENOR QUE A(S) CONTA(S) SELECIONADA(S).' + slinebreak + slinebreak +
                  'DESEJA CONTINUAR?.') = TRUE then
    begin
      criarmensagem('AVISO','ALTERE O VALOR A BAIXAR DA ÚLTIMA CONTA DA LISTA ');
      mtb_conta_receber.Last;
      // chama o formulario para alterar o valor e passo o valor sugerido
      try
        if frmRecibosAlterarValorConta = nil then
          frmRecibosAlterarValorConta := TfrmRecibosAlterarValorConta.Create(application);

        frmRecibosAlterarValorConta.lbl_pessoa.Caption        := cbx_pessoa.Text;
        frmRecibosAlterarValorConta.lbl_nr_documento.Caption  := mtb_conta_receber.FieldByName('NR_DOCUMENTO').AsString;
        frmRecibosAlterarValorConta.lbl_historico.Caption     := mtb_conta_receber.FieldByName('DESCRICAO').AsString;
        frmRecibosAlterarValorConta.lbl_total_parcela.Caption := formatfloat('0.00', mtb_conta_receber.FieldByName('TOTAL_PARCELA').Asfloat);
        frmRecibosAlterarValorConta.lbl_saldo_aberto.Caption  := formatfloat('0.00', mtb_conta_receber.FieldByName('TOTAL_PARCELA').Asfloat - mtb_conta_receber.FieldByName('VALOR_PAGO').Asfloat );
        // valor sugerido
        frmRecibosAlterarValorConta.edt_baixar.Text := formatfloat('0.00',mtb_conta_receber.FieldByName('BAIXAR').AsFloat + strtofloatdef(pnl_saldo.Caption,0));
        frmRecibosAlterarValorConta.ShowModal;

        prc_atualiza_painel_totais;

      finally
        freeandnil(frmRecibosAlterarValorConta);
      end;


      exit;
    end else
    begin
      criarmensagem('AVISO','CORRIJA OS DADOS E TENTE NOVAMENTE.');
      exit;
    end;
  end ;

  result := true;
end;

procedure TfrmRecibosE.btn_dinheiro_cancelaClick(Sender: TObject);
begin
  inherited;
  gbx_entrada_dinheiro.Visible := FALSE;
end;

procedure TfrmRecibosE.btn_dinheiro_confirmaClick(Sender: TObject);
begin
  inherited;
  if edt_obs_dinheiro.Text = '' then
  begin
    CriarMensagem('AVISO','INSIRA UM COMENTÁRIO');
    edt_obs_dinheiro.SetFocus;
    exit;
  end;

  mtb_dinheiro.Insert;
  mtb_dinheiro.fieldbyname('ID').AsInteger := -1;
  mtb_dinheiro.fieldbyname('RECIBO_ID').AsInteger := -1;
  mtb_dinheiro.fieldbyname('VALOR').AsFloat := StrToFloat(edt_valor_dinheiro.Text);
  mtb_dinheiro.fieldbyname('OBSERVACAO').AsString := edt_obs_dinheiro.Text;
  mtb_dinheiro.post;

  prc_atualiza_painel_totais;

  gbx_entrada_dinheiro.Visible := false;

end;

procedure TfrmRecibosE.btnOkClick(Sender: TObject);
begin
  prc_salvar;
end;

procedure TfrmRecibosE.prc_salvar;
begin
  {faz as validações, se não validar não contiunua}
  if not fnc_validar then Exit;

  {inicia uma nova transação}
  if not Self.Conexao.InTransaction then Self.Conexao.StartTransaction;
  try

    {incluir/alterar o recibo}
    prc_incluir_alterar( p_operacao );

    {manda pro banco de dados}
    if Self.Conexao.InTransaction then Self.Conexao.Commit;

    {mensagem ao usuário}
    if p_operacao = opincluir then
      CriarMensagem('AVISO',' RECIBO INCLUIDO COM SUCESSO. ')
    else if p_operacao = opalterar then
      CriarMensagem('AVISO',' RECIBO ALTERADO COM SUCESSO. ');

    {fecha o formulário}
    Close;

  except
    {se der algum erro durante o processo de gravação desfaz tudo!}
    on E : Exception do
       begin
         CriarMensagem('AVISO','NÃO FOI POSSIVEL SALVAR O PEDIDO.' + slinebreak + slinebreak + E.Message);
         if Conexao.InTransaction then
           Conexao.Rollback;;
         //***
         Raise;
       end;
  end;

end;

procedure TfrmRecibosE.prc_incluir_alterar(operacao: TOperacao);
var
  loqry : TFDQuery;
begin
  try
    loqry := TFDQuery.Create(application);
    loqry.Connection := conexao;

    loQry.sql.clear;
    if operacao = opExcluir then
    begin

      loQry.SQL.Add('update RECIBOS set ATIVO = ''N'' where ID =:ID');
      loQry.ParamByName('ID').AsInteger := Codigo;
      loQry.ExecSQL;
      exit;

    end;

    if operacao = OpIncluir then
    begin
      loQry.SQL.Add('insert into RECIBOS ');
      loQry.SQL.Add('(                   ');
      loQry.SQL.Add('  CADASTRADO_EM,    ');
      loQry.SQL.Add('  VALOR,            ');
      loQry.SQL.Add('  PESSOA_ID,        ');
      loQry.SQL.Add('  USUARIO_ID,       ');
      loQry.SQL.Add('  OBSERVACAO,        ');
      loQry.SQL.Add('  valor_extenso      ');
      loQry.SQL.Add(')                   ');
      loQry.SQL.Add('VALUES              ');
      loQry.SQL.Add('(                   ');
      loQry.SQL.Add(' :CADASTRADO_EM,    ');
      loQry.SQL.Add(' :VALOR,            ');
      loQry.SQL.Add(' :PESSOA_ID,        ');
      loQry.SQL.Add(' :USUARIO_ID,       ');
      loQry.SQL.Add(' :OBSERVACAO,        ');
      loQry.SQL.Add(' :valor_extenso      ');
      loQry.SQL.Add(')                   ');
      loQry.SQL.Add('returning RECIBO_ID ');

      loQry.ParamByName('CADASTRADO_EM').AsDate := Date;
    end else
    if operacao = opAlterar then
    begin
      loQry.SQL.Add('UPDATE                      ');
      loQry.SQL.Add(Tabela);
      loQry.SQL.Add('SET                         ');
      loQry.SQL.Add('  VALOR      = :VALOR,      ');
      loQry.SQL.Add('  PESSOA_ID  = :PESSOA_ID,  ');
      loQry.SQL.Add('  USUARIO_ID = :USUARIO_ID, ');
      loQry.SQL.Add('  OBSERVACAO = :OBSERVACAO,  ');
      loQry.SQL.Add('  valor_extenso = :valor_extenso  ');
      loQry.SQL.Add('WHERE                       ');
      loQry.SQL.Add('  RECIBO_ID  = :ID          ');
      //
      loQry.ParamByName('RECIBO_ID').AsInteger := Codigo;

    end;

    loQry.ParamByName('VALOR').AsFloat        := strtofloatdef(pnl_total_creditos.Caption,0);
    loQry.ParamByName('PESSOA_ID').AsInteger  := cbx_pessoa.KeyValue;
    loQry.ParamByName('USUARIO_ID').AsInteger := 3;
    loQry.ParamByName('OBSERVACAO').asstring  := edt_observacoes.Text;
    loQry.ParamByName('valor_extenso').asstring  := unit_funcoes.extenso(StrToFloat(pnl_total_creditos.Caption));

    //ShowMessage(loQry.SQL.Text);

    if operacao = opincluir then
    begin
      loQry.Open;
      codigo := loQry.FieldByName('RECIBO_ID').AsInteger;
    end
    else
    begin
      loQry.ExecSQL;
    end;

    {INICIO DE GRAVAÇÃO DOS ITENS DO RECIBO}
    // créditos do cliente

    {dinheiro}
    if strtofloatdef(edt_valor_dinheiro.Text,0) > 0 then
    begin
      // salva entrada na tabela recibo_itens_dinheiro
      prc_incluir_alterar_dinheiro( p_operacao );

      // salva entrada em dinheiro da tabela dinheiro_entrada
      prc_salva_entrada_dinheiro(opincluir);
    end;

    {pix}
    if strtofloatdef(edt_valor_pix.Text,0) > 0  then
    begin
      // salva da tabela recibo_itens_pix
      prc_incluir_alterar_pix( p_operacao );
      // registra do pix na tabela de pix_recebidos
      prc_salvar_entrada_pix;
    end;

    {cheque}
    if not mtb_cheque_cliente.IsEmpty  then
    begin
      mtb_cheque_cliente.First;
      while not mtb_cheque_cliente.eof do
      begin
        {inclui na tabela recibo_itens_cheque}
        prc_incluir_alterar_cheque( p_operacao,
          mtb_cheque_cliente.fieldbyname('CORRENTISTA_CONTA_ID').AsInteger,
          mtb_cheque_cliente.fieldbyname('BANCO').AsString,
          mtb_cheque_cliente.fieldbyname('AGENCIA').AsString,
          mtb_cheque_cliente.fieldbyname('CONTA').AsString,
          mtb_cheque_cliente.fieldbyname('NR_CHEQUE').AsString,
          mtb_cheque_cliente.fieldbyname('PRE_DATADO_PARA').AsDateTime,
          mtb_cheque_cliente.fieldbyname('VALOR').AsFloat,
          mtb_cheque_cliente.fieldbyname('HISTORICO').AsString );

        {incluir o cheque na tabela de cheques_cliente}
        prc_salvar_entrada_cheque;
        // próximo cheque
        mtb_cheque_cliente.Next;
      end;
    end;

    {cartão}
    if not mtb_cartao.IsEmpty  then
    begin
      mtb_cartao.First;
      while not mtb_cartao.eof do
      begin
        {inclui cartao na tabela recibo_itens_cartao}
        prc_incluir_alterar_cartao( p_operacao,
          mtb_cartao.fieldbyname('DATA_VENDA').AsDateTime,
          mtb_cartao.fieldbyname('CARTAO_OPERADORA_ID').AsInteger,
          mtb_cartao.fieldbyname('CARTAO_BANDEIRA_ID').AsInteger,
          mtb_cartao.fieldbyname('TAXA_ID').AsInteger,
          mtb_cartao.fieldbyname('QTDE_PARCELAS').AsInteger,
          mtb_cartao.fieldbyname('TAXA').AsFloat,
          mtb_cartao.fieldbyname('VALOR_VENDA').AsFloat,
          mtb_cartao.fieldbyname('VALOR_LIQUIDO').AsFloat,
          mtb_cartao.fieldbyname('CV').AsString );
        {incluir cartão na tabela de cartão vendas e parcelas no contas a receber}
        prc_salvar_entrada_cartao;

        mtb_cartao.Next;
      end;
    end;

    {contas a pagar}
    if not mtb_conta_pagar.IsEmpty  then
    begin
      mtb_conta_pagar.First;
      while not mtb_conta_pagar.eof do
      begin

        {inclui conta a pagar na tabela recibo_itens_contas_pagar}
        prc_incluir_alterar_contas_pagar( p_operacao,
          mtb_conta_pagar.fieldbyname('ID').AsInteger,
          mtb_conta_pagar.fieldbyname('DESCRICAO').AsString,
          mtb_conta_pagar.fieldbyname('TOTAL_PARCELA').AsFloat,
          mtb_conta_pagar.fieldbyname('VALOR_PAGO').AsFloat,
          mtb_conta_pagar.fieldbyname('BAIXAR').AsFloat);

        {implementar baixar saldo da conta a pagar selecionada}
        prc_salvar_baixa_conta_pagar;
        mtb_conta_pagar.Next;

      end;
    end;

    /// fim de créditos

    {debitos do cliente}
    {contas a receber}
    if not mtb_conta_receber.IsEmpty  then
    begin
      mtb_conta_receber.First;
      while not mtb_conta_receber.eof do
      begin
        {inclui conta a receber na tabela recibo_itens_contas_receber}
        prc_incluir_alterar_contas_receber( p_operacao,
          mtb_conta_receber.fieldbyname('ID').AsInteger,
          mtb_conta_receber.fieldbyname('DESCRICAO').AsString,
          mtb_conta_receber.fieldbyname('TOTAL_PARCELA').AsFloat,
          mtb_conta_receber.fieldbyname('VALOR_PAGO').AsFloat,
          mtb_conta_receber.fieldbyname('BAIXAR').AsFloat);

        {inclui o pagamento na tabela contas_receber_baixa}
        prc_salvar_baixa_conta_receber;

        {se for uma conta receber ref a um pedido...
          por uma coluna na grid de contas a receber "tabela origem",
          pra saber se a conta é ref a um pedido}
        if mtb_conta_receber.fieldbyname('TABELA_ORIGEM').Asstring = 'PEDIDOS' then
        begin
          ufinanceiro.prc_registrar_pagamento_pedido(
                                                Conexao,
                                                mtb_conta_receber.fieldbyname('NR_DOCUMENTO').AsInteger,
                                                date,
                                                mtb_conta_receber.fieldbyname('BAIXAR').AsFloat,
                                                'PAGO CONF RECIBO N. ' + INTTOSTR(CODIGO)
                                               );

          {atualiza saldo aberto do pedido}
          uFinanceiro.prc_baixar_pedido(
                                        conexao,
                                        mtb_conta_receber.fieldbyname('NR_DOCUMENTO').AsInteger,
                                        mtb_conta_receber.fieldbyname('BAIXAR').AsFloat);
        end;
        {atualiza saldo contas a receber}
        uFinanceiro.baixar_contas_receber(
                                      Conexao, mtb_conta_receber.fieldbyname('ID').AsInteger, 0,
                                      mtb_conta_receber.fieldbyname('BAIXAR').AsFloat);
        mtb_conta_receber.Next;
      end;
    end;




  finally
    freeandnil( loQry );
  end;

end;

procedure TfrmRecibosE.prc_salvar_entrada_cartao;
var
  loqry : TFDquery;
  codigo_cartao : integer;
  I: Integer;
begin
  I := 0;
  try
    loqry := TFDquery.Create(application);
    loqry.Connection := conexao;
    loqry.SQL.Clear;
    loqry.SQL.Add('insert into CARTAO_VENDAS ');
    loqry.SQL.Add('(                         ');
    loqry.SQL.Add('  CADASTRADO_EM,          ');
    loqry.SQL.Add('  DATA_VENDA,             ');
    loqry.SQL.Add('  CARTAO_OPERADORA_ID,    ');
    loqry.SQL.Add('  CARTAO_MAQUINA_ID,      ');
    loqry.SQL.Add('  CARTAO_BANDEIRA_ID,     ');
    loqry.SQL.Add('  CARTAO_FORMA_PAGTO_ID,  ');
    loqry.SQL.Add('  TAXA,                   ');
    loqry.SQL.Add('  VALOR_VENDA,            ');
    loqry.SQL.Add('  VALOR_LIQUIDO,          ');
    loqry.SQL.Add('  CV                      ');
    loqry.SQL.Add(')                         ');
    loqry.SQL.Add('VALUES                    ');
    loqry.SQL.Add('(                         ');
    loqry.SQL.Add('  :CADASTRADO_EM,         ');
    loqry.SQL.Add('  :DATA_VENDA,            ');
    loqry.SQL.Add('  :CARTAO_OPERADORA_ID,   ');
    loqry.SQL.Add('  :CARTAO_MAQUINA_ID,     ');
    loqry.SQL.Add('  :CARTAO_BANDEIRA_ID,    ');
    loqry.SQL.Add('  :CARTAO_FORMA_PAGTO_ID, ');
    loqry.SQL.Add('  :TAXA,                  ');
    loqry.SQL.Add('  :VALOR_VENDA,           ');
    loqry.SQL.Add('  :VALOR_LIQUIDO,         ');
    loqry.SQL.Add('  :CV                     ');
    loqry.SQL.Add(')                         ');
    loqry.SQL.Add('returning ID              ');

    loqry.ParamByName('CADASTRADO_EM').AsDate            := Date;
    loqry.ParamByName('DATA_VENDA').AsDate               := Date;
    loqry.ParamByName('CARTAO_OPERADORA_ID').AsInteger   := mtb_cartao.fieldbyname('CARTAO_OPERADORA_ID').asinteger;
    loqry.ParamByName('CARTAO_MAQUINA_ID').AsInteger     := mtb_cartao.fieldbyname('CARTAO_MAQUINA_ID').asinteger;
    loqry.ParamByName('CARTAO_BANDEIRA_ID').AsInteger    := mtb_cartao.fieldbyname('CARTAO_BANDEIRA_ID').asinteger;
    loqry.ParamByName('CARTAO_FORMA_PAGTO_ID').AsInteger := mtb_cartao.fieldbyname('CARTAO_FORMA_PAGTO_ID').asinteger;
    loqry.ParamByName('TAXA').AsFloat                    := mtb_cartao.fieldbyname('TAXA').AsFloat;
    loqry.ParamByName('VALOR_VENDA').AsFloat             := mtb_cartao.fieldbyname('VALOR_VENDA').AsFloat;
    loqry.ParamByName('VALOR_LIQUIDO').AsFloat           := mtb_cartao.fieldbyname('VALOR_LIQUIDO').AsFloat;
    loqry.ParamByName('CV').AsString                     := mtb_cartao.fieldbyname('CV').AsString;
    loqry.Open;
    codigo_cartao := qry.FieldByName('ID').AsInteger;

    {salvar as parcelas no contas a receber}
    if mtb_cartao.FieldByName('proprietario_id').AsInteger < 0 then
    begin
      {maquina da empresa, lança parcela a parcela}
      for I := 0 to mtb_cartao.FieldByName('QTDE_PARCELAS').AsInteger -1 do
      begin
        uFinanceiro.AddContasReceber(
         conexao,
         codigo,
         date,
         sesenao(mtb_cartao.FieldByName('proprietario_id').AsInteger < 0, mtb_cartao.FieldByName('cartao_operadora_id').AsInteger{operadora}, mtb_cartao.FieldByName('proprietario_id').AsInteger{fornecedor}),
         'CARTAO_VENDAS',
         codigo_cartao,
         I,
         mtb_cartao.FieldByName('QTDE_PARCELAS').AsInteger,
         mtb_cartao.fieldbyname('VALOR_LIQUIDO').AsFloat / mtb_cartao.FieldByName('QTDE_PARCELAS').AsInteger,
         0,0,0,0,
         date,
         0,
         0,
         'VENDA COM CARTÃO DE CRÉDITO CV ' + mtb_cartao.fieldbyname('CV').AsString + ' PARCELA ' + INTTOSTR(I +1) + '/' + inttostr(mtb_cartao.FieldByName('QTDE_PARCELAS').AsInteger),
         '',
         10 //plano de contas : cartão de crédito
         );

      end;
    end else
    if mtb_cartao.FieldByName('proprietario_id').AsInteger > 0 then
    begin
      {maquina de fornecedor , lançar parcela unica}
      uFinanceiro.AddContasReceber(
       conexao,
       codigo,
       date,
       sesenao(mtb_cartao.FieldByName('proprietario_id').AsInteger < 0, mtb_cartao.FieldByName('cartao_operadora_id').AsInteger{operadora}, mtb_cartao.FieldByName('proprietario_id').AsInteger{fornecedor}),
       'CARTAO_VENDAS',
       codigo_cartao,
       I,
       1,
       mtb_cartao.fieldbyname('VALOR_LIQUIDO').AsFloat,
       0,0,0,0,
       date,
       0,
       0,
       'VENDA COM CARTÃO DE CRÉDITO CV ' + mtb_cartao.fieldbyname('CV').AsString + ' PARCELA 1/1',
       '',
       10 //plano de contas : cartão de crédito
       );
    end;

  finally
    freeandnil( loqry );
  end;
end;

procedure TfrmRecibosE.prc_salvar_entrada_cheque;
var
  loqry :TFDQuery;
begin
  try
    loqry := TFDQuery.Create(application);
    loqry.Connection := conexao;

    loqry.sql.clear;
    loqry.SQL.Add('insert into CHEQUES_CLIENTES');
    loqry.SQL.Add('(                           ');
    loqry.SQL.Add('  CADASTRADO_EM,            ');
    loqry.SQL.Add('  CORRENTISTA_CONTA_ID,     ');
    loqry.SQL.Add('  NR_CHEQUE,                ');
    loqry.SQL.Add('  PRE_DATADO_PARA,          ');
    loqry.SQL.Add('  VALOR,                    ');
    loqry.SQL.Add('  RECIBO_ID,                ');
    loqry.SQL.Add('  HISTORICO,                ');
    loqry.SQL.Add('  REPASSADO                 ');
    loqry.SQL.Add(')                           ');
    loqry.SQL.Add('VALUES                      ');
    loqry.SQL.Add('(                           ');
    loqry.SQL.Add('  :CADASTRADO_EM,           ');
    loqry.SQL.Add('  :CORRENTISTA_CONTA_ID,    ');
    loqry.SQL.Add('  :NR_CHEQUE,               ');
    loqry.SQL.Add('  :PRE_DATADO_PARA,         ');
    loqry.SQL.Add('  :VALOR,                   ');
    loqry.SQL.Add('  :RECIBO_ID,               ');
    loqry.SQL.Add('  :HISTORICO,               ');
    loqry.SQL.Add('  :REPASSADO                ');
    loqry.SQL.Add(')                           ');

    loqry.ParamByName('CADASTRADO_EM').AsDate           := date;
    loqry.ParamByName('CORRENTISTA_CONTA_ID').AsInteger := mtb_cheque_cliente.FieldByName('CORRENTISTA_CONTA_ID').AsInteger;
    loqry.ParamByName('NR_CHEQUE').AsString             := mtb_cheque_cliente.FieldByName('NR_CHEQUE').AsString;
    loqry.ParamByName('PRE_DATADO_PARA').AsDate         := mtb_cheque_cliente.FieldByName('PRE_DATADO_PARA').AsDateTime;
    loqry.ParamByName('VALOR').AsFloat                  := mtb_cheque_cliente.FieldByName('VALOR').AsFloat;
    loqry.ParamByName('RECIBO_ID').AsInteger            := CODIGO;
    loqry.ParamByName('HISTORICO').AsString             := mtb_cheque_cliente.FieldByName('HISTORICO').AsString;
    loqry.ParamByName('REPASSADO').AsString             := 'N';
    loqry.ExecSQL;

  finally
    freeandnil( loqry );
  end;
end;


procedure TfrmRecibosE.prc_incluir_alterar_dinheiro( operacao : TOperacao);
var
  loqry : TFDQuery;
begin
//ShowMessage('ENTREI');
  try
    loqry := TFDQuery.Create(application);
    loqry.Connection := conexao;

    loQry.sql.clear;
    if operacao = opExcluir then
    begin

      //loQry.SQL.Add('update RECIBO_ITENS_DINHEIRO set ATIVO = ''N'' where ID =:ID');
      //loQry.ParamByName('ID').AsInteger := Codigo;
      //loQry.ExecSQL;
      exit;

    end;

    if operacao = OpIncluir then
    begin
  //ShowMessage('incluir');
      loQry.SQL.Add('insert into RECIBO_ITENS_DINHEIRO ');
      loQry.SQL.Add('(                   ');
      loQry.SQL.Add('  RECIBO_ID,        ');
      loQry.SQL.Add('  VALOR,            ');
      loQry.SQL.Add('  OBSERVACAO        ');
      loQry.SQL.Add(')                   ');
      loQry.SQL.Add('VALUES              ');
      loQry.SQL.Add('(                   ');
      loQry.SQL.Add(' :RECIBO_ID,        ');
      loQry.SQL.Add(' :VALOR,            ');
      loQry.SQL.Add(' :OBSERVACAO        ');
      loQry.SQL.Add(')                   ');
      loQry.ParamByName('RECIBO_ID').AsInteger := Codigo;

    end else
    if operacao = opAlterar then
    begin
      loQry.SQL.Add('UPDATE                      ');
      loQry.SQL.Add('RECIBO_ITENS_DINHEIRO       ');
      loQry.SQL.Add('SET                         ');
      loQry.SQL.Add('  VALOR      = :VALOR,      ');
      loQry.SQL.Add('  OBSERVACAO = :OBSERVACAO  ');
      loQry.SQL.Add('WHERE                       ');
      loQry.SQL.Add('  ID  = :ID                 ');
      //
      loQry.ParamByName('ID').AsInteger := Codigo;

    end;

    loQry.ParamByName('VALOR').AsFloat        := strtofloatdef(edt_valor_dinheiro.Text,0);
    loQry.ParamByName('OBSERVACAO').asstring  := edt_obs_dinheiro.Text;

    loQry.ExecSQL;
  finally
    freeandnil( loQry );
  end;

end;

procedure TfrmRecibosE.prc_incluir_alterar_pix( operacao : TOperacao);
var
  loqry : TFDQuery;
begin
//ShowMessage('ENTREI');
  try
    loqry := TFDQuery.Create(application);
    loqry.Connection := conexao;

    loQry.sql.clear;
    if operacao = opExcluir then
    begin

      //loQry.SQL.Add('update RECIBO_ITENS_DINHEIRO set ATIVO = ''N'' where ID =:ID');
      //loQry.ParamByName('ID').AsInteger := Codigo;
      //loQry.ExecSQL;
      exit;

    end;

    if operacao = OpIncluir then
    begin
  //ShowMessage('incluir');
      loQry.SQL.Add('insert into RECIBO_ITENS_PIX ');
      loQry.SQL.Add('(                            ');
      loQry.SQL.Add('  RECIBO_ID,                 ');
      loQry.SQL.Add('  BANCO_PESSOA_ID,           ');
      loQry.SQL.Add('  CONTAS_BANCARIAS_ITENS_ID, ');
      loQry.SQL.Add('  VALOR,                     ');
      loQry.SQL.Add('  OBSERVACAO                 ');
      loQry.SQL.Add(')                            ');
      loQry.SQL.Add('VALUES                       ');
      loQry.SQL.Add('(                            ');
      loQry.SQL.Add(' :RECIBO_ID,                 ');
      loQry.SQL.Add(' :BANCO_PESSOA_ID,           ');
      loQry.SQL.Add(' :CONTAS_BANCARIAS_ITENS_ID, ');
      loQry.SQL.Add(' :VALOR,                     ');
      loQry.SQL.Add(' :OBSERVACAO                 ');
      loQry.SQL.Add(')                            ');
      loQry.ParamByName('RECIBO_ID').AsInteger := Codigo;

    end else
    if operacao = opAlterar then
    begin
      loQry.SQL.Add('UPDATE                                                   ');
      loQry.SQL.Add('RECIBO_ITENS_PIX                                         ');
      loQry.SQL.Add('SET                                                      ');
      loQry.SQL.Add('  BANCO_PESSOA_ID = :BANCO_PESSOA_ID,                    ');
      loQry.SQL.Add('  CONTAS_BANCARIAS_ITENS_ID = :CONTAS_BANCARIAS_ITENS_ID,');
      loQry.SQL.Add('  VALOR      = :VALOR,      ');
      loQry.SQL.Add('  OBSERVACAO = :OBSERVACAO  ');
      loQry.SQL.Add('WHERE                       ');
      loQry.SQL.Add('  ID  = :ID                 ');
      //
      loQry.ParamByName('ID').AsInteger := Codigo;

    end;

    loQry.ParamByName('BANCO_PESSOA_ID').AsInteger := qry_bancos.FieldByName('pessoa_id').AsInteger;
    loQry.ParamByName('CONTAS_BANCARIAS_ITENS_ID').AsInteger := cbx_conta_bancaria.KeyValue;
    loQry.ParamByName('VALOR').AsFloat        := strtofloatdef(edt_valor_pix.Text,0);
    loQry.ParamByName('OBSERVACAO').asstring  := edt_obs_pix.Text;

    loQry.ExecSQL;
  finally
    freeandnil( loQry );
  end;
end;

procedure TfrmRecibosE.prc_inicializar;
begin
  case self.p_operacao of
  uTipos.opIncluir: begin
                      pnDados.Enabled     := true;
                      btnOk.Caption       := 'SALVAR RECIBO';
                      lbl_emissao.Caption := datetostr(date);
                    end;
  uTipos.opAlterar: begin
                      prc_ler_dados;
                      btnOk.Caption := 'SOMENTE LEITURA';
                      btnok.Enabled := false;
                    end;
  uTipos.opExcluir: begin
                      prc_ler_dados;
                      btnOk.Caption := 'SOMENTE LEITURA';
                      btnFechar.SetFocus;
                    end;
  else
    begin
      pnDados.Enabled := false;
      if btnFechar.CanFocus then btnFechar.SetFocus;
    end;
  end;

end;

procedure TfrmRecibosE.prc_ler_dados;
var
  loqry : TFDQuery;
begin
  try
    loqry := TFDQuery.Create(application);
    loqry.Connection := conexao;
    // cabeçalho do recibo
    loQry.sql.clear;
    loqry.SQL.Add('select r.recibo_id, r.cadastrado_em, r.pessoa_id, r.observacao from recibos r where recibo_id =:recibo_id');
    loqry.ParamByName('recibo_id').AsInteger  := codigo;
    loqry.Open;
    lbl_nr_recibo.Caption:= loqry.fieldbyname('recibo_id').Asstring;
    lbl_emissao.Caption  := loqry.fieldbyname('cadastrado_em').Asstring;
    cbx_pessoa.KeyValue  := loqry.fieldbyname('pessoa_id').AsInteger;
    cbx_pessoa.Enabled   := false;
    edt_observacoes.Text := loqry.fieldbyname('observacao').Asstring;
    loqry.Close;

    // busca os itens de contas a receber do recibo
    loQry.sql.clear;
    loqry.SQL.Add('select r.id, r.recibo_id, r.contas_receber_id, r.historico, r.valor_parcela, r.valor_pago, r.baixar from RECIBO_ITENS_CONTAS_RECEBER r where r.recibo_id =:recibo_id');
    loqry.ParamByName('recibo_id').AsInteger  := codigo;
    loqry.Open;
    if not loqry.IsEmpty then
    begin
      loqry.First;
      while not loqry.eof do
      begin
        mtb_conta_receber.Insert;
        mtb_conta_receber.FieldByName('ID').AsInteger          := loqry.FieldByName('ID').AsInteger;
        mtb_conta_receber.FieldByName('NR_DOCUMENTO').AsString := loqry.FieldByName('contas_receber_id').AsString;
        mtb_conta_receber.FieldByName('DESCRICAO').AsString    := loqry.FieldByName('HISTORICO').AsString;
        mtb_conta_receber.FieldByName('TOTAL_PARCELA').AsFloat := loqry.FieldByName('valor_parcela').AsFloat;
        mtb_conta_receber.FieldByName('VALOR_PAGO').AsFloat    := loqry.FieldByName('valor_pago').AsFloat;
        mtb_conta_receber.FieldByName('BAIXAR').AsFloat        := loqry.FieldByName('baixar').AsFloat;
        mtb_conta_receber.post;
        loqry.Next;
      end;
    end else
    loqry.Close;

    // busca os lançamentos em dinheiro do recibo
    loQry.sql.clear;
    loqry.SQL.Add('select d.id, d.recibo_id, d.valor, d.observacao from RECIBO_ITENS_DINHEIRO d where d.recibo_id =:recibo_id');
    loqry.ParamByName('recibo_id').AsInteger  := codigo;
    loqry.Open;
    if not loqry.IsEmpty then
    begin
      PageControlCreditos.ActivePage := tbs_dinheiro;
      edt_valor_dinheiro.Text := formatfloat('0.00', loqry.fieldbyname('valor').AsFloat );
      edt_obs_dinheiro.Text   := loqry.fieldbyname('observacao').Asstring;
    end else
    begin
      edt_valor_dinheiro.Text := '0,00';
      edt_obs_dinheiro.Text   := '0,00';
    end;
    loqry.Close;

    // busca os lançamentos em pix do recibo
    loQry.sql.clear;
    loqry.SQL.Add('select p.id, p.recibo_id, p.banco_pessoa_id, p.contas_bancarias_itens_id, p.valor, p.observacao from RECIBO_ITENS_PIX p where p.recibo_id =:recibo_id');
    loqry.ParamByName('recibo_id').AsInteger  := codigo;
    loqry.Open;
    if not loqry.IsEmpty then
    begin
      PageControlCreditos.ActivePage := tbs_pix;
      cbx_bancos.KeyValue := loqry.fieldbyname('banco_pessoa_id').AsInteger;

      qry_contas_bancarias.Close;
      qry_contas_bancarias.ParamByName('banco_id').AsInteger := qry_bancos.FieldByName('id').AsInteger;
      qry_contas_bancarias.open;

      cbx_conta_bancaria.KeyValue := qry_contas_bancarias.fieldbyname('id').AsInteger;

      edt_valor_pix.Text := formatfloat('0.00', loqry.fieldbyname('valor').AsFloat );
      edt_obs_pix.Text   := loqry.fieldbyname('observacao').Asstring;
    end else
    begin
      edt_valor_pix.Text := '0,00';
      edt_obs_pix.Text   := '0,00';
    end;
    loqry.Close;

    // busca os cheques do recibo
    loQry.sql.clear;
    loqry.SQL.Add('select                      ');
    loqry.SQL.Add('  ch.banco,                 ');
    loqry.SQL.Add('  ch.agencia,               ');
    loqry.SQL.Add('  ch.nr_conta,              ');
    loqry.SQL.Add('  ch.nr_cheque,             ');
    loqry.SQL.Add('  ch.valor,                 ');
    loqry.SQL.Add('  ch.data,                  ');
    loqry.SQL.Add('  ch.historico              ');
    loqry.SQL.Add('                            ');
    loqry.SQL.Add('from                        ');
    loqry.SQL.Add('  recibo_itens_cheque ch    ');
    loqry.SQL.Add('where                       ');
    loqry.SQL.Add('  ch.recibo_id = :recibo_id ');

    loqry.ParamByName('recibo_id').AsInteger  := codigo;
    loqry.Open;
    if not loqry.IsEmpty then
    begin
      PageControlCreditos.ActivePage := tbs_cheque;
      loqry.First;
      while not loqry.eof do
      begin
        mtb_cheque_cliente.Insert;
        mtb_cheque_cliente.FieldByName('banco').AsString     := loqry.FieldByName('banco').AsString;
        mtb_cheque_cliente.FieldByName('agencia').AsString   := loqry.FieldByName('agencia').AsString;
        mtb_cheque_cliente.FieldByName('conta').AsString     := loqry.FieldByName('nr_conta').AsString;
        mtb_cheque_cliente.FieldByName('nr_cheque').AsString := loqry.FieldByName('nr_cheque').AsString;
        mtb_cheque_cliente.FieldByName('valor').AsFloat              := loqry.FieldByName('valor').AsFloat;
        mtb_cheque_cliente.FieldByName('pre_datado_para').AsDateTime := loqry.FieldByName('data').AsDateTime;
        mtb_cheque_cliente.FieldByName('historico').AsString         := loqry.FieldByName('historico').AsString;
        mtb_cheque_cliente.post;
        loqry.Next;
      end;
    end;
    loqry.Close;

    // busca os cartoes do recibo
    loQry.sql.clear;
    loqry.SQL.Add('select                    ');
    loqry.SQL.Add('  rc.data_venda,          ');
    loqry.SQL.Add('  p1.nome,                ');
    loqry.SQL.Add('  b.descricao,            ');
    loqry.SQL.Add('  rc.qtde_parcelas,       ');
    loqry.SQL.Add('  rc.taxa,                ');
    loqry.SQL.Add('  rc.valor_venda,         ');
    loqry.SQL.Add('  rc.valor_liquido,       ');
    loqry.SQL.Add('  rc.cv                   ');
    loqry.SQL.Add('from                      ');
    loqry.SQL.Add('  recibo_itens_cartao rc, ');
    loqry.SQL.Add('  cartao_operadoras o,    ');
    loqry.SQL.Add('  pessoas p1,             ');
    loqry.SQL.Add('  cartao_bandeiras b      ');
    loqry.SQL.Add('where                     ');
    loqry.SQL.Add('  o.pessoa_id = p1.id and                   ');
    loqry.SQL.Add('  rc.bandeiras_id = b.id and                ');
    loqry.SQL.Add('  rc.cartao_operadoras_id = o.pessoa_id and ');
    loqry.SQL.Add('  rc.recibo_id = :recibo_id                 ');
    loqry.ParamByName('recibo_id').AsInteger := codigo;
    loqry.Open;
    if not loqry.IsEmpty then
    begin
      PageControlCreditos.ActivePage := tbs_cartao_credito;
      loqry.First;
      while not loqry.eof do
      begin
        mtb_cartao.Insert;
        mtb_cartao.FieldByName('DATA_VENDA').AsDateTime  := loqry.FieldByName('data_venda').AsDateTime;
        mtb_cartao.FieldByName('NM_OEPRADORA').AsString  := loqry.FieldByName('nome').AsString;
        mtb_cartao.FieldByName('NM_BANDEIRA').AsString   := loqry.FieldByName('descricao').AsString;
        mtb_cartao.FieldByName('QTDE_PARCELAS').AsInteger:= loqry.FieldByName('qtde_parcelas').AsInteger;
        mtb_cartao.FieldByName('TAXA').AsFloat           := loqry.FieldByName('taxa').AsFloat;
        mtb_cartao.FieldByName('VALOR_VENDA').AsFloat    := loqry.FieldByName('valor_venda').AsFloat;
        mtb_cartao.FieldByName('VALOR_LIQUIDO').AsFloat  := loqry.FieldByName('valor_liquido').AsFloat;
        mtb_cartao.FieldByName('CV').AsString            := loqry.FieldByName('cv').AsString;
        mtb_cartao.post;
        loqry.Next;
      end;
    end;
    loqry.Close;

    // busca os itens de contas a pagar do recibo
    loQry.sql.clear;
    loqry.SQL.Add('select r.id, r.recibo_id, r.contas_pagar_id, r.historico, r.valor_parcela, r.valor_pago, r.baixar from RECIBO_ITENS_CONTA_PAGAR r where r.recibo_id =:recibo_id');
    loqry.ParamByName('recibo_id').AsInteger  := codigo;
    loqry.Open;
    if not loqry.IsEmpty then
    begin
      PageControlCreditos.ActivePage := tbs_contas_pagar;
      loqry.First;
      while not loqry.eof do
      begin
        mtb_conta_pagar.Insert;
        mtb_conta_pagar.FieldByName('ID').AsInteger          := loqry.FieldByName('ID').AsInteger;
        mtb_conta_pagar.FieldByName('NR_DOCUMENTO').AsString := loqry.FieldByName('contas_pagar_id').AsString;
        mtb_conta_pagar.FieldByName('DESCRICAO').AsString    := loqry.FieldByName('HISTORICO').AsString;
        mtb_conta_pagar.FieldByName('TOTAL_PARCELA').AsFloat := loqry.FieldByName('valor_parcela').AsFloat;
        mtb_conta_pagar.FieldByName('VALOR_PAGO').AsFloat    := loqry.FieldByName('valor_pago').AsFloat;
        mtb_conta_pagar.FieldByName('BAIXAR').AsFloat        := loqry.FieldByName('baixar').AsFloat;
        mtb_conta_pagar.post;
        loqry.Next;
      end;
    end;
    loqry.Close;



  finally
    prc_atualiza_painel_totais;
    freeandnil(loqry);
  end;
end;

procedure TfrmRecibosE.prc_incluir_alterar_cheque( operacao : TOperacao;
          conta_bancaria_id :integer; banco, agencia, nr_conta, nr_cheque :string;
          data : TDate; valor: double; historico: string);
var
  loqry : TFDQuery;
begin
//ShowMessage('ENTREI');
  try
    loqry := TFDQuery.Create(application);
    loqry.Connection := conexao;

    loQry.sql.clear;
    if operacao = opExcluir then
    begin
      //loQry.SQL.Add('update RECIBO_ITENS_DINHEIRO set ATIVO = ''N'' where ID =:ID');
      //loQry.ParamByName('ID').AsInteger := Codigo;
      //loQry.ExecSQL;
      exit;
    end;

    if operacao = OpIncluir then
    begin
  //ShowMessage('incluir');
      loQry.SQL.Add('insert into RECIBO_ITENS_CHEQUE ');
      loQry.SQL.Add('(                               ');
      loQry.SQL.Add('  RECIBO_ID,                    ');
      loQry.SQL.Add('  CORRENTISTA_CONTAS_ID,        ');
      loQry.SQL.Add('  BANCO,                        ');
      loQry.SQL.Add('  AGENCIA,                      ');
      loQry.SQL.Add('  NR_CONTA,                     ');
      loQry.SQL.Add('  NR_CHEQUE,                    ');
      loQry.SQL.Add('  DATA,                         ');
      loQry.SQL.Add('  VALOR,                        ');
      loQry.SQL.Add('  HISTORICO                     ');
      loQry.SQL.Add(')                               ');
      loQry.SQL.Add('VALUES                          ');
      loQry.SQL.Add('(                               ');
      loQry.SQL.Add(' :RECIBO_ID,                    ');
      loQry.SQL.Add(' :CORRENTISTA_CONTAS_ID,        ');
      loQry.SQL.Add(' :BANCO,                        ');
      loQry.SQL.Add(' :AGENCIA,                      ');
      loQry.SQL.Add(' :NR_CONTA,                     ');
      loQry.SQL.Add(' :NR_CHEQUE,                    ');
      loQry.SQL.Add(' :DATA,                         ');
      loQry.SQL.Add(' :VALOR,                        ');
      loQry.SQL.Add(' :HISTORICO                     ');
      loQry.SQL.Add(')                               ');
      loQry.ParamByName('RECIBO_ID').AsInteger := Codigo;

    end else
    if operacao = opAlterar then
    begin
      loQry.SQL.Add('UPDATE                                           ');
      loQry.SQL.Add('RECIBO_ITENS_CHEQUE                              ');
      loQry.SQL.Add('SET                                              ');
      loQry.SQL.Add('  CORRENTISTA_CONTAS_ID = :CORRENTISTA_CONTAS_ID,');
      loQry.SQL.Add('  BANCO                 = :BANCO,                ');
      loQry.SQL.Add('  AGENCIA               = :AGENCIA,              ');
      loQry.SQL.Add('  CONTA                 = :CONTA,                ');
      loQry.SQL.Add('  NR_CHEQUE             = :NR_CHEQUE,            ');
      loQry.SQL.Add('  DATA                  = :DATA,                 ');
      loQry.SQL.Add('  VALOR                 = :VALOR,                ');
      loQry.SQL.Add('  HISTORICO             = :HISTORICO             ');
      loQry.SQL.Add('WHERE                                            ');
      loQry.SQL.Add('  ID  = :ID                                      ');
      //
      loQry.ParamByName('ID').AsInteger := Codigo;

    end;

    loQry.ParamByName('CORRENTISTA_CONTAS_ID').AsInteger := conta_bancaria_id;
    loQry.ParamByName('BANCO').asstring       := banco;
    loQry.ParamByName('AGENCIA').asstring     := agencia;
    loQry.ParamByName('NR_CONTA').asstring    := nr_conta;
    loQry.ParamByName('NR_CHEQUE').asstring   := nr_cheque;
    loQry.ParamByName('DATA').AsDate          := data;
    loQry.ParamByName('VALOR').AsFloat        := valor;
    loQry.ParamByName('HISTORICO').asstring   := historico;

    loQry.ExecSQL;
  finally
    freeandnil( loQry );
  end;
end;

procedure TfrmRecibosE.prc_incluir_alterar_cartao( operacao : TOperacao; data_venda:TDate;
          cartao_operadoras_id :integer; cartao_bandeira_id : integer; cartao_taxas_itens_id :integer;
          qtde_parcelas: integer; taxa :double; valor_venda :double ;valor_liquido :double ;cv :string);
var
  loqry : TFDQuery;
begin
//ShowMessage('ENTREI');
  try
    loqry := TFDQuery.Create(application);
    loqry.Connection := conexao;

    loQry.sql.clear;
    if operacao = opExcluir then
    begin

      //loQry.SQL.Add('update RECIBO_ITENS_DINHEIRO set ATIVO = ''N'' where ID =:ID');
      //loQry.ParamByName('ID').AsInteger := Codigo;
      //loQry.ExecSQL;
      exit;

    end;

    if operacao = OpIncluir then
    begin
  //ShowMessage('incluir');
      loQry.SQL.Add('insert into RECIBO_ITENS_CARTAO ');
      loQry.SQL.Add('(                               ');
      loQry.SQL.Add('  RECIBO_ID,                    ');
      loQry.SQL.Add('  DATA_VENDA,                   ');
      loQry.SQL.Add('  CARTAO_OPERADORAS_ID,         ');
      loQry.SQL.Add('  BANDEIRAS_ID,                 ');
      loQry.SQL.Add('  CARTAO_TAXAS_ITENS_ID,        ');
      loQry.SQL.Add('  QTDE_PARCELAS,                ');
      loQry.SQL.Add('  TAXA,                         ');
      loQry.SQL.Add('  VALOR_VENDA,                  ');
      loQry.SQL.Add('  VALOR_LIQUIDO,                ');
      loQry.SQL.Add('  CV                            ');
      loQry.SQL.Add(')                               ');
      loQry.SQL.Add('VALUES                          ');
      loQry.SQL.Add('(                               ');
      loQry.SQL.Add(' :RECIBO_ID,                    ');
      loQry.SQL.Add(' :DATA_VENDA,                   ');
      loQry.SQL.Add(' :CARTAO_OPERADORAS_ID,         ');
      loQry.SQL.Add(' :BANDEIRAS_ID,                 ');
      loQry.SQL.Add(' :CARTAO_TAXAS_ITENS_ID,        ');
      loQry.SQL.Add(' :QTDE_PARCELAS,                ');
      loQry.SQL.Add(' :TAXA,                         ');
      loQry.SQL.Add(' :VALOR_VENDA,                  ');
      loQry.SQL.Add(' :VALOR_LIQUIDO,                ');
      loQry.SQL.Add(' :CV                            ');
      loQry.SQL.Add(')                               ');
      loQry.ParamByName('RECIBO_ID').AsInteger := Codigo;
    end else
    if operacao = opAlterar then
    begin
      loQry.SQL.Add('UPDATE                                           ');
      loQry.SQL.Add('RECIBO_ITENS_CARTAO                              ');
      loQry.SQL.Add('SET                                              ');
      loQry.SQL.Add('  DATA_VENDA            = :DATA_VENDA,           ');
      loQry.SQL.Add('  CARTAO_OPERADORAS_ID  = :CARTAO_OPERADORAS_ID, ');
      loQry.SQL.Add('  BANDEIRAS_ID          = :BANDEIRAS_ID,         ');
      loQry.SQL.Add('  CARTAO_TAXAS_ITENS_ID = :CARTAO_TAXAS_ITENS_ID,');
      loQry.SQL.Add('  QTDE_PARCELAS         = :QTDE_PARCELAS,        ');
      loQry.SQL.Add('  TAXA                  = :TAXA,                 ');
      loQry.SQL.Add('  VALOR_VENDA           = :VALOR_VENDA,          ');
      loQry.SQL.Add('  VALOR_LIQUIDO         = :VALOR_LIQUIDO,        ');
      loQry.SQL.Add('  CV                    = :CV                    ');
      loQry.SQL.Add('WHERE                                            ');
      loQry.SQL.Add('  ID  = :ID                                      ');
      //
      loQry.ParamByName('ID').AsInteger := Codigo;

    end;

    loQry.ParamByName('DATA_VENDA').AsDate              := data_venda;
    loQry.ParamByName('CARTAO_OPERADORAS_ID').AsInteger := cartao_operadoras_id;
    loQry.ParamByName('BANDEIRAS_ID').AsInteger         := cartao_bandeira_id;
    loQry.ParamByName('CARTAO_TAXAS_ITENS_ID').AsInteger:= cartao_taxas_itens_id;
    loQry.ParamByName('QTDE_PARCELAS').AsInteger        := qtde_parcelas;
    loQry.ParamByName('TAXA').AsFloat                   := taxa;
    loQry.ParamByName('VALOR_VENDA').AsFloat            := valor_venda;
    loQry.ParamByName('VALOR_LIQUIDO').AsFloat          := valor_liquido;
    loQry.ParamByName('CV').asstring                    := cv;

    loQry.ExecSQL;
  finally
    freeandnil( loQry );
  end;
end;

procedure TfrmRecibosE.prc_incluir_alterar_contas_pagar( operacao : TOperacao;
          contas_pagar_id :integer; historico: string; valor_parcela :double;
          valor_pago :double; baixar :double);
var
  loqry : TFDQuery;
begin
  try
    loqry := TFDQuery.Create(application);
    loqry.Connection := conexao;

    loQry.sql.clear;
    if operacao = opExcluir then
    begin

      //loQry.SQL.Add('update RECIBO_ITENS_CONTA_PAGAR set ATIVO = ''N'' where ID =:ID');
      //loQry.ParamByName('ID').AsInteger := Codigo;
      //loQry.ExecSQL;
      exit;

    end;

    if operacao = OpIncluir then
    begin
  //ShowMessage('incluir');
      loQry.SQL.Add('insert into RECIBO_ITENS_CONTA_PAGAR ');
      loQry.SQL.Add('(                          ');
      loQry.SQL.Add('  RECIBO_ID,               ');
      loQry.SQL.Add('  CONTAS_PAGAR_ID,         ');
      loQry.SQL.Add('  HISTORICO,               ');
      loQry.SQL.Add('  VALOR_PARCELA,           ');
      loQry.SQL.Add('  VALOR_PAGO,              ');
      loQry.SQL.Add('  BAIXAR                   ');
      loQry.SQL.Add(')                          ');
      loQry.SQL.Add('VALUES                     ');
      loQry.SQL.Add('(                          ');
      loQry.SQL.Add(' :RECIBO_ID,               ');
      loQry.SQL.Add(' :CONTAS_PAGAR_ID,         ');
      loQry.SQL.Add(' :HISTORICO,               ');
      loQry.SQL.Add(' :VALOR_PARCELA,           ');
      loQry.SQL.Add(' :VALOR_PAGO,              ');
      loQry.SQL.Add(' :BAIXAR                   ');
      loQry.SQL.Add(')                          ');
      loQry.ParamByName('RECIBO_ID').AsInteger := Codigo;
    end else
    if operacao = opAlterar then
    begin
      loQry.SQL.Add('UPDATE                                 ');
      loQry.SQL.Add('RECIBO_ITENS_CONTA_PAGAR               ');
      loQry.SQL.Add('SET                                    ');
      loQry.SQL.Add('  CONTAS_PAGAR_ID  = :CONTAS_PAGAR_ID, ');
      loQry.SQL.Add('  HISTORICO        = :HISTORICO,       ');
      loQry.SQL.Add('  VALOR_PARCELA    = :VALOR_PARCELA,   ');
      loQry.SQL.Add('  VALOR_PAGO       = :VALOR_PAGO,      ');
      loQry.SQL.Add('  BAIXAR           = :BAIXAR           ');
      loQry.SQL.Add('WHERE                                  ');
      loQry.SQL.Add('  ID  = :ID                            ');
      //
      loQry.ParamByName('ID').AsInteger := Codigo;

    end;

    loQry.ParamByName('CONTAS_PAGAR_ID').AsInteger := contas_pagar_id;
    loQry.ParamByName('HISTORICO').AsString        := historico;
    loQry.ParamByName('VALOR_PARCELA').AsFloat     := valor_parcela;
    loQry.ParamByName('VALOR_PAGO').AsFloat        := valor_pago;
    loQry.ParamByName('BAIXAR').AsFloat            := baixar;

    loQry.ExecSQL;
  finally
    freeandnil( loQry );
  end;
end;

procedure TfrmRecibosE.prc_incluir_alterar_contas_receber( operacao : TOperacao;
          contas_receber_id :integer; historico: string; valor_parcela :double;
          valor_pago :double; baixar :double);
var
  loqry : TFDQuery;
begin
//ShowMessage('ENTREI');
  try
    loqry := TFDQuery.Create(application);
    loqry.Connection := conexao;

    loQry.sql.clear;
    if operacao = opExcluir then
    begin

      //loQry.SQL.Add('update RECIBO_ITENS_CONTAS_RECEBER set ATIVO = ''N'' where ID =:ID');
      //loQry.ParamByName('ID').AsInteger := Codigo;
      //loQry.ExecSQL;
      exit;

    end;

    if operacao = OpIncluir then
    begin
  //ShowMessage('incluir');
      loQry.SQL.Add('insert into RECIBO_ITENS_CONTAS_RECEBER ');
      loQry.SQL.Add('(                          ');
      loQry.SQL.Add('  RECIBO_ID,               ');
      loQry.SQL.Add('  CONTAS_RECEBER_ID,       ');
      loQry.SQL.Add('  HISTORICO,               ');
      loQry.SQL.Add('  VALOR_PARCELA,           ');
      loQry.SQL.Add('  VALOR_PAGO,              ');
      loQry.SQL.Add('  BAIXAR                   ');
      loQry.SQL.Add(')                          ');
      loQry.SQL.Add('VALUES                     ');
      loQry.SQL.Add('(                          ');
      loQry.SQL.Add(' :RECIBO_ID,               ');
      loQry.SQL.Add(' :CONTAS_RECEBER_ID,       ');
      loQry.SQL.Add('  :HISTORICO,              ');
      loQry.SQL.Add(' :VALOR_PARCELA,           ');
      loQry.SQL.Add(' :VALOR_PAGO,              ');
      loQry.SQL.Add(' :BAIXAR                   ');
      loQry.SQL.Add(')                          ');
      loQry.ParamByName('RECIBO_ID').AsInteger := Codigo;
    end else
    if operacao = opAlterar then
    begin
      loQry.SQL.Add('UPDATE                                     ');
      loQry.SQL.Add('RECIBO_ITENS_CONTAS_RECEBER                ');
      loQry.SQL.Add('SET                                        ');
      loQry.SQL.Add('  CONTAS_RECEBER_ID  = :CONTAS_RECEBER_ID, ');
      loQry.SQL.Add('  HISTORICO   = :HISTORICO,                ');
      loQry.SQL.Add('  VALOR_PARCELA    = :VALOR_PARCELA,       ');
      loQry.SQL.Add('  VALOR_PAGO       = :VALOR_PAGO,          ');
      loQry.SQL.Add('  BAIXAR           = :BAIXAR               ');
      loQry.SQL.Add('WHERE                                      ');
      loQry.SQL.Add('  ID  = :ID                                ');
      //
      loQry.ParamByName('ID').AsInteger := Codigo;

    end;

    loQry.ParamByName('CONTAS_RECEBER_ID').AsInteger := contas_receber_id;
    loQry.ParamByName('HISTORICO').AsString          := historico;
    loQry.ParamByName('VALOR_PARCELA').AsFloat       := valor_parcela;
    loQry.ParamByName('VALOR_PAGO').AsFloat          := valor_pago;
    loQry.ParamByName('BAIXAR').AsFloat              := baixar;

    loQry.ExecSQL;
  finally
    freeandnil( loQry );
  end;
end;


procedure TfrmRecibosE.btn_alterar_valor_creditoClick(Sender: TObject);
begin
  try
    if frmRecibosAlterarValorConta = nil then
      frmRecibosAlterarValorConta := TfrmRecibosAlterarValorConta.Create(application);
    // passar paramentros
    frmRecibosAlterarValorConta.lbl_pessoa.Caption        := cbx_pessoa.Text;
    frmRecibosAlterarValorConta.lbl_nr_documento.Caption  := mtb_conta_pagar.FieldByName('NR_DOCUMENTO').AsString;
    frmRecibosAlterarValorConta.lbl_historico.Caption     := mtb_conta_pagar.FieldByName('DESCRICAO').AsString;
    frmRecibosAlterarValorConta.lbl_total_parcela.Caption := formatfloat('0.00', mtb_conta_pagar.FieldByName('TOTAL_PARCELA').Asfloat);
    frmRecibosAlterarValorConta.lbl_saldo_aberto.Caption  := formatfloat('0.00', mtb_conta_pagar.FieldByName('TOTAL_PARCELA').Asfloat - mtb_conta_pagar.FieldByName('VALOR_PAGO').Asfloat );
    //frmRecibosAlterarValorConta.edt_baixar.Text           := formatfloat('0.00', mtb_conta_pagar.FieldByName('TOTAL_PARCELA').Asfloat - mtb_conta_pagar.FieldByName('VALOR_PAGO').Asfloat );
    // sugestão de pagamento...
    frmRecibosAlterarValorConta.edt_baixar.Text := formatfloat('0.00', mtb_conta_pagar.FieldByName('TOTAL_PARCELA').Asfloat - StrToFloat(pnl_saldo.Caption) );

    //chama o formulario de alteração
    frmRecibosAlterarValorConta.ShowModal;
    // se confirmado, faz as alterações
    if frmRecibosAlterarValorConta.p_confirmado then
    begin
      mtb_conta_pagar.Edit;
      mtb_conta_pagar.FieldByName('BAIXAR').AsFloat := strtofloat(frmRecibosAlterarValorConta.edt_baixar.Text) ;
      mtb_conta_pagar.post;
      // atualiza totais
      prc_atualiza_painel_totais
    end;


  finally
    freeandnil(frmRecibosAlterarValorConta);
  end;
end;

procedure TfrmRecibosE.btn_alterar_valor_debitoClick(Sender: TObject);
begin
  try
    if frmRecibosAlterarValorConta = nil then
      frmRecibosAlterarValorConta := TfrmRecibosAlterarValorConta.Create(application);
    // passar paramentros
    frmRecibosAlterarValorConta.lbl_pessoa.Caption        := cbx_pessoa.Text;
    frmRecibosAlterarValorConta.lbl_nr_documento.Caption  := mtb_conta_receber.FieldByName('NR_DOCUMENTO').AsString;
    frmRecibosAlterarValorConta.lbl_historico.Caption     := mtb_conta_receber.FieldByName('DESCRICAO').AsString;
    frmRecibosAlterarValorConta.lbl_total_parcela.Caption := formatfloat('0.00', mtb_conta_receber.FieldByName('TOTAL_PARCELA').Asfloat);
    frmRecibosAlterarValorConta.lbl_saldo_aberto.Caption  := formatfloat('0.00', mtb_conta_receber.FieldByName('TOTAL_PARCELA').Asfloat - mtb_conta_receber.FieldByName('VALOR_PAGO').Asfloat );
    frmRecibosAlterarValorConta.edt_baixar.Text           := formatfloat('0.00', mtb_conta_receber.FieldByName('TOTAL_PARCELA').Asfloat - mtb_conta_receber.FieldByName('VALOR_PAGO').Asfloat );

    //chama o formulario de alteração
    frmRecibosAlterarValorConta.ShowModal;
    // se confirmado, faz as alterações
    if frmRecibosAlterarValorConta.p_confirmado then
    begin
      mtb_conta_receber.Edit;
      mtb_conta_receber.FieldByName('BAIXAR').AsFloat := strtofloat(frmRecibosAlterarValorConta.edt_baixar.Text) ;
      mtb_conta_receber.post;
      // atualiza totais
      prc_atualiza_painel_totais
    end;


  finally
    freeandnil(frmRecibosAlterarValorConta);
  end;

end;

procedure TfrmRecibosE.btn_excluir_cartaoClick(Sender: TObject);
begin
  inherited;
  mtb_cartao.Delete;
end;

procedure TfrmRecibosE.btn_excluir_chequeClick(Sender: TObject);
begin
  inherited;
  mtb_cheque_cliente.Delete;
end;

procedure TfrmRecibosE.btn_excluir_conta_pagarClick(Sender: TObject);
begin
  mtb_conta_pagar.Delete;
  prc_atualiza_painel_totais;

end;

procedure TfrmRecibosE.btn_excluir_conta_receberClick(Sender: TObject);
begin
  mtb_conta_receber.Delete;
  prc_atualiza_painel_totais;

end;

procedure TfrmRecibosE.btn_excluir_dinheiroClick(Sender: TObject);
begin
  inherited;
  mtb_dinheiro.Delete;
end;

procedure TfrmRecibosE.btn_fecharClick(Sender: TObject);
begin
  inherited;
  close;
end;

procedure TfrmRecibosE.btn_incluir_conta_receberClick(Sender: TObject);
begin
  try
    if frmPesquisaContas = nil then
      frmPesquisaContas := TfrmPesquisaContas.Create(application);

    if cbx_pessoa.Text = '' then
    begin
      CriarMensagem('AVISO','INFORME UMA PESSOA.');
      cbx_pessoa.SetFocus;
      exit;
    end;


    // passa a pessoa como parametro
    frmPesquisaContas.p_pessoa_id        := cbx_pessoa.KeyValue;
    frmPesquisaContas.lbl_pessoa.Caption := cbx_pessoa.text;
    frmPesquisaContas.lbl_titulo.Caption := 'CONSULTA CONTAS A RECEBER DO CLIENTE';
    frmPesquisaContas.p_R_OU_P           := 'R';

     frmPesquisaContas.ShowModal;

     if frmPesquisaContas.p_confirmado then
     begin
     //  ShowMessage( inttostr( frmPesquisaContas.mtb_contas_selecionadas.RecordCount ));
       mtb_conta_receber.CloneCursor(frmPesquisaContas.p_cds, true);

     end;

  finally
    prc_atualiza_painel_totais;
    freeandnil( frmPesquisaContas );
  end;
end;

procedure TfrmRecibosE.btn_incluir_dinheiroClick(Sender: TObject);
begin
  inherited;
  edt_valor_dinheiro.Text := '0';
  edt_obs_dinheiro.Text   := '';
  gbx_entrada_dinheiro.Visible := true;



end;

procedure TfrmRecibosE.btn_incluir_cartaoClick(Sender: TObject);
begin
  try
    if frmCartaoVendasE = nil then
      frmCartaoVendasE := TfrmCartaoVendasE.Create(application);

    frmCartaoVendasE.p_somente_leitura := TRUE;
    frmCartaoVendasE.Operacao := utipos.OpIncluir;
    frmCartaoVendasE.ShowModal;

    if frmCartaoVendasE.p_confirmado = true then
    begin
    //ShowMessage(inttostr(frmCartaoVendasE.p_taxa_id));
    // incluir no memtable
      mtb_cartao.Append;
      mtb_cartao.FieldByName('ID').AsInteger                    := -1;
      mtb_cartao.FieldByName('CADASTRADO_EM').AsDateTime        := date;
      mtb_cartao.FieldByName('DATA_VENDA').AsDateTime           := frmCartaoVendasE.dtp_data_venda.DATE;
      mtb_cartao.FieldByName('CARTAO_OPERADORA_ID').AsInteger   := frmCartaoVendasE.cbx_operadora.KeyValue;
      mtb_cartao.FieldByName('NM_OEPRADORA').AsString           := frmCartaoVendasE.p_nm_operadora;
      mtb_cartao.FieldByName('CARTAO_MAQUINA_ID').AsInteger     := frmCartaoVendasE.cbx_nr_maquina.KeyValue;
      mtb_cartao.FieldByName('CARTAO_BANDEIRA_ID').AsInteger    := frmCartaoVendasE.cbx_desc_bandeira.KeyValue;
      mtb_cartao.FieldByName('NM_BANDEIRA').AsString            := frmCartaoVendasE.p_nm_bandeira;
      mtb_cartao.FieldByName('CARTAO_FORMA_PAGTO_ID').AsInteger := frmCartaoVendasE.cbx_desc_forma_pagamento.KeyValue;
      mtb_cartao.FieldByName('QTDE_PARCELAS').AsInteger         := frmCartaoVendasE.p_qtde_parcelas;
      // quando usar maquina de terceiro, guardar -1 no banco
      mtb_cartao.FieldByName('TAXA_ID').AsInteger               := ubiblioteca.SeSenao( frmCartaoVendasE.p_taxa_id <= 0, -1, frmCartaoVendasE.p_taxa_id) ;
      mtb_cartao.FieldByName('TAXA').AsFloat                    := strtofloat(frmCartaoVendasE.edt_taxa.Text);
      mtb_cartao.FieldByName('VALOR_VENDA').AsFloat             := strtofloat(frmCartaoVendasE.edt_vr_venda.Text);
      mtb_cartao.FieldByName('VALOR_LIQUIDO').AsFloat           := strtofloat(frmCartaoVendasE.edt_vr_liquido.Text);
      mtb_cartao.FieldByName('CV').AsString                     := frmCartaoVendasE.edt_cv.Text;
      mtb_cartao.FieldByName('PROPRIETARIO_ID').AsInteger       := frmCartaoVendasE.p_proprietario_id;// dono da máquina

      mtb_cartao.Post;
      prc_atualiza_painel_totais;

    end;


  finally
    freeandnil(frmCartaoVendasE);
  end;
end;

procedure TfrmRecibosE.btn_incluir_chequeClick(Sender: TObject);
begin
  try
    if frmChequesClientesE = nil then
      frmChequesClientesE := TfrmChequesClientesE.Create(application);

    frmChequesClientesE.p_somente_leitura := TRUE;
    frmChequesClientesE.Operacao := utipos.OpIncluir;
    frmChequesClientesE.ShowModal;

    if frmChequesClientesE.p_confirmado = true then
    begin

    // incluir no memtable
      mtb_cheque_cliente.Append;
      mtb_cheque_cliente.FieldByName('ID').AsInteger               := -1;
      mtb_cheque_cliente.FieldByName('CADASTRADO_EM').AsDateTime   := date;
      mtb_cheque_cliente.FieldByName('CORRENTISTA_CONTA_ID').AsInteger := strtoint(frmChequesClientesE.pnl_id_conta.Caption);
      mtb_cheque_cliente.FieldByName('BANCO').AsString             := frmChequesClientesE.pnl_nr_banco.Caption;
      mtb_cheque_cliente.FieldByName('AGENCIA').AsString           := frmChequesClientesE.pnl_nr_agencia.Caption;
      mtb_cheque_cliente.FieldByName('NR_CHEQUE').AsString         := frmChequesClientesE.edt_nr_cheque.Text;
      mtb_cheque_cliente.FieldByName('CONTA').AsString             := frmChequesClientesE.pnl_nr_conta.Caption;
      mtb_cheque_cliente.FieldByName('PRE_DATADO_PARA').AsDateTime := frmChequesClientesE.dtp_data_cheque.Date;
      mtb_cheque_cliente.FieldByName('VALOR').AsFloat              := strtofloat(frmChequesClientesE.edt_valor.Text);
      mtb_cheque_cliente.FieldByName('REPASSADO').AsString         := 'N';
      mtb_cheque_cliente.FieldByName('RECIBO_ID').AsInteger        := -1;
      mtb_cheque_cliente.FieldByName('HISTORICO').AsString         := frmChequesClientesE.edt_histórico.Text;
      mtb_cheque_cliente.Post;

      prc_atualiza_painel_totais;
    end;

  finally
    freeandnil(frmChequesClientesE);
  end;
end;

procedure TfrmRecibosE.btn_incluir_conta_pagarClick(Sender: TObject);
var
  loqry : TFDQuery;
begin
  try
    if frmPesquisaContas = nil then
      frmPesquisaContas := TfrmPesquisaContas.Create(application);

    if cbx_pessoa.Text = '' then
    begin
      CriarMensagem('AVISO','INFORME UMA PESSOA.');
      cbx_pessoa.SetFocus;
      exit;
    end;


    // passa a pessoa como parametro
    frmPesquisaContas.p_R_OU_P           := 'P'; //contas a pagar
    frmPesquisaContas.lbl_titulo.Caption := 'CONSULTA CONTAS A PAGAR DO CLIENTE';
    frmPesquisaContas.p_pessoa_id        := cbx_pessoa.KeyValue;
    frmPesquisaContas.lbl_pessoa.Caption := cbx_pessoa.text;

     frmPesquisaContas.ShowModal;

     if frmPesquisaContas.p_confirmado then
     begin
       // localizar a conta a pagar
       loqry := TFDQuery.create(application);
       loqry.Connection := conexao;
       loqry.SQL.Clear;
       loqry.SQL.Add('select id, nr_documento, descricao, total_parcela, valor_pago from contas_pagar where id =:conta_id');
       loqry.ParamByName('conta_id').AsInteger := frmPesquisaContas.p_conta_id;
       loqry.Open;

       // ver duplicidade
       mtb_conta_pagar.First;
       if mtb_conta_pagar.Locate('ID', loqry.FieldByName('id').AsInteger, []) then
       begin
         unit_funcoes.criarmensagem('AVISO','DUPLICIDADE!' + slinebreak + slinebreak +
                                   'CONTA JÁ FOI SELECIONA.');
         exit;
       end else
       begin
         // incluir a conta na grid
         mtb_conta_pagar.insert;
         mtb_conta_pagar.FieldByName('id').AsInteger          := loqry.FieldByName('id').AsInteger;
         mtb_conta_pagar.FieldByName('nr_documento').Asstring := loqry.FieldByName('nr_documento').Asstring;
         mtb_conta_pagar.FieldByName('descricao').Asstring    := loqry.FieldByName('descricao').Asstring;
         mtb_conta_pagar.FieldByName('total_parcela').Asfloat := loqry.FieldByName('total_parcela').Asfloat;
         mtb_conta_pagar.FieldByName('valor_pago').Asfloat    := loqry.FieldByName('valor_pago').Asfloat;
         mtb_conta_pagar.FieldByName('baixar').Asfloat        := loqry.FieldByName('total_parcela').Asfloat - loqry.FieldByName('valor_pago').Asfloat;
         mtb_conta_pagar.post;
         prc_atualiza_painel_totais;
       end;
     end;
  finally
    freeandnil( loqry );
    freeandnil( frmPesquisaContas );
  end;
end;

procedure TfrmRecibosE.cbx_bancosCloseUp(Sender: TObject);
begin
  inherited;
  qry_contas_bancarias.Close;
  qry_contas_bancarias.ParamByName('banco_id').AsInteger := qry_bancos.FieldByName('id').AsInteger;
  qry_contas_bancarias.open;

end;

procedure TfrmRecibosE.cbx_pessoaCloseUp(Sender: TObject);
begin
  inherited;

  {zera da memoria caso o usuario troque de pessoa}
  mtb_conta_pagar.Close;
  mtb_conta_receber.Close;

  //abre para garantir que esteja vazia
  mtb_conta_pagar.open;
  mtb_conta_receber.open;

end;

procedure TfrmRecibosE.ds_cartaoDataChange(Sender: TObject; Field: TField);
begin
  inherited;
  btn_excluir_cartao.Enabled := not mtb_cartao.IsEmpty;
end;

procedure TfrmRecibosE.ds_cheque_clienteDataChange(Sender: TObject;
  Field: TField);
begin
  inherited;
  btn_excluir_cheque.Enabled := not mtb_cheque_cliente.IsEmpty;

end;

procedure TfrmRecibosE.ds_contas_pagarDataChange(Sender: TObject;
  Field: TField);
begin
  btn_excluir_conta_pagar.Enabled   := not mtb_conta_pagar.IsEmpty;
  btn_alterar_valor_credito.Enabled := not mtb_conta_pagar.IsEmpty;
end;

procedure TfrmRecibosE.ds_conta_receberDataChange(Sender: TObject;
  Field: TField);
begin
  btn_excluir_conta_receber.Enabled := not mtb_conta_receber.IsEmpty;
  btn_alterar_valor_debito.Enabled  := not mtb_conta_receber.IsEmpty;
end;

procedure TfrmRecibosE.ds_dinheiroDataChange(Sender: TObject; Field: TField);
begin
  inherited;
  btn_excluir_dinheiro.Enabled := not mtb_dinheiro.IsEmpty;
end;

procedure TfrmRecibosE.edt_valor_dinheiroExit(Sender: TObject);
begin
  inherited;
  ubiblioteca.prc_formata_dinheiro(sender);
  btn_dinheiro_confirma.Enabled :=  strtofloat(edt_valor_dinheiro.Text) > 0;

end;

procedure TfrmRecibosE.edt_valor_dinheiroKeyPress(Sender: TObject;
  var Key: Char);
begin
  inherited;
  ubiblioteca.prc_somente_numeros(sender, key);
end;

procedure TfrmRecibosE.edt_valor_pixExit(Sender: TObject);
begin
  ubiblioteca.prc_formata_dinheiro(sender);

  prc_atualiza_painel_totais;

end;

procedure TfrmRecibosE.edt_valor_pixKeyPress(Sender: TObject; var Key: Char);
begin
  ubiblioteca.prc_somente_numeros(sender, key);
end;

procedure TfrmRecibosE.FormCreate(Sender: TObject);
begin
  inherited;
  tabela := 'RECIBOS';
  titulo := 'RECIBO DE PAGAMENTO DE PEDIDOS';
end;

procedure TfrmRecibosE.FormShow(Sender: TObject);
begin
  inherited;
  prc_componentes;
  prc_inicializar;

end;

procedure TfrmRecibosE.prc_atualiza_painel_totais;

var
  total_em_cheques        : double;
  total_em_cartoes        : double;
  total_em_contas_pagar   : double;
  total_em_contas_receber : double;
begin

   total_em_cheques      := uBiblioteca.SeSenao( mtb_cheque_cliente.IsEmpty, 0, mtb_cheque_cliente.FieldByName('TOTAL').value);
   total_em_cartoes      := uBiblioteca.SeSenao( mtb_cartao.IsEmpty, 0, mtb_cartao.FieldByName('TOTAL').value);
   total_em_contas_pagar := uBiblioteca.SeSenao( mtb_conta_pagar.IsEmpty, 0, mtb_conta_pagar.FieldByName('TOTAL').value);

   pnl_dinheiro.Caption := FormatFloat('0.00', mtb_dinheiro.FieldByName('TOTAL').Value);
   pnl_pix.Caption      := edt_valor_pix.Text;
   pnl_cheques.Caption  := FormatFloat('0.00',  total_em_cheques);
   pnl_cartao_credito.Caption  := FormatFloat('0.00',  total_em_cartoes);
   pnl_contas_pagar.Caption    := FormatFloat('0.00',  total_em_contas_pagar);

   // totais
   pnl_total_creditos.caption := formatfloat('0.00',
                                strtofloat(edt_valor_dinheiro.Text)
                              + strtofloat(edt_valor_pix.text)
                              + total_em_cheques
                              + total_em_cartoes
                              + total_em_contas_pagar
                              );
   if strtofloat(pnl_total_creditos.caption) > 0 then
     pnl_total_creditos.Font.Size := 18 else
       pnl_total_creditos.Font.Size := 10 ;

   // contas a receber
   total_em_contas_receber := 0;
   if not mtb_conta_receber.IsEmpty then
   begin
     mtb_conta_receber.First;
     while not mtb_conta_receber.eof do
     begin
       total_em_contas_receber := total_em_contas_receber +
                                 mtb_conta_receber.FieldByName('baixar').AsFloat;
       mtb_conta_receber.Next;
     end;
   end;
   pnl_contas_receber.Caption :=  formatfloat('0.00', total_em_contas_receber );
   if strtofloat(pnl_contas_receber.caption) > 0 then
   begin
     pnl_contas_receber.Font.Size := 18 ;
     pnl_contas_receber.Font.Color := clred;
   end else
   begin
     pnl_contas_receber.Font.Size := 10 ;
     pnl_contas_receber.Font.Color := clBlack;
   end;

   {saldo}
   pnl_saldo.Caption :=formatfloat('0.00',   strtofloat(pnl_total_creditos.caption) - strtofloat(pnl_contas_receber.caption) );
end;

procedure TfrmRecibosE.prc_componentes;
begin
  qry.Connection := conexao;
  qry.Open;

  qry_bancos.Connection := conexao;
  qry_bancos.open;

  qry_contas_bancarias.Connection := conexao;

  dbg_cheques.Columns[0].Visible := false;
  dbg_cheques.Columns[1].Visible := false;
  dbg_cheques.Columns[2].Visible := false;
  dbg_cheques.Columns[9].Visible := false;
  dbg_cheques.Columns[10].Visible := false;

  dbg_cartao.Columns[0].Visible := false;  // id
  dbg_cartao.Columns[1].Visible := false;  // cadastrado_em
  dbg_cartao.Columns[2].Visible := false;  // alterado_em
  dbg_cartao.Columns[4].Visible := false;  // cartao_operadora_id
  dbg_cartao.Columns[6].Visible := false;  // cartao_maquina_id
  dbg_cartao.Columns[7].Visible := false;  // cartao_bandeira_id
  dbg_cartao.Columns[9].Visible := false;  // cartao_forma_pagto_id
  dbg_cartao.Columns[11].Visible := false; // taxa_id
  dbg_cartao.Columns[16].Visible := false; // proprietario_id

  dbg_debitos_cliente.Columns[0].Visible := false; // id
  dbg_debitos_cliente.Columns[6].Visible := false; // tabela origem


end;

procedure TfrmRecibosE.prc_salva_entrada_dinheiro(_operacao: TOperacao);
var
  loqry :TFDQuery;
begin
  try
    loqry := TFDQuery.Create(application);
    loqry.Connection := conexao;

    loqry.sql.clear;
    if _operacao = opExcluir then
    begin
      (*
      loqry.SQL.Add('update ' + Tabela + ' set ATIVO = ''N'' where ID =:ID');
      loqry.ParamByName('ID').AsInteger := Codigo;
      loqry.ExecSQL;
      exit;
      *)
      if CriarMensagem('DELETE','DESEJA EXCLUIR ESTE LANÇAMENTO?') then
      begin
        loqry.SQL.Add('delete from DINHEIRO_ENTRADA where ID =:ID');
        loqry.ParamByName('ID').AsInteger := Codigo;
        loqry.ExecSQL;
      end;
      exit;

    end;

    if _operacao = OpIncluir then
    begin
  //ShowMessage('incluir');
      loqry.SQL.Add('insert into DINHEIRO_ENTRADA' );  // DINHEIRO_ENTRADA
      loqry.SQL.Add('(');
      loqry.SQL.Add('  CADASTRADO_EM, ');
      loqry.SQL.Add('  VALOR,         ');
      loqry.SQL.Add('  OBS,           ');
      loqry.SQL.Add('  RECIBO_ID      ');
      loqry.SQL.Add(')                ');
      loqry.SQL.Add('VALUES           ');
      loqry.SQL.Add('(                ');
      loqry.SQL.Add(' :CADASTRADO_EM, ');
      loqry.SQL.Add(' :VALOR,         ');
      loqry.SQL.Add(' :OBS,           ');
      loqry.SQL.Add(' :RECIBO_ID      ');
      loqry.SQL.Add(')                ');
     // loqry.SQL.Add('returning ID     ');

      loqry.ParamByName('CADASTRADO_EM').AsDate := Date;
    end
    else
    if _operacao = opAlterar then
    begin
      loqry.SQL.Add('UPDATE                   ');
      loqry.SQL.Add('DINHEIRO_ENTRADA         ');
      loqry.SQL.Add('SET                      ');
      loqry.SQL.Add('  VALOR     = :VALOR,    ');
      loqry.SQL.Add('  OBS       = :OBS,      ');
      loqry.SQL.Add('  RECIBO_ID = :RECIBO_ID ');
      loqry.SQL.Add('WHERE                    ');
      loqry.SQL.Add('  ID = :ID               ');
      //
      loqry.ParamByName('ID').AsInteger := Codigo;

    end;

    loqry.ParamByName('VALOR').AsFloat := StrToFloatDef(edt_valor_dinheiro.Text,0);
    loqry.ParamByName('OBS').AsString  := edt_obs_dinheiro.Text;
    {-1 será o valor default para entradas avulsas, pois não será viculada a
     nenhum recibo de pagamento}
    loqry.ParamByName('RECIBO_ID').AsInteger := codigo;

    //ShowMessage(loqry.SQL.Text);

(*    if _operacao = opincluir then
    begin
      loqry.Open;
      codigo := loqry.FieldByName('ID').AsInteger;
    end
    else
    if (_operacao = opalterar) or (_operacao = opExcluir) then
    begin *)
      loqry.ExecSQL;
  //  end;

    {incluir lançamento na tabela de dinheiro_movimentacao}
    ufinanceiro.prc_incluir_movimento_caixa('RECIBO', Codigo, 'ENTRADA', edt_obs_dinheiro.Text, StrToFloatDef(edt_valor_dinheiro.Text,0));
  finally
    freeandnil( loqry );
  end;
end;

procedure TfrmRecibosE.prc_salvar_entrada_pix;
var
  loqry: TFDQuery;
begin
  try
    loqry := TFDQuery.Create(self);
    loqry.Connection := conexao;
    loqry.SQL.Add('insert into pix_recebidos ');
    loqry.SQL.Add('( data_pix, contas_bancarias_itens_id, valor, obs ) ');
    loqry.SQL.Add('values ');
    loqry.SQL.Add('( :data_pix, :contas_bancarias_itens_id, :valor, :obs )');
    loqry.parambyname('data_pix').AsDate := Date;
    loqry.parambyname('contas_bancarias_itens_id').AsInteger := cbx_conta_bancaria.KeyValue;
    loqry.parambyname('valor').AsFloat := StrToFloat(edt_valor_pix.Text);
    loqry.parambyname('obs').AsString := edt_obs_pix.Text;
    loqry.ExecSQL
  finally
    freeandnil( loqry );
  end;
end;


procedure TfrmRecibosE.prc_salvar_baixa_conta_pagar;
var
 loQry : TFDQuery;
 codigo_baixa: integer;
begin
  try
    loQry := TFDQuery.Create(self);
    loQry.Connection := conexao;

    {faz o lançamento na tabela de contas a pagar baixa}
    loQry.sql.Add('insert into CONTAS_PAGAR_BAIXA');
    loQry.sql.Add('(                             ');
    loQry.sql.Add('  ID,                         ');
    loQry.sql.Add('  CADASTRADO_EM,              ');
    loQry.sql.Add('  CONTAS_PAGAR_ID,            ');
    loQry.sql.Add('  HISTORICO,                  ');
    loQry.sql.Add('  VALOR,                      ');
    loQry.sql.Add('  FORMA_PAGTO,                ');
    loQry.sql.Add('  USUARIO_ID                  ');
    loQry.sql.Add(')                             ');
    loQry.sql.Add('VALUES                        ');
    loQry.sql.Add('(                             ');
    loQry.sql.Add('  :ID,                        ');
    loQry.sql.Add('  :CADASTRADO_EM,             ');
    loQry.sql.Add('  :CONTAS_PAGAR_ID,           ');
    loQry.sql.Add('  :HISTORICO,                 ');
    loQry.sql.Add('  :VALOR,                     ');
    loQry.sql.Add('  :FORMA_PAGTO,               ');
    loQry.sql.Add('  :USUARIO_ID                 ');
    loQry.sql.Add(')                             ');

    codigo_baixa := uBiblioteca.AutoIncremento(conexao, 'CONTAS_PAGAR_BAIXA');
    loQry.ParamByName('ID').AsInteger              := codigo_baixa;
    loQry.ParamByName('CADASTRADO_EM').AsDate      := Date;
    loQry.ParamByName('CONTAS_PAGAR_ID').AsInteger := mtb_conta_pagar.FieldByName('ID').AsInteger;
    loQry.ParamByName('HISTORICO').AsString        := 'BAIXADO CONF. RECIBO N.' + IntToStr(CODIGO);
    loQry.ParamByName('VALOR').AsFloat             := mtb_conta_pagar.FieldByName('BAIXAR').AsFloat;
    loQry.ParamByName('FORMA_PAGTO').AsInteger     := 5;//outros
    loQry.ParamByName('USUARIO_ID').AsInteger      := 3;
    loQry.ExecSQL;

    {atualiza o saldo da conta a pagar principal}
    prc_atualizar_saldo_contas_pagar( mtb_conta_pagar.FieldByName('BAIXAR').AsFloat ) ;

  finally
    FreeAndNil(loQry)
  end;

end;

procedure TfrmRecibosE.prc_atualizar_saldo_contas_pagar(valor_pago: double);
var
  loQry          :TFDQuery;
  oldValorPago   :double;
  oldSaldoAberto :double;
begin
  try
    loQry := TFDQuery.Create(Self);
    loQry.Connection := conexao;

    loQry.sql.Add('select * from CONTAS_PAGAR where ID = :ID');
    loQry.ParamByName('ID').AsInteger := mtb_conta_pagar.FieldByName('ID').AsInteger;
    loQry.Open;

    oldValorPago   := loQry.fieldbyname('VALOR_PAGO').AsFloat;
    oldSaldoAberto := loQry.fieldbyname('SALDO_ABERTO').AsFloat;

    //Atualiza o para o novo valor
    loQry.SQL.Clear;
    loQry.SQL.Add('UPDATE CONTAS_PAGAR                  ');
    loQry.SQL.Add('SET DATA_PAGAMENTO = :DATA_PAGAMENTO,');
    loQry.SQL.Add('  VALOR_PAGO       = :VALOR_PAGO,    ');
    loQry.SQL.Add('  SALDO_ABERTO     = :SALDO_ABERTO,  ');
    loQry.SQL.Add('  PAGO             = :PAGO           ');
    loQry.SQL.Add('WHERE ID           = :ID             ');

    loQry.ParamByName('DATA_PAGAMENTO').AsDate := Date;
    loQry.ParamByName('VALOR_PAGO').AsFloat    := oldValorPago + valor_pago;
    loQry.ParamByName('SALDO_ABERTO').AsFloat  := oldSaldoAberto - valor_pago;
    loQry.ParamByName('PAGO').AsString         := ubiblioteca.SeSenao( (oldSaldoAberto - valor_pago) >= 0.01, 'N','S');
    loQry.ParamByName('ID').AsInteger          := mtb_conta_pagar.FieldByName('ID').AsInteger;
    loQry.ExecSQL;
    //
  finally
    FreeAndNil( loQry );
  end;
end;

procedure TfrmRecibosE.prc_salvar_baixa_conta_receber;
var
  loqry : TFDQuery;
  contas_receber_baixa_id : integer;
begin
  try
    loQry := TFDQuery.Create(Self);
    loQry.Connection := Conexao;
    loQry.SQL.Clear;
    loQry.Sql.Add('INSERT INTO          ');
    loQry.Sql.Add('CONTAS_RECEBER_BAIXA ');
    loQry.Sql.Add('(                    ');
    loQry.Sql.Add('ID,                  ');
    loQry.Sql.Add('CADASTRADO_EM,       ');
    loQry.Sql.Add('CONTAS_RECEBER_ID,   ');
    loQry.Sql.Add('RECIBO_ID,           ');
    loQry.Sql.Add('HISTORICO,           ');
    loQry.Sql.Add('VALOR,               ');
    loQry.Sql.Add('PESSOA_ID,           ');
    loQry.Sql.Add('USUARIO_ID )         ');
    loQry.Sql.Add('values               ');
    loQry.Sql.Add('(                    ');
    loQry.Sql.Add(':ID,                 ');
    loQry.Sql.Add(':CADASTRADO_EM,      ');
    loQry.Sql.Add(':CONTAS_RECEBER_ID,  ');
    loQry.Sql.Add(':RECIBO_ID,          ');
    loQry.Sql.Add(':HISTORICO,          ');
    loQry.Sql.Add(':VALOR,              ');
    loQry.Sql.Add(':PESSOA_ID,          ');
    loQry.Sql.Add(':USUARIO_ID )        ');
    //***
    contas_receber_baixa_id                   := uBiblioteca.AutoIncremento(conexao, 'CONTAS_RECEBER_BAIXA');
    loQry.ParamByName('ID').AsInteger         := contas_receber_baixa_id;
    loQry.ParamByName('CADASTRADO_EM').AsDate := date;
    loQry.ParamByName('CONTAS_RECEBER_ID').AsInteger := mtb_conta_receber.FieldByName('ID').AsInteger;
    loQry.ParamByName('RECIBO_ID').AsInteger  := codigo;
    loQry.ParamByName('HISTORICO').AsString   := 'PAGO CONF. RECIBO N. ' + INTTOSTR( CODIGO );
    loQry.ParamByName('VALOR').AsFloat        := mtb_conta_receber.FieldByName('baixar').AsFloat;
    loQry.ParamByName('PESSOA_ID').AsInteger  := cbx_pessoa.KeyValue;
    loQry.ParamByName('USUARIO_ID').AsInteger := 3;
    loQry.ExecSQL;
  finally
    freeandnil( loqry );
  end;
end;



end.
