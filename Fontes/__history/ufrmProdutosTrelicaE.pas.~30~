unit ufrmProdutosTrelicaE;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseEdicao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.ExtCtrls, Vcl.DBCtrls, Vcl.Mask, uTipos, Vcl.Imaging.pngimage,
  Vcl.ComCtrls;

type
  TfrmProdutosTrelicaE = class(TfrmBaseEdicao)
    GroupBox1: TGroupBox;
    Label4: TLabel;
    Label9: TLabel;
    Label10: TLabel;
    edt_superior: TDBEdit;
    edt_sinozoide: TDBEdit;
    edt_inferior: TDBEdit;
    Label12: TLabel;
    dsDeptos: TDataSource;
    qryDeptos: TFDQuery;
    qryTrelica: TFDQuery;
    dsTrelica: TDataSource;
    Label13: TLabel;
    GroupBox3: TGroupBox;
    Label7: TLabel;
    Label8: TLabel;
    edCusto: TDBEdit;
    edt_preco_venda: TDBEdit;
    Label15: TLabel;
    edt_custo_liquido: TDBEdit;
    Label16: TLabel;
    edPercentual: TDBEdit;
    cbx_altura: TDBComboBox;
    Label5: TLabel;
    Label19: TLabel;
    Label29: TLabel;
    edt_id_departamento: TDBEdit;
    cbxDepartamento: TDBLookupComboBox;
    Label6: TLabel;
    edt_comprimento: TDBEdit;
    Image1: TImage;
    Label11: TLabel;
    cbx_tipo_trelica: TComboBox;
    DBText1: TDBText;
    DBText2: TDBText;
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    edID: TDBText;
    edCadastro: TDBText;
    edAlteracao: TDBText;
    cbAtivo: TDBCheckBox;
    cbEstoqueControlado: TDBCheckBox;
    Label17: TLabel;
    edt_preco_vendedor: TDBEdit;
    Label18: TLabel;
    edt_peso: TDBEdit;
    PageControl1: TPageControl;
    tbs_fiscal: TTabSheet;
    gb_fiscal: TGroupBox;
    Label20: TLabel;
    Label21: TLabel;
    Label22: TLabel;
    Label23: TLabel;
    edClassFis: TDBEdit;
    edSitTrib: TDBEdit;
    edTxICMS: TDBEdit;
    edTxIPI: TDBEdit;
    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure btnOkClick(Sender: TObject);
    procedure edt_descricao_tecnicaExit(Sender: TObject);
    procedure cbx_tipo_trelicaExit(Sender: TObject);
    procedure edPercentualExit(Sender: TObject);
  private
    FOperacao: uTipos.TOperacao;
    FTitulo: string;
    FTabela: string;
    FCodigo: integer;

    procedure Salvar();
    procedure prc_descricao_trelica;
    procedure prc_calcula_custo_linear;

  protected
    procedure Componentes();
    procedure Inicializar();

    procedure LerDados();
    function valida: boolean;
  public
    property Codigo   :integer read FCodigo write FCodigo;
    property Operacao :uTipos.TOperacao read FOperacao write FOperacao;
    property Tabela   :string read FTabela write FTabela;
    property Titulo   :string read FTitulo write FTitulo;
  end;

  procedure Incluir;
  procedure Alterar(ACodigo :integer);
  procedure Excluir(ACodigo :integer);


implementation

uses uBiblioteca;


procedure Incluir;
var
  loForm : TfrmProdutosTrelicaE;
begin
  loForm := TfrmProdutosTrelicaE.Create(Application);
  try
    loForm.Operacao := uTipos.opIncluir;
    loForm.Codigo   := 0;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

procedure Alterar(ACodigo :integer);
var
  loForm : TfrmProdutosTrelicaE;
begin
  loForm := TfrmProdutosTrelicaE.Create(Application);
  try
    loForm.Operacao := uTipos.opAlterar;
    loForm.Codigo   := ACodigo;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

procedure Excluir(ACodigo :integer);
var
  loForm : TfrmProdutosTrelicaE;
begin
  loForm := TfrmProdutosTrelicaE.Create(Application);
  try
    loForm.Operacao := uTipos.opExcluir;
    loForm.Codigo   := ACodigo;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;


{$R *.dfm}



procedure TfrmProdutosTrelicaE.btnOkClick(Sender: TObject);
begin
  inherited;
  Salvar();

end;

procedure TfrmProdutosTrelicaE.Componentes;
begin
  qry.Open('select * from '+ self.Tabela +' where ID = :ID');
  //
  qryDeptos.Open('select * from DEPARTAMENTOS order by NOME');
  //
  qryTrelica.Open('select * from PRODUTOS_TRELICA where PRODUTO_ID =:ID');
end;

procedure TfrmProdutosTrelicaE.edPercentualExit(Sender: TObject);
begin
  inherited;
  prc_calcula_custo_linear;
end;

procedure TfrmProdutosTrelicaE.edt_descricao_tecnicaExit(Sender: TObject);
begin
  inherited;
  prc_descricao_trelica;
end;

procedure TfrmProdutosTrelicaE.FormCreate(Sender: TObject);
begin
  inherited;
  qry.Connection := self.Conexao;
  self.Tabela := 'PRODUTOS';

  qryDeptos.Connection := self.Conexao;

  qryTrelica.Connection := self.Conexao;

end;

procedure TfrmProdutosTrelicaE.FormShow(Sender: TObject);
begin
  inherited;
  Componentes;
  Inicializar;

end;

procedure TfrmProdutosTrelicaE.Inicializar;
begin
  case self.Operacao of
  uTipos.opIncluir: begin
                       pnTitulo.Caption := 'Manuten巫o de Treli網s [Inclus伋]';
                       btnOk     .Caption := 'Incluir';
                       // insert em produtos
                       qry.Insert;
                       qry.FieldByName('ID').AsInteger := ubiblioteca.AutoIncremento(self.Conexao,self.Tabela);
                       qry.FieldByName('DATA_CAD').AsDateTime := Date;
                       qry.FieldByName('ATIVO').AsString := 'S';
                       qry.FieldByName('ESTOQUE_CONTROLADO').AsString := 'N';
                       qry.FieldByName('PRECO_CUSTO').AsFloat := 0;
                       qry.FieldByName('PRECO_VENDA').AsFloat := 0;
                       qry.FieldByName('UNIDADE').AsString := 'PC';
                       //ESTOQUE
                       qry.FieldByName('ESTOQUE_FISICO').AsFloat := 0;
                       qry.FieldByName('PEDIDO_ABERTO').AsFloat := 0;
                       qry.FieldByName('ESTOQUE_DISPONIVEL').AsFloat := 0;
                       qry.FieldByName('PEDIDO_AGUARDANDO').AsFloat := 0;
                       qry.FieldByName('ESTOQUE_LIQUIDO').AsFloat := 0;
                       //CONTROLE DE ESTOQUE
                       qry.FieldByName('PONTO_PEDIDO').AsFloat := 0;
                       qry.FieldByName('QTDE_MIN').AsFloat := 0;
                       qry.FieldByName('QTDE_MAX').AsFloat := 0;
                       qry.FieldByName('TEMPO_REPOSICAO').AsInteger := 0;
                       //FISCAL
                       qry.FieldByName('CLASS_FIS').AsString := '';
                       qry.FieldByName('SIT_TRIB').AsString := '';
                       qry.FieldByName('TX_ICMS').AsFloat := 0;
                       qry.FieldByName('TX_IPI').AsFloat := 0;

                       //**
                       qry.FieldByName('REVENDA').AsString := 'S';
                       qry.FieldByName('MATERIA_PRIMA').AsString := 'S';
                       qry.FieldByName('AGREGADO').AsString := 'N';
                       qry.FieldByName('LAJE').AsString := 'N';
                       qry.FieldByName('VIGA').AsString := 'N';
                       qry.FieldByName('LAJOTA').AsString := 'N';
                       qry.FieldByName('ISOPOR').AsString := 'N';
                       qry.FieldByName('CONCRETO').AsString := 'N';
                       qry.FieldByName('BOMBA').AsString := 'N';
                       qry.FieldByName('VERGALHAO').AsString := 'N';
                       qry.FieldByName('TRELICA').AsString := 'S';
                       qry.FieldByName('PERCA').AsFloat := 0;

                       //**

                       // insert em trelica
                       qryTrelica.Insert;
                       qryTrelica.FieldByName('ID').AsInteger := ubiblioteca.AutoIncremento(self.Conexao,'PRODUTOS_TRELICA');
                       qryTrelica.FieldByName('PRODUTO_ID').AsInteger := qry.FieldByName('ID').AsInteger;
                       //qryTrelica.FieldByName('COMPRIMENTO').AsInteger := 1;
                     end;
  uTipos.opAlterar: begin
                      self.LerDados;
                      pnTitulo.Caption := 'Manuten巫o de Treli網s [Altera巫o]';
                      btnOk.Caption := 'Alterar';
                      //produto
                      qry.Edit;
                      qry.FieldByName('DATA_ALT').AsDateTime := Date;
                      //trelica
                      qryTrelica.Edit;

                      btnOk.SetFocus;
                    end;
  uTipos.opExcluir: begin
                      self.LerDados;
                      pnTitulo.Caption        := 'Manuten巫o de Treli網s [Exclus伋]';
                      pnDados.Enabled   := false;
                      btnOk.Caption := 'Excluir';
                      qry.Edit;
                      qry.FieldByName('ATIVO').AsString := 'N';
                      btnFechar.SetFocus;
                    end;
  else
    begin
      pnDados.Enabled   := false;
      if btnFechar.CanFocus then btnFechar.SetFocus;
    end;
  end;

end;

procedure TfrmProdutosTrelicaE.LerDados;
begin
  uBiblioteca.FilterCds(qry, uTipos.fsInteger, inttostr(self.Codigo));
  uBiblioteca.FilterCds(qryTrelica, uTipos.fsInteger, inttostr(self.Codigo));
  cbx_tipo_trelica.text := qryTrelica.FieldByName('TIPO_TRELICA').AsString;
end;

procedure TfrmProdutosTrelicaE.Salvar;
begin
  case Self.Operacao of

    // Inclus伋
    uTipos.opIncluir :
    begin
      if not Valida then Exit;

      if not Self.Conexao.InTransaction then Self.Conexao.StartTransaction;
      //***
      try
        {Pr鳥imo c祚igo}
        qry.Post;
        //ShowMessage('post em qry');
        qryTrelica.Post;
        if Self.Conexao.InTransaction then Self.Conexao.Commit;

        if Application.MessageBox('Deseja continuar incluindo?','Inclus伋...',MB_YESNO) = mrYES then
          Self.Inicializar
        else
          ModalResult := mrOk;
      except
        ShowMessage('N伋 foi poss仰el salvar o registro');
      end;
    end;

    // Altera巫o
    uTipos.opAlterar :
    begin
      if not Valida then Exit;

      if not Self.Conexao.InTransaction then Self.Conexao.StartTransaction;
      //***
      try
        qry.Post;
        qryTrelica.Post;
        if Self.Conexao.InTransaction then Self.Conexao.Commit;
        ModalResult := mrOk;
      except
        ShowMessage('N伋 foi poss仰el alterar o registro');
      end;
    end;

    //Exclus伋
    uTipos.opExcluir :
    begin
      if Application.MessageBox('Deseja excluir este registro?','Aten巫o',MB_OKCANCEL) = mrOK then
      begin
        if not Self.Conexao.InTransaction then Self.Conexao.StartTransaction;
        try
          //qryPessoas.Delete;
          qry.Post;
          if Self.Conexao.InTransaction then Self.Conexao.Commit;
          ModalResult := mrOk;
        except
          ShowMessage('N伋 foi poss仰el excluir o registro');
        end;
      end; // if
    end;
  end;// case

end;

function TfrmProdutosTrelicaE.valida: boolean;
begin
  result := false;
  if cbx_altura.Text = '' then
  begin
    ShowMessage('Informe a ALTURA da treli網');
    cbx_altura.SetFocus;
    exit;
  end;

  if edt_superior.Text = '' then
  begin
    ShowMessage('Informe a medida do ferro SUPERIOR da treli網');
    edt_superior.SetFocus;
    exit;
  end;

  if edt_sinozoide.Text = '' then
  begin
    ShowMessage('Informe a medida do ferro SINUZ휼DE da treli網');
    edt_sinozoide.SetFocus;
    exit;
  end;

  if edt_inferior.Text = '' then
  begin
    ShowMessage('Informe a medida do ferro INFERIOR da treli網');
    edt_inferior.SetFocus;
    exit;
  end;


  if edt_comprimento.Text = '' then
  begin
    ShowMessage('Informe o COMPRIMENTO DA TRELI큐');
    edt_comprimento.SetFocus;
    exit;
  end;

  if cbx_tipo_trelica.Text = '' then
  begin
    ShowMessage('Informe o TIPO DE TRELI큐');
    cbx_tipo_trelica.SetFocus;
    exit;
  end
  else
  begin
    qryTrelica.FieldByName('TIPO_TRELICA').AsString := cbx_tipo_trelica.Text;
  end;

  if edt_peso.Text = '' then
  begin
    ShowMessage('Informe o PESO DA TRELI큐');
    edt_peso.SetFocus;
    exit;
  end;

  if cbxDepartamento.Text = '' then
  begin
    ShowMessage('Informe um Departamento');
    cbxDepartamento.SetFocus;
    exit;
  end;

  if qry.FieldByName('PRECO_CUSTO').AsFloat <= 0 then
  begin
    ShowMessage('Informe o PRE큞 DE FORNECEDOR');
    edCusto.SetFocus;
    exit;
  end;

  if qry.FieldByName('PERCA').AsFloat <= 0 then
  begin
    ShowMessage('Informe o PERCENTUAL DE PERCA');
    edPercentual.SetFocus;
    exit;
  end;

  if qry.FieldByName('PRECO_VENDEDOR').AsFloat <= 0 then
  begin
    ShowMessage('Informe o PRE큞 PARA O VENDEDOR');
    edt_preco_vendedor.SetFocus;
    exit;
  end;

  if qry.FieldByName('PRECO_VENDA').AsFloat <= 0 then
  begin
    ShowMessage('Informe um Pre每 de Venda v涇ido');
    edt_preco_venda.SetFocus;
    exit;
  end;

  //
  qryTrelica.FieldByName('KGS_METRO').AsFloat := qry.FieldByName('peso').AsFloat /
                                                 qryTrelica.FieldByName('comprimento').AsFloat ;


  result := true;
end;

procedure TfrmProdutosTrelicaE.prc_calcula_custo_linear;
var
  c, preco_fornecedor, perca, custo_liquido, metro_linear: double ;
begin
  preco_fornecedor := qry.FieldByName('preco_custo').AsFloat;
  perca := qry.FieldByName('perca').AsFloat;
  c := (100-perca) /100;
  custo_liquido := preco_fornecedor / c;
  qry.FieldByName('custo_liquido').AsFloat := custo_liquido;
  metro_linear := custo_liquido/  qryTrelica.FieldByName('COMPRIMENTO').AsFloat;
  qryTrelica.FieldByName('PRECO_CUSTO_12MT').AsFloat := custo_liquido;
 // ShowMessage(FloatToStr(metro_linear));
end;

procedure TfrmProdutosTrelicaE.prc_descricao_trelica;
var
  p_descricao_tecnica, p_descricao_fantasia : string;
  altura,superior, sinozoide, inferior: double;
begin
  altura   := strtofloat(cbx_altura.Text) /10;
  superior := strtofloat(edt_superior.Text) *10;
  sinozoide:= strtofloat(edt_sinozoide.Text) *10;
  inferior := strtofloat(edt_inferior.Text) *10;

  p_descricao_tecnica  := 'TR ' +  cbx_altura.Text + ' ' + formatfloat('00', superior) + formatfloat('00', sinozoide) + formatfloat('00', inferior);
  p_descricao_fantasia := 'TRELI큐 H-' + floattostr(altura) + ' BARRA COM ' + formatfloat('0.00', strtofloat(edt_comprimento.Text)) + ' MT(S) "' + cbx_tipo_trelica.text + '"';
 // edt_descricao_tecnica.Text := p_descricao_tecnica;
 // edt_descricao_fantasia.Text := 'TRELI큐 H-' + floattostr(altura) + ' BARRA COM ' + edt_comprimento.Text + ' MT(S) "' + cbx_tipo_trelica.text + '"';
  qry.FieldByName('DESCRICAO').AsString := p_descricao_tecnica;
  qry.FieldByName('NOME_FANTASIA').AsString := p_descricao_fantasia;

end;



procedure TfrmProdutosTrelicaE.cbx_tipo_trelicaExit(Sender: TObject);
begin
  inherited;
  if (cbx_altura.Text = '') or (edt_superior.Text = '') or (edt_sinozoide.Text = '') or
  (edt_inferior.Text = '') then
  begin
    ShowMessage('Informe as dimens添s corretas da treli網 a ser cadastrada');
    exit;
  end
  else
    prc_descricao_trelica;
end;

end.
