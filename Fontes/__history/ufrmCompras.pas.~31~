unit ufrmCompras;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseGrade, Data.DB,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,
  FireDAC.Stan.Async, FireDAC.DApt, System.Actions, Vcl.ActnList,
  System.ImageList, Vcl.ImgList, Vcl.Menus, FireDAC.Comp.DataSet,
  FireDAC.Comp.Client, Vcl.Grids, Vcl.DBGrids, Vcl.ExtCtrls, Vcl.ComCtrls,
  Vcl.DBCtrls, Vcl.ToolWin, Vcl.StdCtrls, Vcl.Buttons;


type
  TfrmCompras = class(TfrmBaseGrade)
    btn_produto: TSpeedButton;
    lbl_nome_fornecedor: TLabel;
    ds_produtos: TDataSource;
    qry_produtos: TFDQuery;
    GroupBox1: TGroupBox;
    dtp_data_ini: TDateTimePicker;
    dtp_data_fim: TDateTimePicker;
    Label1: TLabel;
    btn_localizar: TButton;
    qryCOMPRAS_ID: TIntegerField;
    qryDATA_CONTABIL: TDateField;
    qryNUMERO_DOCUMENTO: TStringField;
    qryABERTO_ENTREGUE: TStringField;
    qryFORNECEDOR_ID: TIntegerField;
    qryNOME: TStringField;
    qryVALOR_COMPRA: TFMTBCDField;
    qryRECEBEMOS_EM: TDateField;

    procedure FormCreate(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);

    procedure actIncluirExecute(Sender: TObject);
    procedure actAlterarExecute(Sender: TObject);
    procedure actExcluirExecute(Sender: TObject);

    procedure edt_consultaKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure btn_produtoClick(Sender: TObject);
    procedure btn_localizarClick(Sender: TObject);
    procedure qryABERTO_ENTREGUEGetText(Sender: TField; var Text: string;
      DisplayText: Boolean);
  private
    Ffornecedor_id: integer;
    procedure prc_sql;
    function  fnc_validar_pesquisa: boolean;
    procedure prc_pesquisar;
    procedure prc_filtrar;

  public
    { Public declarations }
    property fornecedor_id :integer read Ffornecedor_id write Ffornecedor_id;
  end;

  var
 loForm : TfrmCompras;

  procedure prc_executa;

implementation

uses unit_principal, uBiblioteca, ufrmComprasE, ufrmFornecedores, unit_funcoes;

procedure prc_executa;
begin

  if loForm = nil then
  begin
    loForm := TfrmCompras.Create(Application);
    form_principal.prc_controla_menu(false);

    // se abrir dentro no painel principal não funciona os edites :(
    //loform.Parent := form_principal.pnl_principal;

    loform.top    :=  form_principal.pnl_Principal.Top;
    loform.Left   := form_principal.pnl_menulateral.Width;

    loForm.Width  := form_principal.pnl_principal.Width;
    loForm.Height := form_principal.pnl_principal.Height;
  end;
  loForm.Show;

end;


{$R *.dfm}

procedure TfrmCompras.prc_pesquisar;
begin

end;

procedure TfrmCompras.prc_sql;
begin

  sSql :=
          'select                    ' +
          '    C.COMPRAS_ID,         ' +
          '    C.DATA_CONTABIL,      ' +
          '    C.NUMERO_DOCUMENTO,   ' +
          '    C.ABERTO_ENTREGUE,    ' +
          '    C.FORNECEDOR_ID,      ' +
          '    P.NOME,               ' +
          '    C.VALOR_COMPRA,       ' +
          '    C.RECEBEMOS_EM        ' +
          'from                      ' +
          '  PESSOAS P, COMPRAS C    ' +
          'where                     ' +
          '  P.ID = C.FORNECEDOR_ID  ';

  qry.sql.Clear;
  qry.sql.Add(sSql);

end;


procedure TfrmCompras.qryABERTO_ENTREGUEGetText(Sender: TField;
  var Text: string; DisplayText: Boolean);
begin
  inherited;
  if qry.FieldByName('ABERTO_ENTREGUE').AsString = 'E' then
    Text := 'ENTREGUE'
  else if qry.FieldByName('ABERTO_ENTREGUE').AsString = 'A' then
    Text := 'ABERTO'
end;

procedure TfrmCompras.actAlterarExecute(Sender: TObject);
var
  id : integer;
begin
  if DBGrid1.DataSource.DataSet.IsEmpty then exit;

  id := qry.fieldbyname('COMPRAS_ID').AsInteger;
  ufrmComprasE.prc_alterar(id);

  uBiblioteca.AtualizaQuery(qry);
  qry.Locate('COMPRAS_ID', id, []);

  inherited;
end;

procedure TfrmCompras.actExcluirExecute(Sender: TObject);
begin
  ufrmComprasE.prc_excluir(qry.fieldbyname('COMPRAS_ID').AsInteger);
  uBiblioteca.AtualizaQuery(qry);
  inherited;

end;

procedure TfrmCompras.actIncluirExecute(Sender: TObject);
begin

  ufrmComprasE.prc_incluir;
  uBiblioteca.AtualizaQuery(qry);

  inherited;

end;

procedure TfrmCompras.btn_localizarClick(Sender: TObject);
begin
  inherited;
  if dtp_data_fim.Date < dtp_data_ini.date then
  begin
    CriarMensagem('AVISO', 'SELECIONE UM PERIODO VÁLIDO');
    exit;
  end else
  begin
    // filtrar tabela
    prc_filtrar;
  end;

end;

procedure TfrmCompras.prc_filtrar;
var
  sql : string;
begin
  sql := qry.SQL.Text;
  sql := sql + ' and P.ID =:PESSOA_ID and C.DATA_CONTABIL >= :DATA_INI and C.DATA_CONTABIL <= :DATA_FIM ';

  qry.SQL.Clear;
  qry.SQL.Add(SQL);
  QRY.ParamByName('PESSOA_ID').AsInteger := fornecedor_id;
  QRY.ParamByName('DATA_INI').AsDate     := dtp_data_ini.date;
  QRY.ParamByName('DATA_FIM').AsDate     := dtp_data_fim.date;

  QRY.Open;

  //ajustas as colunas do dbgrid
  prc_ajustar_colunas_grid( DBGrid1 );

  //aumenta o tamanho da linha do ddgrid
  prc_ajusta_tamanho_linha( DBGrid1 );



end;



procedure TfrmCompras.btn_produtoClick(Sender: TObject);
var
  loQry : TFDQuery;
begin
  inherited;
  try
    loQry := TFDQuery.Create(application);
    loQry.connection := conexao;
    loQry.SQL.Add('select ID, NOME from PESSOAS where ID =:ID');

    if frmFornecedores = nil then
    begin
      frmFornecedores := TfrmFornecedores.Create(application);

      frmFornecedores.top    :=  form_principal.pnl_Principal.Top;
      frmFornecedores.Left   := form_principal.pnl_menulateral.Width;

      frmFornecedores.Width  := form_principal.pnl_principal.Width;
      frmFornecedores.Height := form_principal.pnl_principal.Height;

      frmFornecedores.btnIncluir.Visible := false;
      frmFornecedores.btnAlterar.Visible := false;
      frmFornecedores.btnExcluir.Visible := false;
      frmFornecedores.btnImprimir.Visible := false;
      frmFornecedores.lbl_resultado.caption := 'SELECIONE O FORNECEDOR DESEJADO E DÊ UM DUPLO CLICK';

    end;

    frmFornecedores.ShowModal;
    if frmFornecedores.fornecedor_id > 0 then
    begin
      loQry.ParamByName('ID').AsInteger := frmFornecedores.fornecedor_id;
      loqry.Open;
      lbl_nome_fornecedor.Caption := loQry.FieldByName('NOME').AsString;
      btn_localizar.Enabled := true;
      // property fornecedor_id
      fornecedor_id := frmFornecedores.fornecedor_id ;
    end
    else
    begin
      btn_localizar.Enabled := false;
      lbl_nome_fornecedor.Caption := 'Nenhum fornecedor foi selecionado! ';
    end;
  finally
    freeandnil(loQry);
    FreeAndNil(frmFornecedores);
  end;
end;

procedure TfrmCompras.edt_consultaKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
//  inherited;

end;

function TfrmCompras.fnc_validar_pesquisa: boolean;
begin

end;

procedure TfrmCompras.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  inherited;

  form_principal.prc_controla_menu(true);
  FreeAndNil(loForm);

end;

procedure TfrmCompras.FormCreate(Sender: TObject);
begin


  self.Tabela := 'COMPRAS';
  prc_sql;

  inherited;

  dtp_data_ini.Date := date;
  dtp_data_fim.Date := date;
  btnLocalizar.Visible := FALSE;

  DBGrid1.Columns[0].Visible := FALSE;// COMPRAS ID
  DBGrid1.Columns[2].Visible := FALSE;// COD FORNECEDOR

end;

end.
