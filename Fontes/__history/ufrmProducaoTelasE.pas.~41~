unit ufrmProducaoTelasE;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseEdicao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.ExtCtrls, Vcl.Grids, Vcl.DBGrids, uTipos, ufrmProducaoTelasPesquisa,
  unit_funcoes, Vcl.Mask, Vcl.DBCtrls, uBiblioteca, udmConn,
  unit_movimenta_estoques;

type
  TfrmProducaoTelasE = class(TfrmBaseEdicao)
    pnl_topo: TPanel;
    Label1: TLabel;
    lbl_Cadastrado_em: TLabel;
    Label2: TLabel;
    lbl_id: TLabel;
    pnl_botoes_produtos: TPanel;
    btn_produto_incluir: TSpeedButton;
    btn_produto_excluir: TSpeedButton;
    btn_produto_editar: TSpeedButton;
    dbg_produtos: TDBGrid;
    mtb_producoes: TFDMemTable;
    mtb_producoesID: TIntegerField;
    mtb_producoesPRODUCAO_ID: TIntegerField;
    mtb_producoesPRODUTO_ID: TIntegerField;
    mtb_producoesNOME_FANTASIA: TStringField;
    mtb_producoesQTDE_TELAS: TIntegerField;
    mtb_producoesACO_ID: TIntegerField;
    ds_producoes: TDataSource;
    Label3: TLabel;
    qry_aco: TFDQuery;
    ds_aco: TDataSource;
    cbx_tipo_aco: TDBLookupComboBox;
    edt_estoque_disponivel: TDBEdit;
    Label4: TLabel;
    Label5: TLabel;
    edt_unidade: TDBEdit;
    qry_acoID: TIntegerField;
    qry_acoNOME_FANTASIA: TStringField;
    qry_acoUNIDADE: TStringField;
    qry_acoESTOQUE_DISPONIVEL: TCurrencyField;
    mtb_producoesPESO: TFloatField;
    mtb_producoesPESO_TOTAL: TFloatField;
    Label7: TLabel;
    Label6: TLabel;
    mtb_producoesTOTAL_ACO: TAggregateField;
    DBEdit1: TDBEdit;
    mtb_producoesTOTAL_TELAS: TAggregateField;
    Label8: TLabel;
    DBEdit2: TDBEdit;
    Label9: TLabel;
    edt_tipos_telas: TEdit;
    mt_itens_deletados: TFDMemTable;
    mt_itens_deletadosID: TIntegerField;

    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);

    procedure btn_produto_incluirClick(Sender: TObject);
    procedure btnOkClick(Sender: TObject);
  private
    FOperacao: uTipos.TOperacao;
    FCodigo: integer;
    FTabela: string;

    procedure prc_componentes;
    procedure prc_inicializar;
    procedure prc_incluir_alterar_na_grid(operacao: TOperacao);

    function fnc_validar: boolean;
    procedure prc_salvar;
    procedure prc_incluir_alterar(_operacao: TOperacao);
    procedure prc_incluir_alterar_itens;
    procedure prc_ler_dados;

  public
    property Tabela   :string read FTabela write FTabela;
    property Operacao :uTipos.TOperacao read FOperacao write FOperacao;
    property Codigo   :integer read FCodigo write FCodigo;

  end;

var
  loForm: TfrmProducaoTelasE;
  id : integer;

  procedure prc_incluir;
  procedure prc_alterar(ACodigo :integer);
  procedure prc_excluir(ACodigo :integer);

implementation

procedure prc_incluir;
begin
  try
    if loForm = nil then
    begin

      loForm := TfrmProducaoTelasE.Create(Application);
      loForm.Operacao := uTipos.OpIncluir;
      loForm.codigo   := 0;

    end;

    loForm.ShowModal;

  finally
    freeandnil(loForm);
  end;
end;

procedure prc_alterar(ACodigo :integer);
begin
  try
    if loForm = nil then
    begin

      loForm := TfrmProducaoTelasE.Create(Application);
      loForm.Operacao := uTipos.opAlterar;
      loForm.Codigo   := ACodigo;

    end;

    loForm.ShowModal;

  finally
    FreeAndNil(loForm)
  end;

end;

procedure prc_excluir(ACodigo :integer);
begin

  try
    if loForm = nil then
    begin

      loForm := TfrmProducaoTelasE.Create(Application);
      loForm.Operacao := uTipos.opExcluir;
      loForm.Codigo   := ACodigo;

    end;

    loForm.ShowModal;

  finally
    FreeAndNil(loForm)
  end;

end;


{$R *.dfm}

procedure TfrmProducaoTelasE.btnOkClick(Sender: TObject);
begin
  //inherited;
  prc_salvar;
end;

procedure TfrmProducaoTelasE.btn_produto_incluirClick(Sender: TObject);
begin
  try
    if frmProducaoTelasPesquisa = nil then
      frmProducaoTelasPesquisa := TfrmProducaoTelasPesquisa.Create(application);

    frmProducaoTelasPesquisa.ShowModal;

    if frmProducaoTelasPesquisa.confirmado then
    begin
      // verificar duplicidade
      mtb_producoes.First;
      if mtb_producoes.Locate('PRODUTO_ID', frmProducaoTelasPesquisa.tela_id, []) then
      begin
        criarmensagem('ERRO', frmProducaoTelasPesquisa.tela_nome_fantasia + ' JÁ FOI INCLUSO NESTA PRODUÇÃO' );
        exit;
      end;

      //incluir a produção na grid
      prc_incluir_alterar_na_grid(opincluir);

      edt_tipos_telas.Text := inttostr(mtb_producoes.RecordCount);

    end;




  finally
    freeandnil(frmProducaoTelasPesquisa);
  end;
end;

function TfrmProducaoTelasE.fnc_validar: boolean;
begin
  result := false;

  if cbx_tipo_aco.Text = '' then
  begin
    criarmensagem('ERRO','INFORME O TIPO DE AÇO UTILIZADO NA PRODUÇÃO DAS TELAS.');
    cbx_tipo_aco.SetFocus;
    exit;
  end;


  if mtb_producoes.IsEmpty then
  begin
    criarmensagem('ERRO','NÃO É POSSIVEL SALVAR UMA PRODUÇÃO SEM NENHUM LANÇAMENTO.');
    exit;
  end;
  result := true;

end;

procedure TfrmProducaoTelasE.FormCreate(Sender: TObject);
begin
  Tabela := 'PRODUCAO_TELAS';
  id := 0;

end;

procedure TfrmProducaoTelasE.FormShow(Sender: TObject);
begin
  prc_componentes;
  prc_inicializar;
end;

procedure TfrmProducaoTelasE.prc_componentes;
begin
  lbl_titulo.Caption := 'PRODUÇÃO DE TELAS';
  QRY.Connection     := dmConn.FDConnection;

  qry_aco.Connection := dmConn.FDConnection;
  qry_aco.open;

  // desabilitar algumas colunas
  dbg_produtos.Columns[0].Visible := false; // ID
  dbg_produtos.Columns[1].Visible := false; // PRODUCAO_ID
  dbg_produtos.Columns[2].Visible := false; // PRODUTO_ID
  dbg_produtos.Columns[6].Visible := false; // ACO_ID

  {vigas}
  mtb_producoes.Open;

end;

procedure TfrmProducaoTelasE.prc_inicializar;
begin
  case self.Operacao of
  uTipos.opIncluir: begin
                      pnDados.Enabled           := true;
                      lbl_sub_titulo.Caption    := 'INCLUSÃO';
                      btnOk.Caption             := 'GRAVAR PRODUÇÃO';
                      lbl_Cadastrado_em.Caption := datetostr(date);
                    end;
  uTipos.opAlterar: begin
                      prc_ler_dados;
                      lbl_sub_titulo.Caption := 'ALTERAÇÃO';
                      btnOk.Caption          := 'SOMENTE LEITURA';
                      btnok.Enabled          := false;
                    end;
  uTipos.opExcluir: begin
                      prc_ler_dados;
                      lbl_sub_titulo.Caption := 'EXCLUSÃO';
                      btnOk.Caption          := 'Excluir';
                      btnFechar.SetFocus;
                    end;
  else
    begin
      pnDados.Enabled := false;
      if btnFechar.CanFocus then btnFechar.SetFocus;
    end;
  end;

end;

procedure TfrmProducaoTelasE.prc_salvar;
begin
  if not fnc_validar then Exit;
  //ShowMessage('SALVAR');
  if not dmconn.FDConnection.InTransaction then dmconn.FDConnection.StartTransaction;
  //***
  try
    prc_incluir_alterar(Operacao);
    //if Self.Conexao.InTransaction then Self.Conexao.Commit;
    if dmconn.FDConnection.InTransaction then dmconn.FDConnection.Commit;

    CriarMensagem('AVISO',' PRODUÇÃO CADASTRADA COM SUCESSO! ');

    Close;
  except
    dmconn.FDConnection.Rollback;
    CriarMensagem('AVISO',' NÃO FOI POSSIVEL SALVAR O REGISTRO! ');
 //   on E : Exception do
 //      Raise Exception.Create(E.Message +  slinebreak +' NÃO FOI POSSIVEL SALVAR O REGISTRO! ' );
  end;

end;

procedure TfrmProducaoTelasE.prc_incluir_alterar_na_grid(operacao: TOperacao);

begin

  {inclui o id da tabela na memoria para deletar na confirmação }
  if operacao = opExcluir then
  begin
    if mtb_producoesID.AsInteger > 0 then
    begin
   //   mt_itens_deletados.Insert;
   //   mt_itens_deletadosID.AsInteger := mtb_producoesID.AsInteger;
   //   mt_itens_deletados.Post;
    end;

    mtb_producoes.Delete;

    exit;
  end;


  if operacao = OpIncluir then
  begin
    id := id -1;
    mtb_producoes.Insert;
    mtb_producoes.FieldByName('ID').AsInteger           := id;
    mtb_producoes.FieldByName('PRODUCAO_ID').AsInteger  := -1;
    mtb_producoes.FieldByName('PRODUTO_ID').AsInteger   := frmProducaoTelasPesquisa.tela_id;
    mtb_producoes.FieldByName('NOME_FANTASIA').AsString := frmProducaoTelasPesquisa.tela_nome_fantasia;
    mtb_producoes.FieldByName('PESO').AsFloat           := frmProducaoTelasPesquisa.tela_peso;
    mtb_producoes.FieldByName('QTDE_TELAS').AsInteger   := frmProducaoTelasPesquisa.tela_quantidade;
    mtb_producoes.FieldByName('ACO_ID').Value           := cbx_tipo_aco.KeyValue;
    mtb_producoes.FieldByName('PESO_TOTAL').AsFloat     := frmProducaoTelasPesquisa.tela_quantidade *
                                                           frmProducaoTelasPesquisa.tela_peso;

    mtb_producoes.post;

  end
  else if operacao = opAlterar then
  begin

    mtb_producoes.Edit;
    mtb_producoes.FieldByName('PRODUTO_ID').AsInteger   := frmProducaoTelasPesquisa.cbx_tipo_tela.KeyValue;
    mtb_producoes.FieldByName('NOME_FANTASIA').AsString := frmProducaoTelasPesquisa.cbx_tipo_tela.Text;
    mtb_producoes.FieldByName('QTDE_TELAS').AsInteger   := strtoint(frmProducaoTelasPesquisa.edt_qtde_tela.Text);
    mtb_producoes.FieldByName('ACO_ID').AsInteger       := cbx_tipo_aco.KeyValue;
    mtb_producoes.post;

  end;

end;


procedure TfrmProducaoTelasE.prc_incluir_alterar(_operacao: TOperacao);
begin
//ShowMessage('ENTREI');
  qry.sql.clear;
  if _operacao = opExcluir then
  begin

    qry.SQL.Add('update ' + Tabela + ' set ATIVO = ''N'' where ID =:ID');
    qry.ParamByName('ID').AsInteger := Codigo;
    qry.ExecSQL;
    exit;

  end;

  if _operacao = OpIncluir then
  begin
ShowMessage('incluir');
    qry.SQL.Add('insert into ' + Tabela );  // PRODUCAO_VIGAS
    qry.SQL.Add('(');
    qry.SQL.Add('  CADASTRADO_EM,         ');
    qry.SQL.Add('  ACO_ID,                ');
    qry.SQL.Add('  QTDE_ACO_UTILIZADO,    ');
    qry.SQL.Add('  QTDE_TELAS_PRODUZIDAS, ');
    qry.SQL.Add('  CONSUMO_POR_TELA,      ');
    qry.SQL.Add('  TIPOS_TELA             ');
    qry.SQL.Add(')                        ');
    qry.SQL.Add('VALUES                   ');
    qry.SQL.Add('(                        ');
    qry.SQL.Add(' :CADASTRADO_EM,         ');
    qry.SQL.Add(' :ACO_ID,                ');
    qry.SQL.Add(' :QTDE_ACO_UTILIZADO,    ');
    qry.SQL.Add(' :QTDE_TELAS_PRODUZIDAS, ');
    qry.SQL.Add(' :CONSUMO_POR_TELA,      ');
    qry.SQL.Add(' :TIPOS_TELA             ');
    qry.SQL.Add(')                        ');
    qry.SQL.Add('returning ID             ');

    qry.ParamByName('CADASTRADO_EM').AsDate := Date;
  end
  else
  if _operacao = opAlterar then
  begin
    qry.SQL.Add('UPDATE                                           ');
    qry.SQL.Add(Tabela);
    qry.SQL.Add('SET                                              ');
    qry.SQL.Add('  ACO_ID                = :ACO_ID,               ');
    qry.SQL.Add('  QTDE_ACO_UTILIZADO    = :QTDE_ACO_UTILIZADO,   ');
    qry.SQL.Add('  QTDE_TELAS_PRODUZIDAS = :QTDE_TELAS_PRODUZIDAS,');
    qry.SQL.Add('  CONSUMO_POR_TELA      = :CONSUMO_POR_TELA      ');
    qry.SQL.Add('  TIPOS_TELA            = :TIPOS_TELA            ');
    qry.SQL.Add('WHERE                                            ');
    qry.SQL.Add('  ID = :ID                                       ');
    //
    qry.ParamByName('ID').AsInteger := Codigo;

  end;

  qry.ParamByName('ACO_ID').AsInteger                := cbx_tipo_aco.KeyValue;
  qry.ParamByName('QTDE_ACO_UTILIZADO').value        := mtb_producoes.FieldByName('TOTAL_ACO').value;
  qry.ParamByName('QTDE_TELAS_PRODUZIDAS').AsInteger := mtb_producoes.FieldByName('TOTAL_TELAS').value;
  qry.ParamByName('CONSUMO_POR_TELA').asfloat        := mtb_producoes.FieldByName('TOTAL_ACO').value /
                                                        mtb_producoes.FieldByName('TOTAL_TELAS').value;
  qry.ParamByName('TIPOS_TELA').AsInteger            := StrToInt(edt_tipos_telas.Text);

  //ShowMessage(qry.SQL.Text);

  if _operacao = opincluir then
  begin
    QRY.Open;
    codigo := qry.FieldByName('ID').AsInteger;
  end
  else
    qry.ExecSQL;



  {inclui/alterar/excluir itens da producao}
  prc_incluir_alterar_itens;

end;

procedure TfrmProducaoTelasE.prc_incluir_alterar_itens;
var
  loQry: TFDQuery;
  novo_id: integer;
begin

  loQry:= TFDQuery.Create(self);
  loqry.Connection := dmConn.FDConnection;

  {excluir itens da memoria "mt_itens_deletados"}
  mt_itens_deletados.First;
  while not mt_itens_deletados.Eof do
  begin
    {inserir}
    loqry.SQL.Clear;
    loQry.SQL.Add('delete from PRODUCAO_TELAS_ITENS where ID =:ITENS_ID ') ;
    loQry.ParamByName('ITENS_ID').AsInteger := mt_itens_deletadosID.AsInteger;

    //ShowMessage('excluir item ' + inttostr(mt_itens_deletadosID.AsInteger)) ;
    loqry.ExecSQL;

    mt_itens_deletados.Next;
  end;

  // salva os itens da produção
  // itens com id < 0 , insere.
  // itens com id > 0 , altera

  mtb_producoes.First;
  while not mtb_producoes.Eof do
  begin
    {Insert}
    if mtb_producoes.FieldByName('ID').AsInteger < 0 then
    begin
      {inserir}
      loqry.SQL.Clear;
      loQry.SQL.Add('insert into PRODUCAO_TELAS_ITENS                 ') ;
      loQry.SQL.Add(' ( PRODUCAO_ID, PRODUTO_ID, PESO_TELA, QTDE_TELAS, ACO_ID, PESO_TOTAL ) ') ;
      loQry.SQL.Add(' values                                          ') ;
      loQry.SQL.Add(' ( :PRODUCAO_ID, :PRODUTO_ID, :PESO_TELA, :QTDE_TELAS, :ACO_ID, :PESO_TOTAL ) ') ;
      loQry.ParamByName('PRODUCAO_ID').AsInteger := codigo;
    end
    else if mtb_producoes.FieldByName('ID').AsInteger > 0 then
    begin
      {Update}
      loqry.SQL.Clear;
      loQry.SQL.Add('update                                             ');
      loQry.SQL.Add('  PRODUCAO_TELAS_ITENS                             ');
      loQry.SQL.Add('set                                                ');
      loQry.SQL.Add('  produto_id =:produto_id, peso_tela =:peso_tela, qtde_telas =:qtde_telas, aco_id =:aco_id, peso_total =:peso_total ');
      loQry.SQL.Add('where                                              ');
      loQry.SQL.Add(' id = :ITENS_ID                                    ');
      loQry.ParamByName('ITENS_ID').AsInteger := mtb_producoes.FieldByName('ID').AsInteger;
    end;
   // ShowMessage(loQry.SQL.Text);
    {parametros}
    loQry.Params.ParamByName('produto_id').AsInteger := mtb_producoes.FieldByName('PRODUTO_ID').AsInteger;
    loQry.Params.ParamByName('peso_tela').AsFloat    := mtb_producoes.FieldByName('peso').AsFloat;
    loQry.Params.ParamByName('qtde_telas').AsInteger := mtb_producoes.FieldByName('qtde_telas').AsInteger;
    loQry.Params.ParamByName('aco_id').AsInteger     := mtb_producoes.FieldByName('aco_id').AsInteger;
    loQry.Params.ParamByName('peso_total').AsFloat   := mtb_producoes.FieldByName('peso_total').AsFloat;
    loqry.ExecSQL;


    {Atualiza saldos na tabela de produtos}
    unit_movimenta_estoques.prc_atualizar_estoque(
                                 mtb_producoes.FieldByName('PRODUTO_ID').AsInteger,
                                 'ENTRADA', 'PRODUCAO',
                                 mtb_producoes.FieldByName('qtde_telas').AsInteger );

    {lança movimento de entrada na tabela de movimentação de estoques}
    unit_movimenta_estoques.prc_incluir_alterar_movimento( OpIncluir,'ENTRADA','PRODUCAO_TELAS_ITENS',sesenao(mtb_producoes.FieldByName('ID').AsInteger < 0, novo_id, mtb_producoes.FieldByName('ID').AsInteger), mtb_producoes.FieldByName('PRODUTO_ID').AsInteger,'PRODUÇÃO', mtb_producoes.FieldByName('Qtde_Telas').AsFloat );



    // proximo produto
    mtb_producoes.Next;
  end;

  FreeAndNil(loqry) ;

end;

procedure TfrmProducaoTelasE.prc_ler_dados;
var
  loQry: TFDQuery;
begin
  try

    loQry:= TFDQuery.Create(self);
    loQry.Connection := dmConn.FDConnection;
    loQry.SQL.Clear;
    loqry.sql.Add('select * from ' + tabela + ' where ID = :ID');
    loQry.Params.ParamByName('ID').AsInteger := Codigo;
    loQry.Open;
    // preencher dados da produção
    lbl_id.Caption            := loQry.FieldByName('ID').AsString;
    lbl_Cadastrado_em.Caption := loQry.FieldByName('CADASTRADO_EM').AsString;
    cbx_tipo_aco.KeyValue     := loQry.FieldByName('ACO_ID').AsInteger;
    loQry.Close;

    // ITENS

    loQry.SQL.Clear;
    loqry.sql.Add('select                                          ');
    loQry.SQL.Add('  ID, PRODUCAO_ID, PRODUTO_ID, PESO_TELA, QTDE_TELAS, ACO_ID, PESO_TOTAL ');
    loQry.SQL.Add('from                                            ');
    loQry.SQL.Add('  PRODUCAO_TELAS_ITENS                          ');
    loQry.SQL.Add('where                                           ');
    loQry.SQL.Add('  PRODUCAO_ID = :PRODUCAO_ID              ');
    loQry.Params.ParamByName('PRODUCAO_ID').AsInteger := Codigo;
    loQry.Open;

    loQry.First;
    while not loQry.Eof do
    begin

      mtb_producoes.Insert;
      mtb_producoes.FieldByName('ID').AsInteger          := loQry.FieldByName('ID').AsInteger;
      mtb_producoes.FieldByName('PRODUCAO_ID').AsInteger := loQry.FieldByName('PRODUCAO_ID').AsInteger;
      mtb_producoes.FieldByName('PRODUTO_ID').AsInteger  := loQry.FieldByName('PRODUTO_ID').AsInteger;
      mtb_producoes.FieldByName('PESO').AsFloat          := loQry.FieldByName('PESO_TELA').AsFloat;
      mtb_producoes.FieldByName('QTDE_TELAS').AsInteger  := loQry.FieldByName('QTDE_TELAS').AsInteger;
      mtb_producoes.FieldByName('ACO_ID').AsInteger      := loQry.FieldByName('ACO_ID').AsInteger;
      mtb_producoes.FieldByName('PESO_TOTAL').AsFloat    := loQry.FieldByName('PESO_TOTAL').AsFloat;

      // pega o nome fantasia da viga
      Qry.Close;
      Qry.SQL.Clear;
      qry.sql.Add('select NOME_FANTASIA, UNIDADE from PRODUTOS where ID = :PRODUTO_ID');
      Qry.Params.ParamByName('PRODUTO_ID').AsInteger := mtb_producoes.FieldByName('PRODUTO_ID').AsInteger;
      Qry.Open;
      mtb_producoes.FieldByName('NOME_FANTASIA').AsString:= Qry.FieldByName('NOME_FANTASIA').AsString;
      // grava na grid
      mtb_producoes.Post;
      loQry.Next;

    end;
    // qtde de tipos de tela produzidos
    edt_tipos_telas.Text := inttostr(mtb_producoes.RecordCount);

  finally
    loQry.Close;
    FreeAndNil(loQry) ;
  end;

end;



end.
