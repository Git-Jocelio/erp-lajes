unit ufrmDinheiroEntrada;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseGrade, Data.DB,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,
  FireDAC.Stan.Async, FireDAC.DApt, System.Actions, Vcl.ActnList,
  System.ImageList, Vcl.ImgList, FireDAC.Comp.DataSet, FireDAC.Comp.Client,
  Vcl.Buttons, Vcl.Grids, Vcl.DBGrids, Vcl.ExtCtrls, Vcl.ComCtrls, Vcl.ToolWin,
  Vcl.StdCtrls, udmConn, ufrmDinheiroEntradaE, uTipos, uBiblioteca, unit_funcoes;

type
  TfrmDinheiroEntrada = class(TfrmBaseGrade)
    qryID: TIntegerField;
    qryCADASTRADO_EM: TDateField;
    qryVALOR: TFMTBCDField;
    qryOBS: TStringField;
    qryRECIBO_ID: TIntegerField;
    Label1: TLabel;
    edt_valor_fim: TEdit;
    cb_valor: TCheckBox;
    cb_data: TCheckBox;
    dtp_data_ini: TDateTimePicker;
    dtp_data_fim: TDateTimePicker;
    Label2: TLabel;
    procedure actIncluirExecute(Sender: TObject);
    procedure actAlterarExecute(Sender: TObject);
    procedure actExcluirExecute(Sender: TObject);

    procedure FormCreate(Sender: TObject);
    procedure edt_consultaKeyPress(Sender: TObject; var Key: Char);
    procedure edt_consultaExit(Sender: TObject);
    procedure actLocalizarExecute(Sender: TObject);

  private
    procedure prc_sql;
    function fnc_validar_pesquisa: boolean;
    { Private declarations }
  public
    { Public declarations }
  end;

var
  frmDinheiroEntrada: TfrmDinheiroEntrada;

implementation

{$R *.dfm}

procedure TfrmDinheiroEntrada.actAlterarExecute(Sender: TObject);
begin

  try
    if frmDinheiroEntradaE = nil then
      frmDinheiroEntradaE := TfrmDinheiroEntradaE.Create(application);

    frmDinheiroEntradaE.Operacao := utipos.opAlterar;
    frmDinheiroEntradaE.Codigo   := qry.FieldByName('ID').AsInteger;
    frmDinheiroEntradaE.ShowModal;

  finally
    ubiblioteca.AtualizaQuery(qry);
    FreeAndNil(frmDinheiroEntradaE)
  end;

end;

procedure TfrmDinheiroEntrada.actExcluirExecute(Sender: TObject);
begin
  try
    if frmDinheiroEntradaE = nil then
      frmDinheiroEntradaE := TfrmDinheiroEntradaE.Create(application);

    frmDinheiroEntradaE.Operacao := utipos.opExcluir;
    frmDinheiroEntradaE.Codigo   := qry.FieldByName('ID').AsInteger;
    frmDinheiroEntradaE.ShowModal;

  finally
    ubiblioteca.AtualizaQuery(qry);
    FreeAndNil(frmDinheiroEntradaE)
  end;

end;

procedure TfrmDinheiroEntrada.actIncluirExecute(Sender: TObject);
begin
  inherited;

  try
    if frmDinheiroEntradaE = nil then
      frmDinheiroEntradaE := TfrmDinheiroEntradaE.Create(application);

    frmDinheiroEntradaE.Operacao := utipos.OpIncluir;
    frmDinheiroEntradaE.ShowModal;

  finally
    ubiblioteca.AtualizaQuery(qry);
    FreeAndNil(frmDinheiroEntradaE)
  end;

end;

procedure TfrmDinheiroEntrada.actLocalizarExecute(Sender: TObject);
var
  condicao : string;
begin
  inherited;
  if fnc_validar_pesquisa then
  begin
    qry.Close;
    condicao := '';

    // condições
    if cb_valor.Checked then
    begin
      condicao := ' and VALOR >= :VALOR_INI and VALOR <= :VALOR_FIM';
    end;

    if cb_data.Checked then
    begin
      condicao := condicao + ' and CADASTRADO_EM >= :DATA_INI and CADASTRADO_EM <= :DATA_FIM';
    end;

    // sql montado
    qry.SQL.Clear;
    qry.SQL.Add( ssql + condicao );


    // parametros
    if cb_valor.Checked then
    begin
      qry.ParamByName('VALOR_INI').AsFloat := strtofloat(edt_consulta.text);
      qry.ParamByName('VALOR_FIM').AsFloat := strtofloat(edt_valor_fim.text);
    end;

    if cb_data.Checked then
    begin
      qry.ParamByName('DATA_INI').AsDate := dtp_data_ini.Date;
      qry.ParamByName('DATA_FIM').AsDate := dtp_data_fim.Date;
    end;

    //showmessage(qry.SQL.Text);
    // resultados
    qry.Open;

  end;

end;

function TfrmDinheiroEntrada.fnc_validar_pesquisa: boolean;
begin
  result := false;

  if cb_valor.Checked then
  begin
    if strtofloatdef(edt_consulta.Text,0) < 0 then
    begin
      criarmensagem('ERRO', 'INFORME UM VALOR VÁLIDO.');
      edt_consulta.SetFocus;
      exit;
    end;

    if strtofloatdef(edt_valor_fim.Text,0) < 0 then
    begin
      criarmensagem('ERRO', 'INFORME UM VALOR VÁLIDO.');
      edt_valor_fim.SetFocus;
      exit;
    end;

    if strtofloatdef(edt_valor_fim.Text,0) < strtofloatdef(edt_consulta.Text,0) then
    begin
      criarmensagem('ERRO', 'VALOR FINAL MAIOR QUE O VALOR INICIAL.' + slinebreak + 'CONFIRA OS DADOS E TENTE NOVAMENTE.');
      edt_consulta.SetFocus;
      exit;
    end;
  end;

  if cb_data.Checked then
  begin
    if dtp_data_fim.date < dtp_data_ini.date then
    begin
      criarmensagem('ERRO', 'DATA FINAL MAIOR QUE A DATA INICIAL.' + slinebreak + 'CONFIRA OS DADOS E TENTE NOVAMENTE.');
      dtp_data_ini.SetFocus;
      exit;
    end;
  end;

  result := true;

end;


procedure TfrmDinheiroEntrada.edt_consultaExit(Sender: TObject);
begin
  inherited;
  prc_formata_dinheiro(sender) ;
end;

procedure TfrmDinheiroEntrada.edt_consultaKeyPress(Sender: TObject;
  var Key: Char);
begin
  inherited;
  prc_somente_numeros(sender, key);

end;

procedure TfrmDinheiroEntrada.FormCreate(Sender: TObject);
begin
  dtp_data_ini.Date := date;
  dtp_data_fim.Date := date;

  DBGrid1.Columns[4].Visible := false;

  self.Tabela := 'DINHEIRO_ENTRADA';
  prc_sql;
  inherited;
end;

procedure TfrmDinheiroEntrada.prc_sql;
begin

  sSql :=
          'select            ' +
          '  id,             ' +
          '  cadastrado_em,  ' +
          '  valor,          ' +
          '  obs,            ' +
          '  recibo_id       ' +
          'from              ' +
          ' dinheiro_entrada ' +
          'where             ' +
          ' id > 0           ';

  qry.sql.Clear;
  qry.sql.Add(sSql);
  QRY.Open;

end;


end.
