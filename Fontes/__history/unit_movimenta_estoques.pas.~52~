unit unit_movimenta_estoques;

interface

uses
  FireDAC.Comp.Client, Vcl.Forms, System.SysUtils, uTipos;

function fnc_buscar_estoque_minimo(produto_id: integer): double;
function fnc_buscar_pedido_aberto(produto_id: integer): double;
function fnc_buscar_estoque_fisico(produto_id: integer): double;
function fnc_buscar_ordem_compra_por_produto(produto_id: integer): Boolean;
procedure prc_emitir_ordem_compra(produto_id: integer);
procedure prc_atualiza_ordem_compra_por_produto(compra_id, produto_id: integer);

{soma todas quantidade de produtos aberto e aguardando nos pedidos}
function fnc_somar_pedidos_aberto_aguardando(tabela, situacao: string; produto_id :integer): double;



procedure prc_incluir_alterar_movimento(
                              operacao: TOperacao; //INCLUIR ALTERAR um registro na tabela estoques_movimentacao
                              entrada_ou_saida : string; // se é uma entrada ou saida de estoque (ENTRADA - SAIDA)
                              tabela_origem : string;    // nome da tabela que gerou o lancamento
                              tabela_origem_id : integer;// id da tabela que gerou o lancamento
                              produto_id: integer; // id do produto
                              historico: string;   // descrição do movimento
                              quantidade: double   // qtde lançada no banco de dados antes de uma edição
                              );



{devolve ou retira estoques de um pedido nas tabelas de produtos e movimentacao_estoques
operacao pode ser "ENTRADA ou SAIDA }
procedure prc_devolve_retira_estoques( pedido_id: integer; operacao: string);

{procedure que atualiza os estoques na tabela de produtos}
procedure prc_atualizar_estoque(produto_id: integer; entrada_saida: string;
                                    situacao_pedido:string; quantidade: double);

{recalcula estoque fisico de um produto e devolve o estoque fisico atual
esse valor será comparado com o estoque fisico da tabela de produtos
se hover diferença , atualizar a tabela de produtos}
function fnc_recalcula_estoque_fisico( produto_id: integer ): double;

{compara o estoque fisico da tabela de movimentacao_estoque com o estoque
fisico da tabela de produtos, se for diferente atualiza a tabela de produtos}
procedure prc_validar_estoque_fisico(produto_id: integer; quantidade: double);

{atualiza estoque fisico na tabela de estoques_movimentacao,
recebe o valor do estoque fisico da tabela de produtos e comprar, se der diferenca
faz um lancamento de entrada ou saida na tabela de estoques_movimentacao}
procedure prc_atualizar_estoque_fisico(produto_id: integer; quantidade: double);


implementation

uses udmConn, uBiblioteca,  Vcl.Dialogs;


procedure prc_incluir_alterar_movimento(
                              operacao: TOperacao; //INCLUIR ALTERAR um registro na tabela estoques_movimentacao
                              entrada_ou_saida : string; // se é uma entrada ou saida de estoque (ENTRADA - SAIDA)
                              tabela_origem : string;    // nome da tabela que gerou o lancamento
                              tabela_origem_id : integer;// id da tabela que gerou o lancamento
                              produto_id: integer; // id do produto
                              historico: string;   // descrição do movimento
                              quantidade: double   // qtde lançada no banco de dados antes de uma edição
                              );

var
  loQry, loqry_estoque : TFDQuery;
  estoque_fisico: double;
begin
  try
    loQry := TFDQuery.Create(application);
    loqry.Connection := dmConn.FDConnection;

    {qry para buscar o estoque fisico pelo id do produto}
    loqry_estoque := TFDQuery.Create(application);
    loqry_estoque.Connection := dmConn.FDConnection;

    // excluir
    if operacao = opExcluir then
    begin
      loQry.sql.clear;
      loQry.SQL.Add('delete from ESTOQUES_MOVIMENTACAO ');
      loQry.SQL.Add(' where TABELA_ORIGEM  = :TABELA_ORIGEM and TABELA_ORIGEM_ID =:TABELA_ORIGEM_ID ');
      loqry.ParamByName('TABELA_ORIGEM').AsString     := tabela_origem;
      loqry.ParamByName('TABELA_ORIGEM_ID').AsInteger := tabela_origem_id;
      loqry.ExecSQL;
      exit;
    end;

    loqry_estoque.sql.clear;
    loqry_estoque.SQL.Add('select ESTOQUE_FISICO from ESTOQUES_MOVIMENTACAO where produto_id =:produto_id order by estoques_id');
    loqry_estoque.ParamByName('produto_id').AsInteger := produto_id;
    loqry_estoque.open;

    {estoque fisico atual}
    if not loqry_estoque.IsEmpty then
    begin
      loqry_estoque.Last;
      estoque_fisico := loqry_estoque.fieldByName('estoque_fisico').Asfloat;
    end
    else if loqry_estoque.IsEmpty then
    begin
      estoque_fisico := 0;
      operacao       := OpIncluir;
    end;
(*    ShowMessage('produtoId      : ' + floattostr(produto_id) + slinebreak +
                'estoque fisico : ' + floattostr(estoque_fisico) + slinebreak +
                'quantidade     : ' + floattostr(quantidade) + slinebreak +
                'entrada ou saida : ' + entrada_ou_saida );
*)

    // incluir
    if operacao = OpIncluir then
    begin

      loQry.sql.clear;
      loQry.SQL.Add('insert into  ESTOQUES_MOVIMENTACAO ');
      loQry.SQL.Add('(                   ');
      loQry.SQL.Add('  TABELA_ORIGEM,    ');
      loQry.SQL.Add('  TABELA_ORIGEM_ID, ');
      loQry.SQL.Add('  PRODUTO_ID,       ');
      loQry.SQL.Add('  DATA,             ');
      loQry.SQL.Add('  HISTORICO,        ');
      loQry.SQL.Add('  ENTRADA,          ');
      loQry.SQL.Add('  SAIDA,            ');
      loQry.SQL.Add('  ESTOQUE_FISICO    ');
      loQry.SQL.Add(')                   ');
      loQry.SQL.Add('VALUES              ');
      loQry.SQL.Add('(                   ');
      loQry.SQL.Add('  :TABELA_ORIGEM,   ');
      loQry.SQL.Add('  :TABELA_ORIGEM_ID,');
      loQry.SQL.Add('  :PRODUTO_ID,      ');
      loQry.SQL.Add('  :DATA,            ');
      loQry.SQL.Add('  :HISTORICO,       ');
      loQry.SQL.Add('  :ENTRADA,         ');
      loQry.SQL.Add('  :SAIDA,           ');
      loQry.SQL.Add('  :ESTOQUE_FISICO   ');
      loQry.SQL.Add(')                   ');

      loQry.ParamByName('DATA').AsDate := Date;
    end
    // alterar
    else if operacao = opAlterar then
    begin
      loQry.sql.clear;
      loQry.SQL.Add('update ESTOQUES_MOVIMENTACAO            ');
      loQry.SQL.Add('set                                     ');
      loQry.SQL.Add('  TABELA_ORIGEM    = :TABELA_ORIGEM,    ');
      loQry.SQL.Add('  TABELA_ORIGEM_ID = :TABELA_ORIGEM_ID, ');
      loQry.SQL.Add('  PRODUTO_ID       = :PRODUTO_ID,       ');
      loQry.SQL.Add('  ALTERADO_EM      = :ALTERADO_EM,      ');
      loQry.SQL.Add('  HISTORICO        = :HISTORICO,        ');
      loQry.SQL.Add('  ENTRADA          = :ENTRADA,          ');
      loQry.SQL.Add('  SAIDA            = :SAIDA,            ');
      loQry.SQL.Add('  ESTOQUE_FISICO   = :ESTOQUE_FISICO    ');
      loQry.SQL.Add('where                                   ');
      loQry.SQL.Add('  TABELA_ORIGEM    = :TABELA_ORIGEM and ');
      loQry.SQL.Add('  TABELA_ORIGEM_ID = :TABELA_ORIGEM_ID  ');

      loqry.ParamByName('TABELA_ORIGEM').AsString     := tabela_origem;
      loqry.ParamByName('TABELA_ORIGEM_ID').AsInteger := tabela_origem_id;
      loqry.ParamByName('ALTERADO_EM').AsDate         := date;
    end;

    loQry.ParamByName('TABELA_ORIGEM').AsString     := tabela_origem;
    loQry.ParamByName('TABELA_ORIGEM_ID').AsInteger := tabela_origem_id;
    loQry.ParamByName('PRODUTO_ID').AsInteger       := produto_id;
    loQry.ParamByName('HISTORICO').AsString         := historico;// edt_historico.Text;
    loQry.ParamByName('ENTRADA').AsFloat            := uBiblioteca.SeSenao(entrada_ou_saida = 'ENTRADA', quantidade, 0 ) ;
    loQry.ParamByName('SAIDA').AsFloat              := uBiblioteca.SeSenao(entrada_ou_saida = 'SAIDA', quantidade, 0 ) ;

    estoque_fisico := uBiblioteca.SeSenao(entrada_ou_saida = 'ENTRADA',
                      (estoque_fisico + quantidade),
                      (estoque_fisico - quantidade));

    loQry.ParamByName('ESTOQUE_FISICO').Asfloat     := estoque_fisico;

    {confere se o estoque fisico na tabela de produtos esta correto,
    se não estiver conserta.}
    prc_validar_estoque_fisico( produto_id, estoque_fisico );

    loQry.ExecSQL;

  finally
    freeandnil(loqry_estoque);
    freeandnil(loQry);
  end;
end;


{devolve ou retira estoques de um pedido
operacao pode ser "ENTRADA ou SAIDA }
procedure prc_devolve_retira_estoques( pedido_id: integer; operacao: string );
var
  loqry: TFDQuery;
  estoque_fisico: double;
begin
  try
    loqry:= TFDQuery.Create(application);
    loqry.Connection := dmconn.FDConnection;

    {filtra os itens do pedido}
    loqry.SQL.Clear;
    loqry.SQL.Add('select p.orcamento, P.SITUACAO, I.ID, I.PRODUTO_ID, I.LAJE, I.QTDE  ');
    loqry.SQL.Add('from PEDIDOS P, PEDIDOS_ITENS I                        ');
    loqry.SQL.Add('where P.ID = I.PEDIDO_ID and I.PEDIDO_ID =:PEDIDO_ID ');
    loqry.ParamByName('PEDIDO_ID').AsInteger := pedido_id;
    loqry.Open;

    {obs. a situacao das tabelas nesse momento reflete o que ainda esta na tela}
    {se for orcamento cai fora!}
    if loqry.FieldByName('orcamento').AsString = 'S' then
    begin
      //ShowMessage('NÃO VAI DEVOLVER OS ESTOQUES');

       EXIT;
    end else
    begin
    end;
    {percorre todos os itens do pedido}
    loqry.First;
    while not loqry.eof do
    begin
      {encontra o produto e se não for laje retira/devolve a quantidade
      de estoque na tabela de produtos}
      if loqry.FieldByName('LAJE').AsString = 'N' then
      begin
        prc_atualizar_estoque( loqry.FieldByName('PRODUTO_ID').AsInteger,
                               operacao,
                               loqry.FieldByName('SITUACAO').AsString,
                               loqry.FieldByName('QTDE').AsFloat);

        {se for uma edição, verificar se o pedido ja foi entregue}
        if operacao = 'ENTRADA' then
        begin
          //
        end else
        if operacao = 'SAIDA' then
        begin
          if ((loqry.FieldByName('SITUACAO').AsString = 'ENTREGUE') or (loqry.FieldByName('SITUACAO').AsString = 'RETIROU')) then
            prc_incluir_alterar_movimento( OpIncluir,'SAIDA','PEDIDOS_ITENS', loqry.FieldByName('ID').AsInteger, loqry.FieldByName('PRODUTO_ID').AsInteger,'VENDA PEDIDO N. ' + inttostr(pedido_id), loqry.FieldByName('QTDE').AsFloat );
        end;
      end;

      loqry.Next;
    end;

    {filtra os itens da laje}
    loqry.SQL.Clear;
    loqry.SQL.Add('select P.ID, P.SITUACAO, I.PRODUTO_ID, I.QTDE        ');
    loqry.SQL.Add('from PEDIDOS P, PEDIDOS_ITENS_LAJE I                 ');
    loqry.SQL.Add('where P.ID = I.PEDIDO_ID and I.PEDIDO_ID =:PEDIDO_ID ');
    loqry.ParamByName('PEDIDO_ID').AsInteger := pedido_id;
    loqry.Open;
    loqry.First;
    while not loqry.eof do
    begin
      {encontra o produto e se não for laje retira/devolve a quantidade de estoque}
      prc_atualizar_estoque( loqry.FieldByName('PRODUTO_ID').AsInteger,
                             operacao,
                             loqry.FieldByName('SITUACAO').AsString,
                             loqry.FieldByName('QTDE').AsFloat);

      {se for uma edição, verificar se o pedido ja foi entregue}
      if operacao = 'ENTRADA' then
      begin
        //
      end else
      if operacao = 'SAIDA' then
      begin
        if ((loqry.FieldByName('SITUACAO').AsString = 'ENTREGUE') or (loqry.FieldByName('SITUACAO').AsString = 'RETIROU')) then
          prc_incluir_alterar_movimento( OpIncluir,'SAIDA','PEDIDOS_ITENS_LAJE', loqry.FieldByName('ID').AsInteger, loqry.FieldByName('PRODUTO_ID').AsInteger,'VENDA PEDIDO N. ' + inttostr(pedido_id), loqry.FieldByName('QTDE').AsFloat );
      end;

      loqry.Next;
    end;

  finally
    freeandnil(loqry);
  end;

end;

function fnc_buscar_estoque_minimo(produto_id: integer): double;
var
  loQry : TFDQuery;
begin
  try
    loQry := TFDQuery.Create(application);
    loqry.Connection := dmConn.FDConnection;

    {buscar último saldo atual do produto}
    loQry.sql.clear;
    loqry.SQL.Add(' select QTDE_MIN from PRODUTOS where ID =:PRODUTO_ID ' );
    loQry.ParamByName('produto_id').AsInteger := produto_id;
    loqry.open;
    Result := loQry.FieldByName('QTDE_MIN').AsFloat;
  finally
    FreeAndNil(loQry);
  end;
end;



procedure prc_validar_estoque_fisico( produto_id: integer; quantidade: double );
{o valor passado na var quantidade é o estoque fisico atual do produto
na tabela de movimentacao_estoques }
var
  loqry: TFDQuery;
  estoque_fisico, pedido_aberto,estoque_disponivel,
  pedido_aguardando, estoque_liquido: double;

begin
//ShowMessage('CORRIGIR ESTOQUES');
  try
    loqry:= TFDQuery.Create(application);
    loqry.Connection := dmconn.FDConnection;
    {filtra os itens do pedido}
    loqry.SQL.Clear;
    loqry.SQL.Add('select                ');
    loqry.SQL.Add('  estoque_fisico,     ');
    loqry.SQL.Add('  pedido_aberto,      ');
    loqry.SQL.Add('  estoque_disponivel, ');
    loqry.SQL.Add('  pedido_aguardando,  ');
    loqry.SQL.Add('  estoque_liquido     ');
    loqry.SQL.Add('from                  ');
    loqry.SQL.Add('  Produtos            ');
    loqry.SQL.Add('where id =:produto_id ');
    loqry.ParamByName('produto_id').AsInteger := produto_id;
    loqry.Open;

    estoque_fisico     := loqry.fieldByName('estoque_fisico').AsFloat;
    pedido_aberto      := loqry.fieldByName('pedido_aberto').AsFloat;
    estoque_disponivel := loqry.fieldByName('estoque_disponivel').AsFloat;
    pedido_aguardando  := loqry.fieldByName('pedido_aguardando').AsFloat;
    estoque_liquido    := loqry.fieldByName('estoque_liquido').AsFloat;

    if estoque_fisico <> quantidade then
    begin
      {atualizar estoques da tabela de produtos}
      loqry.SQL.Clear;
      loqry.SQL.Add('update produtos set                        ');
      loqry.SQL.Add('  estoque_fisico     =:estoque_fisico,     ');
      loqry.SQL.Add('  pedido_aberto      =:pedido_aberto,      ');
      loqry.SQL.Add('  estoque_disponivel =:estoque_disponivel, ');
      loqry.SQL.Add('  pedido_aguardando  =:pedido_aguardando,  ');
      loqry.SQL.Add('  estoque_liquido    =:estoque_liquido     ');
      loqry.SQL.Add('where                                      ');
      loqry.SQL.Add('  id =:produto_id                          ');
      loqry.ParamByName('produto_id').AsInteger       := produto_id;
      loqry.ParamByName('estoque_fisico').AsFloat     := quantidade;
      loqry.ParamByName('pedido_aberto').AsFloat      := pedido_aberto;
      loqry.ParamByName('estoque_disponivel').AsFloat := quantidade - pedido_aberto;
      loqry.ParamByName('pedido_aguardando').AsFloat  := pedido_aguardando;
      loqry.ParamByName('estoque_liquido').AsFloat    := quantidade - pedido_aberto - pedido_aguardando;
      loqry.ExecSQL;

    end;

  finally
    freeandnil(loqry);
  end;
end;


{procedure que atualiza os estoques na tabela de produtos}
procedure prc_atualizar_estoque(produto_id: integer; entrada_saida: string;
                                situacao_pedido: string; quantidade: double);
var
  loqry, loqry_produto: TFDQuery;
  estoque_fisico, pedido_aberto, estoque_disponivel,pedido_aguardando,
  estoque_liquido : double;
begin
  estoque_fisico    := 0;
  pedido_aberto     := 0;
  pedido_aguardando := 0;

  //ShowMessage('situação do item : ' + situacao_pedido + slinebreak + 'entrada ou saida ' + entrada_saida);
  //ShowMessage('ATUALIZAR PRODUTO : ' + INTTOSTR(produto_id));
  try
    {query de atualização dos estoques na tabela de produtos}
    loqry:= TFDQuery.Create(application);
    loqry.Connection := dmConn.FDConnection;
    loqry.SQL.Clear;
    loqry.Close;
    loqry.SQL.Add('update                                    ');
    loqry.SQL.Add('  produtos                                ');
    loqry.SQL.Add('set                                       ');
    loqry.SQL.Add(' estoque_fisico     =:estoque_fisico,     ');
    loqry.SQL.Add(' pedido_aberto      =:pedido_aberto,      ');
    loqry.SQL.Add(' estoque_disponivel =:estoque_disponivel, ');
    loqry.SQL.Add(' pedido_aguardando  =:pedido_aguardando,  ');
    loqry.SQL.Add(' estoque_liquido    =:estoque_liquido     ');
    loqry.SQL.Add('where                                     ');
    loqry.SQL.Add(' id =:produto_id                          ');

    {query de busca de produtos}
    loqry_produto:= TFDQuery.Create(application);
    loqry_produto.Connection := dmConn.FDConnection;
    loqry_produto.SQL.Clear;
    loqry_produto.SQL.Add('select estoque_fisico, pedido_aberto, pedido_aguardando from produtos where id =:produto_id ');
    loqry_produto.ParamByName('produto_id').AsInteger := produto_id;
    loqry_produto.Open;

    {valores no banco de dados}
    estoque_fisico    := loqry_produto.fieldByName('estoque_fisico').AsFloat ;
    pedido_aberto     := loqry_produto.fieldByName('pedido_aberto').AsFloat ;
    pedido_aguardando := loqry_produto.fieldByName('pedido_aguardando').AsFloat ;

 //ShowMessage('aguardando ' + floattostr(pedido_aguardando));

    if entrada_saida = 'ENTRADA' then
    begin
      if ((situacao_pedido = 'ENTREGUE') or (situacao_pedido = 'RETIROU')) then
      begin
        //showmessage ('operacao ENTRADA, situacao ENTREGUE OU RETIROU');
        {atualizar estoque fisico na tabela de produtos}
        estoque_fisico     := estoque_fisico + quantidade;
        pedido_aberto      := pedido_aberto  + quantidade;
        estoque_disponivel := estoque_fisico     - pedido_aberto;
        estoque_liquido    := estoque_disponivel - pedido_aguardando;
      end else
      if situacao_pedido = 'ABERTO' then
      begin
        //Showmessage ('operacao ENTRADA, situacao ABERTO');
        {devolve estoques}

        pedido_aberto      := pedido_aberto      - quantidade;
        estoque_disponivel := estoque_fisico     - pedido_aberto;
        estoque_liquido    := estoque_disponivel - pedido_aguardando;
      end else
      if situacao_pedido = 'AGUARDANDO' then
      begin
        //showmessage ('operacao ENTRADA, situacao AGUARDANDO');
        estoque_disponivel := estoque_fisico     - pedido_aberto;
        pedido_aguardando  := pedido_aguardando  - quantidade;
        estoque_liquido    := estoque_disponivel - pedido_aguardando;
      end else
      if situacao_pedido = 'PRODUCAO' then
      begin
        estoque_fisico     := estoque_fisico + quantidade;
        estoque_disponivel := estoque_fisico - pedido_aberto;
        estoque_liquido    := estoque_disponivel - pedido_aguardando;
      end else
      if situacao_pedido = 'AVULSO' then
      begin
        estoque_fisico     := estoque_fisico + quantidade;
        estoque_disponivel := estoque_fisico - pedido_aberto;
        estoque_liquido    := estoque_disponivel - pedido_aguardando;
      end;

    end else
    if entrada_saida = 'SAIDA' then
    begin
      if ((situacao_pedido = 'ENTREGUE') or (situacao_pedido = 'RETIROU')) then
      begin
        estoque_fisico     := estoque_fisico     - quantidade;
        pedido_aberto      := pedido_aberto      - quantidade;
        estoque_disponivel := estoque_fisico     - pedido_aberto;
        estoque_liquido    := estoque_disponivel - pedido_aguardando;
      end else
      if situacao_pedido = 'ABERTO' then
      begin
        //showmessage ('operacao SAIDA, situacao ABERTO');
        {atualizar estoque "pedido_aberto" na tabela de produtos}
        //estoque_fisico     := estoque_fisico - quantidade;
        pedido_aberto      := pedido_aberto + quantidade;
        estoque_disponivel := estoque_fisico - pedido_aberto;
        estoque_liquido    := estoque_disponivel - pedido_aguardando;
      end else
      if situacao_pedido = 'AGUARDANDO' then
      begin
        //showmessage ('operacao SAIDA, situacao AGUARDANDO');
        {atualizar estoque "pedido_aguardando" na tabela de produtos}
        estoque_disponivel := estoque_fisico - pedido_aberto;
        pedido_aguardando  := pedido_aguardando + quantidade;
        estoque_liquido    := estoque_disponivel - pedido_aguardando;
      end else
      if situacao_pedido = 'AVULSO' then
      begin
        estoque_fisico     := estoque_fisico - quantidade;
        estoque_disponivel := estoque_fisico - pedido_aberto;
        estoque_liquido    := estoque_disponivel - pedido_aguardando;
      end;

    end;
    // passagem de parametros
    loqry.Close;
    loqry.ParamByName('estoque_fisico').AsFloat     := estoque_fisico;
    loqry.ParamByName('pedido_aberto').Asfloat      := pedido_aberto ;
    loqry.ParamByName('estoque_disponivel').AsFloat := estoque_disponivel;
    loqry.ParamByName('pedido_aguardando').Asfloat  := pedido_aguardando;
    loqry.ParamByName('estoque_liquido').AsFloat    := estoque_liquido;
    loqry.ParamByName('produto_id').AsInteger       := produto_id;
    loqry.ExecSQL;


  finally
    loqry.Close;
    loqry_produto.Close;
    FreeAndNil(loqry);
    FreeAndNil(loqry_produto);
  end;
end;

function fnc_recalcula_estoque_fisico(produto_id: integer ): double;
var
  loQry: TFDQuery;
  loQryAtualiza: TFDQuery;
  saldo_anterior : double;
  entrada : double;
  saida : double;
begin
  {atualizar o campo estoque_fisico da tabela estoques_movimentação após uma
  alteração nas quantidade}
  try
    {qry para atualização do estoque fisico de um produto}
    loQryAtualiza := TFDQuery.Create(application);
    loQryAtualiza.Connection := dmConn.FDConnection;
    loQryAtualiza.sql.Clear;
    //loQryAtualiza.SQL.Add('update estoques_movimentacao set estoque_fisico =:estoque_fisico where estoques_id =:estoques_id');
    loQryAtualiza.SQL.Add('update ');
    loQryAtualiza.SQL.Add('  estoques_movimentacao           ');
    loQryAtualiza.SQL.Add('set                               ');
    loQryAtualiza.SQL.Add('  estoque_fisico =:estoque_fisico ');
    loQryAtualiza.SQL.Add('where                             ');
    loQryAtualiza.SQL.Add('  estoques_id =:estoques_id       ');

    {lista o histórico de movimentação do produto}
    loQry := TFDQuery.Create(application);
    loqry.Connection := dmConn.FDConnection;
    loqry.sql.clear;
    loqry.SQL.Add(' select ');
    loqry.SQL.Add('   estoques_id, data,  historico, entrada, saida, estoque_fisico ');
    loqry.SQL.Add(' from ESTOQUES_MOVIMENTACAO                                      ');
    loqry.SQL.Add('   where produto_id =:produto_id                                 ');
    loqry.SQL.Add(' order by estoques_id                                            ');
    loqry.ParamByName('produto_id').AsInteger := produto_id;
    loqry.open;

    saldo_anterior := 0;

    loqry.First;
    while not loqry.eof do
    begin
      {calculo do novo estoque fisico}
      entrada := loqry.fieldByName('entrada').AsFloat;
      saida   := loqry.fieldByName('saida').AsFloat;
      loQryAtualiza.paramByName('estoque_fisico').AsFloat := saldo_anterior + entrada - saida;
      loQryAtualiza.paramByName('estoques_id').AsInteger  := loqry.FieldByName('estoques_id').AsInteger;
      loQryAtualiza.ExecSQL;

      {rsss... novo saldo anterior}
      saldo_anterior := saldo_anterior + entrada - saida;

      loqry.Next;
    end;

  finally
    freeandnil(loQryAtualiza);
    freeandnil(loQry);
  end;
end;


function fnc_buscar_estoque_fisico(produto_id: integer): double;
var
  loQry : TFDQuery;
begin
  try
    loQry := TFDQuery.Create(application);
    loqry.Connection := dmConn.FDConnection;

    {buscar último saldo atual do produto}
    loQry.sql.clear;
    loqry.SQL.Add(' select estoque_fisico from produtos where id =:PRODUTO_ID' );
    loQry.ParamByName('produto_id').AsInteger := produto_id;
    loqry.open;
    Result := loQry.FieldByName('estoque_fisico').AsFloat;
  finally
    FreeAndNil(loQry);
  end;
end;

function fnc_buscar_pedido_aberto(produto_id: integer): double;
var
  loQry : TFDQuery;
  itens_pedido, itens_laje : double;
begin
  Result := 0;
  try
    loQry := TFDQuery.Create(application);
    loqry.Connection := dmConn.FDConnection;

    loQry.sql.clear;
    loqry.SQL.Add(' select pedido_aberto from produtos where id =:PRODUTO_ID' );
    loQry.ParamByName('produto_id').AsInteger := produto_id;
    loqry.open;
    Result := loQry.FieldByName('pedido_aberto').AsFloat;

  finally
    FreeAndNil(loQry);
  end;
end;

function fnc_buscar_ordem_compra_por_produto(produto_id: integer): Boolean;
var
  loQry : TFDQuery;
begin
  try
    loQry := TFDQuery.Create(application);
    loqry.Connection := dmConn.FDConnection;

    {buscar último saldo atual do produto}
    loQry.sql.clear;
    loqry.SQL.Add(' select ORDEM_COMPRA_ID from ORDEM_COMPRA where PRODUTO_ID =:PRODUTO_ID and STATUS =:STATUS ' );
    loQry.ParamByName('produto_id').AsInteger := produto_id;
    loQry.ParamByName('STATUS').AsString      := 'A';
    loqry.open;
    Result := loQry.RecordCount > 0;
  finally
    LOQRY.Close;
    FreeAndNil(loQry);
  end;
end;

procedure prc_emitir_ordem_compra(produto_id: integer);
var
  loQry : TFDQuery;
begin
  try
    loQry := TFDQuery.Create(application);
    loqry.Connection := dmConn.FDConnection;

    {buscar último saldo atual do produto}
    loQry.sql.clear;
    loqry.SQL.Add(' insert into ORDEM_COMPRA                                    ' );
    loqry.SQL.Add('   ( CADASTRADO_EM, HORA, PRODUTO_ID, STATUS, COMPRA_ID )    ' );
    loqry.SQL.Add(' values                                                      ' );
    loqry.SQL.Add('   (:CADASTRADO_EM, :HORA, :PRODUTO_ID, :STATUS, :COMPRA_ID )' );

    loQry.ParamByName('CADASTRADO_EM').AsDate := date;
    loQry.ParamByName('HORA').AsTime          := Time;
    loQry.ParamByName('PRODUTO_ID').AsInteger := produto_id;
    loQry.ParamByName('STATUS').AsString      := 'A';
    loQry.ParamByName('COMPRA_ID').AsInteger  := -1;
    loqry.ExecSQL;
  finally
    FreeAndNil(loQry);
  end;
end;

procedure prc_atualiza_ordem_compra_por_produto(compra_id, produto_id: integer);
var
  loQry : TFDQuery;
  ordem_compra_id : integer;
begin
  try
    {verifico se tem ordem de compra aberta do produto lancada no sistema}
    loQry := TFDQuery.Create(application);
    loqry.Connection := dmConn.FDConnection;
    loqry.SQL.Clear;
    loqry.SQL.Add(' select ORDEM_COMPRA_ID from ORDEM_COMPRA where PRODUTO_ID =:PRODUTO_ID and STATUS =:STATUS ' );
    loQry.ParamByName('produto_id').AsInteger := produto_id;
    loQry.ParamByName('STATUS').AsString      := 'A';
    loqry.open;
    if loqry.RecordCount = 1 then
    begin
      {se achar uma, altera o status e grava o número da compra}
      ordem_compra_id := loqry.FieldByName('ORDEM_COMPRA_ID').AsInteger;

      loqry.CLOSE;
      loQry.sql.clear;
      loqry.SQL.Add(' update ORDEM_COMPRA set STATUS =:STATUS, COMPRA_ID =:COMPRA_ID where ORDEM_COMPRA_ID =:ORDEM_COMPRA_ID ' );
      loQry.ParamByName('ORDEM_COMPRA_ID').AsInteger := ordem_compra_id;
      loQry.ParamByName('COMPRA_ID').AsInteger       := compra_id;
      loQry.ParamByName('STATUS').AsString            := 'F';
      LOQRY.ExecSQL;
    end
    else if loqry.RecordCount > 1 then
    begin
      {se achar mais que um ( problema :/ )... deleta tudo!,
      pois o sistema gerará uma nova ordem de compra quando efetuar uma nova venda}
      loqry.CLOSE;
      loQry.sql.clear;
      loqry.SQL.Add(' delete from ORDEM_COMPRA where PRODUTO_ID =:PRODUTO_ID and STATUS =:STATUS ' );
      loQry.ParamByName('PRODUTO_ID').AsInteger := produto_id;
      loQry.ParamByName('STATUS').AsString      := 'A';
      LOQRY.ExecSQL;

    end;



  finally
    FreeAndNil(loQry);
  end;
end;


function fnc_somar_pedidos_aberto_aguardando(tabela, situacao: string; produto_id :integer): double;
var   // tabela = pedidos_itens ou pedidos_itens_laje // situacao = ABERTO ou AGUARDANDO
  loQry : TFDQuery;
begin
  try
    loQry := TFDQuery.Create(application);
    loqry.Connection := dmConn.FDConnection;

    {buscar último saldo atual do produto}
    loQry.sql.clear;
    loqry.SQL.Add(' select ' );
    loqry.SQL.Add('   sum(i.qtde) as QUANTIDADE ' );
    loqry.SQL.Add(' from ' );
    loqry.SQL.Add('   pedidos p,  ' );
    loqry.SQL.Add( tabela + ' i  ');
    loqry.SQL.Add(' where ' );
    loqry.SQL.Add('   p.id = i.pedido_id and ' );
    loqry.SQL.Add('   p.orcamento = :orcamento and ' );
    loqry.SQL.Add('   p.situacao = :situacao and   ' );
    loqry.SQL.Add('   i.produto_id = :produto_id   ' );

    loQry.ParamByName('orcamento').AsString := 'N';
    loQry.ParamByName('situacao').AsString := situacao;
    loQry.ParamByName('produto_id').AsInteger := produto_id;
    loqry.open;


    Result := loQry.FieldByName('QUANTIDADE').AsFloat;
  finally


    LOQRY.Close;
    FreeAndNil(loQry);
  end;
end;

procedure prc_atualizar_estoque_fisico(produto_id: integer; quantidade: double);
var
  loQry: TFDQuery;
  estoque_fisico, diferenca : double;
begin
  {atualizar o campo estoque_fisico da tabela estoques_movimentação após uma
  alteração nas quantidade}
  try
    {lista o movimento de um produto}
    loQry := TFDQuery.Create(application);
    loqry.Connection := dmConn.FDConnection;

    {lista o histórico de movimentação do produto}
    loqry.sql.clear;
    loqry.SQL.Add(' select ');
    loqry.SQL.Add('   estoques_id, data,  historico, entrada, saida, estoque_fisico ');
    loqry.SQL.Add(' from ESTOQUES_MOVIMENTACAO                               ');
    loqry.SQL.Add('   where produto_id =:produto_id                            ');
    loqry.SQL.Add(' order by estoques_id                                     ');
    loqry.ParamByName('produto_id').AsInteger := produto_id;
    loqry.open;
    loqry.Last;
    estoque_fisico := loqry.FieldByName('estoque_fisico').AsFloat;
    loqry.Close;

    {comparar estoque fisico da tabela de movimentacao_estoques com
    o estoque fisico na tabela de produtos}
    if estoque_fisico > quantidade then
    begin
      diferenca := estoque_fisico - quantidade{est fisico na tabela de produtos};
      loqry.sql.clear;
      loqry.SQL.Add(' insert into estoques_movimentacao ( tabela_origem, tabela_origem_id, produto_id, historico, entrada, saida, estoque_fisico ) values ( :tabela_origem, :tabela_origem_id, :produto_id, :historico, :entrada, :saida, :estoque_fisico ) ');
      loqry.ParamByName('produto_id').AsInteger       := produto_id;
      loqry.ParamByName('tabela_origem').AsString     := 'ESTOQUES_MOVIMENTACAO';
      loqry.ParamByName('tabela_origem_id').AsInteger := -1;
      loqry.ParamByName('historico').AsString         := 'ATUALIZAÇÃO DO ESTOQUE FISICO VIA SISTEMA';
      loqry.ParamByName('entrada').AsFloat            := 0;
      loqry.ParamByName('saida').AsFloat              := diferenca;
      loqry.ParamByName('estoque_fisico').AsFloat     := estoque_fisico - diferenca;
      loqry.ExecSQL;
    end else
    if estoque_fisico < quantidade then
    begin
      diferenca :=  quantidade - estoque_fisico ;
      loqry.sql.clear;
      loqry.SQL.Add(' insert into estoques_movimentacao ( tabela_origem, tabela_origem_id, produto_id, historico, entrada, saida, estoque_fisico ) values ( :tabela_origem, :tabela_origem_id, :produto_id, :historico, :entrada, :saida, :estoque_fisico ) ');
      loqry.ParamByName('produto_id').AsInteger := produto_id;
      loqry.ParamByName('tabela_origem').AsString := 'ESTOQUES_MOVIMENTACAO';
      loqry.ParamByName('tabela_origem_id').AsInteger := -1;
      loqry.ParamByName('historico').AsString := 'ATUALIZAÇÃO DO ESTOQUE FISICO VIA SISTEMA';
      loqry.ParamByName('entrada').AsFloat := diferenca;
      loqry.ParamByName('saida').AsFloat := 0;
      loqry.ParamByName('estoque_fisico').AsFloat := estoque_fisico + diferenca;
      loqry.ExecSQL;
    end;



  finally
    freeandnil(loqry);
  end;
end;


end.
