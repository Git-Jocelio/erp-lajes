unit ufrmDinheiroSaidaE;
// 27/05/2025
// saidas em dinheiro avulsas
interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseEdicao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.ExtCtrls, Vcl.DBCtrls, uTipos, uBiblioteca, unit_funcoes, uFinanceiro;

type
  TfrmDinheiroSaidaE = class(TfrmBaseEdicao)
    Label2: TLabel;
    Label3: TLabel;
    Label7: TLabel;
    Label1: TLabel;
    edt_id: TPanel;
    edt_cadastrado_em: TPanel;
    edt_valor: TEdit;
    edt_historico: TEdit;
    cb_contas_receber: TCheckBox;
    cbx_contas: TDBLookupComboBox;
    Label4: TLabel;
    cbx_pessoas: TDBLookupComboBox;
    Label5: TLabel;
    ds_pessoas: TDataSource;
    qry_pessoas: TFDQuery;
    ds_contas: TDataSource;
    qry_contas: TFDQuery;
    procedure edt_valorKeyPress(Sender: TObject; var Key: Char);
    procedure edt_valorExit(Sender: TObject);

    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure btnOkClick(Sender: TObject);

  private
    { Private declarations }
    FOperacao: uTipos.TOperacao;
    FTabela: string;
    FCodigo: integer;

    procedure prc_componentes;
    procedure prc_inicializar;

    function fnc_validar: boolean;
    procedure prc_salvar;
    procedure prc_incluir_alterar(_operacao: TOperacao);

    procedure prc_ler_dados;
  public
    property Codigo   :integer read FCodigo write FCodigo;
    property Operacao :uTipos.TOperacao read FOperacao write FOperacao;
    property Tabela   :string read FTabela write FTabela;

  end;

var
  frmDinheiroSaidaE: TfrmDinheiroSaidaE;

implementation

{$R *.dfm}

procedure TfrmDinheiroSaidaE.btnOkClick(Sender: TObject);
begin
  inherited;
  prc_salvar;
end;

procedure TfrmDinheiroSaidaE.edt_valorExit(Sender: TObject);
begin
  inherited;
  prc_formata_dinheiro(sender);
end;

procedure TfrmDinheiroSaidaE.edt_valorKeyPress(Sender: TObject; var Key: Char);
begin
  inherited;
 prc_somente_numeros(sender, key);
end;

function TfrmDinheiroSaidaE.fnc_validar: boolean;
begin
  result := false;

  if cbx_contas.Text = '' then
  begin
    CriarMensagem('AVISO','SELECIONE UMA CONTA.');
    cbx_contas.setfocus;
    exit;
  end;

  if edt_historico.Text = '' then
  begin
    CriarMensagem('AVISO','DESCREVA A SAIDA EM DINHEIRO.');
    edt_historico.setfocus;
    exit;
  end;

  if cbx_pessoas.Text = '' then
  begin
    CriarMensagem('AVISO','SELECIONE UMA PESSOA.');
    cbx_contas.setfocus;
    exit;
  end;

  if strtofloatdef(edt_valor.Text, 0) <= 0 then
  begin
    unit_funcoes.CriarMensagem('ERRO','INFORME UM VALOR VÁLIDO');
    edt_valor.setfocus;
    exit;
  end;


  result := true;

end;

procedure TfrmDinheiroSaidaE.FormCreate(Sender: TObject);
begin
  inherited;

  Tabela := 'DINHEIRO_SAIDA';
  titulo := 'SAIDA EM DINHEIRO DO CAIXA';

end;

procedure TfrmDinheiroSaidaE.FormShow(Sender: TObject);
begin
  inherited;
  prc_componentes;
  prc_inicializar;
end;

procedure TfrmDinheiroSaidaE.prc_componentes;
begin

  qry_pessoas.Connection := conexao;
  qry_pessoas.Open;

  qry_contas.Connection := conexao;
  qry_contas.Open;

end;

procedure TfrmDinheiroSaidaE.prc_incluir_alterar(_operacao: TOperacao);
begin
  qry.sql.clear;
  if _operacao = opExcluir then
  begin
    (*
    qry.SQL.Add('update ' + Tabela + ' set ATIVO = ''N'' where ID =:ID');
    qry.ParamByName('ID').AsInteger := Codigo;
    qry.ExecSQL;
    exit;
    *)
    if CriarMensagem('DELETE','DESEJA EXCLUIR ESTE LANÇAMENTO?') then
    begin
      qry.SQL.Add('delete from ' + Tabela + ' where ID =:ID');
      qry.ParamByName('ID').AsInteger := Codigo;
      qry.ExecSQL;
    end;
    exit;

  end;

  if _operacao = OpIncluir then
  begin
//ShowMessage('incluir');
    qry.SQL.Add('insert into ' + Tabela );  // DINHEIRO_SAIDA
    qry.SQL.Add('(');
    qry.SQL.Add('  CADASTRADO_EM,         ');
    qry.SQL.Add('  PESSOA_ID,             ');
    qry.SQL.Add('  PLANO_CONTAS_ID,       ');
    qry.SQL.Add('  HISTORICO,             ');
    qry.SQL.Add('  VALOR,                 ');
    qry.SQL.Add('  LANCADO_CONTAS_RECEBER ');
    qry.SQL.Add(')                        ');
    qry.SQL.Add('VALUES                   ');
    qry.SQL.Add('(                        ');
    qry.SQL.Add(' :CADASTRADO_EM,         ');
    qry.SQL.Add(' :PESSOA_ID,             ');
    qry.SQL.Add(' :PLANO_CONTAS_ID,       ');
    qry.SQL.Add(' :HISTORICO,             ');
    qry.SQL.Add(' :VALOR,                 ');
    qry.SQL.Add(' :LANCADO_CONTAS_RECEBER ');
    qry.SQL.Add(')                        ');
    qry.SQL.Add('returning ID             ');

    qry.ParamByName('CADASTRADO_EM').AsDate := Date;
  end
  else
  if _operacao = opAlterar then
  begin
    qry.SQL.Add('UPDATE                                             ');
    qry.SQL.Add(Tabela);
    qry.SQL.Add('SET                                                ');
    qry.SQL.Add('  PESSOA_ID              = :PESSOA_ID,             ');
    qry.SQL.Add('  PLANO_CONTAS_ID        = :PLANO_CONTAS_ID,       ');
    qry.SQL.Add('  HISTORICO              = :HISTORICO,             ');
    qry.SQL.Add('  VALOR                  = :VALOR,                 ');
    qry.SQL.Add('  LANCADO_CONTAS_RECEBER = :LANCADO_CONTAS_RECEBER ');
    qry.SQL.Add('WHERE                                              ');
    qry.SQL.Add('  ID = :ID                                         ');
    //
    qry.ParamByName('ID').AsInteger := Codigo;

  end;

  qry.ParamByName('PESSOA_ID').AsInteger             := cbx_pessoas.KeyValue;
  qry.ParamByName('PLANO_CONTAS_ID').AsInteger       := cbx_contas.KeyValue;
  qry.ParamByName('HISTORICO').AsString              := edt_historico.Text;
  qry.ParamByName('VALOR').AsFloat                   := StrToFloatDef(edt_valor.Text,0);
  qry.ParamByName('LANCADO_CONTAS_RECEBER').AsString := uBiblioteca.SeSenao(cb_contas_receber.Checked,'S','N');

  ShowMessage(qry.SQL.Text);

  if _operacao = opincluir then
  begin
    QRY.Open;
    codigo := qry.FieldByName('ID').AsInteger;
  end
  else
  if (_operacao = opalterar) or (_operacao = opExcluir) then
  begin
    qry.ExecSQL;
  end;

  {incluir lançamento na tabela de dinheiro_movimentacao}
  ufinanceiro.prc_incluir_movimento_caixa(Tabela, Codigo, 'SAIDA', edt_historico.Text, StrToFloatDef(edt_valor.Text,0));
(*
  {incluir lançamento no contas a receber}
  if ( cb_contas_receber.Checked ) and ( pessoa_id > 0 )then
  begin
    ufinanceiro.prc_contas_pagar(opincluir,conexao,-1,-1, conta_id, pessoa_id,
    inttostr(codigo), historico, 'DINHEIRO_ENTRADA', codigo, 1, 1, strtofloatdef(edt_valor.Text,0),
    0,0,0,0,date,0,'S','S','S','S','','' );
  end;
*)
end;

procedure TfrmDinheiroSaidaE.prc_inicializar;
begin
  case self.Operacao of
  uTipos.opIncluir: begin
                       pnDados.Enabled        := true;
                       lbl_sub_titulo.Caption := 'Incluir uma saida em dinheiro';

                       edt_Id.Caption            := '-1';
                       edt_cadastrado_em.Caption := DateToStr(Date);
                       btnOk     .Caption        := 'Incluir';
                     end;
  uTipos.opAlterar: begin
                      //somente leitura
                      prc_ler_dados;
                      lbl_sub_titulo.Caption := 'Alterar um lançamento em dinheiro.';
                      btnOk.Caption          := 'Somente leitura';
                      pnDados.Enabled        := false;

                      btnFechar.SetFocus;
                    end;
  uTipos.opExcluir: begin
                      //somente leitura
                      prc_ler_dados;
                      lbl_sub_titulo.Caption := 'Excluir um lançamento em dinheiro.';
                      btnOk.Caption          := 'Somente leitura';
                      pnDados.Enabled        := false;
                      btnFechar.SetFocus;
                    end;
  else
    begin
      pnDados.Enabled       := false;
      if btnFechar.CanFocus then btnFechar.SetFocus;
    end;
  end;

end;

procedure TfrmDinheiroSaidaE.prc_ler_dados;
var
  loQry: TFDQuery;
begin
  try

    loQry:= TFDQuery.Create(self);
    loQry.Connection := conexao;
    loQry.SQL.Clear;
    loqry.sql.Add('select * from ' + tabela + ' where ID = :ID');
    loQry.Params.ParamByName('ID').AsInteger := Codigo;
    loQry.Open;
    // preencher dados da saida
    edt_id.Caption            := loQry.FieldByName('ID').AsString;
    edt_Cadastrado_em.Caption := loQry.FieldByName('CADASTRADO_EM').AsString;
    cbx_pessoas.KeyValue      := loQry.FieldByName('PESSOA_ID').AsInteger;
    cbx_contas.KeyValue       := loQry.FieldByName('PLANO_CONTAS_ID').AsInteger;
    edt_historico.Text        := loQry.FieldByName('HISTORICO').AsString;
    edt_valor.Text            := formatfloat('0.00',loQry.FieldByName('VALOR').Asfloat);
    cb_contas_receber.Checked := uBiblioteca.SeSenao(loQry.FieldByName('LANCADO_CONTAS_RECEBER').AsString = 'S', true, false);

  finally
    loQry.Close;
    FreeAndNil(loQry) ;
  end;
end;


procedure TfrmDinheiroSaidaE.prc_salvar;
begin
  if not fnc_validar then Exit;
  if not conexao.InTransaction then conexao.StartTransaction;
  //***
  try
    prc_incluir_alterar(Operacao);

    if conexao.InTransaction then conexao.Commit;

    CriarMensagem('AVISO',' SAIDA CADASTRADA COM SUCESSO! ');

    Close;
  except
    on E : Exception do
       begin
         CriarMensagem('AVISO','NÃO FOI POSSIVEL SALVAR O REGISTRO.' + slinebreak + slinebreak + E.Message);
         if conexao.InTransaction then
           conexao.Rollback;
         //***
         Raise;
       end;
  end;

end;

end.
