unit ufrmContasBancariasE;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseEdicao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.ExtCtrls, uTipos, uBiblioteca, Vcl.Mask, Vcl.DBCtrls, Vcl.Grids,
  Vcl.DBGrids, ufrmContasBancariasItens, FireDAC.Stan.StorageBin;

type
  TfrmContasBancariasE = class(TfrmBaseEdicao)
    Label2: TLabel;
    lbl_Id: TLabel;
    Label1: TLabel;
    lbl_cadastrado_em: TLabel;
    cb_ativo: TCheckBox;
    Label6: TLabel;
    gb_contas: TGroupBox;
    dbg_taxas: TDBGrid;
    pnl_botoes_itens: TPanel;
    btn_incluir: TBitBtn;
    btn_alterar: TBitBtn;
    btn_excluir: TBitBtn;
    cbx_banco: TDBLookupComboBox;
    edt_cod_banco: TDBEdit;
    qry_banco: TFDQuery;
    ds_banco: TDataSource;
    Label4: TLabel;
    lbl_alterado_em: TLabel;
    ds_itens: TDataSource;
    mt_itens_deletados: TFDMemTable;
    mt_itens_deletadosID: TIntegerField;
    mt_itens: TFDMemTable;
    mt_itensID: TIntegerField;
    mt_itensAGENCIA: TStringField;
    mt_itensNR_CONTA: TStringField;
    mt_itensATIVO: TStringField;
    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure btnOkClick(Sender: TObject);
    procedure btn_incluirClick(Sender: TObject);
    procedure btn_alterarClick(Sender: TObject);
    procedure btn_excluirClick(Sender: TObject);
    procedure ds_itensDataChange(Sender: TObject; Field: TField);
  private
    FOperacao: uTipos.TOperacao;
    FTabela: string;
    FCodigo: integer;
    Fp_id: integer;

    procedure prc_salvar;
    procedure prc_incluir_alterar(operacao: TOperacao);
    procedure prc_incluir_alterar_na_grid(operacao: TOperacao);
    procedure prc_incluir_alterar_itens;


  protected
    procedure prc_componentes;
    procedure prc_inicializar;
    procedure prc_ler_dados;
    function prc_validar: boolean;

  public
    property Codigo   :integer read FCodigo write FCodigo;
    property Operacao :uTipos.TOperacao read FOperacao write FOperacao;
    property Tabela   :string read FTabela write FTabela;

    {controla o id dos itens}
    property p_id   :integer read Fp_id write Fp_id;



  end;

  procedure prc_incluir;
  procedure prc_alterar(ACodigo :integer);
  procedure prc_excluir(ACodigo :integer);

implementation



procedure prc_incluir;
var
  loForm : TfrmContasBancariasE;
begin
  loForm := TfrmContasBancariasE.Create(Application);
  try
    loForm.Operacao := uTipos.opIncluir;
    loForm.Codigo   := 0;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

procedure prc_alterar(ACodigo :integer);
var
  loForm : TfrmContasBancariasE;
begin
  loForm := TfrmContasBancariasE.Create(Application);
  try
    loForm.Operacao := uTipos.opAlterar;
    loForm.Codigo   := ACodigo;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

procedure prc_excluir(ACodigo :integer);
var
  loForm : TfrmContasBancariasE;
begin
  loForm := TfrmContasBancariasE.Create(Application);
  try
    loForm.Operacao := uTipos.opExcluir;
    loForm.Codigo   := ACodigo;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

{$R *.dfm}

procedure TfrmContasBancariasE.btnOkClick(Sender: TObject);
begin
  inherited;
  prc_salvar;
end;

procedure TfrmContasBancariasE.btn_alterarClick(Sender: TObject);
begin
  inherited;
  try
    if frmContasBancariasItens = nil then
      frmContasBancariasItens := TfrmContasBancariasItens.Create(self) ;

    frmContasBancariasItens.p_operacao := opAlterar;
    //frmCartaoTaxasItens.p_codigo := 0;

    {carregar componentes}
    frmContasBancariasItens.edt_agencia.text  := mt_itensAGENCIA.AsString;
    frmContasBancariasItens.edt_nr_conta.Text := mt_itensNR_CONTA.AsString;
    frmContasBancariasItens.cb_ativo.Checked  := mt_itensATIVO.AsString = 'S';


    frmContasBancariasItens.ShowModal;

    if frmContasBancariasItens.p_confirmado then
      prc_incluir_alterar_na_grid( opAlterar );


  finally
    freeandnil( frmContasBancariasItens );
  end;

end;

procedure TfrmContasBancariasE.btn_excluirClick(Sender: TObject);
begin
  inherited;
  prc_incluir_alterar_na_grid(opExcluir);

end;

procedure TfrmContasBancariasE.btn_incluirClick(Sender: TObject);
begin
  inherited;
  try
    if frmContasBancariasItens = nil then
      frmContasBancariasItens := TfrmContasBancariasItens.Create(self) ;

    frmContasBancariasItens.p_operacao := OpIncluir;
    //frmCartaoTaxasItens.p_codigo := 0;

    frmContasBancariasItens.ShowModal;
   (*
    {verfificar duplicidade}
    mt_itens.First;
    if mt_itens.Locate('forma_pagto_id', frmContasBancariasItens.p_forma_pagto_id, []) then
    begin
      ShowMessage('Taxa já inclusa');
      exit;
    end;
    *)
    if frmContasBancariasItens.p_confirmado then
      prc_incluir_alterar_na_grid( OpIncluir );


  finally
    freeandnil( frmContasBancariasItens );
  end;

end;

procedure TfrmContasBancariasE.ds_itensDataChange(Sender: TObject;
  Field: TField);
begin
  inherited;
  btn_alterar.Enabled := not mt_itens.IsEmpty;
  btn_excluir.Enabled := not mt_itens.IsEmpty;

end;

procedure TfrmContasBancariasE.prc_incluir_alterar_na_grid(operacao: TOperacao);

begin

  {inclui o id da taxa na memoria para deletar da confirmição }
  if operacao = opExcluir then
  begin
    mt_itens_deletados.Insert;
    mt_itens_deletadosID.AsInteger := mt_itensID.AsInteger;
    mt_itens_deletados.Post;

    mt_itens.Delete;
    exit;
  end;



  if operacao = OpIncluir then
  begin
    p_id := p_id -1;

    mt_itens.Insert;
    mt_itensID.AsInteger      := p_id;
    mt_itensAGENCIA.AsString  := frmContasBancariasItens.p_agencia;
    mt_itensNR_CONTA.AsString := frmContasBancariasItens.p_nrconta;
    mt_itensATIVO.AsString    := frmContasBancariasItens.p_ativo;
    mt_itens.Post;

  end
  else
  begin
    mt_itens.Edit;
    //mt_itensID.AsInteger      := p_id;
    mt_itensAGENCIA.AsString  := frmContasBancariasItens.p_agencia;
    mt_itensNR_CONTA.AsString := frmContasBancariasItens.p_nrconta;
    mt_itensATIVO.AsString    := frmContasBancariasItens.p_ativo;
    mt_itens.Post;

  end;


end;


procedure TfrmContasBancariasE.FormCreate(Sender: TObject);
begin
  inherited;
  Tabela := 'CONTAS_BANCARIAS';
end;

procedure TfrmContasBancariasE.FormShow(Sender: TObject);
begin
  inherited;
  prc_componentes;
  prc_inicializar;

end;

procedure TfrmContasBancariasE.prc_componentes;
begin
  {qry de principal}
  qry.Connection := Conexao;

  {qry banco}
  qry_banco.Connection := Conexao;
  qry_banco.SQL.Add('select id, cod_banco, descricao from bancos order by descricao');
  qry_banco.Open;



end;

procedure TfrmContasBancariasE.prc_incluir_alterar(operacao: TOperacao);
begin
  qry.sql.clear;
  if operacao = opExcluir then
  begin
    qry.SQL.Add('update '+ self.Tabela + ' set ATIVO = ''N'' where id =:id');
    qry.ParamByName('id').AsInteger := Codigo;
    qry.ExecSQL;
    exit;
  end;


  if operacao = OpIncluir then
  begin
    qry.SQL.Add('insert into ' + self.Tabela );
    qry.SQL.Add('(');
    qry.SQL.Add('  CADASTRADO_EM, ');
    qry.SQL.Add('  BANCO_ID,      ');
    qry.SQL.Add('  ATIVO          ');
    qry.SQL.Add(')                ');
    qry.SQL.Add('VALUES           ');
    qry.SQL.Add('(                ');
    qry.SQL.Add('  :CADASTRADO_EM,');
    qry.SQL.Add('  :BANCO_ID,     ');
    qry.SQL.Add('  :ATIVO         ');
    qry.SQL.Add(')                ');
    qry.SQL.Add('returning ID     ');

    qry.ParamByName('CADASTRADO_EM').AsDate := Date;
  end
  else
  begin
    qry.SQL.Add('UPDATE                       ');
    qry.SQL.Add(Tabela);
    qry.SQL.Add('SET                          ');
    qry.SQL.Add('  ALTERADO_EM = :ALTERADO_EM,');
    qry.SQL.Add('  BANCO_ID = :BANCO_ID,      ');
    qry.SQL.Add('  ATIVO = :ATIVO             ');
    qry.SQL.Add('WHERE                        ');
    qry.SQL.Add('  ID = :ID                   ');
    //
    qry.ParamByName('ID').AsInteger       := Codigo;
    qry.ParamByName('ALTERADO_EM').AsDate := Date;

  end;
  //ShowMessage(QRY.SQL.Text);

  qry.ParamByName('BANCO_ID').AsInteger  := cbx_banco.KeyValue;
  qry.ParamByName('ATIVO').AsString      := ubiblioteca.SeSenao(cb_ativo.Checked  , 'S','N');

  if operacao = opincluir then
  begin
    QRY.Open;
    codigo := qry.FieldByName('ID').AsInteger;
  end
  else
    qry.ExecSQL;

  {salvar/alterar itens}
  prc_incluir_alterar_itens;


end;


procedure TfrmContasBancariasE.prc_incluir_alterar_itens;
var
  loQry: TFDQuery;
begin

  loQry:= TFDQuery.Create(self);
  loqry.Connection := conexao;

  {excluir itens da memoria "mt_itens_deletados"}
  mt_itens_deletados.First;
  while not mt_itens_deletados.Eof do
  begin
    {inserir}
    loqry.SQL.Clear;
    loQry.SQL.Add('delete from contas_bancarias_itens where id =:id ') ;
    loQry.Params.ParamByName('id').AsInteger := mt_itens_deletadosID.AsInteger;;
    loqry.ExecSQL;

    mt_itens_deletados.Next;
  end;

  mt_itens.First;
  while not mt_itens.Eof do
  begin

    if mt_itensID.AsInteger < 0 then
    begin
      {inserir}
      loqry.SQL.Clear;
      loQry.SQL.Add('insert into contas_bancarias_itens ') ;
      loQry.SQL.Add(' ( banco_id, agencia, nr_conta, ativo )') ;
      loQry.SQL.Add(' values ') ;
      loQry.SQL.Add(' ( :banco_id, :agencia, :nr_conta, :ativo )') ;
      //loQry.Params.ParamByName('conta_bancaria_id').AsInteger := codigo;
    end
    else
    begin
      {alterar}
      loqry.SQL.Clear;
      loQry.SQL.Add('update  ');
      loQry.SQL.Add('  contas_bancarias_itens  ');
      loQry.SQL.Add('set ');
      loQry.SQL.Add('  banco_id =:banco_id, agencia =:agencia, nr_conta =:nr_conta, ativo =:ativo ');
      loQry.SQL.Add('where ');
      loQry.SQL.Add(' id =:id ');
      loQry.Params.ParamByName('id').AsInteger := mt_itensID.AsInteger;
    end;
(*
    ShowMessage(loqry.SQL.Text);
    ShowMessage(
                inttostr(Codigo) + sLineBreak +
                mt_itensFORMA_PAGTO_ID.AsString + sLineBreak +
                mt_itensQTDE_PARCELAS.AsString + sLineBreak +
                mt_itensPRIMEIRO_VENCIMENTO.AsString + sLineBreak +
                mt_itensINTERVALO_DEMAIS_PARC.AsString + sLineBreak +
                mt_itensTAXA.AsString );
*)


    {parametros}
    loQry.Params.ParamByName('banco_id').AsString := cbx_banco.KeyValue;
    loQry.Params.ParamByName('agencia').AsString  := mt_itensAGENCIA.AsString;
    loQry.Params.ParamByName('nr_conta').AsString := mt_itensNR_CONTA.AsString;
    loQry.Params.ParamByName('ativo').AsString    := mt_itensATIVO.AsString;
    loqry.ExecSQL;

    mt_itens.Next;
  end;

  FreeAndNil(loqry) ;

end;


procedure TfrmContasBancariasE.prc_inicializar;
begin
  pnTitulo.Caption := 'CADASTRO DE CONTAS BANCÁRIAS DA EMPRESA';

  case self.Operacao of
  uTipos.opIncluir: begin

                       lbl_sub_titulo.Caption := 'INCLUSÃO';
                       pnDados.Enabled := true;

                       lbl_Id.Caption := '-1';
                       lbl_cadastrado_em.Caption := DateToStr(Date);
                       btnOk.Caption := 'Incluir';

                     end;
  uTipos.opAlterar: begin

                      prc_ler_dados;
                      lbl_sub_titulo.Caption := 'ALTERAÇÃO';
                      btnOk.Caption    := 'Alterar';
                      //
                      btnOk.SetFocus;

                    end;
  uTipos.opExcluir: begin

                      prc_ler_dados;
                      lbl_sub_titulo.Caption := 'EXCLUIR';
                      pnDados.Enabled     := false;
                      btnOk.Caption       := 'Excluir';
                      btnFechar.SetFocus;

                    end;
  else
    begin
      pnDados.Enabled   := false;
      if btnFechar.CanFocus then btnFechar.SetFocus;
    end;
  end;

end;

procedure TfrmContasBancariasE.prc_ler_dados;
var
 loQry: TFDQuery;
begin

  try

    loQry := TFDQuery.Create(Self);
    try
      with loQry, loQry.Sql do
      begin
        Connection := Self.Conexao;
        Add('SELECT * FROM ' + Self.Tabela + ' WHERE ID =:ID');
        ParamByName('ID').AsInteger := Codigo;
        Open;
      end;
      if not loQry.IsEmpty then
      begin
        //Carrega dados do banco
        lbl_Id.Caption             := loQry.FieldByName('ID').AsString;
        lbl_cadastrado_em.Caption  := loQry.FieldByName('CADASTRADO_EM').AsString;
        lbl_alterado_em.Caption    := loQry.FieldByName('ALTERADO_EM').AsString;
        cbx_banco.keyvalue         := loQry.FieldByName('BANCO_ID').AsInteger;
        cb_ativo.Checked           := loQry.FieldByName('ATIVO').AsString = 'S';

        // carrega itens da tabela contas bancarias
        loqry.SQL.Clear;
        loQry.sql.Add('select * from contas_bancarias_itens where banco_id =:banco_id');
        loQry.params.ParamByName('banco_id').AsInteger := cbx_banco.keyvalue;
        loQry.Open;
        loQry.First;
        while not loqry.eof do
        begin

          mt_itens.Insert;
          mt_itensID.AsInteger      := loqry.FieldByName('id').AsInteger;
          mt_itensAGENCIA.AsString  := loqry.FieldByName('agencia').AsString;
          mt_itensNR_CONTA.AsString := loqry.FieldByName('nr_conta').AsString;
          mt_itensATIVO.AsString    := loqry.FieldByName('ativo').AsString;
          mt_itens.Post;

          loqry.Next;
        end;



      end
      else
      begin
        ShowMessage('conta NÃO encontrada!');

      end;
    finally
      FreeAndNil(loQry);
    end;
  except
    on E : Exception do
       Raise Exception.Create(E.Message + Self.Name + '.prc_ler_dados');
  end;
end;

procedure TfrmContasBancariasE.prc_salvar;
begin
  if not prc_validar then Exit;

  if not Self.Conexao.InTransaction then Self.Conexao.StartTransaction;
  //***
  try
    prc_incluir_alterar(Operacao);
    if Self.Conexao.InTransaction then Self.Conexao.Commit;
    ModalResult := mrOk;
  except
    conexao.Rollback;
    ShowMessage('Não foi possível salvar o registro');
  end;

end;

function TfrmContasBancariasE.prc_validar: boolean;
var loQry : TFDQuery;
begin
  result := false;


  if cbx_banco.text = '' then
  begin
    ShowMessage('informe um BANCO');
    cbx_banco.DropDown;
    exit;
  end;

  {verificar duplicidade}
  if Operacao = OpIncluir then
  begin
  {ver duplidicade}
  try
    loqry := TFDQuery.Create(self) ;
    loQry.Connection := conexao;
    loQry.SQL.Add('select * from contas_bancarias where banco_id =:banco_id');
    loqry.Params.ParamByName('banco_id').AsInteger := cbx_banco.KeyValue;
    loQry.Open;

    if not loQry.IsEmpty then
    begin
      ShowMessage('Banco já esta cadastrado');
      exit;
    end;
  finally
    FreeAndNil(loQry);
  end;
  end;

  if mt_itens.IsEmpty then
  begin
    ShowMessage('Cadastre as contas');
    btn_incluir.Click;
    exit;
  end;

  result := true;

end;

end.
