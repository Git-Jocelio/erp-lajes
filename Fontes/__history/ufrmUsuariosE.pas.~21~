unit ufrmUsuariosE;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseEdicao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.ExtCtrls, Vcl.DBCtrls, Vcl.Mask, uTipos, uBiblioteca, ufrmPesquisaPessoa,
  ufrmPessoasE;

type
  TfrmUsuariosE = class(TfrmBaseEdicao)
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    Label6: TLabel;
    Label7: TLabel;
    Label8: TLabel;
    Label9: TLabel;
    Label10: TLabel;
    Label11: TLabel;
    Label12: TLabel;
    Label13: TLabel;
    Label14: TLabel;
    Label15: TLabel;
    Label16: TLabel;
    Label17: TLabel;
    btnBuscaPessoa: TBitBtn;
    btnIncluirPessoa: TBitBtn;
    DBEdit1: TDBEdit;
    DBEdit2: TDBEdit;
    DBEdit3: TDBEdit;
    DBEdit6: TDBEdit;
    DBEdit7: TDBEdit;
    DBEdit8: TDBEdit;
    DBEdit9: TDBEdit;
    DBEdit10: TDBEdit;
    DBEdit11: TDBEdit;
    DBEdit12: TDBEdit;
    DBEdit13: TDBEdit;
    DBEdit14: TDBEdit;
    DBEdit15: TDBEdit;
    DBEdit16: TDBEdit;
    DBEdit17: TDBEdit;
    DBCheckBox1: TDBCheckBox;
    rgPessoa: TDBRadioGroup;
    gbx_usuario: TGroupBox;
    edt_login: TEdit;
    edt_senha: TEdit;
    Label4: TLabel;
    Label5: TLabel;
    qryPessoas: TFDQuery;
    dsPessoas: TDataSource;
    Label18: TLabel;
    edt_cadastrado_em: TEdit;
    cb_ativo: TCheckBox;
    procedure btnBuscaPessoaClick(Sender: TObject);
    procedure btnIncluirPessoaClick(Sender: TObject);

    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure btnOkClick(Sender: TObject);

  private
    FOperacao : uTipos.TOperacao;
    FTabela   : string;
    FCodigo   : integer;
    Fsenha    : string;
    Flogin    : string;
    Fpessoa_id: integer;

    procedure prc_limpar_tela;
    function  fnc_validar: Boolean;

    function  fnc_incluir: boolean;
    function  fnc_alterar: boolean;
    function  fnc_excluir: boolean;

    procedure prc_salvar;

  protected
    procedure prc_componentes;
    procedure prc_inicializar;
    procedure prc_ler_dados;

  public
    property Codigo   :integer read FCodigo write FCodigo;
    property Operacao :uTipos.TOperacao read FOperacao write FOperacao;
    property Tabela   :string read FTabela write FTabela;

    // Tabela
    property pessoa_id :integer read Fpessoa_id write Fpessoa_id;
    property login     :string read  Flogin write Flogin;
    property senha     :string read  Fsenha write Fsenha;


  end;

  procedure prc_incluir;
  procedure prc_alterar(ACodigo :integer);
  procedure prc_excluir(ACodigo :integer);

implementation

procedure prc_incluir;
var
  loForm : TfrmUsuariosE;
begin
  loForm := TfrmUsuariosE.Create(Application);
  try
    loForm.Operacao := uTipos.opIncluir;
    loForm.Codigo   := 0;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

procedure prc_alterar(ACodigo :integer);
var
  loForm : TfrmUsuariosE;
begin
  loForm := TfrmUsuariosE.Create(Application);
  try
    loForm.Operacao := uTipos.opAlterar;
    loForm.Codigo   := ACodigo;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

procedure prc_excluir(ACodigo :integer);
var
  loForm : TfrmUsuariosE;
begin
  loForm := TfrmUsuariosE.Create(Application);
  try
    loForm.Operacao := uTipos.opExcluir;
    loForm.Codigo   := ACodigo;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;


{$R *.dfm}

{ TfrmUsuariosE }

procedure TfrmUsuariosE.prc_inicializar;
begin
  case self.Operacao of
  uTipos.opIncluir: begin

                       pnTitulo.Caption := 'Manutenção de Usuários [Inclusão]';
                       pnDados.Enabled := true;
                       prc_limpar_tela;

                       btnBuscaPessoa.SetFocus;
                       {Novo id usuario}
                       self.Codigo := ubiblioteca.AutoIncremento(self.Conexao,self.Tabela);
                       ShowMessage(Inttostr(SELF.Codigo));
                       edt_cadastrado_em.Text := DateToStr(Date);
                       btnOk     .Caption := 'Incluir';

                     end;
  uTipos.opAlterar: begin

                      prc_ler_dados;
                      pnDados.Enabled  := false;
                      pnTitulo.Caption := 'Manutenção de Usuários [Alteração]';
                      btnOk.Caption    := 'Alterar';
                      //
                      btnOk.SetFocus;

                    end;
  uTipos.opExcluir: begin

                      prc_ler_dados;
                      pnTitulo.Caption    := 'Manutenção de Usuários [Exclusão]';
                      pnDados.Enabled     := false;
                      gbx_usuario.Enabled := false;
                      btnOk.Caption       := 'Excluir';
                      btnFechar.SetFocus;

                    end;
  else
    begin
      pnDados.Enabled   := false;
      //pnCliente.Enabled   := false;
      if btnFechar.CanFocus then btnFechar.SetFocus;
    end;
  end;


end;

procedure TfrmUsuariosE.prc_limpar_tela;
begin
  edt_login.Clear;
  edt_senha.Clear;
end;


procedure TfrmUsuariosE.prc_ler_dados;
var
  qryUsuario : TFDQuery;
begin
  try

    qryUsuario := TFDQuery.Create(Self);
    try
      with qryUsuario, qryUsuario.Sql do
      begin
        Connection := Self.Conexao;
        Add('SELECT * FROM ' + Self.Tabela + ' WHERE ID =:ID');
        ParamByName('ID').AsInteger := Self.Codigo;
        Open;
      end;
      if not qryUsuario.IsEmpty then
      begin
        //Carrega dados da pessoas
        pessoa_id := qryUsuario.FieldByName('PESSOA_ID').AsInteger;
        login     := qryUsuario.fieldbyname('LOGIN').AsString;
        senha     := qryUsuario.fieldbyname('SENHA').AsString;

        uBiblioteca.FilterCds( qryPessoas, utipos.fsInteger, inttostr(pessoa_id) );

        //Carrega dados do usuário
        edt_login.Text         := login;
        edt_senha.Text         := senha;
        edt_cadastrado_em.Text := DateToStr( qryUsuario.fieldbyname('CADASTRADO_EM').AsDateTime );
        cb_ativo.Checked       := qryUsuario.fieldbyname('ATIVO').AsString = 'S';

      end
      else
      begin
        ShowMessage('usuário não encontrado!');

      end;
    finally
      FreeAndNil(qryUsuario);
    end;
  except
    on E : Exception do
       Raise Exception.Create(E.Message + Self.Name + '.prc_ler_dados');
    end;
end;

procedure TfrmUsuariosE.btnBuscaPessoaClick(Sender: TObject);
begin
  if frmPesquisaPessoa = nil  then
  frmPesquisaPessoa := TfrmPesquisaPessoa.Create(Application);
  try
    frmPesquisaPessoa.ShowModal;

    ShowMessage(inttostr(frmPesquisaPessoa.Codigo));
    if frmPesquisaPessoa.Confirmado then
    begin
      pessoa_id := frmPesquisaPessoa.Codigo;
      uBiblioteca.FilterCds(qryPessoas, uTipos.fsInteger, inttostr(pessoa_id));
    end
    else
      qryPessoas.Close;
  finally
    FreeAndNil(frmPesquisaPessoa);

  end;
end;

procedure TfrmUsuariosE.btnIncluirPessoaClick(Sender: TObject);
begin
  inherited;
  ufrmPessoasE.incluir;

end;

procedure TfrmUsuariosE.btnOkClick(Sender: TObject);
begin
  inherited;
  try
    ModalResult := mrNone;
    //***
    prc_salvar;
  except
    on E : Exception do
       begin
       ShowMessage('Erro na prc_salvar');
       if Self.Conexao.InTransaction then
          Self.Conexao.Rollback;;
       //***
       Raise;
       end;
    end;

end;

procedure TfrmUsuariosE.FormCreate(Sender: TObject);
begin
  inherited;
  self.Tabela := 'USUARIOS';
end;

procedure TfrmUsuariosE.FormShow(Sender: TObject);
begin
  inherited;

  prc_componentes;
  prc_inicializar;

end;

procedure TfrmUsuariosE.prc_componentes;
begin
  {qry de pessoas}
  qryPessoas.Connection := SELF.Conexao;
  qryPessoas.SQL.Clear;
  qryPessoas.SQL.Add('select * from PESSOAS where ID =:ID');
end;

function TfrmUsuariosE.fnc_alterar: boolean;
var
  qry : TFDQuery;
begin
  try
    qry := TFDQuery.Create(Self);
    try
      with qry, qry.Sql do
      begin
        connection := Conexao;
        Add('UPDATE            ');
        Add('  USUARIOS        ');
        Add('SET               ');
        Add('  ID = :ID,       ');
        Add('  LOGIN = :LOGIN, ');
        Add('  SENHA = :SENHA, ');
        Add('  ATIVO = :ATIVO  ');
        Add('WHERE             ');
        Add('ID = :ID          ');

        ParamByName('ID').AsInteger   := self.Codigo;
        ParamByName('LOGIN').AsString := edt_login.Text;
        ParamByName('SENHA').AsString := edt_senha.Text;
        ParamByName('ATIVO').AsString := uBiblioteca.SeSenao(cb_ativo.Checked, 'S','N');
        ExecSQL;

        Result := (qry.RowsAffected > 0);



      end; // with


    finally
      FreeAndNil(qry);
    end; // try/finnaly
  except
    on E : Exception do
       Raise Exception.Create(E.Message + Self.Name +'.Alterar');
  end; //try/exception
end;

function TfrmUsuariosE.fnc_excluir: boolean;
var
  qry : TFDQuery;
begin
  try
    qry := TFDQuery.Create(Self);
    try
      with qry, qry.Sql do
      begin
        connection := Conexao;
        Add('UPDATE            ');
        Add('  USUARIOS        ');
        Add('SET               ');
        Add('  ID = :ID,       ');
        Add('  ATIVO = :ATIVO  ');
        Add('WHERE             ');
        Add('ID = :ID          ');

        ParamByName('ID').AsInteger   := self.Codigo;
        ParamByName('ATIVO').AsString := 'N';
        ExecSQL;

        Result := (qry.RowsAffected > 0);
      end; // with

    finally
      FreeAndNil(qry);
    end; // try/finnaly
  except
    on E : Exception do
       Raise Exception.Create(E.Message + Self.Name +'.Alterar');
  end; //try/exception
end;

function TfrmUsuariosE.fnc_incluir: boolean;
var
  qry : TFDQuery;
begin
  // Incluir Compras
  try
    qry := TFDQuery.Create(Self);
    try
      with qry, qry.Sql do
      begin
        Connection := Conexao;
        Add('INSERT INTO        ');
        Add('   USUARIOS        ');
        Add('  (ID,             ');
        Add('   PESSOA_ID,      ');
        Add('   LOGIN,          ');
        Add('   SENHA,          ');
        Add('   CADASTRADO_EM,  ');
        Add('   ATIVO)          ');
        Add('VALUES             ');
        Add('  (:ID,            ');
        Add('   :PESSOA_ID,     ');
        Add('   :LOGIN,         ');
        Add('   :SENHA,         ');
        Add('   :CADASTRADO_EM, ');
        Add('   :ATIVO)         ');

        ParamByName('ID').AsInteger         := self.Codigo;
        ParamByName('PESSOA_ID').AsInteger  := pessoa_id;
        ParamByName('LOGIN').AsString       := edt_login.Text;
        ParamByName('SENHA').AsString       := edt_senha.Text;
        ParamByName('CADASTRADO_EM').AsDate := date;
        ParamByName('ATIVO').AsString       := uBiblioteca.SeSenao (cb_ativo.Checked, 'S','N');
        ExecSQL;
        //***
        Result := (qry.RowsAffected > 0);
      end;



    finally
      FreeAndNil(qry);
    end;
  except
    on E : Exception do
       Raise Exception.Create(E.Message + Self.Name +'.Incluir Compras');
    end;
end;

function TfrmUsuariosE.fnc_validar: Boolean;
begin
  result := false;


  if qryPessoas.IsEmpty then
  begin
    ShowMessage('Selecione ou cadastre uma pessoa');
    btnBuscaPessoa.SetFocus;
    exit;
  end;


  if edt_login.Text = ''  then
  begin
    ShowMessage('Informe um LOGIN');
    edt_login.SetFocus;
    exit;
  end;

  if edt_senha.Text = '' then
  begin
    ShowMessage('Informe uma senha');
    edt_senha.SetFocus;
    exit;
  end;

  //***
  ShowMessage('Usuário validado com sucesso!');

  result := true;

end;

procedure TfrmUsuariosE.prc_salvar;
begin
  case Self.Operacao of

    // Inclusão
    uTipos.opIncluir :
    begin
      if not fnc_validar then Exit;

      if not Self.Conexao.InTransaction then Self.Conexao.StartTransaction;
      //***
      if fnc_incluir then
      begin
        if Self.Conexao.InTransaction then Self.Conexao.Commit;
        if Application.MessageBox('Deseja continuar incluindo?','Inclusão...',MB_YESNO) = mrYES then
          prc_inicializar
        else
          ModalResult := mrOk;
      end
      else
      begin
        ShowMessage('Não foi possível incluir o usuário');
      end;
    end;

    // Alteração
    uTipos.opAlterar :
    begin
      if not fnc_validar then Exit;
      if not Self.Conexao.InTransaction then Self.Conexao.StartTransaction;
      //***
      if fnc_alterar then
      begin
        if Self.Conexao.InTransaction then Self.Conexao.Commit;
        ModalResult := mrOk;
      end
      else
      begin
        ShowMessage('Não foi possível alterar o registro');
      end;
    end;

    //Exclusão
    uTipos.opExcluir :
    begin
      if Application.MessageBox('Deseja excluir este registro?','Atenção',MB_OKCANCEL) = mrOK then
      begin
        if not Self.Conexao.InTransaction then Self.Conexao.StartTransaction;
        if fnc_excluir then
        begin
          if Self.Conexao.InTransaction then Self.Conexao.Commit;
          ModalResult := mrOk;
        end
        else
        begin
          ShowMessage('Não foi possível excluir o usuário');
        end;
      end; // if
    end;
  end;// case
end;




end.
