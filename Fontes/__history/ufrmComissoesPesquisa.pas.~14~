unit ufrmComissoesPesquisa;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseEdicao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Vcl.DBCtrls, Vcl.ComCtrls, Vcl.StdCtrls, Data.DB, FireDAC.Comp.DataSet,
  FireDAC.Comp.Client, Vcl.Buttons, Vcl.ExtCtrls, Vcl.Grids, Vcl.DBGrids,
  uBiblioteca;

type
  TfrmComissoesPesquisa = class(TfrmBaseEdicao)
    Panel1: TPanel;
    gb_data_contabil: TGroupBox;
    Label7: TLabel;
    cb_data_contabil: TCheckBox;
    dtp_data_contabil_ini: TDateTimePicker;
    dtp_data_contabil_fim: TDateTimePicker;
    Label1: TLabel;
    lbl_nome_vendedor: TLabel;
    btnLocalizar: TBitBtn;
    dbn_principal: TDBNavigator;
    dbg_comissoes: TDBGrid;

    procedure btnLocalizarClick(Sender: TObject);
    procedure btnOkClick(Sender: TObject);
    procedure btnFecharClick(Sender: TObject);

    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);


  private
    Fp_vendedor_id: integer;
    Fp_confirmado: boolean;

    procedure prc_componentes;
    procedure prc_filtrar;
  public

    property p_vendedor_id : integer read Fp_vendedor_id write Fp_vendedor_id;
    property p_confirmado : boolean read Fp_confirmado write Fp_confirmado;

  end;

var
  frmComissoesPesquisa : TfrmComissoesPesquisa;

implementation

{$R *.dfm}

procedure TfrmComissoesPesquisa.btnFecharClick(Sender: TObject);
begin
  p_confirmado := false;
  close;
  //inherited;
end;

procedure TfrmComissoesPesquisa.btnLocalizarClick(Sender: TObject);
begin
  inherited;

  if cb_data_contabil.Checked then
  begin

    if dtp_data_contabil_fim.date < dtp_data_contabil_ini.Date then
      ShowMessage('informe uma data válida');

    dtp_data_contabil_fim.SetFocus;

  end;

  prc_filtrar;

end;

procedure TfrmComissoesPesquisa.btnOkClick(Sender: TObject);
begin
  inherited;
  p_confirmado := false;

  if dbg_comissoes.SelectedRows.Count = 0 then
  begin
    ShowMessage('nenhum item selecionado');
    btnLocalizar.SetFocus;
    exit;
  end;


  p_confirmado := true;
  close;
end;


procedure TfrmComissoesPesquisa.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
 {deixar marcado senão fecha o dataset, procedure heradada}
 // inherited;

end;

procedure TfrmComissoesPesquisa.FormCreate(Sender: TObject);
begin
  inherited;

  titulo := 'Pesquisa de comissões' ;
  lbl_sub_titulo.Caption := 'Lista todas as comissões em aberto do vendedor em um periodo pré-selecionado';

end;

procedure TfrmComissoesPesquisa.FormShow(Sender: TObject);
begin
  inherited;
  prc_componentes;
end;

procedure TfrmComissoesPesquisa.prc_componentes;
var
  loQry: TFDQuery;
begin

  {nome do vendedor}
  loQry := uBiblioteca.CriaQuery( conexao, 'select * from PESSOAS where ID =:ID', false);
  loqry.ParamByName('ID').AsInteger := p_vendedor_id;
  loQry.Open;

  lbl_nome_vendedor.Caption := loQry.FieldByName('NOME').AsString;
  FreeAndNil(loQry);

  {datas default}
  dtp_data_contabil_ini.Date := date;
  dtp_data_contabil_fim.Date := date;

  btnOk.Enabled := false;

end;

procedure TfrmComissoesPesquisa.prc_filtrar;
var
  loSql, condicao : string;
begin

  btnOk.Enabled := false;
  condicao      := '';
  loSql         := '';

  //loSql := 'select * from COMISSAO where STATUS = ' + QuotedStr('A') + ' and VENDEDOR_ID =:VENDEDOR_ID';

  loSql := 'select ';
  loSql := loSql + '  C.id,';
  loSql := loSql + '  C.data_contabil,';
  loSql := loSql + '  C.pedido_id,';
  loSql := loSql + '  cli.nome,';
  loSql := loSql + '  cli.bairro,';
  loSql := loSql + '  C.vendedor_id,';
  loSql := loSql + '  C.total_venda,';
  loSql := loSql + '  C.total_custo,';
  loSql := loSql + '  C.outras_despesas,';
  loSql := loSql + '  C.comissao_adm,';
  loSql := loSql + '  C.comissao_bruta,';
  loSql := loSql + '  C.comissao_liquida,';
  loSql := loSql + '  C.status,';
  loSql := loSql + '  C.historico ';
  loSql := loSql + 'from ';
  loSql := loSql + '  comissao C, ';
  loSql := loSql + '  pedidos P, ';
  loSql := loSql + '  pessoas cli ';
  loSql := loSql + 'where ';
  loSql := loSql + '  C.status = ' + QuotedStr('A') + ' and ';
  loSql := loSql + '  c.pedido_id = P.ID and';
  loSql := loSql + '  cli.id = p.cliente_id and ';
  loSql := loSql + '  c.vendedor_id = :VENDEDOR_ID ';





  if cb_data_contabil.Checked then
  begin
     condicao := ' and C.DATA_CONTABIL between :DATA_INI and :DATA_FIM ';
  end;


  loSql := loSql + condicao;
  //  ShowMessage(loSql);
  qry.SQL.Text := loSql;
  {parametros}


  if cb_data_contabil.Checked then
  begin
    qry.ParamByName('DATA_INI').AsDate := dtp_data_contabil_ini.Date;
    qry.ParamByName('DATA_FIM').AsDate := dtp_data_contabil_fim.Date;
  end;

  qry.ParamByName('VENDEDOR_ID').AsInteger := p_vendedor_id;


  qry.Open;
  //ShowMessage(qry.SQL.Text);
  if qry.IsEmpty then
  begin
    ShowMessage('Nenhum registro encontrado!');
  end
  else
    btnOk.Enabled := true;

end;


end.
