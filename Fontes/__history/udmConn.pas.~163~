unit udmConn;

interface

uses
  System.SysUtils, System.Classes, FireDAC.Stan.Intf, FireDAC.Stan.Option,
  FireDAC.Stan.Error, FireDAC.UI.Intf, FireDAC.Phys.Intf, FireDAC.Stan.Def,
  FireDAC.Stan.Pool, FireDAC.Stan.Async, FireDAC.Phys, FireDAC.VCLUI.Wait,
  FireDAC.Phys.FBDef, FireDAC.Phys.IBBase, FireDAC.Phys.FB, Data.DB,
  FireDAC.Comp.Client, IniFiles, Vcl.Forms, FireDAC.Comp.UI, Classe.Conexao,
  uClasse.Empresa;

type
  TdmConn = class(TDataModule)
    FDConnection: TFDConnection;
    WaitCursor: TFDGUIxWaitCursor;
    FBDriverLink: TFDPhysFBDriverLink;

    procedure FDConnectionBeforeConnect(Sender: TObject);

    procedure DataModuleCreate(Sender: TObject);
    procedure DataModuleDestroy(Sender: TObject);
  private
    Fservidor: string;
    { Private declarations }
  public
    conexao : Tconexao;
    empresa : TEmpresa;

    Ini: TIniFile;
    procedure lerIni;
    procedure gravarIni;


    property servidor :string read Fservidor write Fservidor;
  end;

const
  parametros = 'conexao';

const
  {toda vez que sair uma nova versão incrementar aqui}
  //versao_neste_app = 70;
  //versao_neste_app = 71; // 09/05/22 frmPedidos mostra o local de entrega na barra de status sempre que houver
  //versao_neste_app = 72; // 10/05/22 frmPedidosE Emissão de pedidos com vigas Painel
  //versao_neste_app = 73; // 16/05/22 frmComissoes mostra o local de entrega no panel detalhes sempre que houver
  //versao_neste_app = 74; // 19/05/22 frmRelPedidos, retirada de bugs no enderedo de entrega
  //versao_neste_app = 75; // 20/05/22 frmRelPedidos, corrigido um erro onde quando vendia viga com adicional, não aparecia os adicionais na impressão erro : FALTOU UM S no nome da tabela
  //versao_neste_app = 76; // 20/05/22 frmPedidosE, corrigido um erro qtde real da laje , erro estava em não passar a largura da forma pra calculo
  //versao_neste_app = 77; // 25/05/22 tabela pedido_local_entrega , aumentado o campo bairro de 30 para 55
  //versao_neste_app = 78; // 27/05/22 alterado a comissão adm para 1%
  //versao_neste_app = 79; // 01/06/22 retirada de bugs relatorio comissao, frmpedidoE exclui lancamento dentro do pedido, frmPedidoE chamada da tela pesquisa cliente qdo pedido novo
  //versao_neste_app = 80; // 07/06/22 bugs Taty
  //versao_neste_app = 81; // 07/06/22 bugs Taty
  //versao_neste_app = 82; // 08/06/22 novo contas a receber baixa igual o da fabrica, terminei dia 10
  //versao_neste_app = 83; // 14/06/22 bugs taty
  //versao_neste_app = 84; // 28/06/22 relatório de agrupamento de vigas
  //versao_neste_app = 85; // 30/06/22 inclusão de cx de nervura por nivel
  //versao_neste_app = 86; // 04/07/22 frmPedidosE retirada bugs na comissão
  //versao_neste_app = 87; // 04/07/22 frmPessoaE, frmClientes E gera o id só quando salva
  //versao_neste_app = 88; // 12/09/22 SISTEMA RODARA DENTRO DA PASTA C:\SYSLAJES
  //versao_neste_app = 89; // 25/10/2023 retomado o desenvolvimento do sistema, novo cliente Lajes ferrari,
                         // sera implementado de imediato uma nova forma de calcular as comissões de vendedoes
                         // mas para isso terei que começar com o cadastro de  plano de contas
  //versao_neste_app = 90; // 01/11/2023 Plano de contas "finalizado"! iniciando o contas a pagar
  //versao_neste_app = 91; // 15/11/2023 iniciando o contas a pagar
  //versao_neste_app = 92; // 08/01/2024 agora em definitivo no sistema, continuando o contas apagar,
                         // implementando lancamento de descontos e acrescimos
                         // 10/01/2023 retirada de bugs no contas a pagar, e iniciando a inclusao dos dados na tabela de contas_pagar_lancamentos
                         // terminado o contas a pagar... iniciar contas a pagar baixa (baixa manual)
                         // contas a pagar pronto!
  //versao_neste_app = 93; // 15/01/2024 enviar comissões ao contas a pagar...
  // 26/01/2024 - devido ao novo contato da ana ferrari vou dar continuidade na parte que gera a comissão da lajes ferrari
  // a ideia é criar uma tabela de preços de lajes amarrado com a forma de pagto, conf a forma seleciona
  // o preço muda, isso na emissão do pedido
  // hoje vou tirar um bug do cadastro de forma de pagamento ... ordenação na coluna clicada na grid
  // corrigido o erro.. faltou carregar a variavel sSql com o sql da qry principal.
  // criar tabela no banco de dados, vou chamar de TABELA_PRECOS...
  // form tabela de preços criado .. falta o CRUD
  // 27/01/2024 resolvi por o cadastro dentro do form de produtos, coloquei uma grid e vou criar um
  // mestre detalhe produto e suas formas de pagamento. talvez mude o nome da tabela de: tabela_precos para
  // PRODUTOS_FORMA_PAGTO e talvez use os forms ja criados para pesquisa ... vou ver ainda
  // 30/01 ainda modificando o cadastro de produtos_lajes...
  //  versao_neste_app = 94; // modificado o cadastro de lajesE, incluido um mestre detalhe com as formas de pagamento
  // vou ter que implementar mais tarde em todos os cadastros de produtos
  // proximo passo... modificar o pedido pra calcular a comissão da lajes ferrari, mas antes devo atualizar as
  // tabelas no servidor da lajes triunfo(ja atualizei). talvez faça o controle de compras antes da comissão...
  // 02/02/2024 fiz a mesma alteração no form de produtos revenda,
  // no pedido inclui uma chamada para o form pesquisa formas de pagamento e no pesquisa produtos
  // ja busca o preço conforme forma de pagamento selecionada
  // proximos passos
  // implementar essas alterações de forma de pagamento nos restantes dos cadastro
  // começar testes para implementação da comissão da lajes ferrari
  // fazendo adaptacao do calculo de comissao da lajes ferrari no pedido, parei no calculo do painel de comissoes
  // olivia me ligou e passando mais problemas... não tenho condições de continuar por hoje... DEUS
  // ajude que resolva essa situação com ela o mais rápido possivel,
  // 15/02/2024 ... terminei a implementação do calculo da comissao ferrari no pedidoE,
  // tambem fa fiz o relatório de comissão ferrari ufa! não ficou como eu queria ainda
  // ta meio engessado.. depois vou buscar os dados da tabela de comissao pra casso haja alteração nas comissoes ja reflita nos relatorios
  // proximi passo fazer um controle pra ver qual empresa esta usando o sistema pra controlar o que pode ser visto (feito!)
  // 20/02/2023 implementado a inclusao dos valores calculados da comissao do pedido, no contas a pagar, insert ok, falta fazer a edicao,
  // caso o pedido seja modificado. feito!
  // 21/02/2024 feito os primeiros testes com sucesso, tive que fazer uma nova tela de configurações do sistema, onde o
  // usuario escolhe no plano de contas o numero da conta
  //versao_neste_app = 95;
  // iniciado o controle de compras
  // 1. atualizar o banco de dados da lajes triunfo()
  // 05/03/2024 alterado o cadastro de treliças, vou alterar a forma de calcular os custos das lajes onde usa treliça por kg,
  // agora usarei por metro, pq fica mais didatico para o usúario, só após isso voltarei ao compras
  //versao_neste_app = 96;
  // 14/03/2024
  // alterado o calculo de custo de vigas e lajes, incluso a possibilidade de incluir a mão de obra fretes etc
  // próximo passo
  // 1. atualizar banco triunfo ok atualizado em 19/03/2024
  // 2. voltar ao compras
  // 3. iniciar o controle de estoques
  //versao_app   = 100;
  versao_banco = 1;
  //versao_app   = 101;// alterações no contas a receber, e atalho no pedido pra chamar o contas a receber
  //versao_app = 102; // retirada de bug no frmPedidoE
  //versao_app = 103; // retirada de bug no frmPedidoE e no calculo de qtde de laje painel
  //versao_app = 104; // totalizações no formPedidos
  //versao_app = 105; // retirada de bugs no formPedidos
  //versao_app = 106; // retirada de bugs no formPedidos no calculo de comissoes despesa
  //versao_app = 107; // retirada de bugs no formPedidos no calculo de comissoes despesa
  //versao_app = 108; // retirada de bugs no formPedidos no calculo de comissoes despesa e mudanças na procedure autoIncremento
  //versao_app = 109; // arrastar painel de reforço de vigas
  //versao_app = 110; // troca do commit retaing por commit na gravação do pedido
  //versao_app = 111; // configuracoes do sistema.. coluna dt emissao/contabil check box pra visualizar ou não
  //versao_app = 112; // troca do ip do servidor triunfo para 192.168.1.120
  //versao_app = 113; // retira de bugs no frmContasReceber_Baixa(atualização do valor pago do pedido errada)
  //versao_app = 114; // versão com controle de estoques para teste
  //versao_app = 115; // retirada de bugs tela de pedido, conf. tamanho fonte tela de mensagens,
                    // implementado pesquisa na tela de compras, etc

  //versao_app = 116; // inclusao do campo data_entrega na tabela de pedidos_itens
  //versao_app = 117; // modifiquei o codido na procedure que baixa os estoques de vigas.
                    // caso as vigas estiverem marcadas estoque_controlado = 'N', NÃO BAIXA
  //versao_app = 118; // finalizado o contas a pagar, lança os estoques e o contas a pagar, melhorei a pesquisa tambem.
  //versao_app = 119; // implementado controle de ordem de compra( notificações do sistema )
  //versao_app = 120; // retirada de bugs controle de ordem de compra( notificações do sistema )
  //versao_app = 121; // controle de estoque igual do sistema anterior
  //versao_app = 122; // inclusão do item trelifacil
  //versao_app = 123; // retirada de bugs no frmpedidosE
  //versao_app = 124; // retirada de bugs no frmPedidos -> chamada do contas a receber
  //versao_app = 125; // retirada de bugs no frmPedidos -> calculo da metragem quadrada da trelifacil
  //versao_app = 126; // 01/01/2025 implementado aba financeira dentro frmPedidosE
  //versao_app = 127; //23/01/2025; retirada de varios bugs no controle de estoques
  //versao_app = 128; //13/05/2025; inicio da parte financeira
  //versao_app = 129; //19/05/2025; retirada de bug no form PedidosE, erro exclusão de adicionais na viga
  //versao_app = 150;   //15/07/2025; parte financeira finalizada para testes
  //versao_app = 151;   //15/07/2025; retirada de bugs
  //versao_app = 152;   //20/07/2025; retirada de bugs
  //versao_app = 153;   //24/07/2025; retirada de bugs
  versao_app = 154;   //28/07/2025; pesquisa de cheques de clientes

var
  dmConn: TdmConn;

implementation

uses
  Vcl.Dialogs;

{%CLASSGROUP 'Vcl.Controls.TControl'}
{$R *.dfm}
{ TdmConn }

procedure TdmConn.FDConnectionBeforeConnect(Sender: TObject);
begin
// lerIni;
end;

procedure TdmConn.DataModuleCreate(Sender: TObject);
begin

  FBDriverLink.VendorLib := ExtractFilePath(Application.ExeName) + 'BD\fbclient.dll';
  FDConnection.Connected := false;
                conexao  := Tconexao.Create( FDConnection );
                servidor := conexao.servidor;

end;

procedure TdmConn.DataModuleDestroy(Sender: TObject);
begin
   conexao.Destroy;
end;

procedure TdmConn.gravarIni;
begin
  //
end;

procedure TdmConn.lerIni;
begin
  try
    Ini := TIniFile.Create(ExtractFilePath(Application.ExeName) + 'config.ini');
(*  Conn.Params.Values['database']        := Ini.ReadString(parametros,'database','lajes');
    Conn.Params.Values['user_name']       := Ini.ReadString(parametros, 'user_name','sysdba');
    Conn.Params.Values['password']        := Ini.ReadString(parametros, 'password','masterkey');
    Conn.Params.Add('server=' +           Ini.ReadString(parametros, 'server','127.0.0.1'));
    Conn.Params.Add('port=' +             Ini.ReadString(parametros, 'port','3050'));
*)

    Ini := TIniFile.Create(ExtractFilePath(Application.ExeName) + 'config.ini');
    FDConnection.Params.Values['database']  := Ini.ReadString(parametros,'database','');
    FDConnection.Params.Values['user_name'] := Ini.ReadString(parametros, 'user_name','');
    FDConnection.Params.Values['password']  := Ini.ReadString(parametros, 'password','');
    FDConnection.Params.Add('server=' + Ini.ReadString(parametros, 'server',''));
    FDConnection.Params.Add('port=' + Ini.ReadString(parametros, 'port','3050'));


  finally
   FreeAndNil(ini);
  end;
end;

end.
