unit ufrmComprasE;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseEdicao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.ExtCtrls, uTipos, uBiblioteca, Vcl.DBCtrls, Vcl.ComCtrls, Vcl.Grids,
  Vcl.DBGrids, unit_calcular_custo_de_lajes, uFinanceiro ;


type
  TfrmComprasE = class(TfrmBaseEdicao)
    Label1: TLabel;
    lbl_compra_id: TLabel;
    Label2: TLabel;
    lbl_Cadastrado_em: TLabel;
    Label4: TLabel;
    lbl_alterado_em: TLabel;
    Label6: TLabel;
    dtp_data_contabil: TDateTimePicker;
    Label7: TLabel;
    edt_nr_pedido: TEdit;
    Label8: TLabel;
    Label9: TLabel;
    Label10: TLabel;
    pnl_valor_produtos: TPanel;
    Label11: TLabel;
    Label12: TLabel;
    Label13: TLabel;
    pnl_valor_pedido: TPanel;
    edt_acrescimos: TEdit;
    edt_desconto: TEdit;
    Label14: TLabel;
    Label15: TLabel;
    cbx_situacao: TComboBox;
    pc_produtos: TPageControl;
    tbs_produtos: TTabSheet;
    tbs_parcelas: TTabSheet;
    dbg_produtos: TDBGrid;
    pnl_botoes_produtos: TPanel;
    btn_produto_incluir: TSpeedButton;
    btn_produto_excluir: TSpeedButton;
    pnl_botoes_parcelas: TPanel;
    btn_parcelas_editar: TSpeedButton;
    btn_parcelas_excluir: TSpeedButton;
    dbg_parcelas: TDBGrid;
    btn_produto_editar: TSpeedButton;
    pnl_forma_pagto: TPanel;
    btn_busca_forma_pagto: TSpeedButton;
    qry_forma_pagto: TFDQuery;
    ds_plano_contas: TDataSource;
    qry_plano_contas: TFDQuery;
    cbx_plano_contas: TDBLookupComboBox;
    cbx_fornecedores: TDBLookupComboBox;
    ds_fornecedores: TDataSource;
    qry_fornecedores: TFDQuery;
    ds_produtos: TDataSource;
    mtb_produtos: TFDMemTable;
    mtb_produtosID: TIntegerField;
    mtb_produtosCOMPRA_ID: TIntegerField;
    mtb_produtosPRODUTO_ID: TIntegerField;
    mtb_produtosDESCRICAO: TStringField;
    mtb_produtosQUANTIDADE: TFloatField;
    mtb_produtosUNITARIO: TFloatField;
    mtb_produtosTOTAL: TFloatField;
    mtb_produtosUNIDADE: TStringField;
    lbl_titulo_topo: TLabel;
    btn_incluir_fornecedor: TBitBtn;
    mt_itens_deletados: TFDMemTable;
    mt_itens_deletadosID: TIntegerField;
    Label3: TLabel;
    btn_fechar: TSpeedButton;
    btn_gerar_parcelas: TSpeedButton;
    mtb_parcelas: TFDMemTable;
    ds_parcelas: TDataSource;
    mtb_parcelasCONTA_PAGAR_ID: TIntegerField;
    mtb_parcelasNR_DOCUMENTO: TStringField;
    mtb_parcelasVENCIMENTO: TDateField;
    mtb_parcelasVALOR_PARCELA: TFloatField;
    mtb_parcelasVALOR_PAGO: TFloatField;
    mtb_parcelasDATA_PAGTO: TFloatField;
    mtb_parcelasTOTAL_PARCELA: TAggregateField;
    btn_forma_pagto: TBitBtn;
    mtb_parcelas_deletadas: TFDMemTable;
    mtb_parcelas_deletadasID: TIntegerField;
    DBGrid1: TDBGrid;
    DataSource1: TDataSource;

    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);

    procedure btn_busca_forma_pagtoClick(Sender: TObject);
    procedure edt_acrescimosKeyPress(Sender: TObject; var Key: Char);
    procedure btn_produto_incluirClick(Sender: TObject);
    procedure btnOkClick(Sender: TObject);
    procedure cbx_fornecedoresCloseUp(Sender: TObject);
    procedure ds_produtosDataChange(Sender: TObject; Field: TField);
    procedure btn_produto_excluirClick(Sender: TObject);
    procedure btn_produto_editarClick(Sender: TObject);
    procedure edt_acrescimosExit(Sender: TObject);
    procedure edt_descontoExit(Sender: TObject);
    procedure btn_incluir_fornecedorClick(Sender: TObject);
    procedure btn_fecharClick(Sender: TObject);
    procedure dbg_produtosDblClick(Sender: TObject);
    procedure btn_gerar_parcelasClick(Sender: TObject);
    procedure ds_parcelasDataChange(Sender: TObject; Field: TField);
    procedure btn_parcelas_excluirClick(Sender: TObject);
    procedure btn_forma_pagtoClick(Sender: TObject);
    procedure btn_parcelas_editarClick(Sender: TObject);
  private
    FOperacao: uTipos.TOperacao;
    FTabela: string;
    FCodigo: integer;
    Fp_forma_pagto_id: integer;
    Fp_fornecedor_id: integer;

    procedure prc_componentes;
    procedure prc_inicializar;
    procedure prc_ler_dados;

    function fnc_validar: boolean;
    procedure prc_salvar;
    procedure prc_incluir_alterar(_operacao :TOperacao);
    procedure prc_totais;
    procedure prc_incluir_alterar_itens;
    procedure prc_incluir_alterar_na_grid(operacao: TOperacao);
    procedure prc_verificar_preco_de_custo( produto_id : integer; preco_novo: double );
    procedure prc_gerar_parcelas(Operacao: uTipos.TOperacao;
      conta_pagar_id: integer; nr_documento: string; vencimento: TDate;
      valor_parcela, valor_pago: double; data_pagamento: TDate);
    { Private declarations }
  public

    property Codigo   :integer read FCodigo write FCodigo;
    property Operacao :uTipos.TOperacao read FOperacao write FOperacao;
    property Tabela   :string read FTabela write FTabela;
    // propriedades da compra
    property p_forma_pagto_id :integer read Fp_forma_pagto_id write Fp_forma_pagto_id;
    property p_fornecedor_id :integer read Fp_fornecedor_id write Fp_fornecedor_id;

  end;
var
  loForm : TfrmComprasE;

  procedure prc_incluir;
  procedure prc_alterar(ACodigo :integer);
  procedure prc_excluir(ACodigo :integer);

implementation

uses unit_funcoes, unit_principal, ufrmPesquisaFormaPagamento,
     ufrmPesquisaProdutos, ufrmFornecedoresE, unit_controle_estoques,
     ufrmProdutosVigas, udmConn, ufrmFormaPagto, unit_movimenta_estoques;

procedure prc_incluir;
begin

  if loForm = nil then
  begin

    loForm := TfrmComprasE.Create(Application);

    form_principal.prc_controla_menu(false);

    // se abrir dentro no painel principal não funciona os edites
    //loform.Parent := form_principal.pnl_principal;

    loform.top    := form_principal.pnl_Principal.Top;
    loform.Left   := form_principal.pnl_menulateral.Width;
    loForm.Width  := form_principal.pnl_principal.Width;
    loForm.Height := form_principal.pnl_principal.Height;

    loForm.Operacao := uTipos.OpIncluir;
    loForm.codigo := 0;

  end;

  loForm.Show;

end;

procedure prc_alterar(ACodigo :integer);
begin

  if loForm = nil then
  begin

    loForm := TfrmComprasE.Create(Application);

    form_principal.prc_controla_menu(false);

    // se abrir dentro no painel principal não funciona os edites
    //loform.Parent := form_principal.pnl_principal;

    loform.top    := form_principal.pnl_Principal.Top;
    loform.Left   := form_principal.pnl_menulateral.Width;
    loForm.Width  := form_principal.pnl_principal.Width;
    loForm.Height := form_principal.pnl_principal.Height;

    loForm.Operacao := uTipos.opAlterar;
    loForm.Codigo   := ACodigo;

  end;

  loForm.Show;

end;

procedure prc_excluir(ACodigo :integer);
begin

  if loForm = nil then
  begin

    loForm := TfrmComprasE.Create(Application);

    form_principal.prc_controla_menu(false);

    // se abrir dentro no painel principal não funciona os edites
    //loform.Parent := form_principal.pnl_principal;

    loform.top    := form_principal.pnl_Principal.Top;
    loform.Left   := form_principal.pnl_menulateral.Width;
    loForm.Width  := form_principal.pnl_principal.Width;
    loForm.Height := form_principal.pnl_principal.Height;

    loForm.Operacao := uTipos.opExcluir;
    loForm.Codigo   := ACodigo;

  end;

  loForm.Show;

end;


{$R *.dfm}

procedure TfrmComprasE.btn_incluir_fornecedorClick(Sender: TObject);
begin
  inherited;
  ufrmFornecedoresE.prc_incluir;
  qry_fornecedores.Close;
  qry_fornecedores.Open;
end;

procedure TfrmComprasE.btnOkClick(Sender: TObject);
begin
  inherited;
  prc_salvar;
end;

procedure TfrmComprasE.btn_busca_forma_pagtoClick(Sender: TObject);
begin
  inherited;
  p_forma_pagto_id := ufrmPesquisaFormaPagamento.fnc_executar;
  FilterCds(qry_forma_pagto, fsInteger, inttostr(p_forma_pagto_id)) ;

  if p_forma_pagto_id > 0 then
  begin
    pnl_forma_pagto.Caption := qry_forma_pagto.FieldByName('DESCRICAO').AsString;
  end
  else if p_forma_pagto_id <= 0 then
  begin
    pnl_forma_pagto.Caption := 'Selecione uma forma de pagamento';
  end;

  if not mtb_produtos.IsEmpty then
    btn_gerar_parcelas.Click;
  

end;

procedure TfrmComprasE.btn_fecharClick(Sender: TObject);
begin
  inherited;
  close;
end;

procedure TfrmComprasE.btn_forma_pagtoClick(Sender: TObject);
begin
  inherited;
  ufrmFormaPagto.executa;
end;

procedure TfrmComprasE.btn_parcelas_editarClick(Sender: TObject);
begin
  inherited;
  showmessage('desenvolver');
end;

procedure TfrmComprasE.btn_parcelas_excluirClick(Sender: TObject);
begin
  inherited;

  if not mtb_parcelas.IsEmpty then
  begin

   if mtb_parcelasCONTA_PAGAR_ID.AsInteger > 0 then
   begin
     mtb_parcelas_deletadas.Insert;
     mtb_parcelas_deletadas.fieldbyname('ID').AsInteger := mtb_parcelasCONTA_PAGAR_ID.AsInteger ;
     mtb_parcelas_deletadas.post;
   end;

   mtb_parcelas.Delete;
  end;

end;

procedure TfrmComprasE.btn_produto_editarClick(Sender: TObject);
begin
  inherited;
  if frmPesquisaProdutos = nil then
  begin
    frmPesquisaProdutos := TfrmPesquisaProdutos.Create(self);
    try
      {abre a pesquisa mostrando todos os produtos}
      frmPesquisaProdutos.rgFiltrar.ItemIndex := 7; // todos
      frmPesquisaProdutos.btnBuscar.Click;
    //  frmPesquisaProdutos.edItemPedido.Caption:= inttostr(item);

      frmPesquisaProdutos.p_forma_pagto_id            := p_forma_pagto_id;
      frmPesquisaProdutos.lbl_forma_pagamento.Visible := false;
      frmPesquisaProdutos.gbItemPedido.Visible        := false;

      {esconde a coluna preço do fornecedor}
      frmPesquisaProdutos.dbgProdutos.Columns[5].Visible := false;
      frmPesquisaProdutos.dbgProdutos.Columns[6].Visible := false;
      frmPesquisaProdutos.gb_Preco_vendedor.Visible      := false;
      frmPesquisaProdutos.gbPrecoVenda.Visible           := false;

      {posiciona no item selecionado}
      frmPesquisaProdutos.qry.First;
      if frmPesquisaProdutos.qry.Locate('ID', mtb_produtos.FieldByName('PRODUTO_ID').AsInteger, []) then
      begin
       frmPesquisaProdutos.edQtde.Text := FormatFloat('0.00', strtofloat(mtb_produtos.FieldByName('QUANTIDADE').AsString));
       frmPesquisaProdutos.edt_preco_fornecedor.Text := FormatFloat('0.00', strtofloat(mtb_produtos.FieldByName('UNITARIO').AsString));
      end;
      frmPesquisaProdutos.ShowModal;

      if frmPesquisaProdutos.itemConfirmado then
      begin
        prc_incluir_alterar_na_grid(opAlterar);
      end;

    finally
      freeandnil(frmPesquisaProdutos) ;
    end;
  end;

end;

procedure TfrmComprasE.btn_produto_excluirClick(Sender: TObject);
begin
  inherited;

    prc_incluir_alterar_na_grid(opExcluir);
end;

procedure TfrmComprasE.btn_produto_incluirClick(Sender: TObject);
begin
  inherited;
  if frmPesquisaProdutos = nil then
  begin
    frmPesquisaProdutos := TfrmPesquisaProdutos.Create(self);
    try
      {abre a pesquisa mostrando todos os produtos}
      frmPesquisaProdutos.rgFiltrar.ItemIndex := 7; // todos
      frmPesquisaProdutos.btnBuscar.Click;
    //  frmPesquisaProdutos.edItemPedido.Caption:= inttostr(item);

      frmPesquisaProdutos.p_forma_pagto_id            := p_forma_pagto_id;
      frmPesquisaProdutos.lbl_forma_pagamento.Visible := FALSE;
      frmPesquisaProdutos.gbItemPedido.Visible        := FALSE;

      {esconde a coluna preço do fornecedor}
      frmPesquisaProdutos.dbgProdutos.Columns[5].Visible := false;
      frmPesquisaProdutos.dbgProdutos.Columns[6].Visible := false;
      frmPesquisaProdutos.gb_Preco_vendedor.Visible      := false;
      frmPesquisaProdutos.gbPrecoVenda.Visible           := false;


      frmPesquisaProdutos.ShowModal;

      if frmPesquisaProdutos.itemConfirmado then
        prc_incluir_alterar_na_grid(OpIncluir);

    finally
      freeandnil(frmPesquisaProdutos) ;
    end;
  end;
end;


procedure TfrmComprasE.prc_incluir_alterar_na_grid(operacao: TOperacao);
begin

  {inclui o id da taxa na memoria para deletar da confirmição }
  if operacao = opExcluir then
  begin
    if mtb_produtosID.AsInteger > 0 then
    begin
      mt_itens_deletados.Insert;
      mt_itens_deletadosID.AsInteger := mtb_produtosID.AsInteger;
      mt_itens_deletados.Post;
    end;

    mtb_produtos.Delete;
    prc_totais;

    exit;
  end;



  if operacao = OpIncluir then
  begin
    //p_id := p_id -1;

    mtb_produtos.Insert;
    mtb_produtos.FieldByName('ID').AsInteger         := -1;
    mtb_produtos.FieldByName('COMPRA_ID').AsInteger  := -1;
    mtb_produtos.FieldByName('PRODUTO_ID').AsInteger := frmPesquisaProdutos.Produto;
    mtb_produtos.FieldByName('DESCRICAO').AsString   := frmPesquisaProdutos.Descricao;
    mtb_produtos.FieldByName('QUANTIDADE').AsFloat   := frmPesquisaProdutos.Qtde;
    mtb_produtos.FieldByName('UNIDADE').AsString     := frmPesquisaProdutos.p_unidade;
    mtb_produtos.FieldByName('UNITARIO').AsFloat     := StrToFloat( frmPesquisaProdutos.edt_preco_fornecedor.Text);
    mtb_produtos.FieldByName('TOTAL').AsFloat        := frmPesquisaProdutos.Qtde * StrToFloat( frmPesquisaProdutos.edt_preco_fornecedor.Text);
    mtb_produtos.post;

    prc_totais;

  end
  else
  begin
    mtb_produtos.Edit;
    //mtb_produtos.FieldByName('ID').AsInteger         := -1;
    mtb_produtos.FieldByName('COMPRA_ID').AsInteger  := CODIGO;
    mtb_produtos.FieldByName('PRODUTO_ID').AsInteger := frmPesquisaProdutos.Produto;
    mtb_produtos.FieldByName('DESCRICAO').AsString   := frmPesquisaProdutos.Descricao;
    mtb_produtos.FieldByName('QUANTIDADE').AsFloat   := frmPesquisaProdutos.Qtde;
    mtb_produtos.FieldByName('UNITARIO').AsFloat     := StrToFloat( frmPesquisaProdutos.edt_preco_fornecedor.Text);
    mtb_produtos.FieldByName('TOTAL').AsFloat        := frmPesquisaProdutos.Qtde * StrToFloat( frmPesquisaProdutos.edt_preco_fornecedor.Text);
    mtb_produtos.post;

    prc_totais;

  end;

 // prc_totais;

end;


procedure TfrmComprasE.prc_totais;
var
  total_produtos: double;
begin
  total_produtos:= 0;
  mtb_produtos.First;
  while not mtb_produtos.eof do
  begin
    total_produtos := total_produtos + mtb_produtos.FieldByName('TOTAL').AsFloat ;
    mtb_produtos.next;
  end;

  pnl_valor_produtos.Caption := formatfloat('0.00', total_produtos);
  pnl_valor_pedido.Caption   := formatfloat('0.00', total_produtos + strtofloat(edt_acrescimos.Text) - strtofloat(edt_desconto.Text));

end;

procedure TfrmComprasE.cbx_fornecedoresCloseUp(Sender: TObject);
begin
  inherited;
  p_fornecedor_id := qry_fornecedores.FieldByName('ID').AsInteger;

  //ShowMessage('id pessoa ' + qry_fornecedores.FieldByName('ID').Asstring);
end;

procedure TfrmComprasE.dbg_produtosDblClick(Sender: TObject);
begin
  inherited;
  btn_produto_editar.Click;
end;

procedure TfrmComprasE.ds_parcelasDataChange(Sender: TObject; Field: TField);
begin
  inherited;
  btn_parcelas_editar.Enabled := not mtb_parcelas.IsEmpty;
  btn_parcelas_excluir.Enabled := not mtb_parcelas.IsEmpty;
end;

procedure TfrmComprasE.ds_produtosDataChange(Sender: TObject; Field: TField);
begin
  inherited;

  btn_produto_excluir.Enabled := not mtb_produtos.IsEmpty;
  btn_produto_editar.Enabled  := not mtb_produtos.IsEmpty;

  // se vazio zero o acrescimo e o desconto
  if mtb_produtos.IsEmpty  then
  begin
     edt_acrescimos.Text := '0,00';
     edt_desconto.Text   := '0,00';
  end;

end;

procedure TfrmComprasE.edt_acrescimosExit(Sender: TObject);
begin
  inherited;
  prc_totais;
  uBiblioteca.prc_formata_dinheiro(sender);
end;

procedure TfrmComprasE.edt_acrescimosKeyPress(Sender: TObject; var Key: Char);
begin
  inherited;
  prc_totais;
  ubiblioteca.prc_somente_numeros(sender, key);
end;

procedure TfrmComprasE.edt_descontoExit(Sender: TObject);
begin
  inherited;
  prc_totais;
  uBiblioteca.prc_formata_dinheiro(sender);

end;

function TfrmComprasE.fnc_validar: boolean;
var
  loqry : TFDQuery;
begin
  result := false;

  if edt_nr_pedido.Text = '' then
  begin
    CriarMensagem('AVISO','Informe o NÚMERO DO DOCUMENTO');
    edt_nr_pedido.SetFocus;
    exit;
  end;

  if p_forma_pagto_id = -1 then
  begin
    CriarMensagem('AVISO','Selecione uma FORMA DE PAGAMENTO');
    btn_busca_forma_pagto.Click;
    exit;
  end;

  if cbx_situacao.Text = '' then
  begin
    CriarMensagem('AVISO','Informe a SITUAÇÃO DO PEDIDO');
    cbx_situacao.SetFocus;
    exit;
  end;

  if cbx_plano_contas.Text = '' then
  begin
    CriarMensagem('AVISO','Informe um PLANO DE CONTAS');
    cbx_plano_contas.SetFocus;
    exit;
  end;

  if cbx_fornecedores.Text = '' then
  begin
    CriarMensagem('AVISO','Informe um FORNECEDOR');
    cbx_fornecedores.SetFocus;
    exit;
  end;

  if ds_produtos.DataSet.IsEmpty  then
  begin
    CriarMensagem('AVISO','INCLUA OS PRODUTOS DA COMPRA ');
    btn_produto_incluir.Click;
    exit;
  end;

  //if cbx_situacao.Text = 'ENTREGUE' then
  //begin
    if ds_parcelas.DataSet.IsEmpty  then
    begin
      CriarMensagem('AVISO','GERE AS PARCELAS DA COMPRA ');
      exit;
    end;

    try
      loqry := TFDQuery.Create(application);
      loqry.Connection := conexao;
      loqry.SQL.Clear;
      loqry.SQL.Add('select QTDE_PARCELAS from FORMAS_PAGTO where ID =:ID');
      loqry.ParamByName('ID').AsInteger := p_forma_pagto_id;
      loqry.OPEN;

      if mtb_parcelas.RecordCount <> loqry.FieldByName('QTDE_PARCELAS').AsInteger then
      begin
        CriarMensagem('AVISO','A FORMA DE PAGAMENTO SELECIONADA' + sLineBreak +
                      'NÃO CORRESPONDE A QUANTIDADE DE PARCELAS.' + sLineBreak + sLineBreak +
                      'CONFIRA OS DADOS E TENTE NOVAMENTE');
        exit;
      end;


    finally
      loqry.close;
      freeandnil( loqry );
    end;

    if formatfloat('0.00', strtofloat(pnl_valor_produtos.Caption)) <>
       formatfloat('0.00', mtb_parcelasTOTAL_PARCELA.value) then
    begin
      CriarMensagem('AVISO','VALOR TOTAL DAS PARCELAS DIFERE DO VALOR DA COMPRA' +
      slinebreak + 'CONFIRA OS DADOS E TENTE NOVAMENTE!');
      exit;
    end;
  //end;

  result := true;
end;

procedure TfrmComprasE.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  inherited;

  //form_principal.prc_controla_menu(true);
  freeandnil ( loForm );

end;

procedure TfrmComprasE.FormCreate(Sender: TObject);
begin
  inherited;
  self.Tabela := 'COMPRAS';

  // forma de pagamento
  p_forma_pagto_id := -1;

end;

procedure TfrmComprasE.prc_componentes;
begin
  QRY.Connection := conexao;
  {qry de compras}
  qry.SQL.Add('select * from ' + tabela +' where ID =:ID');

  {qry forma de pagamento}
  qry_forma_pagto.Connection := conexao;

  {qry plano de contas}
  qry_plano_contas.Connection := SELF.Conexao;
  qry_plano_contas.SQL.Clear;
  qry_plano_contas.SQL.Add('select * from PLANO_CONTAS where TIPO = ' + QuotedStr('A') + ' and ( CUSTO_FIXO = ' + QuotedStr('S') + ' or CUSTO_VARIAVEL = ' + QuotedStr('S') + ') order by DESCRICAO');
  qry_plano_contas.Open;

  {qry plano de contas}
  qry_fornecedores.Connection := SELF.Conexao;
  qry_fornecedores.SQL.Clear;
  qry_fornecedores.SQL.Add('select P.ID, P.NOME from PESSOAS P, FORNECEDORES F where P.ID = F.PESSOA_ID order by P.NOME');
  qry_fornecedores.Open;

  {item da compra}
  mtb_produtos.Open;
end;

procedure TfrmComprasE.prc_ler_dados;
var
  loQry: TFDQuery;
begin
  try

    loQry:= TFDQuery.Create(self);
    loQry.Connection := conexao;
    loQry.SQL.Clear;
    loqry.sql.Add('select * from ' + tabela + ' where COMPRAS_ID = :COMPRAS_ID');
    loQry.Params.ParamByName('COMPRAS_ID').AsInteger := Codigo;
    loQry.Open;
    // preencher dados da compra
    lbl_compra_id.Caption     := loQry.FieldByName('COMPRAS_ID').AsString;
    lbl_Cadastrado_em.Caption := loQry.FieldByName('CADASTRADO_EM').AsString;
    lbl_alterado_em.Caption   := loQry.FieldByName('ALTERADO_EM').AsString;

    dtp_data_contabil.Date    := loQry.FieldByName('DATA_CONTABIL').AsDateTime;
    edt_nr_pedido.Text        := loQry.FieldByName('NUMERO_DOCUMENTO').AsString;

    p_forma_pagto_id := loQry.FieldByName('FORMAS_PAGTO_ID').AsInteger;
    FilterCds(qry_forma_pagto, fsInteger, inttostr(p_forma_pagto_id)) ;
    if p_forma_pagto_id > 0 then
      pnl_forma_pagto.Caption := qry_forma_pagto.FieldByName('DESCRICAO').AsString
    else
      pnl_forma_pagto.Caption := 'Selecione uma forma de pagamento' ;

    cbx_situacao.ItemIndex    := uBiblioteca.SeSenao( loQry.FieldByName('ABERTO_ENTREGUE').AsString = 'A', 0, 1 );

    // pedido "ENTREGUE" não será permitido alterar
//    if cbx_situacao.Text = 'ENTREGUE' then
//      btnOk.Enabled := FALSE;

    cbx_plano_contas.KeyValue := loQry.FieldByName('PLANO_CONTAS_ID').AsInteger;
    cbx_fornecedores.KeyValue := loQry.FieldByName('FORNECEDOR_ID').AsInteger;

    pnl_valor_produtos.Caption := FormatFloat('0.00',loQry.FieldByName('VALOR_PRODUTOS').AsFloat );
    edt_acrescimos.Text        := FormatFloat('0.00',loQry.FieldByName('ACRESCIMOS').AsFloat );
    edt_desconto.Text          := FormatFloat('0.00',loQry.FieldByName('DESCONTOS').AsFloat );
    pnl_valor_pedido.Caption   := FormatFloat('0.00',loQry.FieldByName('VALOR_COMPRA').AsFloat );
    loQry.Close;

    // ITENS

    loQry.SQL.Clear;
    loqry.sql.Add('select COMPRAS_ITENS_ID, COMPRAS_ID, PRODUTO_ID, QUANTIDADE, UNITARIO, ACRESCIMO, DESCONTOS, TOTAL from COMPRAS_ITENS where COMPRAS_ID = :COMPRAS_ID');
    loQry.Params.ParamByName('COMPRAS_ID').AsInteger := Codigo;
    loQry.Open;

    while not loQry.Eof do
    begin
      mtb_produtos.Insert;
      mtb_produtos.FieldByName('ID').AsInteger         := loQry.FieldByName('COMPRAS_ITENS_ID').AsInteger;
      mtb_produtos.FieldByName('COMPRA_ID').AsInteger  := loQry.FieldByName('COMPRAS_ID').AsInteger;
      mtb_produtos.FieldByName('PRODUTO_ID').AsInteger := loQry.FieldByName('PRODUTO_ID').AsInteger;
      mtb_produtos.FieldByName('QUANTIDADE').AsFloat   := loQry.FieldByName('QUANTIDADE').AsFloat;
      mtb_produtos.FieldByName('UNITARIO').AsFloat     := loQry.FieldByName('UNITARIO').AsFloat;
      mtb_produtos.FieldByName('TOTAL').AsFloat        := loQry.FieldByName('TOTAL').AsFloat;

      Qry.Close;
      Qry.SQL.Clear;
      qry.sql.Add('select NOME_FANTASIA, UNIDADE from PRODUTOS where ID = :PRODUTO_ID');
      Qry.Params.ParamByName('PRODUTO_ID').AsInteger := mtb_produtos.FieldByName('PRODUTO_ID').AsInteger;
      Qry.Open;
      mtb_produtos.FieldByName('DESCRICAO').AsString   := Qry.FieldByName('NOME_FANTASIA').AsString;
      mtb_produtos.FieldByName('UNIDADE').AsString     := Qry.FieldByName('UNIDADE').AsString;

      mtb_produtos.post;

      loQry.Next;

    end;

  //Parcelas
    loqry.Close;
    loqry.SQL.Clear;
    loqry.SQL.Add('select                                 ');
    loqry.SQL.Add('  ID,                                  ');
    loqry.SQL.Add('  NR_DOCUMENTO,                        ');
    loqry.SQL.Add('  DATA_VENC,                           ');
    loqry.SQL.Add('  TOTAL_PARCELA,                       ');
    loqry.SQL.Add('  VALOR_PAGO,                          ');
    loqry.SQL.Add('  DATA_PAGAMENTO                       ');
    loqry.SQL.Add('from                                   ');
    loqry.SQL.Add('  CONTAS_PAGAR                         ');
    loqry.SQL.Add('where                                  ');
    loqry.SQL.Add('  TABELA_ORIGEM =:TABELA_ORIGEM and    ');
    loqry.SQL.Add('  TABELA_ID =:TABELA_ID                ');
    //
    loqry.ParamByName('TABELA_ORIGEM').AsString := 'COMPRAS';
    loqry.ParamByName('TABELA_ID').AsInteger    := Codigo;
    loqry.Open;

    //Carrega as Parcelas no memTable
    loQry.First;
    while not loQry.Eof do
    begin
      prc_gerar_parcelas(
                        OpIncluir,
                        loQry.FieldByName('ID').AsInteger,
                        loQry.FieldByName('NR_DOCUMENTO').AsString,
                        loQry.FieldByName('DATA_VENC').AsDateTime,
                        loQry.FieldByName('TOTAL_PARCELA').AsFloat,
                        loQry.FieldByName('VALOR_PAGO').AsFloat,
                        loQry.FieldByName('DATA_PAGAMENTO').AsDATETime
                        );
      loQry.Next;
    end;



  finally
    Qry.Close;
    loQry.Close;
    FreeAndNil(loQry) ;
  end;
//  p_fornecedor_id := id do fornecedor ja cadatrado
end;


procedure TfrmComprasE.prc_salvar;
begin
  if not fnc_validar then Exit;

  if not Self.Conexao.InTransaction then Self.Conexao.StartTransaction;
  //***
  try
    prc_incluir_alterar(Operacao);
    if Self.Conexao.InTransaction then Self.Conexao.Commit;

    CriarMensagem('AVISO',' COMPRA CADASTRADA COM SUCESSO! ');

    Close;
  except
  //  conexao.Rollback;
  //  CriarMensagem('AVISO',' NÃO FOI POSSIVEL SALVAR O REGISTRO! ');
 on E : Exception do
   Raise Exception.Create(E.Message +  slinebreak +' NÃO FOI POSSIVEL SALVAR O REGISTRO! ' );
  end;

end;

procedure TfrmComprasE.prc_incluir_alterar(_operacao: TOperacao);
var
  loqry: TFDQuery;
begin
  qry.sql.clear;

  if operacao = opExcluir then
  begin

    qry.SQL.Add('update '+ self.Tabela + ' set ATIVO = ''N'' where COMPRAS_ID =:COMPRAS_ID');
    qry.ParamByName('COMPRAS_ID').AsInteger := Codigo;
    qry.ExecSQL;
    exit;

  end;

  if operacao = OpIncluir then
  begin
//ShowMessage('incluir');
    qry.SQL.Add('insert into ' + self.Tabela );
    qry.SQL.Add('(');
    qry.SQL.Add('  CADASTRADO_EM,    ');
    qry.SQL.Add('  DATA_CONTABIL,    ');
    qry.SQL.Add('  NUMERO_DOCUMENTO, ');
    qry.SQL.Add('  FORMAS_PAGTO_ID,  ');
    qry.SQL.Add('  ABERTO_ENTREGUE,  ');
    qry.SQL.Add('  PLANO_CONTAS_ID,  ');
    qry.SQL.Add('  FORNECEDOR_ID,    ');
    qry.SQL.Add('  VALOR_PRODUTOS,   ');
    qry.SQL.Add('  ACRESCIMOS,       ');
    qry.SQL.Add('  DESCONTOS,        ');
    qry.SQL.Add('  VALOR_COMPRA,     ');
    qry.SQL.Add('  RECEBEMOS_EM,     ');
    qry.SQL.Add('  USUARIO_ID,       ');
    qry.SQL.Add('  ATIVO             ');
    qry.SQL.Add(')                   ');
    qry.SQL.Add('VALUES              ');
    qry.SQL.Add('(                   ');
    qry.SQL.Add(' :CADASTRADO_EM,    ');
    qry.SQL.Add(' :DATA_CONTABIL,    ');
    qry.SQL.Add(' :NUMERO_DOCUMENTO, ');
    qry.SQL.Add(' :FORMAS_PAGTO_ID,  ');
    qry.SQL.Add(' :ABERTO_ENTREGUE,  ');
    qry.SQL.Add(' :PLANO_CONTAS_ID,  ');
    qry.SQL.Add(' :FORNECEDOR_ID,    ');
    qry.SQL.Add(' :VALOR_PRODUTOS,   ');
    qry.SQL.Add(' :ACRESCIMOS,       ');
    qry.SQL.Add(' :DESCONTOS,        ');
    qry.SQL.Add(' :VALOR_COMPRA,     ');
    qry.SQL.Add(' :RECEBEMOS_EM,     ');
    qry.SQL.Add(' :USUARIO_ID,       ');
    qry.SQL.Add(' :ATIVO             ');
    qry.SQL.Add(')                   ');
    qry.SQL.Add('returning COMPRAS_ID ');

    qry.ParamByName('CADASTRADO_EM').AsDate := Date;
  end
  else if operacao = opAlterar then
  begin
    qry.SQL.Add('UPDATE                                  ');
    qry.SQL.Add(Tabela);
    qry.SQL.Add('SET                                     ');
    qry.SQL.Add('  ALTERADO_EM      = :ALTERADO_EM,      ');
    qry.SQL.Add('  DATA_CONTABIL    = :DATA_CONTABIL,    ');
    qry.SQL.Add('  NUMERO_DOCUMENTO = :NUMERO_DOCUMENTO, ');
    qry.SQL.Add('  FORMAS_PAGTO_ID  = :FORMAS_PAGTO_ID,  ');
    qry.SQL.Add('  ABERTO_ENTREGUE  = :ABERTO_ENTREGUE,  ');
    qry.SQL.Add('  PLANO_CONTAS_ID  = :PLANO_CONTAS_ID,  ');
    qry.SQL.Add('  FORNECEDOR_ID    = :FORNECEDOR_ID,    ');
    qry.SQL.Add('  VALOR_PRODUTOS   = :VALOR_PRODUTOS,   ');
    qry.SQL.Add('  ACRESCIMOS       = :ACRESCIMOS,       ');
    qry.SQL.Add('  DESCONTOS        = :DESCONTOS,        ');
    qry.SQL.Add('  VALOR_COMPRA     = :VALOR_COMPRA,     ');
    qry.SQL.Add('  RECEBEMOS_EM     = :RECEBEMOS_EM,     ');
    qry.SQL.Add('  USUARIO_ID       = :USUARIO_ID,       ');
    qry.SQL.Add('  ATIVO            = :ATIVO             ');
    qry.SQL.Add('WHERE                                   ');
    qry.SQL.Add('  COMPRAS_ID = :COMPRAS_ID              ');
    //
    qry.ParamByName('COMPRAS_ID').AsInteger := Codigo;
    qry.ParamByName('ALTERADO_EM').AsDate   := Date;

  end;

  qry.ParamByName('DATA_CONTABIL').AsDate      := dtp_data_contabil.date;
  qry.ParamByName('NUMERO_DOCUMENTO').AsString := edt_nr_pedido.Text;
  qry.ParamByName('FORMAS_PAGTO_ID').AsInteger := p_forma_pagto_id;
  qry.ParamByName('ABERTO_ENTREGUE').AsString  := ubiblioteca.SeSenao( cbx_situacao.Text = 'ABERTO', 'A','E' );
  qry.ParamByName('PLANO_CONTAS_ID').AsInteger := cbx_plano_contas.KeyValue ;
  qry.ParamByName('FORNECEDOR_ID').AsInteger   := cbx_fornecedores.KeyValue ;
  qry.ParamByName('VALOR_PRODUTOS').Asfloat    := strtofloat( pnl_valor_produtos.Caption );
  qry.ParamByName('ACRESCIMOS').Asfloat        := strtofloat( edt_acrescimos.Text );
  qry.ParamByName('DESCONTOS').Asfloat         := strtofloat( edt_desconto.Text );
  qry.ParamByName('VALOR_COMPRA').Asfloat      := Strtofloat( pnl_valor_pedido.Caption );
  qry.ParamByName('RECEBEMOS_EM').AsDate       := dtp_data_contabil.date;
  qry.ParamByName('USUARIO_ID').AsInteger      := 2;
  qry.ParamByName('ATIVO').AsString            := 'S';

  //ShowMessage(qry.SQL.Text);

  if operacao = opincluir then
  begin
    QRY.Open;
    codigo := qry.FieldByName('COMPRAS_ID').AsInteger;
  end
  else
    qry.ExecSQL;

  {inclui/alterar/excluir itens da compra}
  prc_incluir_alterar_itens;

  if not mtb_parcelas_deletadas.IsEmpty then
  begin
    try
      loqry:= TFDQuery.Create(application);
      loqry.Connection := conexao;
      loqry.SQL.Clear;
      loqry.SQL.Add('delete from contas_pagar where id = :id');
      mtb_parcelas_deletadas.First;
      while not mtb_parcelas_deletadas.eof do
      begin
        loqry.ParamByName('id').AsInteger := mtb_parcelas_deletadasID.AsInteger;
        loqry.ExecSQL;
      end;
    finally
      freeandnil(loqry);
    end;
  end;

  {Incluir parcelas da grid de parcelas no banco de dados,
   somente se o material foi entregue }
//  if cbx_situacao.Text = 'ENTREGUE' then
  //begin
    mtb_parcelas.First;
    while not mtb_parcelas.Eof do
    begin

      {Inclui apenas os itens com id < 0}
      if mtb_parcelas.FieldByName('CONTA_PAGAR_ID').AsInteger < 0 then
      begin
          ufinanceiro.prc_contas_pagar(Opincluir, conexao, -1, -1, cbx_plano_contas.KeyValue,
                                      cbx_fornecedores.KeyValue, edt_nr_pedido.text,
                                      'PARCELA '+ inttostr(mtb_parcelas.RecNo) + ' de ' + inttostr(mtb_parcelas.RecordCount), 'COMPRAS', codigo,
                                      mtb_parcelas.RecNo, mtb_parcelas.RecordCount, mtb_parcelasVALOR_PARCELA.AsFloat,
                                      0,0,0,0,
                                      mtb_parcelasVENCIMENTO.AsDateTime , 0,'S','S','S','S', '', ''
                                       );
      end;

      mtb_parcelas.Next;
    end;
  //end;
end;

procedure TfrmComprasE.prc_incluir_alterar_itens;
var
  loQry: TFDQuery;
  novo_id : integer;
begin

  loQry:= TFDQuery.Create(self);
  loqry.Connection := conexao;

  {excluir itens da memoria "mt_itens_deletados"}
  mt_itens_deletados.First;
  while not mt_itens_deletados.Eof do
  begin
    {inserir}
    loqry.SQL.Clear;
    loQry.SQL.Add('delete from compras_itens where COMPRAS_ITENS_ID =:COMPRAS_ITENS_ID ') ;
    loQry.ParamByName('COMPRAS_ITENS_ID').AsInteger := mt_itens_deletadosID.AsInteger;

    //ShowMessage('excluir item ' + inttostr(mt_itens_deletadosID.AsInteger)) ;
    loqry.ExecSQL;

    mt_itens_deletados.Next;
  end;

  mtb_produtos.First;
  while not mtb_produtos.Eof do
  begin

    if mtb_produtos.FieldByName('ID').AsInteger < 0 then
    begin
      {inserir}
      loqry.SQL.Clear;
      loQry.SQL.Add('insert into compras_itens ') ;
      loQry.SQL.Add(' ( compras_id, produto_id, quantidade, unitario, acrescimo, descontos, total )') ;
      loQry.SQL.Add(' values ') ;
      loQry.SQL.Add(' ( :compras_id, :produto_id, :quantidade, :unitario, :acrescimo, :descontos, :total )  returning COMPRAS_ITENS_ID ') ;
      loQry.ParamByName('compras_id').AsInteger := codigo;
    end
    else if mtb_produtos.FieldByName('ID').AsInteger > 0 then
    begin
      {alterar}
      loqry.SQL.Clear;
      loQry.SQL.Add('update  ');
      loQry.SQL.Add('  compras_itens  ');
      loQry.SQL.Add('set ');
      loQry.SQL.Add('  produto_id =:produto_id, quantidade =:quantidade, unitario =:unitario, acrescimo =:acrescimo, descontos =:descontos, total =:total ');
      loQry.SQL.Add('where ');
      loQry.SQL.Add(' COMPRAS_ITENS_ID =:COMPRAS_ITENS_ID ');
      loQry.ParamByName('COMPRAS_ITENS_ID').AsInteger := mtb_produtos.FieldByName('ID').AsInteger;
    end;
   // ShowMessage(loQry.SQL.Text);
    {parametros}
    loQry.Params.ParamByName('produto_id').AsInteger := mtb_produtos.FieldByName('PRODUTO_ID').AsInteger;
    loQry.Params.ParamByName('quantidade').AsFloat   := mtb_produtos.FieldByName('QUANTIDADE').AsFloat;
    loQry.Params.ParamByName('unitario').AsFloat     := mtb_produtos.FieldByName('UNITARIO').AsFloat;
    loQry.Params.ParamByName('acrescimo').AsFloat    := 0;
    loQry.Params.ParamByName('descontos').AsFloat    := 0;
    loQry.Params.ParamByName('total').AsFloat        := mtb_produtos.FieldByName('TOTAL').AsFloat;

    if mtb_produtos.FieldByName('ID').AsInteger < 0 then
    begin
       loQry.Open;
       novo_id := loqry.FieldByName('COMPRAS_ITENS_ID').AsInteger;
    end
    else
    if mtb_produtos.FieldByName('ID').AsInteger > 0 then
      loqry.ExecSQL;

    // caso a situação da compra seja ENTREGUE
    // verificar se o preço atual da compra é diferente do cadastrado
    // na tabela de produtos
    if cbx_situacao.Text = 'ENTREGUE' then
    begin
      prc_verificar_preco_de_custo(
                                   mtb_produtos.FieldByName('PRODUTO_ID').AsInteger,
                                   mtb_produtos.FieldByName('UNITARIO').AsFloat
                                  );
      {atualiza a ordem de compra, caso o produto esteja com estoque minimo}
      unit_movimenta_estoques.prc_atualiza_ordem_compra_por_produto(codigo, mtb_produtos.FieldByName('PRODUTO_ID').AsInteger);

      {Atualiza saldos na tabela de produtos}
      unit_movimenta_estoques.prc_atualizar_estoque(mtb_produtos.FieldByName('PRODUTO_ID').AsInteger, 'ENTRADA', 'COMPRA', mtb_produtos.FieldByName('QUANTIDADE').AsFloat );

      {lança movimento de entrada na tabela de movimentação de estoques}
      unit_movimenta_estoques.prc_incluir_alterar_movimento( OpIncluir,'ENTRADA','COMPRAS_ITENS',sesenao( mtb_produtos.FieldByName('ID').AsInteger < 0, novo_id, mtb_produtos.FieldByName('ID').AsInteger  ), mtb_produtos.FieldByName('PRODUTO_ID').AsInteger,'COMPRA N. ' + edt_nr_pedido.Text + ' - ' + cbx_fornecedores.Text, mtb_produtos.FieldByName('QUANTIDADE').AsFloat );

    end;
    // proximo produto
    mtb_produtos.Next;
  end;

  FreeAndNil(loqry) ;

end;

procedure TfrmComprasE.prc_verificar_preco_de_custo( produto_id : integer; preco_novo: double );
var
  loQry: TFDQuery;
  valor_no_banco :double;
  perca :double;
  e_materia_prima,
  e_trelica,
  nome_fantasia: string;
begin
 // esta procedure tem como finalidade comparar o preço do produto que esta
 // chegando com o preço ja cadastrado no sistema.
 // caso sejam diferentes o sistema da uma mensagem ao usuario perguntando
 // se quer altere o valor ja cadastrado para o valor que esta chegando.
 // caso sim... e o produto fazer parte da composicao das vigas
 // o sistema altera o custo das mesmas.
 try
   loQry := TFDQuery.Create(application);
   loqry.Connection := conexao;
   // localizo o produto no banco de dados
   loqry.SQL.Clear;
   loQry.SQL.Add(' select ID, NOME_FANTASIA, PRECO_CUSTO, PERCA, MATERIA_PRIMA, TRELICA from PRODUTOS ');
   loQry.SQL.Add(' where ID =:PRODUTO_ID ');
   loQry.ParamByName('PRODUTO_ID').AsInteger := produto_id;
   loQry.Open;

   nome_fantasia   := loQry.FieldByName('NOME_FANTASIA').AsString;
   valor_no_banco  := loQry.FieldByName('PRECO_CUSTO').AsFloat;
   perca           := loQry.FieldByName('PERCA').AsFloat;
   perca           :=  1 + ( perca /100 );
   e_materia_prima := loQry.FieldByName('MATERIA_PRIMA').AsString;
   e_trelica       := loQry.FieldByName('TRELICA').AsString;

   // comparo os precos
   if preco_novo <> valor_no_banco then
   begin
     // se os preços forem diferente, pergunta pro usuario se quer atualiza no banco
     if CriarMensagem('CONFIRMACAO',
                      'O PREÇO DO PRODUTO : ' + nome_fantasia+ slinebreak +
                      'É DIFERENTE DO CADASTRADO DO BANCO DE DADOS!' + sLineBreak + sLineBreak +

                      'PREÇO DO PRODUTO ATUAL R$ ' + FormatFloat('0.00, ', valor_no_banco )  + sLineBreak +
                      'PREÇO DO PRODUTO NESTA COMPRA R$ ' + FormatFloat('0.00, ', preco_novo ) + sLineBreak + sLineBreak +

                      'DESEJA ATUALIZAR O VALOR ?'
                      )
     then
     begin
       // atualizar valores do produto
       loQry.Close;
       loqry.SQL.Clear;
       loQry.SQL.Add(' update PRODUTOS set PRECO_CUSTO =:PRECO_CUSTO, CUSTO_LIQUIDO =:CUSTO_LIQUIDO, ');
       loQry.SQL.Add('  DATA_ALT =:DATA_ALT ');

       loQry.SQL.Add(' where ID =:PRODUTO_ID ');
       loQry.ParamByName('PRODUTO_ID').AsInteger  := produto_id;
       loQry.ParamByName('PRECO_CUSTO').AsFloat   := preco_novo;
       loQry.ParamByName('CUSTO_LIQUIDO').AsFloat := preco_novo *  perca ;
       loQry.ParamByName('DATA_ALT').AsDate       := date;
       loQry.ExecSQL;

     end;

     // verificar se o produto faz parte da composição de viga de laje
     if ( e_materia_prima = 'S' ) or ( e_trelica = 'S' ) then
     begin
       if CriarMensagem('CONFIRMACAO',
                        'O PRODUTO : ' + nome_fantasia + slinebreak +
                        'FAZ PARTE DA COMPOSIÇÃO DAS VIGAS DE LAJES.' + sLineBreak + sLineBreak +

                        'DESEJA ATUALIZAR O CUSTO DAS VIGAS ?'
                        )
       then
       begin
         // passo como parametro a largura da forma
         unit_calcular_custo_de_lajes.GravarCusto( 130 );
        // frmProdutosVigas.GravarCusto( 250 );
       end;
     end;

   end;// fim da atualização de valores
 finally
   FreeAndNil( loQry );
 end;

end;

procedure TfrmComprasE.prc_gerar_parcelas(Operacao: uTipos.TOperacao;
                       conta_pagar_id: integer; nr_documento: string;
                       vencimento: TDate; valor_parcela, valor_pago: double;
                       data_pagamento: TDate);

begin
  case Operacao of
    uTipos.OpIncluir :
    begin
      mtb_parcelas.Insert;
      mtb_parcelas.FieldByName('CONTA_PAGAR_ID').AsInteger:= conta_pagar_id;
      mtb_parcelas.FieldByName('NR_DOCUMENTO').AsString   := nr_documento;
      mtb_parcelas.FieldByName('VENCIMENTO').AsDateTime   := vencimento;
      mtb_parcelas.FieldByName('VALOR_PARCELA').AsFloat   := valor_parcela;
      mtb_parcelas.FieldByName('VALOR_PAGO').AsFloat      := valor_pago;
      mtb_parcelas.FieldByName('DATA_PAGTO').AsVariant    := data_pagamento;
      mtb_parcelas.Post;
    end;
    uTipos.opAlterar :
    begin
      mtb_parcelas.Edit;
      mtb_parcelas.FieldByName('CONTA_PAGAR_ID').AsInteger:= conta_pagar_id;
      mtb_parcelas.FieldByName('NR_DOCUMENTO').AsString   := nr_documento;
      mtb_parcelas.FieldByName('VENCIMENTO').AsDateTime   := vencimento;
      mtb_parcelas.FieldByName('VALOR_PARCELA').AsFloat   := valor_parcela;
      mtb_parcelas.FieldByName('VALOR_PAGO').AsFloat      := valor_pago;
      mtb_parcelas.FieldByName('DATA_PAGTO').AsDateTime   := data_pagamento;
      mtb_parcelas.Post;
    end;
   end;
end;


procedure TfrmComprasE.btn_gerar_parcelasClick(Sender: TObject);
var
  loQry : TFDQuery;
  i,
  qtde_parcelas   : integer;
  vlr_parcela,
  vlr_sobra       : double;
  data_vencimento : TDate;
begin
  // Validar
  if trim(edt_nr_pedido.Text) = '' then
  begin
    CriarMensagem('AVISO','Informe o número do pedido');
    edt_nr_pedido.SetFocus;
    exit;
  end;

  if p_forma_pagto_id = -1 then
  begin
    ShowMessage('Informe uma condição de pagamento.');
    btn_busca_forma_pagto.Click;
    exit;
  end;

  //limpa o memtable
  mtb_parcelas.close;
  mtb_parcelas.open;

  //buscar a quantidade de parcelas de acordo com a forma de pagamento escolhida
  try
    loQry := TFDQuery.Create(application);
    loqry.Connection := conexao;
    loqry.SQL.Clear;
    loQry.SQL.Add(' select ID, QTDE_PARCELAS, PRIM_VENC, INTERVALO ');
    loQry.SQL.Add(' from FORMAS_PAGTO                              ');
    loQry.SQL.Add(' where ID =:ID                                  ');
    loQry.ParamByName('ID').AsInteger := p_forma_pagto_id;
    loQry.Open;
    //
    qtde_parcelas  := loQry.FieldByName('QTDE_PARCELAS').AsInteger;

    data_vencimento := Date;

    if qtde_parcelas > 1 then
    begin
      // Valor de cada parcela
      vlr_parcela := StrToFloat(formatfloat('0.00',(StrToFloat(pnl_valor_pedido.Caption) / qtde_parcelas)));
      vlr_sobra   := (StrToFloat(pnl_valor_pedido.Caption) - (vlr_parcela * qtde_parcelas));
    end
    else
    begin
      vlr_parcela := StrToFloat(pnl_valor_pedido.Caption);
      vlr_sobra   := 0;
    end;

    for i := 0 to qtde_parcelas -1 do
    begin
      if i = 0 then
      begin
        data_vencimento := data_vencimento + loqry.FieldByName('PRIM_VENC').AsInteger;
        prc_gerar_parcelas(uTipos.OpIncluir, ((i+1)*-1), edt_nr_pedido.Text + '/' + inttostr(i+1), data_vencimento,vlr_parcela + vlr_sobra,0,0);
      end
      else
      begin
        data_vencimento := data_vencimento + loqry.FieldByName('INTERVALO').AsInteger;
        prc_gerar_parcelas(uTipos.OpIncluir, ((i+1)*-1), edt_nr_pedido.Text + '/' + inttostr(i+1), data_vencimento,vlr_parcela,0,0);
      end;
    end;
  finally
     loqry.Close;
     freeandnil( loqry );
  end;


end;

procedure TfrmComprasE.prc_inicializar;
begin
  case self.Operacao of
  uTipos.opIncluir: begin
                       pnDados.Enabled           := true;
                       btnOk     .Caption        := 'Incluir';
                       lbl_Cadastrado_em.Caption := datetostr(date);
                       dtp_data_contabil.Date    := date;
                       cbx_situacao.ItemIndex    := 0; // 'ABERTO';
                       qry.Close;
                     end;
  uTipos.opAlterar: begin
                      self.prc_ler_dados;
                      btnOk.Caption := 'Alterar';
                      if cbx_situacao.Text = 'ENTREGUE' then
                      begin
                        lbl_sub_titulo.Visible := TRUE;
                        lbl_sub_titulo.Caption := 'SOMENTE LEITURA';
                        btnOk.Enabled := false;
                      end;
                    end;
  uTipos.opExcluir: begin
                      self.prc_ler_dados;
                      btnOk.Caption := 'Excluir';
                      if cbx_situacao.Text = 'ENTREGUE' then
                      begin
                        lbl_sub_titulo.Visible := TRUE;
                        lbl_sub_titulo.Caption := 'SOMENTE LEITURA';
                        btnOk.Enabled := false;
                      end;
                    end;
  else
    begin
      pnDados.Enabled       := false;
      //pn_fornecedor.Enabled := false;
      if btnFechar.CanFocus then btnFechar.SetFocus;
    end;
  end;

end;


procedure TfrmComprasE.FormShow(Sender: TObject);
begin
  inherited;

  prc_componentes;
  prc_inicializar;

end;

end.
