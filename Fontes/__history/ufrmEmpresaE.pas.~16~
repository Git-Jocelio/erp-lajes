unit ufrmEmpresaE;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseEdicao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.ExtCtrls, ufrmPesquisaPessoa, uBiblioteca, uTipos, ufrmPessoasE,
  Vcl.DBCtrls, Vcl.Mask, udmConn;

type
  TfrmEmpresaE = class(TfrmBaseEdicao)
    Panel1: TPanel;
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    Label6: TLabel;
    Label7: TLabel;
    Label8: TLabel;
    Label9: TLabel;
    Label10: TLabel;
    Label11: TLabel;
    Label12: TLabel;
    Label13: TLabel;
    Label14: TLabel;
    Label15: TLabel;
    Label16: TLabel;
    Label17: TLabel;
    btnBuscaPessoa: TBitBtn;
    btnIncluirPessoa: TBitBtn;
    DBEdit1: TDBEdit;
    DBEdit2: TDBEdit;
    DBEdit3: TDBEdit;
    DBEdit6: TDBEdit;
    DBEdit7: TDBEdit;
    DBEdit8: TDBEdit;
    DBEdit9: TDBEdit;
    DBEdit10: TDBEdit;
    DBEdit11: TDBEdit;
    DBEdit12: TDBEdit;
    DBEdit13: TDBEdit;
    DBEdit14: TDBEdit;
    DBEdit15: TDBEdit;
    DBEdit16: TDBEdit;
    DBEdit17: TDBEdit;
    DBCheckBox1: TDBCheckBox;
    rgPessoa: TDBRadioGroup;
    pnCliente: TPanel;
    Label18: TLabel;
    Label19: TLabel;
    Label20: TLabel;
    Label22: TLabel;
    Label23: TLabel;
    Label24: TLabel;
    edt_nome_fantasia: TEdit;
    edt_site: TEdit;
    edt_celular: TEdit;
    edt_telefone_fixo: TEdit;
    edt_crea: TEdit;
    edt_frase: TEdit;
    procedure FormShow(Sender: TObject);
    procedure FormCreate(Sender: TObject);

    procedure btnBuscaPessoaClick(Sender: TObject);
    procedure btnIncluirPessoaClick(Sender: TObject);
    procedure btnOkClick(Sender: TObject);
  private
    FOperacao: uTipos.TOperacao;
    FCodigo: integer;
    FTabela: string;
    function  fnc_valida: Boolean;
    procedure prc_salvar;

  protected
    procedure prc_componentes;
    procedure prc_inicializar;
    procedure prc_lerDados;

  public
    { Public declarations }
    property Codigo   :integer read FCodigo write FCodigo;
    property Operacao :uTipos.TOperacao read FOperacao write FOperacao;
    property Tabela   :string read FTabela write FTabela;

  end;

  procedure Incluir;
  procedure Alterar(ACodigo :integer);
  procedure Excluir(ACodigo :integer);

implementation

procedure Incluir;
var
  loForm : TfrmEmpresaE;
begin
  loForm := TfrmEmpresaE.Create(Application);
  try
    loForm.Operacao := uTipos.opIncluir;
    loForm.Codigo   := 0;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

procedure Alterar(ACodigo :integer);
var
  loForm : TfrmEmpresaE;
begin
  loForm := TfrmEmpresaE.Create(Application);
  try
    loForm.Operacao := uTipos.opAlterar;
    loForm.Codigo   := ACodigo;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

procedure Excluir(ACodigo :integer);
var
  loForm : TfrmEmpresaE;
begin
  loForm := TfrmEmpresaE.Create(Application);
  try
    loForm.Operacao := uTipos.opExcluir;
    loForm.Codigo   := ACodigo;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;


{$R *.dfm}

procedure TfrmEmpresaE.btnBuscaPessoaClick(Sender: TObject);
begin
  inherited;
  if frmPesquisaPessoa = nil  then
  frmPesquisaPessoa := TfrmPesquisaPessoa.Create(Application);
  try
    frmPesquisaPessoa.ShowModal;

    //ShowMessage(inttostr(frmPesquisaPessoa.Codigo));
    if frmPesquisaPessoa.Confirmado then
    begin
      uBiblioteca.FilterCds(qry, uTipos.fsInteger, inttostr(frmPesquisaPessoa.Codigo));
     // qryClientes.FieldByName('PESSOA_ID').AsInteger := frmPesquisaPessoa.Codigo;
    end
    else
      qry.Close;
  finally
    FreeAndNil(frmPesquisaPessoa);

  end;

end;

procedure TfrmEmpresaE.btnIncluirPessoaClick(Sender: TObject);
begin
  inherited;
  ufrmPessoasE.incluir;

end;

procedure TfrmEmpresaE.btnOkClick(Sender: TObject);
begin
  inherited;
  prc_salvar;
end;

procedure TfrmEmpresaE.prc_componentes;
begin
  qry.SQL.Add('select * from PESSOAS where ID =:ID');
end;


procedure TfrmEmpresaE.FormCreate(Sender: TObject);
begin
  inherited;
  Tabela := 'EMPRESA';

end;

procedure TfrmEmpresaE.FormShow(Sender: TObject);
begin
  inherited;
  prc_componentes;
  prc_inicializar;
end;

function TfrmEmpresaE.fnc_valida: Boolean;
begin
  result := false;

  if DS.DataSet.IsEmpty then
  begin
    ShowMessage('Selecione uma Pessoa');
    btnBuscaPessoa.Click;
    exit;
  end;

  if edt_nome_fantasia.Text = '' then
  begin
    ShowMessage('Informe o NOME FANTASIA da empresa');
    edt_nome_fantasia.SetFocus;
    exit;
  end;

  if edt_site.Text = '' then
  begin
    ShowMessage('Informe o SITE da empresa');
    edt_site.SetFocus;
    exit;
  end;

  if edt_celular.Text = '' then
  begin
    ShowMessage('Informe o CELULAR da empresa');
    edt_celular.SetFocus;
    exit;
  end;

  if edt_telefone_fixo.Text = '' then
  begin
    ShowMessage('Informe o TELEFONE FIXO da empresa');
    edt_telefone_fixo.SetFocus;
    exit;
  end;

  if edt_crea.Text = '' then
  begin
    ShowMessage('Informe o número do CREA da empresa');
    edt_crea.SetFocus;
    exit;
  end;

  if edt_frase.Text = '' then
  begin
    ShowMessage('Informe uma FRASE DE BOAS VINDAS da empresa');
    edt_frase.SetFocus;
    exit;
  end;

  {carrega a classe}
  dmConn.empresa.PessoaId      := ds.DataSet.FieldByName('ID').AsInteger;
  dmConn.empresa.Nome_Fantasia := edt_nome_fantasia.Text;
  dmConn.empresa.Site          := edt_site.Text;
  dmConn.empresa.Crea          := edt_crea.Text;
  dmConn.empresa.Frase         := edt_frase.Text;
  dmConn.empresa.Telefone1     := edt_celular.Text;
  dmConn.empresa.Telefone2     := edt_telefone_fixo.Text;


  result := true;
end;

procedure TfrmEmpresaE.prc_inicializar;
begin
  case self.Operacao of
  uTipos.opIncluir: begin
                       pnDados.Enabled := true;
                       Self      .Caption := 'SysLajes';
                       pnTitulo.Caption   := 'Manutenção de ' + Tabela + ' [Inclusão]';
                       btnOk     .Caption := 'Incluir';

                       btnBuscaPessoa.SetFocus;
                       qry.Close;
                     end;

  uTipos.opAlterar: begin
                      self.prc_lerDados;
                      Self      .Caption := 'SysLajes';
                      pnTitulo.Caption   := 'Manutenção de ' + Tabela + ' [Alteração]';
                      btnOk.Caption      := 'Alterar';
                      //
                      btnBuscaPessoa.Enabled := false;
                      btnIncluirPessoa.Enabled := false;

                      btnOk.SetFocus;
                    end;

  uTipos.opExcluir: begin
                      self.prc_lerDados;
                      Self      .Caption := 'SysLajes';
                      pnTitulo.Caption   := 'Manutenção de ' + Tabela + ' [Exclusão]';
                      pnDados.Enabled    := false;
                      btnOk.Caption      := 'Excluir';
                      btnFechar.SetFocus;
                    end;
  else
    begin
      pnDados.Enabled   := false;
      //pnCliente.Enabled   := false;
      if btnFechar.CanFocus then btnFechar.SetFocus;
    end;
  end;
end;

procedure TfrmEmpresaE.prc_lerDados;
begin

   DS.DataSet :=
   dmConn.empresa.fnc_consulta('select p.*, e.id as empresa_id, e.nome_fantasia, e.site, e.telefone1, e.telefone2, e.crea, e.frase ' +
                               'from ' +
                               'pessoas p, empresa e ' +
                               'where ' +
                               'p.id = e.pessoa_id and ' +
                               'p.id = :id ',IntToStr(Self.Codigo));

  edt_nome_fantasia.Text := ds.DataSet.FieldByName('NOME_FANTASIA').AsString;
  edt_site.Text          := ds.DataSet.FieldByName('SITE').AsString;
  edt_celular.Text       := ds.DataSet.FieldByName('TELEFONE1').AsString;
  edt_telefone_fixo.Text := ds.DataSet.FieldByName('TELEFONE2').AsString;;
  edt_crea.Text          := ds.DataSet.FieldByName('CREA').AsString;;
  edt_frase.Text         := ds.DataSet.FieldByName('FRASE').AsString;;

end;

procedure TfrmEmpresaE.prc_salvar;
var
  sErro: string;
begin
  case Self.Operacao of

    // Inclusão
    uTipos.opIncluir :
    begin
      if not fnc_valida then Exit;

      if not Self.Conexao.InTransaction then Self.Conexao.StartTransaction;
      //***
      try

        if not dmconn.empresa.fnc_inserir_alterar( uTipos.OpIncluir, sErro ) then
          ShowMessage(sErro)
        else
        begin
          if Application.MessageBox('Deseja continuar incluindo?','Inclusão...',MB_YESNO) = mrYES then
            Self.prc_inicializar
          else
            ModalResult := mrOk;
        end;

      except
        ShowMessage('Não foi possível salvar o registro');
        Self.Conexao.Rollback;
      end;
    end;

    // Alteração
    uTipos.opAlterar :
    begin
      if not fnc_valida then Exit;

      if not Self.Conexao.InTransaction then Self.Conexao.StartTransaction;
      //***
      try
        if not dmconn.empresa.fnc_inserir_alterar( uTipos.opAlterar, sErro ) then
          ShowMessage(sErro)
        else
        begin
          //if Application.MessageBox('Deseja continuar incluindo?','Inclusão...',MB_YESNO) = mrYES then
          //  Self.prc_inicializar
          //else
            ModalResult := mrOk;
        end;

      except
        ShowMessage('Não foi possível alterar o registro');
      end;
    end;

    //Exclusão
    uTipos.opExcluir :
    begin
      //if Application.MessageBox('Deseja excluir este registro?','Atenção',MB_OKCANCEL) = mrOK then
      //begin
        //ShowMessage('vai perguntar');

        if not Self.Conexao.InTransaction then Self.Conexao.StartTransaction;
        try
          //ShowMessage('excluir '   );
          dmconn.empresa.prc_excluir( ds.DataSet.FieldByName('EMPRESA_ID').AsInteger );
          ModalResult := mrOk;
        except
          ShowMessage('Não foi possível excluir o registro');
        end;
      //end; // if
    end;
  end;// case


end;

end.
