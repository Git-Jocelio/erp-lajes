//***************************************************************************//
// Cadastro de Tabela de preços
// desenvolvida por Jocelio G Silva
// inicio : 28/01/2024 // base ufrmPlanoContasE
// fim :
//***************************************************************************//
unit ufrmTabelaPrecosE;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseEdicao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.ExtCtrls, uTipos, Vcl.DBCtrls, uBiblioteca, Vcl.Grids, Vcl.DBGrids;

type
  TfrmTabelaPrecosE = class(TfrmBaseEdicao)
    lbl_Id: TLabel;
    Label1: TLabel;
    ds_Forma_pagto: TDataSource;
    qry_forma_pagto: TFDQuery;
    Label5: TLabel;
    Label12: TLabel;
    edt_preco_vendedor: TEdit;
    lbl_descricao_produto: TLabel;
    Label6: TLabel;
    Label7: TLabel;
    edt_preco_venda: TEdit;
    Label8: TLabel;
    edt_taxa: TEdit;
    cbx_forma_pagto: TDBLookupComboBox;
    Label13: TLabel;
    lbl_id_produto: TLabel;
    ds_produtos: TDataSource;
    qry_produtos: TFDQuery;
    cb_ativo: TCheckBox;

    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);

    procedure edt_preco_vendedorExit(Sender: TObject);
    procedure btnOkClick(Sender: TObject);
    procedure edt_taxaKeyPress(Sender: TObject; var Key: Char);
    procedure edt_taxaExit(Sender: TObject);
  private
    FOperacao: uTipos.TOperacao;
    FTabela: string;
    FCodigo: integer;
    FDescricaoProduto: string;
    FPrecoVenda: double;
    FFormaPagtoId: integer;
    FPrecoVendedor: double;
    Fconfirmado: boolean;
    FTaxa: double;
    FDescricaoFormaPagto: string;
    FAtivo: string;
    procedure prc_calcula_mao_de_obra;
    procedure prc_salvar;
   // procedure prc_incluir_alterar(operacao: TOperacao; v_tabela: string; v_id: integer);
  protected
    procedure prc_componentes;
    procedure prc_inicializar;
    procedure prc_ler_dados;
    function prc_validar: boolean;

  public
    property Codigo   :integer read FCodigo write FCodigo;
    property DescricaoProduto   :string read FDescricaoProduto write FDescricaoProduto;
    property Operacao :uTipos.TOperacao read FOperacao write FOperacao;
    property Tabela   :string read FTabela write FTabela;

    {dados da tabela produtos_forma_pagto}
    property FormaPagtoId: integer read FFormaPagtoId write FFormaPagtoId;
    property DescricaoFormaPagto: string read FDescricaoFormaPagto write FDescricaoFormaPagto;
    property PrecoVendedor: double read FPrecoVendedor write FPrecoVendedor;
    property PrecoVenda: double read FPrecoVenda write FPrecoVenda;
    property Taxa: double read FTaxa write FTaxa;
    property Ativo: string read FAtivo write FAtivo;

    property confirmado: boolean read Fconfirmado write Fconfirmado;


  end;

var
   frmTabelaPrecosE: TfrmTabelaPrecosE;

implementation



{$R *.dfm}

procedure TfrmTabelaPrecosE.btnOkClick(Sender: TObject);
begin
  inherited;
  if prc_validar then
    prc_salvar;
end;

procedure TfrmTabelaPrecosE.edt_taxaExit(Sender: TObject);
begin
  inherited;
  prc_formata_dinheiro(sender);

end;

procedure TfrmTabelaPrecosE.edt_taxaKeyPress(Sender: TObject;
  var Key: Char);
begin
  inherited;
 // if not (key in [#1..#31,#48..#57,#44]) then key := #0;
 prc_somente_numeros(sender, key);
end;

procedure TfrmTabelaPrecosE.edt_preco_vendedorExit(Sender: TObject);
begin
  inherited;
  prc_calcula_mao_de_obra;

end;

procedure TfrmTabelaPrecosE.FormCreate(Sender: TObject);
begin
  inherited;
  self.Tabela := 'PRODUTOS_FORMA_PAGAMENTO';
  confirmado := false;
end;

procedure TfrmTabelaPrecosE.FormShow(Sender: TObject);
begin
  inherited;
  prc_componentes;
  prc_inicializar;

end;

procedure TfrmTabelaPrecosE.prc_componentes;
begin
  {qry de principal - tabela : PRODUTOS_FORMAS_PAGAMENTO}

  qry.Connection := SELF.Conexao;
  qry.SQL.Clear;
  qry.SQL.Add('select * from ' + tabela + ' where ID =:ID');
  QRY.Params.ParamByName('ID').AsInteger := FormaPagtoId;

  {qryforma_pagto}
  qry_forma_pagto.Connection := Conexao;
  qry_forma_pagto.SQL.Add('select * from FORMAS_PAGTO order by DESCRICAO');
  qry_forma_pagto.Open;

  {qryProdutos}
  // busca os dados do produto
  qry_produtos.Connection := Conexao;
  qry_produtos.SQL.Add('select * from PRODUTOS where ID =:ID');
  qry_produtos.Params.ParamByName('ID').AsInteger := Codigo;
  qry_produtos.Open;
  // confirgura os labels
  lbl_id_produto.Caption := INTTOSTR(Codigo);
  lbl_descricao_produto.Caption := qry_produtos.FieldByName('DESCRICAO').AsString;




end;

procedure TfrmTabelaPrecosE.prc_inicializar;
begin
  case self.Operacao of
  uTipos.opIncluir: begin

                       pnTitulo.Caption := 'Manutenção da Tabela de Preços [Inclusão]';
                       lbl_sub_titulo.Caption := 'Inclui um nova forma de pagamento ao produto';
                       pnDados.Enabled := true;

                       {Novo id usuario}
                       lbl_Id.Caption := '-1';
                       //lbl_cadastrado_em.Caption := DateToStr(Date);
                       btnOk     .Caption := 'Incluir';

                     end;
  uTipos.opAlterar: begin

                      prc_ler_dados;
                      pnTitulo.Caption := 'Manutenção da Tabela de Preços [Alteração]';
                      lbl_sub_titulo.Caption := 'aqui é possivel alterar um preço/forma pagamento no produto';
                      btnOk.Caption    := 'Alterar';
                      cbx_forma_pagto.ReadOnly := true;
                      //
                      btnOk.SetFocus;

                    end;
  uTipos.opExcluir: begin

                      prc_ler_dados;
                      pnTitulo.Caption    := 'Manutenção da Tabela de Preços [Exclusão]';
                      lbl_sub_titulo.Caption := 'exclui uma forma de pagamento no produto';
                      pnDados.Enabled     := false;
                      btnOk.Caption       := 'Excluir';
                      btnFechar.SetFocus;

                    end;
  else
    begin
      pnDados.Enabled   := false;
      if btnFechar.CanFocus then btnFechar.SetFocus;
    end;
  end;

end;

procedure TfrmTabelaPrecosE.prc_ler_dados;
var
 loQry: TFDQuery;
begin

  try

    loQry := TFDQuery.Create(Self);
    try
      with loQry, loQry.Sql do
      begin
        Connection := Self.Conexao;
        //Add('SELECT * FROM ' + Self.Tabela + ' WHERE ID =:ID');
        //ParamByName('ID').AsInteger := FormaPagtoId;
        //Open;

        Add('select ');
        Add('  P.ID, P.PRODUTO_ID, PR.DESCRICAO, P.FORMA_PAGTO_ID, P.PRECO_VENDEDOR, ');
        Add('P.PRECO_VENDA, P.TAXA_PARCELAMENTO, P.ATIVO ');
        Add('from ');
        Add('  PRODUTOS_FORMA_PAGAMENTO P, PRODUTOS PR ');
        Add('where ' );
        Add('  P.PRODUTO_ID = PR.ID AND P.ID =:ID ') ;
        ParamByName('ID').AsInteger := FormaPagtoId;
        Open;

      end;
      if not loQry.IsEmpty then
      begin
        //Carrega dados do produto
        lbl_Id.Caption                := loQry.FieldByName('ID').AsString;
        lbl_id_produto.Caption        := loQry.FieldByName('PRODUTO_ID').AsString;
        lbl_descricao_produto.Caption := loQry.FieldByName('DESCRICAO').AsString;
        cbx_forma_pagto.KeyValue      := loQry.FieldByName('FORMA_PAGTO_ID').AsInteger;
        edt_taxa.Text                 := FormatFloat('0.00',loQry.FieldByName('TAXA_PARCELAMENTO').AsFloat);
        edt_preco_vendedor.Text       := FormatFloat('0.00',  loQry.FieldByName('PRECO_VENDEDOR').AsFloat );
        edt_preco_venda.Text          := FormatFloat('0.00',  loQry.FieldByName('PRECO_VENDA').AsFloat );
        cb_ativo.Checked              := SeSenao(loQry.FieldByName('ATIVO').AsString = 'S',TRUE,FALSE);

        cbx_forma_pagto.Enabled := FALSE;
      end
      else
      begin
        ShowMessage('conta NÃO encontrada!');

      end;
    finally
      FreeAndNil(loQry);
    end;
  except
    on E : Exception do
       Raise Exception.Create(E.Message + Self.Name + '.prc_ler_dados');
  end;
end;


procedure TfrmTabelaPrecosE.prc_salvar;
begin
   {carrega as propriedades}
   FormaPagtoId := cbx_forma_pagto.KeyValue;
   DescricaoFormaPagto := cbx_forma_pagto.Text;
   PrecoVendedor := strtofloat(edt_preco_vendedor.Text);
   PrecoVenda := strtofloat(edt_preco_venda.Text);
   taxa := strtofloat(edt_taxa.Text);
   ativo := SeSenao(cb_ativo.Checked, 'S','N');
   // fecha o form
   confirmado := true;
   close;
end;

function TfrmTabelaPrecosE.prc_validar: boolean;
begin
   result := false;

   if cbx_forma_pagto.Text = '' then
   begin
     ShowMessage('Selecione uma FORMA DE PAGAMENTO');
     cbx_forma_pagto.SetFocus;
     exit;

   end;

   if StrToFloatDef(edt_taxa.Text,0) < 0 then
   begin
     ShowMessage('informe um VALOR DE TAXA VÁLIDO');
     edt_taxa.SetFocus;
     exit;

   end;

   if StrToFloatDef(edt_preco_vendedor.Text,0) <= 0 then
   begin
     ShowMessage('informe o PREÇO PARA O VENDEDOR');
     edt_preco_vendedor.SetFocus;
     exit;

   end;

   if StrToFloatDef(edt_preco_venda.Text,0) <= 0 then
   begin
     ShowMessage('informe O PREÇO DE VENDA VÁLIDO');
     edt_preco_venda.SetFocus;
     exit;

   end;

   result := true;

end;




procedure TfrmTabelaPrecosE.prc_calcula_mao_de_obra;
begin
   //edt_mao_de_obra.Text := FormatFloat ('0.00', strtofloat(edt_preco_vendedor.Text) - strtofloat(edt_custo.Text));
end;




end.
