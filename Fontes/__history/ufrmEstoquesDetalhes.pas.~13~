unit ufrmEstoquesDetalhes;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseConexao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.ExtCtrls, Vcl.Grids,
  Vcl.DBGrids, Vcl.ComCtrls, Vcl.StdCtrls, Vcl.Buttons, udmConn, uBiblioteca,
  uTipos;

type
  TfrmEstoquesDetalhes = class(TfrmBaseConexao)
    pnl_fundo: TPanel;
    pnl_topo: TPanel;
    pnl_descricao_produto: TPanel;
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    Label4: TLabel;
    Label5: TLabel;
    SpeedButton1: TSpeedButton;
    lbl_estoque_fisico: TLabel;
    lbl_pedido_aberto: TLabel;
    lbl_estoque_Disponivel: TLabel;
    lbl_pedido_aguardando: TLabel;
    lbl_estoque_liquido: TLabel;
    Label6: TLabel;
    Label7: TLabel;
    lbl_endereco: TLabel;
    lbl_nome_cliente: TLabel;
    lbl_nome_responsavel: TLabel;
    lbl_telefones: TLabel;
    pnl_itens_pedido: TPanel;
    pnl_venda_avulso: TPanel;
    pnl_venda_laje: TPanel;
    dbg_detalhes_pedido: TDBGrid;
    dbg_itens_pedidos: TDBGrid;
    qry_detalhes_pedido: TFDQuery;
    qry_detalhes_laje: TFDQuery;
    qry_detalhes_pedidoSITUACAO: TStringField;
    qry_detalhes_pedidoDATA_ENTREGA: TDateField;
    qry_detalhes_pedidoQTDE: TCurrencyField;
    qry_detalhes_pedidoNOME: TStringField;
    qry_detalhes_lajeSITUACAO: TStringField;
    qry_detalhes_lajeDATA_ENTREGA: TDateField;
    qry_detalhes_lajePRODUTO_ID: TIntegerField;
    qry_detalhes_lajeQTDE: TIntegerField;
    qry_detalhes_lajeNOME: TStringField;
    dbg_detalhes_laje: TDBGrid;
    qry_itens_pedidos: TFDQuery;
    ds_detalhes_pedido: TDataSource;
    ds_detalhes_laje: TDataSource;
    ds_itens_pedidos: TDataSource;
    qry_detalhes_pedidoPEDIDO_ID: TIntegerField;
    qry_detalhes_lajePEDIDO_ID: TIntegerField;
    Label8: TLabel;
    Label9: TLabel;
    Label10: TLabel;
    lbl_produto_id: TLabel;
    lbl_descricao_do_produto: TLabel;
    procedure SpeedButton1Click(Sender: TObject);

    procedure FormCreate(Sender: TObject);
    procedure qry_detalhes_pedidoAfterScroll(DataSet: TDataSet);
    procedure qry_detalhes_lajeAfterScroll(DataSet: TDataSet);
    procedure FormKeyPress(Sender: TObject; var Key: Char);
    procedure ds_itens_pedidosDataChange(Sender: TObject; Field: TField);
    procedure ds_detalhes_pedidoDataChange(Sender: TObject; Field: TField);
    procedure ds_detalhes_lajeDataChange(Sender: TObject; Field: TField);
  private
    procedure prc_localizar_produto( produto_id : integer );
    { Private declarations }
  public
    var
      produto_Id : integer;

  end;

var
  frmEstoquesDetalhes: TfrmEstoquesDetalhes;

implementation

{$R *.dfm}

procedure TfrmEstoquesDetalhes.SpeedButton1Click(Sender: TObject);
begin
  inherited;
  close;
end;

procedure TfrmEstoquesDetalhes.prc_localizar_produto( produto_id : integer );
begin

  qry_itens_pedidos.First;
  qry_itens_pedidos.Locate( 'PRODUTO_ID', produto_id,[] );

end;

procedure TfrmEstoquesDetalhes.qry_detalhes_lajeAfterScroll(DataSet: TDataSet);
begin
  inherited;
  prc_localizar_produto( produto_id );
end;

procedure TfrmEstoquesDetalhes.qry_detalhes_pedidoAfterScroll(
  DataSet: TDataSet);
begin
  inherited;
  prc_localizar_produto( produto_id );
end;

procedure TfrmEstoquesDetalhes.ds_detalhes_lajeDataChange(Sender: TObject;
  Field: TField);
begin
  inherited;
  qry_itens_pedidos.close;
  qry_itens_pedidos.SQL.Clear;
  qry_itens_pedidos.SQL.Add('select it.pedido_id, it.produto_Id, prod.nome_fantasia, it.qtde ');
  qry_itens_pedidos.SQL.Add('from pedidos_itens_laje it, produtos prod ');
  qry_itens_pedidos.SQL.Add('where it.produto_Id = prod.id and ');
  qry_itens_pedidos.SQL.Add('prod.viga = ' + quotedstr('S') + ' and it.pedido_id = :pedido_id');
  qry_itens_pedidos.ParamByName('pedido_id').AsInteger := qry_detalhes_laje.FieldByName('pedido_id').AsInteger;
  qry_itens_pedidos.Open;

  prc_localizar_produto( produto_id );

end;

procedure TfrmEstoquesDetalhes.ds_detalhes_pedidoDataChange(Sender: TObject;
  Field: TField);
begin
  inherited;
  qry_itens_pedidos.close;
  qry_itens_pedidos.SQL.Clear;
  qry_itens_pedidos.SQL.Add('select it.pedido_id, it.produto_id, prod.nome_fantasia, it.qtde ');
  qry_itens_pedidos.SQL.Add('from pedidos_itens it, produtos prod ');
  qry_itens_pedidos.SQL.Add('where it.produto_id = prod.id and ');
  qry_itens_pedidos.SQL.Add('prod.viga = ' + quotedstr('S') + ' and it.pedido_id = :pedido_id');
  qry_itens_pedidos.ParamByName('pedido_id').AsInteger := qry_detalhes_pedido.FieldByName('pedido_id').AsInteger;
  qry_itens_pedidos.Open;

  prc_localizar_produto( produto_id );

end;

procedure TfrmEstoquesDetalhes.ds_itens_pedidosDataChange(Sender: TObject;
  Field: TField);
var
  loQry : TFDQuery;
begin
  try
    loQry := TFDQuery.Create(application);
    loQry.Connection := conexao;
    LOQRY.SQL.Clear;
    loqry.SQL.Add('select PS.NOME from PESSOAS PS, PEDIDOS P where P.CLIENTE_ID = PS.ID and P.ID =:PEDIDO_ID ');
    loQry.ParamByName('PEDIDO_ID').AsInteger := qry_itens_pedidos.fieldbyname('PEDIDO_ID').AsInteger;
    loQry.Open;

    if not qry_itens_pedidos.IsEmpty then
    begin
      lbl_nome_cliente.Caption := loQry.fieldbyname('NOME').AsString ;
    end;

    LOQRY.SQL.Clear;
    loqry.SQL.Add('select L.NOME, L.ENDERECO, L.NUMERO, L.BAIRRO, L.CIDADE, L.UF, l.TELEFONE, L.CELULAR  ');
    loqry.SQL.Add('from PEDIDOS P, PEDIDOS_LOCAL_ENTREGA L ');
    loqry.SQL.Add('where P.ID = L.PEDIDO_ID AND P.ID =:PEDIDO_ID ');
    loQry.ParamByName('PEDIDO_ID').AsInteger := qry_itens_pedidos.fieldbyname('PEDIDO_ID').AsInteger;
    loQry.Open;

    lbl_nome_responsavel.Caption := loQry.fieldbyname('NOME').AsString ;

    lbl_telefones.Caption    := 'Telefone(s) ' + loQry.fieldbyname('TELEFONE').AsString + ' ' +
                                loQry.fieldbyname('CELULAR').AsString ;

    lbl_endereco.Caption     := 'Endereço  ' + loQry.fieldbyname('ENDERECO').AsString + ' ' +
                                loQry.fieldbyname('NUMERO').AsString + ' ' +
                                loQry.fieldbyname('BAIRRO').AsString + ' ' +
                                loQry.fieldbyname('CIDADE').AsString + ' ' +
                                loQry.fieldbyname('UF').AsString ;
  finally
    FreeAndNil(loQry);
  end;
end;

procedure TfrmEstoquesDetalhes.FormCreate(Sender: TObject);
begin
  inherited;

 qry_detalhes_pedido.Connection := conexao;
 qry_detalhes_laje.Connection   := conexao;
 qry_itens_pedidos.Connection   := conexao;

end;


procedure TfrmEstoquesDetalhes.FormKeyPress(Sender: TObject; var Key: Char);
begin
  inherited;
  if key = #27 then close;
end;

end.
