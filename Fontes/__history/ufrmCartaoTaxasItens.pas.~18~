unit ufrmCartaoTaxasItens;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseEdicao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.ExtCtrls, Vcl.Mask, Vcl.DBCtrls, Vcl.ComCtrls, uTipos, uBiblioteca;

type
  TfrmCartaoTaxasItens = class(TfrmBaseEdicao)
    Label7: TLabel;
    cbx_forma_pagto: TDBLookupComboBox;
    edt_id_bandeira: TDBEdit;
    Label1: TLabel;
    gb_dias: TGroupBox;
    edt_Vencimento: TEdit;
    up_vencimento: TUpDown;
    Label2: TLabel;
    edt_intervalo: TEdit;
    up_parcela: TUpDown;
    Label3: TLabel;
    gb_taxa: TGroupBox;
    edt_taxa: TEdit;
    edt_qtde_parcelas: TDBEdit;
    Label4: TLabel;
    lbl_Id: TLabel;
    procedure FormShow(Sender: TObject);
    procedure edt_taxaKeyPress(Sender: TObject; var Key: Char);
    procedure btnOkClick(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure dsDataChange(Sender: TObject; Field: TField);
  private
    Fp_qtde_parcelas: integer;
    Fp_forma_pagto_id: integer;
    Fp_operacao: uTipos.TOperacao;
    Fp_taxa: double;
    Fp_primeiro_vencimento: integer;
    Fp_tabela: string;
    Fp_codigo: integer;
    Fp_intervalo_parcelas: integer;
    Fp_confirmado: boolean;
    Fp_descricao: string;

    procedure prc_componentes;
    function fnc_validar: boolean;
    procedure prc_salvar;
    procedure prc_inicializar;
    { Private declarations }
  public
    property p_forma_pagto_id : integer read Fp_forma_pagto_id write Fp_forma_pagto_id;
    property p_descricao : string read Fp_descricao write Fp_descricao;
    property p_qtde_parcelas : integer read Fp_qtde_parcelas write Fp_qtde_parcelas;
    property p_primeiro_vencimento : integer read Fp_primeiro_vencimento write Fp_primeiro_vencimento;
    property p_intervalo_parcelas : integer read Fp_intervalo_parcelas write Fp_intervalo_parcelas;
    property p_taxa : double read Fp_taxa write Fp_taxa;

    //property p_codigo   :integer read Fp_codigo write Fp_codigo;
    property p_operacao :uTipos.TOperacao read Fp_operacao write Fp_operacao;
    property p_tabela   :string read Fp_tabela write Fp_tabela;
    property p_confirmado :boolean read Fp_confirmado write Fp_confirmado;


  end;

  var
  frmCartaoTaxasItens : TfrmCartaoTaxasItens;


implementation



{$R *.dfm}

procedure TfrmCartaoTaxasItens.btnOkClick(Sender: TObject);
begin
  inherited;
  prc_salvar;
end;

procedure TfrmCartaoTaxasItens.dsDataChange(Sender: TObject; Field: TField);
begin
  inherited;
(*
  if edt_qtde_parcelas.Text = '1' then
  begin
    edt_intervalo.Text := '0';
    edt_intervalo.Enabled := false;
  end
  else
  begin
    edt_intervalo.Text := '30';
    edt_intervalo.Enabled := true;

  end;
*)
end;

procedure TfrmCartaoTaxasItens.edt_taxaKeyPress(Sender: TObject; var Key: Char);
begin
  inherited;
  ubiblioteca.prc_somente_numeros(sender,key);

end;

procedure TfrmCartaoTaxasItens.FormCreate(Sender: TObject);
begin
  inherited;
  p_confirmado := false;
end;

procedure TfrmCartaoTaxasItens.FormShow(Sender: TObject);
begin
  inherited;
  prc_componentes;
  prc_inicializar;

end;

procedure TfrmCartaoTaxasItens.prc_inicializar;
begin
  pnTitulo.Caption := 'CONFIGURAÇÃO DA PARCELA DO CARTÃO DE CRÉDITO';

  case p_operacao of
  uTipos.opIncluir: begin

                       lbl_sub_titulo.Caption    := 'INCLUSÃO';
                       lbl_Id.Caption            := '-1';
                       //lbl_cadastrado_em.Caption := datetostr(date);
                       btnOk.Caption             := 'Incluir';

                     end;
  uTipos.opAlterar: begin

                      //prc_ler_dados;
                      lbl_sub_titulo.Caption    := 'ALTERAÇÃO';
                      btnOk.Caption             := 'Alterar';
                      //lbl_alterado_em.Caption   := datetostr(date);
                      btnOk.SetFocus;

                    end;
  uTipos.opExcluir: begin

                      //prc_ler_dados;
                      lbl_sub_titulo.Caption := 'EXCLUIR';
                      pnDados.Enabled        := false;
                      btnOk.Caption          := 'Excluir';
                      btnFechar.SetFocus;

                    end;
  else
    begin
      pnDados.Enabled   := false;
      if btnFechar.CanFocus then btnFechar.SetFocus;
    end;
  end;

end;



procedure TfrmCartaoTaxasItens.prc_componentes;
begin
  qry.Connection := conexao;
  qry.SQL.Clear;
  qry.SQL.Add('select id, descricao, debito, credito, qtde_parcelas from cartao_formas_pagto order by descricao');
  qry.open;

end;

function TfrmCartaoTaxasItens.fnc_validar: boolean;
begin
  result := false;

  if cbx_forma_pagto.Text = '' then
  begin
    ShowMessage('informe uma forma de pagamento');
    cbx_forma_pagto.DropDown;
    cbx_forma_pagto.SetFocus;
    exit;
  end;

  if edt_Vencimento.Text = '0' then
  begin
    ShowMessage('informe o primeiro vencimento da parcela');
    up_vencimento.SetFocus;
    exit;
  end;

  if  strtoint(edt_qtde_parcelas.Text) > 1 then
    if edt_intervalo.Text = '0' then
    begin
      ShowMessage('informe o intervalo entre as parcelas');
      up_parcela.SetFocus;
      exit;
    end;

  if  strtofloatdef(edt_taxa.Text,0) = 0 then
  begin
    ShowMessage('taxa do cartão ZERO !');

  end;


  result := true;

end;

procedure TfrmCartaoTaxasItens.prc_salvar;
begin
  if not fnc_validar then exit;

  {carregar as propriedades}
  p_forma_pagto_id      := cbx_forma_pagto.KeyValue;
  p_descricao           := cbx_forma_pagto.Text;
  p_qtde_parcelas       := qry.FieldByName('qtde_parcelas').AsInteger;
  p_primeiro_vencimento := strtoint( edt_Vencimento.Text );
  p_intervalo_parcelas  := strtoint( edt_intervalo.Text );
  p_taxa                := StrToFloat( edt_taxa.Text );

  {confirmado}
  p_confirmado := true;
  close;
end;


end.
