//***************************************************************************//
// fechamento de comissão
// desenvolvida por Jocelio G Silva
// inicio : 28/02/2022
// fim :
//***************************************************************************//


unit ufrmComissaoFechamento;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseGrade, Data.DB,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,
  FireDAC.Stan.Async, FireDAC.DApt, System.Actions, Vcl.ActnList,
  System.ImageList, Vcl.ImgList, Vcl.Menus, FireDAC.Comp.DataSet,
  FireDAC.Comp.Client, Vcl.Grids, Vcl.DBGrids, Vcl.ComCtrls, Vcl.ToolWin,
  Vcl.ExtCtrls, Vcl.DBCtrls, Vcl.StdCtrls, Vcl.Buttons, ufrmComissoesFechamento,
  uBiblioteca, frxClass, frxDBSet, udmConn, frxExportBaseDialog, frxExportPDF;

type
  TfrmComissaoFechamento = class(TfrmBaseGrade)
    gb_data_contabil: TGroupBox;
    Label7: TLabel;
    cb_data_contabil: TCheckBox;
    dtp_data_ini: TDateTimePicker;
    dtp_data_fim: TDateTimePicker;
    gbPessoa: TGroupBox;
    cb_vendedor: TCheckBox;
    cbx_vendedores: TDBLookupComboBox;
    GroupBox1: TGroupBox;
    Label9: TLabel;
    cbx_mes: TComboBox;
    edt_ano: TEdit;
    dsVendedor: TDataSource;
    qryVendedor: TFDQuery;
    cb_periodo: TCheckBox;
    frxReportRecibo: TfrxReport;
    frxDBDataset1: TfrxDBDataset;
    frxDBEmpresa: TfrxDBDataset;
    qryEmpresa: TFDQuery;
    frxDBVendedor: TfrxDBDataset;
    qry_rel_comissoes: TFDQuery;
    frxDBFechamentoComissoes: TfrxDBDataset;
    qry_rel_debitos: TFDQuery;
    frxDBFechamentoDebitos: TfrxDBDataset;
    frxPDFExport1: TfrxPDFExport;
    Panel1: TPanel;
    qry_busca_vendedor: TFDQuery;
    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);

    procedure actLocalizarExecute(Sender: TObject);
    procedure actIncluirExecute(Sender: TObject);
    procedure actAlterarExecute(Sender: TObject);
    procedure cb_vendedorClick(Sender: TObject);
    procedure actImprimirExecute(Sender: TObject);
  private
    procedure prc_sql;
    function  fnc_validar_pesquisa: boolean;
    procedure prc_pesquisar;
    procedure prc_componentes;

  public
    { Public declarations }
  end;

procedure prc_executa;


implementation

procedure prc_executa;
var
  loForm :  TfrmComissaoFechamento;
begin

  try
    loForm :=  TfrmComissaoFechamento.Create(Application);
    loForm.ShowModal;
  finally
    FreeAndNil(loform);

  end;

end;


{$R *.dfm}

procedure TfrmComissaoFechamento.actAlterarExecute(Sender: TObject);
begin
  inherited;
  ufrmComissoesFechamento.prc_alterar(qry.fieldbyname('ID').AsInteger);

end;

procedure TfrmComissaoFechamento.actImprimirExecute(Sender: TObject);
begin
  inherited;
  qry_rel_comissoes.Close;
  qry_rel_comissoes.ParamByName('fechamento_comissao_id').AsInteger :=
    qry.FieldByName('ID').AsInteger;
  qry_rel_comissoes.Open;

  //ShowMessage('filtrar fechamento n.' + qry.FieldByName('ID').AsString + sLineBreak +
  //            'qtde de comissoes : ' + inttostr(qry_rel_comissoes.RecordCount));


  qry_rel_debitos.Close;
  qry_rel_debitos.ParamByName('fechamento_comissao_id').AsInteger :=
    qry.FieldByName('ID').AsInteger;
  qry_rel_debitos.Open;

  qry_busca_vendedor.Close;
  qry_busca_vendedor.ParamByName('ID').AsInteger :=
    cbx_vendedores.KeyValue;
  qry_busca_vendedor.Open;


  //ShowMessage('filtrar fechamento n.' + qry.FieldByName('ID').AsString + sLineBreak +
  //            'qtde de débitos : ' + inttostr(qry_rel_debitos.RecordCount));


  frxReportRecibo.ShowReport();

end;

procedure TfrmComissaoFechamento.actIncluirExecute(Sender: TObject);
begin
  inherited;
  ufrmComissoesFechamento.prc_incluir;
  uBiblioteca.AtualizaQuery(qry);

end;

procedure TfrmComissaoFechamento.actLocalizarExecute(Sender: TObject);
begin
  inherited;
  if fnc_validar_pesquisa then
    prc_pesquisar;

  // mensagem para o usuario
  StatusBar.Panels[0].Text := 'Encontrado(s) : ' + inttostr(qry.RecordCount) + ' registro(s)';

end;

procedure TfrmComissaoFechamento.cb_vendedorClick(Sender: TObject);
begin
  inherited;
  DBGrid1.Columns[3].Visible := not cb_vendedor.Checked;
end;

function TfrmComissaoFechamento.fnc_validar_pesquisa: boolean;
begin
   result := false;

   if ( dtp_data_fim.Date < dtp_data_ini.Date ) then
   begin
     ShowMessage('Infome uma DATA válida');
     dtp_data_fim.SetFocus;
     exit;
   end;

   if ( (cb_vendedor.Checked) and (cbx_vendedores.Text = '') ) then
   begin
     ShowMessage('Infome um VENDEDOR');
     cbx_vendedores.SetFocus;
     exit;
   end;

   if ( (cb_periodo.Checked) and
    ((cbx_mes.Text = '') or (edt_ano.Text ='')) ) then
   begin
     ShowMessage('Infome um PERIODO válido');
     cbx_mes.SetFocus;
     exit;
   end;


   result := true;

end;

procedure TfrmComissaoFechamento.prc_componentes;
begin
  DBGrid1.Columns[0].Visible := false; // id
  DBGrid1.Columns[2].Visible := false; // pessoa_id
  DBGrid1.Columns[3].Visible := true;  // nome pessoa


  btnExcluir.Visible  := false;
  btnAlterar.Enabled  := false;
  btnImprimir.Enabled := false;


  dtp_data_ini.Date :=date;
  dtp_data_fim.Date :=date;

  qryVendedor.Connection := self.Conexao;
  qryVendedor.Close;
  qryVendedor.SQL.Clear;
  qryVendedor.SQL.Add('select ');
  qryVendedor.SQL.Add('  P.ID, V.PESSOA_ID, P.NOME ');
  qryVendedor.SQL.Add(' from ');
  qryVendedor.SQL.Add('  PESSOAS P, VENDEDORES V ');
  qryVendedor.SQL.Add(' where ');
  qryVendedor.SQL.Add('  P.ID = V.PESSOA_ID ');
  qryVendedor.SQL.Add(' order by P.NOME');
  qryVendedor.Open;

  qry_busca_vendedor.Connection := self.Conexao;
  qry_busca_vendedor.Close;
  qry_busca_vendedor.SQL.Clear;
  qry_busca_vendedor.SQL.Add('select         ');
  qry_busca_vendedor.SQL.Add('  P.ID, P.NOME ');
  qry_busca_vendedor.SQL.Add(' from          ');
  qry_busca_vendedor.SQL.Add('  PESSOAS P    ');
  qry_busca_vendedor.SQL.Add(' where         ');
  qry_busca_vendedor.SQL.Add('  P.ID = :ID   ');
  qry_busca_vendedor.Open;


  {Empresa}
  qryEmpresa.Connection := self.Conexao;
  qryEmpresa.Close;
  qryEmpresa.SQL.Clear;
  qryEmpresa.SQL.Add('select P.*, E.*  from PESSOAS P, EMPRESA E where E.PESSOA_ID = P.ID');
  qryEmpresa.Open;


end;

procedure TfrmComissaoFechamento.FormCreate(Sender: TObject);
begin
  inherited;
  Tabela  := 'FECHAMENTO_COMISSAO';
  Titulo  := 'Fechamentos de comissões ' + '[' + self.Tabela + ']';
  Caption := Titulo;

  prc_sql;


end;

procedure TfrmComissaoFechamento.FormShow(Sender: TObject);
begin
  inherited;
  prc_componentes;
end;

procedure TfrmComissaoFechamento.prc_pesquisar;
var
  situacao, Condicao : string;
begin

  Condicao := '';
  qry.SQL.Clear;
  qry.SQL.Text := sSql;

  if cb_data_contabil.Checked then
    Condicao := ' and F.CADASTRADO_EM between :DATA_INI and :DATA_FIM ';

  if cb_vendedor.Checked then
    Condicao := Condicao + ' and F.PESSOA_ID =:PESSOA_ID ';

  if cb_periodo.Checked then
    Condicao := Condicao + ' and F.MES =:MES and F.ANO =:ANO ';


  if Condicao <> '' then
  begin
    //Condicao := copy(Condicao,4,length(Condicao)-4);

    qry.SQL.Text := qry.SQL.Text + condicao;

    {Carregar parametros}
    if cb_data_contabil.Checked then
    begin
      qry.ParamByName('DATA_INI').AsDate := dtp_data_ini.Date;
      qry.ParamByName('DATA_fim').AsDate := dtp_data_fim.Date;
    end;

    if cb_vendedor.Checked then
    begin
      qry.ParamByName('PESSOA_ID').AsInteger := cbx_vendedores.KeyValue;
    end;

    if cb_periodo.Checked then
    begin
      qry.ParamByName('MES').AsString := cbx_mes.Text;
      qry.ParamByName('ANO').AsString := edt_ano.Text;
    end;

  end;

  //ShowMessage(qry.SQL.Text);
  qry.Open;

end;

procedure TfrmComissaoFechamento.prc_sql;
begin

  {SQL default}
  with qry.SQL do
  begin
    clear;
    add(' select ');
    add('   f.id, ');
    add('   f.cadastrado_em, ');
    add('   f.pessoa_id, ');
    add('   p.nome, ');
    add('   f.mes, ');
    add('   f.ano, ');
    add('   f.total_venda, ');
    add('   f.saldo_liquido, ');
    add('   f.obs ');
    add(' from ');
    add('   fechamento_comissao f, ');
    add('   pessoas p ');
    add(' where ');
    add('   f.pessoa_id = p.id ');
  end;

  sSql := QRY.SQL.Text;

end;

end.
