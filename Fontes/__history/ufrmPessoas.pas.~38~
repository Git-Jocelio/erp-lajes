unit ufrmPessoas;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseGrade, Data.DB,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,
  FireDAC.Stan.Async, FireDAC.DApt, System.Actions, Vcl.ActnList,
  System.ImageList, Vcl.ImgList, Vcl.Menus, FireDAC.Comp.DataSet,
  FireDAC.Comp.Client, Vcl.ComCtrls, Vcl.ToolWin, Vcl.Grids, Vcl.DBGrids,
  Vcl.StdCtrls, Vcl.ExtCtrls, Vcl.Buttons, Vcl.DBCtrls;

type
  TfrmPessoas = class(TfrmBaseGrade)
    cbCpfCnpj: TCheckBox;
    edCpfCnpj: TEdit;
    cbNome: TCheckBox;
    edNome: TEdit;
    cbTelefone: TCheckBox;
    edTelefone: TEdit;
    cbCelular: TCheckBox;
    edCelular: TEdit;
    rgSituacao: TRadioGroup;

    procedure actIncluirExecute(Sender: TObject);
    procedure actAlterarExecute(Sender: TObject);
    procedure actExcluirExecute(Sender: TObject);
    procedure actLocalizarExecute(Sender: TObject);

    procedure FormCreate(Sender: TObject);

  private
    function ValidarPesquisa(): boolean;
    procedure Pesquisar();
    procedure ASql();


  public
  end;

  procedure executa();

implementation

{$R *.dfm}

uses uBiblioteca, ufrmPessoasE;

procedure executa();
var
  loForm: TfrmPessoas;
begin
  try
    loForm := TfrmPessoas.Create(Application);
    loForm.ShowModal;
  finally
    freeandnil(loForm);
  end;
end;



procedure TfrmPessoas.actAlterarExecute(Sender: TObject);
begin
  inherited;
  ufrmPessoasE.Alterar(qry.fieldbyname('ID').AsInteger);
  uBiblioteca.AtualizaQuery(qry);

end;

procedure TfrmPessoas.actExcluirExecute(Sender: TObject);
begin
  inherited;
  if not qry.IsEmpty then
  begin
    ufrmPessoasE.Excluir(qry.fieldbyname('ID').AsInteger);
    uBiblioteca.AtualizaQuery(qry);
  end;

end;

procedure TfrmPessoas.actIncluirExecute(Sender: TObject);
begin
  inherited;
  ufrmPessoasE.Incluir;
  uBiblioteca.AtualizaQuery(qry);

end;

procedure TfrmPessoas.actLocalizarExecute(Sender: TObject);
begin
  inherited;
  if ValidarPesquisa() then
    Pesquisar();

  // mensagem para o usuario
  StatusBar.Panels[0].Text := 'Encontrado(s) : ' + inttostr(qry.RecordCount) + ' registro(s)';
end;

procedure TfrmPessoas.ASql;
begin
  qry.Open('select * from ' + Self.Tabela + ' where ID = -1');
end;

procedure TfrmPessoas.FormCreate(Sender: TObject);
begin
  inherited;
  // property tabela no form BaseGrade
  self.Tabela := 'PESSOAS';
  self.Titulo := 'Cadastro de Pessoas' + '[' + self.Tabela + ']';
  Caption := Titulo;
  ASql();
end;

procedure TfrmPessoas.Pesquisar;
var
  Situacao, Condicao: string;
begin


  {Situação da pessoa}
  if rgSituacao.ItemIndex = 0 then
    situacao := 'ATIVO =' + QuotedStr('S') + ' and ';
  if rgSituacao.ItemIndex = 1 then
    situacao := 'ATIVO =' + QuotedStr('N') + ' and ';
  if rgSituacao.ItemIndex = 2 then
    situacao := 'ATIVO <>' + QuotedStr('') + ' and ';

  Condicao := '';

  if cbCpfCnpj.Checked then
    if trim(edCpfCnpj.Text) <> '' then
        Condicao := Condicao + 'and CPF_CNPJ like :CPF_CNPJ ';

  if cbNome.Checked then
    if trim(edNome.Text) <> '' then
    Condicao := Condicao + 'and NOME like :NOME ';

  if cbTelefone.Checked then
    if trim(edTelefone.Text) <> '' then
    Condicao := Condicao + 'and TELEFONE like :TELEFONE ';

  if cbCelular.Checked then
    if trim(edCelular.Text) <> '' then
    Condicao := Condicao + 'and CELULAR like :CELULAR ';

  if Condicao <> '' then
  begin
    Condicao := copy(Condicao,4,length(Condicao)-4);

    qry.SQL.Clear;
    qry.SQL.Add('select * from ' + Self.Tabela + ' where '+ Situacao + Condicao );
    self.ssql := qry.SQL.Text;

    {Carregar parametros}
    if cbCpfCnpj.Checked then
      if trim(edCpfCnpj.Text) <> '' then
      begin
        qry.Params.ParamByName('CPF_CNPJ').AsString := '%' + EdCpfCnpj.Text + '%';
      end;

     if cbNome.Checked then
      begin
        qry.Params.ParamByName('NOME').AsString := '%' + EdNome.Text + '%';
      end;

     if cbTelefone.Checked then
      begin
        qry.Params.ParamByName('TELEFONE').AsString := '%' + edTelefone.Text + '%';
      end;

     if cbCelular.Checked then
      begin
        qry.Params.ParamByName('CELULAR').AsString := '%' + edCelular.Text + '%';
      end;

    qry.Open;
  end
  else
  begin
    qry.SQL.Clear;
    if rgSituacao.ItemIndex = 2 then // todos
    begin
      qry.SQL.Add('select * from ' + Self.Tabela);
      self.sSql := qry.SQL.Text;
    end
    else
    begin // verifica a situação selecionada
      Situacao := copy(Situacao,1,length(Situacao)-4);
      qry.SQL.Add('select * from ' + Self.Tabela + ' where ' + Situacao);
      self.sSql := qry.SQL.Text;
  end;
    qry.Open;
  end;

end;

function TfrmPessoas.ValidarPesquisa: boolean;
begin
   result := true;
end;

end.
