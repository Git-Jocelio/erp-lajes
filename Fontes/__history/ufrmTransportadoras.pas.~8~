unit ufrmTransportadoras;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseGrade, Data.DB,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,
  FireDAC.Stan.Async, FireDAC.DApt, System.Actions, Vcl.ActnList,
  System.ImageList, Vcl.ImgList, Vcl.Menus, FireDAC.Comp.DataSet,
  FireDAC.Comp.Client, Vcl.ComCtrls, Vcl.ToolWin, Vcl.Grids, Vcl.DBGrids,
  Vcl.StdCtrls, Vcl.Buttons, Vcl.ExtCtrls;

type
  TfrmTransportadoras = class(TfrmBaseGrade)
    rgSituacao: TRadioGroup;
    cbCpfCnpj: TCheckBox;
    edCpfCnpj: TEdit;
    cbNome: TCheckBox;
    edNome: TEdit;
    procedure FormCreate(Sender: TObject);
    procedure actIncluirExecute(Sender: TObject);
    procedure actAlterarExecute(Sender: TObject);
    procedure actExcluirExecute(Sender: TObject);
    procedure actLocalizarExecute(Sender: TObject);

  private
    function ValidarPesquisa(): boolean;
    procedure Pesquisar();
    procedure ASql();

  public
    { Public declarations }
  end;

 procedure executa();

implementation

{$R *.dfm}

uses uBiblioteca, ufrmTransportadorasE;

procedure executa();
var
  loForm: TfrmTransportadoras;
begin
  try
    loForm := TfrmTransportadoras.Create(Application);
    loForm.ShowModal;
  finally
    freeandnil(loForm);
  end;
end;


procedure TfrmTransportadoras.actAlterarExecute(Sender: TObject);
begin
  inherited;
  ufrmTransportadorasE.Alterar(qry.fieldbyname('ID').AsInteger);
  uBiblioteca.AtualizaQuery(qry);

end;

procedure TfrmTransportadoras.actExcluirExecute(Sender: TObject);
begin
  inherited;
  if not qry.IsEmpty then
  begin
    ufrmTransportadorasE.Excluir(qry.fieldbyname('ID').AsInteger);
    uBiblioteca.AtualizaQuery(qry);
  end;

end;

procedure TfrmTransportadoras.actIncluirExecute(Sender: TObject);
begin
  inherited;
  ufrmTransportadorasE.Incluir;
  uBiblioteca.AtualizaQuery(qry);

end;

procedure TfrmTransportadoras.actLocalizarExecute(Sender: TObject);
begin
  inherited;
  if ValidarPesquisa() then
    Pesquisar();

  // mensagem para o usuario
  StatusBar.Panels[0].Text := 'Encontrado(s) : ' + inttostr(qry.RecordCount) + ' registro(s)';

end;

procedure TfrmTransportadoras.ASql;
begin
  qry.Open('select T.ID, P.CPF_CNPJ, P.NOME from ' + Self.Tabela + ' T, PESSOAS P where P.ID = -1');
end;

procedure TfrmTransportadoras.FormCreate(Sender: TObject);
begin
  inherited;
  // property tabela no form BaseGrade
  self.Tabela := 'TRANSPORTADORAS';
  self.Titulo := 'Cadastro de Transportadoras' + '[' + self.Tabela + ']';
  Caption := Titulo;
  ASql();

end;

procedure TfrmTransportadoras.Pesquisar;
var
  Situacao, Condicao: string;
begin

  {Situação da pessoa}
  if rgSituacao.ItemIndex = 0 then
    situacao := 'P.ATIVO =' + QuotedStr('S') + ' and ';
  if rgSituacao.ItemIndex = 1 then
    situacao := 'P.ATIVO =' + QuotedStr('N') + ' and ';
  if rgSituacao.ItemIndex = 2 then
    situacao := 'P.ATIVO <>' + QuotedStr('') + ' and ';

  Condicao := '';

  if cbCpfCnpj.Checked then
    if trim(edCpfCnpj.Text) <> '' then
        Condicao := Condicao + 'and CPF_CNPJ like :CPF_CNPJ ';

  if cbNome.Checked then
    if trim(edNome.Text) <> '' then
    Condicao := Condicao + 'and NOME like :NOME ';


  if Condicao <> '' then
  begin
    Condicao := copy(Condicao,4,length(Condicao)-4);

    qry.SQL.Clear;
    qry.SQL.Add('select P.*, T.PERCENTUAL from ' + Self.Tabela + ' T, PESSOAS P where P.ID = T.PESSOA_ID and '+ Situacao + Condicao );
    self.ssql := qry.SQL.Text;

    {Carregar parametros}
    if cbCpfCnpj.Checked then
      if trim(edCpfCnpj.Text) <> '' then
      begin
        qry.Params.ParamByName('CPF_CNPJ').AsString := '%' + EdCpfCnpj.Text + '%';
      end;

     if cbNome.Checked then
      begin
        qry.Params.ParamByName('NOME').AsString := '%' + EdNome.Text + '%';
      end;

    //ShowMessage(qry.SQL.Text);
    qry.Open;
  end
  else
  begin
    qry.SQL.Clear;
    if rgSituacao.ItemIndex = 2 then // todos
    begin
        qry.SQL.Clear;
        qry.SQL.Add('select P.*, T.ID AS IDTRANSP from ' + Self.Tabela + ' T, PESSOAS P where P.ID = T.PESSOA_ID');
        self.sSql := qry.SQL.Text;
    end
    else
    begin // verifica a situação selecionada
      Situacao := copy(Situacao,1,length(Situacao)-4);

      qry.SQL.Add('select P.*, T.ID AS IDTRANSP from ' + Self.Tabela + ' T, PESSOAS P where P.ID = T.PESSOA_ID and ' + Situacao);
      self.sSql := qry.SQL.Text;
  end;
    //ShowMessage(qry.SQL.Text);
    qry.Open;
  end;

end;

function TfrmTransportadoras.ValidarPesquisa: boolean;
begin
  result := false;
  // validar...
  result := true;
end;

end.
