// cadastro de fornecedores - base cadastro de clientes
// inicio : 26/02/2024


unit ufrmFornecedoresE;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseEdicao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.ExtCtrls, uTipos, Vcl.DBCtrls, Vcl.Mask, ufrmPesquisaPessoa, uBiblioteca,
  ufrmPessoasE;

type
  TfrmFornecedoresE = class(TfrmBaseEdicao)
    qryPessoas: TFDQuery;
    dsPessoas: TDataSource;
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    Label6: TLabel;
    Label7: TLabel;
    Label8: TLabel;
    Label9: TLabel;
    Label10: TLabel;
    Label11: TLabel;
    Label12: TLabel;
    Label13: TLabel;
    Label14: TLabel;
    Label15: TLabel;
    Label16: TLabel;
    Label17: TLabel;
    btn_busca_pessoa: TBitBtn;
    btnIncluirPessoa: TBitBtn;
    DBEdit1: TDBEdit;
    DBEdit2: TDBEdit;
    DBEdit3: TDBEdit;
    DBEdit6: TDBEdit;
    DBEdit7: TDBEdit;
    DBEdit8: TDBEdit;
    DBEdit9: TDBEdit;
    DBEdit10: TDBEdit;
    DBEdit11: TDBEdit;
    DBEdit12: TDBEdit;
    DBEdit13: TDBEdit;
    DBEdit14: TDBEdit;
    DBEdit15: TDBEdit;
    DBEdit16: TDBEdit;
    DBEdit17: TDBEdit;
    DBCheckBox1: TDBCheckBox;
    rgPessoa: TDBRadioGroup;
    pn_fornecedor: TPanel;
    Label22: TLabel;
    Label23: TLabel;
    Label24: TLabel;
    edt_contato: TEdit;
    edt_telefones: TEdit;
    edt_produtos: TEdit;
    cb_fornecedor_ativo: TDBCheckBox;

    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);

    procedure btn_busca_pessoaClick(Sender: TObject);
    procedure btnIncluirPessoaClick(Sender: TObject);
    procedure btnOkClick(Sender: TObject);
  private
    FOperacao: uTipos.TOperacao;
    FTabela: string;
    FCodigo: integer;
    //Fp_fornecedor_id: integer;

  protected
    procedure prc_componentes;
    procedure prc_inicializar;
    procedure prc_ler_dados;
    function fnc_validar: boolean;
    procedure prc_salvar;
    procedure prc_incluir_alterar;
  public

    property Codigo   :integer read FCodigo write FCodigo;
    property Operacao :uTipos.TOperacao read FOperacao write FOperacao;
    property Tabela   :string read FTabela write FTabela;

  end;

  procedure prc_incluir;
  procedure prc_alterar(ACodigo :integer);
  procedure prc_excluir(ACodigo :integer);

implementation

procedure prc_incluir;
var
  loForm : TfrmFornecedoresE;
begin
  loForm := TfrmFornecedoresE.Create(Application);
  try
    loForm.Operacao := uTipos.opIncluir;
    loForm.Codigo   := 0;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

procedure prc_alterar(ACodigo :integer);
var
  loForm : TfrmFornecedoresE;
begin
  loForm := TfrmFornecedoresE.Create(Application);
  try
    loForm.Operacao := uTipos.opAlterar;
    loForm.Codigo   := ACodigo;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

procedure prc_excluir(ACodigo :integer);
var
  loForm : TfrmFornecedoresE;
begin
  loForm := TfrmFornecedoresE.Create(Application);
  try
    loForm.Operacao := uTipos.opExcluir;
    loForm.Codigo   := ACodigo;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;



{$R *.dfm}

procedure TfrmFornecedoresE.btnIncluirPessoaClick(Sender: TObject);
var
  pessoa: integer;
begin
  inherited;
  pessoa := ufrmPessoasE.incluir;
//  ShowMessage(inttostr(pessoa));

  uBiblioteca.FilterCds(qry, uTipos.fsInteger, inttostr(pessoa));

end;

procedure TfrmFornecedoresE.btnOkClick(Sender: TObject);
begin
  inherited;
  if fnc_validar then
  begin
    prc_salvar;
  end;
end;

procedure TfrmFornecedoresE.btn_busca_pessoaClick(Sender: TObject);
begin
  inherited;
  if frmPesquisaPessoa = nil  then
  frmPesquisaPessoa := TfrmPesquisaPessoa.Create(Application);
  try
    frmPesquisaPessoa.ShowModal;

    //ShowMessage(inttostr(frmPesquisaPessoa.Codigo));
    if frmPesquisaPessoa.Confirmado then
    begin
      uBiblioteca.FilterCds(qry, uTipos.fsInteger, inttostr(frmPesquisaPessoa.Codigo));
    end
    else
      qry.Close;
  finally
    FreeAndNil(frmPesquisaPessoa);

  end;

end;

function TfrmFornecedoresE.fnc_validar: boolean;
var
  loQuery: TFDQuery;
begin
  result := false;


  if qry.IsEmpty then
  begin
    ShowMessage('Selecione ou cadastre uma pessoa');
    btn_busca_pessoa.SetFocus;
    exit;
  end;

  {verifica duplicidade}
  if self.Operacao = uTipos.OpIncluir then
  begin
    try
      try
        loQuery := TFDQuery.Create(self);
        loQuery.Connection := Self.Conexao;
        loQuery.SQL.Add('select PESSOA_ID from FORNECEDORES where PESSOA_ID =:PESSOA_ID');
        loQuery.Params[0].AsInteger := qry.fieldbyname('ID').AsInteger;
        loQuery.Open;
        if not loQuery.IsEmpty then
        begin
          ShowMessage('Cliente já está cadastrado no sistema');
          exit;
        end;
      finally
        FreeAndNil(loQuery);
      end;
    except
      on E : Exception do
      Raise Exception.Create(E.Message + Self.Name +'.Valida : ' + self.Caption );
    end;
  end;

  if edt_contato.Text = '' then
  begin
    ShowMessage('Informe o nome do vendedor(a) desse fornecedor.');
    edt_contato.SetFocus;
    exit;
  end;

  if edt_telefones.Text = '' then
  begin
    ShowMessage('Informe pelo menos um telefone de contato');
    edt_telefones.SetFocus;
    exit;
  end;

  if edt_produtos.Text = '' then
  begin
    ShowMessage('Informe a descrição dos produtos que o fornecedores vende');
    edt_produtos.SetFocus;
    exit;
  end;

  result := true;

end;

procedure TfrmFornecedoresE.FormCreate(Sender: TObject);
begin
  inherited;
  self.Tabela := 'FORNECEDORES';
  // titulo do lbl_titulo
  titulo := 'CADASTRO DE FORNECEDORES';

end;

procedure TfrmFornecedoresE.FormShow(Sender: TObject);
begin
  inherited;

  prc_componentes;
  prc_inicializar;

end;

procedure TfrmFornecedoresE.prc_componentes;
begin
  {qry de pessoas}
  qry.SQL.Add('select * from PESSOAS where ID =:ID');


end;

procedure TfrmFornecedoresE.prc_incluir_alterar;
var
  loQry : TFDQuery;
begin
  try
    loQry := TFDQuery.Create(self);
    loQry.Connection := Conexao;

    if operacao = opExcluir then
    begin
      loQry.SQL.Add('update FORNECEDORES set ATIVO = ' + QuotedStr('N') + ' where ID =:ID');
      loQry.ParamByName('ID').AsInteger := Codigo;
      loQry.ExecSQL;
      exit;
    end;


    if operacao = OpIncluir then
    begin
      loQry.SQL.Add('insert into FORNECEDORES ');
      loQry.SQL.Add('(                        ');
      loQry.SQL.Add('  ID,                    ');
      loQry.SQL.Add('  PESSOA_ID,             ');
      loQry.SQL.Add('  CONTATOS,              ');
      loQry.SQL.Add('  TELEFONES_CONTATO,     ');
      loQry.SQL.Add('  PRODUTOS,              ');
      loQry.SQL.Add('  ATIVO                  ');
      loQry.SQL.Add(')                        ');
      loQry.SQL.Add('VALUES                   ');
      loQry.SQL.Add('(                        ');
      loQry.SQL.Add('  :ID,                   ');
      loQry.SQL.Add('  :PESSOA_ID,            ');
      loQry.SQL.Add('  :CONTATOS,             ');
      loQry.SQL.Add('  :TELEFONES_CONTATO,    ');
      loQry.SQL.Add('  :PRODUTOS,             ');
      loQry.SQL.Add('  :ATIVO                 ');
      loQry.SQL.Add(')                        ');

      Codigo := uBiblioteca.AutoIncremento(conexao, 'FORNECEDORES');
      loQry.ParamByName('ID').AsInteger        := Codigo;
      loQry.ParamByName('PESSOA_ID').AsInteger := qry.FieldByName('ID').AsInteger;

    end
    else
    begin
      loQry.SQL.Add('UPDATE                                   ');
      loQry.SQL.Add('  FORNECEDORES                           ');
      loQry.SQL.Add('SET                                      ');
      loQry.SQL.Add('  CONTATOS   = :CONTATOS,                ');
      loQry.SQL.Add('  TELEFONES_CONTATO = :TELEFONES_CONTATO,');
      loQry.SQL.Add('  PRODUTOS  = :PRODUTOS,                 ');
      loQry.SQL.Add('  ATIVO  = :ATIVO                        ');
      loQry.SQL.Add('WHERE                                    ');
      loQry.SQL.Add('  ID = :ID                               ');

      loQry.ParamByName('ID').AsInteger := Codigo;

    end;
    ShowMessage(loqry.SQL.text);

    loQry.ParamByName('CONTATOS').AsString   := edt_contato.Text;
    loQry.ParamByName('TELEFONES_CONTATO').AsString := edt_telefones.Text;
    loQry.ParamByName('PRODUTOS').AsString  := edt_produtos.Text;
    loQry.ParamByName('ATIVO').AsString     := SeSenao(cb_fornecedor_ativo.Checked, 'S','N');
    loQry.ExecSQL;
  finally
     FreeAndNil(loQry);
  end;
end;

procedure TfrmFornecedoresE.prc_inicializar;
begin
  case self.Operacao of
  uTipos.opIncluir: begin
                       pnDados.Enabled        := true;
                       lbl_sub_titulo.Caption := 'Incluir um novo fornecedor';
                       btnOk     .Caption     := 'Incluir';
                       btn_busca_pessoa.SetFocus;
                       qry.Close;
                     end;
  uTipos.opAlterar: begin
                      self.prc_ler_dados;
                      lbl_sub_titulo.Caption := 'Alterar dados do fornecedor';
                      btnOk.Caption          := 'Alterar';
                      //
                      btnOk.SetFocus;
                    end;
  uTipos.opExcluir: begin
                      self.prc_ler_dados;
                      lbl_sub_titulo.Caption := 'Marcar o fornecedor como INATIVO';
                      pn_fornecedor.Enabled  := false;
                      btnOk.Caption          := 'Excluir';
                      btnFechar.SetFocus;
                    end;
  else
    begin
      pnDados.Enabled       := false;
      pn_fornecedor.Enabled := false;
      if btnFechar.CanFocus then btnFechar.SetFocus;
    end;
  end;

end;

procedure TfrmFornecedoresE.prc_ler_dados;
var
  loQry: TFDQuery;
begin
  pnDados.Enabled := false;
  try
    loQry:= TFDQuery.Create(self);
    loQry.Connection := conexao;
    loqry.sql.Add('select * from ' + tabela + ' where id = :id');
    loQry.Params.ParamByName('id').AsInteger := Codigo;
    loQry.Open;

    //pessoa
    FilterCds(qry, fsInteger, inttostr(loQry.FieldByName('pessoa_id').AsInteger));
    edt_contato.Text := loQry.FieldByName('contatos').AsString;
    edt_telefones.Text := loQry.FieldByName('TELEFONES_CONTATO').AsString;
    edt_produtos.Text := loQry.FieldByName('PRODUTOS').AsString;
    cb_fornecedor_ativo.Checked := uBiblioteca.SeSenao(loQry.FieldByName('ativo').AsString = 'S', TRUE, FALSE)
  finally
    FreeAndNil(loQry)
  end;
//  p_fornecedor_id := id do fornecedor ja cadatrado
end;

procedure TfrmFornecedoresE.prc_salvar;
begin

  if not Self.Conexao.InTransaction then Self.Conexao.StartTransaction;
  //***
  try
    prc_incluir_alterar;

    if Self.Conexao.InTransaction then Self.Conexao.Commit;
      ShowMessage('Fornecedor salvo com sucesso!');

    ModalResult := mrOk;
  except
    Self.Conexao.Rollback;
    ShowMessage('Não foi possível salvar o registro');

  end;

end;

end.
