//***************************************************************************//
// Manutenção de comissoes
// desenvolvida por Jocelio G Silva
// inicio : 04/03/2022
// fim :
// baseado frmContasReceber
//
//***************************************************************************//

unit ufrmComissoes;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseGrade, Data.DB,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,
  FireDAC.Stan.Async, FireDAC.DApt, System.Actions, Vcl.ActnList,
  System.ImageList, Vcl.ImgList, Vcl.Menus, FireDAC.Comp.DataSet,
  FireDAC.Comp.Client, Vcl.ComCtrls, Vcl.ToolWin, Vcl.Grids, Vcl.DBGrids,
  Vcl.StdCtrls, Vcl.Buttons, Vcl.DBCtrls, Vcl.ExtCtrls, uTipos, ufrmComissoesE,
  udmPrincipal, ufrmComissoesDespesaE, uFinanceiro, frxClass, frxDBSet,
  ufrmComissoesItensE;

type
  TfrmComissoes = class(TfrmBaseGrade)
    dsVendedor: TDataSource;
    qryVendedor: TFDQuery;
    pgc_pesquisa: TPageControl;
    tbs_pedido: TTabSheet;
    tbs_customizado: TTabSheet;
    gbValor: TGroupBox;
    edt_numero_pedido: TEdit;
    tbs_custos_pedido: TTabSheet;
    gbx_totais_comissao: TGroupBox;
    Label1: TLabel;
    edt_qtde_registros: TEdit;
    Label2: TLabel;
    edt_total_vendas: TEdit;
    Label3: TLabel;
    edt_custo_pedidos: TEdit;
    Label4: TLabel;
    edt_comissao_adm: TEdit;
    Label5: TLabel;
    edt_margem: TEdit;
    edt_comissao_vend: TEdit;
    Label6: TLabel;
    qry_comissao_itens: TFDQuery;
    qry_comissao_itensID: TIntegerField;
    qry_comissao_itensPEDIDO_ID: TIntegerField;
    qry_comissao_itensPRODUTO_ID: TIntegerField;
    qry_comissao_itensNOME_FANTASIA: TStringField;
    qry_comissao_itensQUANTIDADE: TCurrencyField;
    qry_comissao_itensCUSTO_FORN: TCurrencyField;
    qry_comissao_itensCUSTO_VEND: TCurrencyField;
    qry_comissao_itensPRECO_VENDA: TCurrencyField;
    qry_comissao_itensDEBITO_CREDITO: TStringField;
    qry_comissao_itensOBS: TStringField;
    dsComissao_itens: TDataSource;
    qry_comissao_itens_agrupados: TFDQuery;
    ds_itens_agrupados: TDataSource;
    qry_comissao_itens_agrupadosPRODUTO_ID: TIntegerField;
    qry_comissao_itens_agrupadosNOME_FANTASIA: TStringField;
    qry_comissao_itens_agrupadosSUM: TFMTBCDField;
    qry_comissao_itens_agrupadosUNIDADE: TStringField;
    pnl_comissoes_titulo: TPanel;
    Label9: TLabel;
    ds_comissao_despesas: TDataSource;
    qry_outros_lancamentos: TFDQuery;
    Label14: TLabel;
    edt_outras_despesas: TEdit;
    pnl_custo_detalhado: TPanel;
    pnl_titulo_custos: TPanel;
    Label12: TLabel;
    dbg_comissao_itens_detalhe: TDBGrid;
    Panel4: TPanel;
    gb_data_contabil: TGroupBox;
    Label7: TLabel;
    cb_data_contabil: TCheckBox;
    dtp_data_contabil_ini: TDateTimePicker;
    dtp_data_contabil_fim: TDateTimePicker;
    gbPessoa: TGroupBox;
    cb_vendedor: TCheckBox;
    cbx_vendedores: TDBLookupComboBox;
    rg_situacao: TRadioGroup;
    frxReportComissoes: TfrxReport;
    frxDBComissoes: TfrxDBDataset;
    frxDBEmpresa: TfrxDBDataset;
    qryEmpresa: TFDQuery;
    pnl_detalhes: TPanel;
    dbg_comissao_itens_agrupados: TDBGrid;
    pnl_outros_lancamentos: TPanel;
    dbg_outros_lancamentos: TDBGrid;
    pnl_topo_outros_lancamentos: TPanel;
    btn_incluir_despesa: TSpeedButton;
    btn_excluir_despesa: TSpeedButton;
    Label20: TLabel;
    Splitter1: TSplitter;
    Panel1: TPanel;
    Label8: TLabel;
    Label10: TLabel;
    Label11: TLabel;
    Label13: TLabel;
    lbl_nm_vendedor: TLabel;
    lbl_nm_cliente: TLabel;
    lbl_nr_pedido: TLabel;
    lbl_bairro: TLabel;
    btn_alterar_valores: TSpeedButton;
    pnl_detalhe_consumidor: TPanel;
    Nome: TLabel;
    lbl_detalhe_consumidor: TLabel;
    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);


    procedure actPesquisarExecute(Sender: TObject);
    procedure actIncluirExecute(Sender: TObject);
    procedure actAlterarExecute(Sender: TObject);
    procedure actExcluirExecute(Sender: TObject);
    procedure tbs_custos_pedidoShow(Sender: TObject);
    procedure TabSheet1Show(Sender: TObject);
    procedure actLocalizarExecute(Sender: TObject);
    procedure tbs_pedidoShow(Sender: TObject);
    procedure tbs_customizadoShow(Sender: TObject);
    procedure DBGrid1DblClick(Sender: TObject);
    procedure tbs_custos_pedido_agrupadoShow(Sender: TObject);
    procedure btn_incluir_despesaClick(Sender: TObject);
    procedure btn_excluir_despesaClick(Sender: TObject);
    procedure ds_comissao_despesasDataChange(Sender: TObject; Field: TField);
    procedure dbg_outras_despesasDblClick(Sender: TObject);
    procedure cb_vendedorClick(Sender: TObject);
    procedure dsDataChange(Sender: TObject; Field: TField);
    procedure btnImprimirClick(Sender: TObject);
    procedure dbg_comissao_itens_detalheDblClick(Sender: TObject);
  private
    function  fnc_validar_pesquisa: boolean;
    procedure prc_componentes;
    procedure prc_filtrar;
    procedure prc_totais;
    procedure prc_filtra_comissao_itens(pedido_id : integer);
    function fnc_somar_despesas(pedido_id: integer): double;
    procedure prc_detalhes_consumidor(pedido_id : integer);

  public
  end;

procedure executa;


implementation

{$R *.dfm}

uses uBiblioteca, udmConn;


procedure executa;
var
  loForm: TfrmComissoes;
begin
  loForm:= TfrmComissoes.Create(application);
  try
    loForm.ShowModal;
  finally
    freeandnil(loform);
  end;
end;

{ TfrmComissoes }

procedure TfrmComissoes.prc_componentes;
begin
  DBGrid1.Columns[0].Visible := false; // id
  dbg_comissao_itens_agrupados.Columns[0].Visible := false; // produto_id

  btnIncluir.Visible := false;
  btnExcluir.Visible := false;

  btn_incluir_despesa.Enabled := false;
  btn_excluir_despesa.Enabled := false;


  dtp_data_contabil_ini.Date :=date;
  dtp_data_contabil_fim.Date :=date;

  pgc_pesquisa.ActivePage := tbs_customizado;

  tbs_custos_pedido.TabVisible          := not qry.IsEmpty;
  //tbs_custos_pedido_agrupado.TabVisible := not qry.IsEmpty;
  btnAlterar.Enabled := false;

  {Empresa}
  qryEmpresa.Connection := self.Conexao;
  qryEmpresa.Close;
  qryEmpresa.SQL.Clear;
  qryEmpresa.SQL.Add('select P.*, E.*  from PESSOAS P, EMPRESA E where E.PESSOA_ID = P.ID');
  qryEmpresa.Open;


  qryVendedor.Connection := self.Conexao;
  qryVendedor.Close;
  qryVendedor.SQL.Clear;
  qryVendedor.SQL.Add( 'select ');
  qryVendedor.SQL.Add('  P.ID, V.PESSOA_ID, P.NOME ');
  qryVendedor.SQL.Add(' from ');
  qryVendedor.SQL.Add('  PESSOAS P, VENDEDORES V ');
  qryVendedor.SQL.Add(' where ');
  qryVendedor.SQL.Add('  P.ID = V.PESSOA_ID ');
  qryVendedor.SQL.Add(' order by P.NOME');
  qryVendedor.Open;

  {cabeça da comissão}

  qry.SQL.Add('select                       ');
  qry.SQL.ADD('   C.id,                     ');
  qry.SQL.ADD('   vend.nome as nm_vendedor, ');
  qry.SQL.ADD('   C.data_contabil,          ');
  qry.SQL.ADD('   C.pedido_id,              ');
  qry.SQL.ADD('   P.ID,                     ');
  qry.SQL.ADD('   P.NOSSO_NUMERO,           ');
  qry.SQL.ADD('   cli.nome as nm_cliente,   ');
  qry.SQL.ADD('   cli.ENDERECO,               ');
  qry.SQL.ADD('   cli.bairro,               ');
  qry.SQL.ADD('   cli.CIDADE,               ');
  qry.SQL.ADD('   cli.NUMERO,               ');
  qry.SQL.ADD('   C.vendedor_id,            ');
  qry.SQL.ADD('   C.total_venda,            ');
  qry.SQL.ADD('   C.total_custo,            ');
  qry.SQL.ADD('   C.outras_despesas,        ');
  qry.SQL.ADD('   C.COMISSAO_ADM_TAXA,      ');
  qry.SQL.ADD('   C.comissao_adm,           ');
  qry.SQL.ADD('   C.COMISSAO_BRUTA,         ');
  qry.SQL.ADD('   C.comissao_liquida,       ');
  qry.SQL.ADD('   C.status,                 ');
  qry.SQL.ADD('   C.historico               ');
  qry.SQL.ADD(' from                        ');
  qry.SQL.ADD('   comissao C,               ');
  qry.SQL.ADD('   pedidos P,                ');
  qry.SQL.ADD('   pessoas cli,              ');
  qry.SQL.ADD('   pessoas vend              ');
  qry.SQL.ADD(' where                       ');
  qry.SQL.ADD('   c.pedido_id = P.ID and    ');
  qry.SQL.ADD('   cli.id = p.cliente_id and ');
  qry.SQL.ADD('   c.vendedor_id = vend.id   ');
  self.sSql := qry.SQL.Text;
//  qry.Open;

  {itens da comissão por pedido}
  qry_comissao_itens.Connection := self.Conexao;
  qry_comissao_itens.SQL.Clear;
  with qry_comissao_itens.SQL do
  begin
    add('select ' );
    add('  I.ID, ' );
    add('  I.PEDIDO_ID,' );
    add('  I.PRODUTO_ID,' );
    add('  P.NOME_FANTASIA,');
    add('  I.QUANTIDADE,   ' );
    add('  I.CUSTO_FORN,    ' );
    add('  I.CUSTO_VEND,   '  );
    add('  I.PRECO_VENDA,   ' );
    add('  I.DEBITO_CREDITO,');
    add('  I.OBS            ' );
    add('from               ' );
    add('  COMISSAO_ITEM I, ' );
    add('  PRODUTOS P       ' );
    add('where              '  );
    add('  I.PRODUTO_ID = P.ID and  ' );
    add('  I.PEDIDO_ID = :PEDIDO_ID  ');

  end;

  {itens da comissão agrupados por pedido}
  qry_comissao_itens_agrupados.Connection := self.Conexao;
  qry_comissao_itens_agrupados.SQL.Clear;
  with qry_comissao_itens_agrupados.SQL do
  begin

    add('select                     ');
    add('  C.PRODUTO_ID,              ');
    add('  P.NOME_FANTASIA,              ');
    add('  SUM(QUANTIDADE) as TOTAL, ');
    add('  P.UNIDADE              ');
    add('from                       ');
    add('  COMISSAO_ITEM C,           ');
    add('  PRODUTOS P           ');
    add('where                      ');
    add('  C.PRODUTO_ID = P.ID and   ');
    add('  C.PEDIDO_ID = :PEDIDO_ID   ');
    add('group by                   ');
    add('  C.PRODUTO_ID, P.NOME_FANTASIA, P.UNIDADE               ');

  end;

  qry_outros_lancamentos.Connection := self.Conexao;
  qry_outros_lancamentos.SQL.Clear;
  with qry_outros_lancamentos.SQL do
  begin

    add('select             ');
    add('  ID,              ');
    add('  DATA_CONTABIL,   ');
    add('  HISTORICO,       ');
    add('  DEBITO_CREDITO,  ');
    add('  VALOR            ');
    add('from               ');
    add('  COMISSAO_DESPESAS');
    add('where                   ');
    add('  PEDIDO_ID = :PEDIDO_ID');

  end;


end;


procedure TfrmComissoes.actAlterarExecute(Sender: TObject);
begin
  inherited;
  ufrmComissoesE.Alterar(qry.FieldByName('PEDIDO_ID').AsInteger);
  ubiblioteca.AtualizaQuery(qry);

end;

procedure TfrmComissoes.actExcluirExecute(Sender: TObject);
begin
  inherited;
  //ufrmComissoesE.Excluir(qry.FieldByName('id').AsInteger);

end;

procedure TfrmComissoes.actIncluirExecute(Sender: TObject);
begin
  inherited;
  //ufrmComissoesE.Incluir;

end;

procedure TfrmComissoes.actLocalizarExecute(Sender: TObject);
begin
  inherited;
  if fnc_validar_pesquisa then
  begin
    prc_filtrar;
  end;
end;

procedure TfrmComissoes.actPesquisarExecute(Sender: TObject);
begin
  //inherited;
  if btnPesquisar.Caption = 'Pesquisa >>' then
  begin
    btnPesquisar.Caption := '<< Ocultar Pesquisa';
    GroupBoxPesquisa.Height := 123;

  end
  else
   begin
     btnPesquisar.Caption := 'Pesquisa >>';
     GroupBoxPesquisa.Height := 0;
   end;

end;

procedure TfrmComissoes.DBGrid1DblClick(Sender: TObject);
begin
  inherited;
  PageControl1.ActivePage := TabSheet1;
end;

procedure TfrmComissoes.dbg_comissao_itens_detalheDblClick(Sender: TObject);
begin
  inherited;

  ufrmComissoesItensE.prc_alterar(
                                  qry_comissao_itens.FieldByName('ID').AsInteger,
                                  qry_comissao_itens.FieldByName('PEDIDO_ID').AsInteger,
                                  qry.FieldByName('VENDEDOR_ID').AsInteger,
                                  qry_comissao_itens.FieldByName('NOME_FANTASIA').AsString,
                                  qry_comissao_itens.FieldByName('QUANTIDADE').AsFloat,
                                  qry_comissao_itens.FieldByName('CUSTO_VEND').AsFloat,
                                  qry_comissao_itens.FieldByName('PRECO_VENDA').AsFloat);

  uBiblioteca.AtualizaQuery( qry_comissao_itens );
  uBiblioteca.AtualizaQuery( qry );

end;

procedure TfrmComissoes.dbg_outras_despesasDblClick(Sender: TObject);
var
  outras_despesas: double;
  pedido_atual   : integer;
  vendedor_id    : integer;
  total_venda, total_custo : double;
begin
  inherited;
  if qry_outros_lancamentos.IsEmpty then exit;

  pedido_atual := qry.FieldByName('PEDIDO_ID').AsInteger;
  vendedor_id  := qry.FieldByName('VENDEDOR_ID').AsInteger;
  total_venda  := qry.FieldByName('TOTAL_VENDA').AsFloat;
  total_custo  := qry.FieldByName('TOTAL_CUSTO').AsFloat;

  if frmComissoesDespesasE = nil then
    frmComissoesDespesasE := TfrmComissoesDespesasE.create(application);

  frmComissoesDespesasE.Codigo    := qry_outros_lancamentos.FieldByName('ID').AsInteger;
  frmComissoesDespesasE.pedido_id := qry.FieldByName('PEDIDO_ID').AsInteger;
  frmComissoesDespesasE.Operacao  := opAlterar;
  frmComissoesDespesasE.ShowModal;

  {atualiza outras despesas}
  uBiblioteca.FilterCds(qry_outros_lancamentos, utipos.fsInteger, inttostr(qry.FieldByName('PEDIDO_ID').AsInteger));

  {atualiza a tabela comissao, campo outras despesas e recalcula}
  if not qry_outros_lancamentos.IsEmpty then
    outras_despesas := fnc_somar_despesas(pedido_atual)
  else
    outras_despesas := 0;

  uFinanceiro.fnc_salvar_comissao(
                                  self.Conexao,
                                  opAlterar,
                                  date,
                                  date,
                                  date,
                                  pedido_atual,
                                  vendedor_id,
                                  3,
                                  total_venda,
                                  total_custo,
                                  outras_despesas,
                                  1,//0.50,
                                  50
                                  );

  {pra atualizar a tela tive que fazer tudo isso, depois melhorar}
  uBiblioteca.AtualizaQuery(qry);
  qry.First;
  qry.Locate('pedido_id', pedido_atual,[]);
  prc_filtra_comissao_itens(pedido_atual);

  FreeAndNil( frmComissoesDespesasE );

end;

procedure TfrmComissoes.dsDataChange(Sender: TObject; Field: TField);
begin
  inherited;
  tbs_custos_pedido.TabVisible          := not qry.IsEmpty;

  uBiblioteca.FilterCds(qry_comissao_itens_agrupados, utipos.fsInteger, inttostr(qry.FieldByName('PEDIDO_ID').AsInteger));

  prc_filtra_comissao_itens(qry.FieldByName('PEDIDO_ID').AsInteger);

  {controla o estado do botao incluir outros lancamentos}
  btn_incluir_despesa.Enabled := not qry.IsEmpty;

  {só mostra os lancamento se houver}
  if qry_outros_lancamentos.IsEmpty then
  begin
    pnl_outros_lancamentos.Height := 30;
  end
  else
  begin
    pnl_outros_lancamentos.Height := 112;
  end;

  prc_detalhes_consumidor(qry.FieldByName('PEDIDO_ID').AsInteger);

end;

procedure TfrmComissoes.ds_comissao_despesasDataChange(Sender: TObject;
  Field: TField);
begin
  inherited;
  btn_excluir_despesa.Enabled := not qry_outros_lancamentos.IsEmpty;
end;

procedure TfrmComissoes.FormCreate(Sender: TObject);
begin
  inherited;
  PageControl1.ActivePage := TabSheet1;
  pgc_pesquisa.ActivePage := tbs_pedido;

  // property tabela no form BaseGrade
  self.Tabela := 'COMISSAO';
  self.Titulo := 'Contas a receber' + '[' + self.Tabela + ']';
  Caption := Titulo;

end;

procedure TfrmComissoes.FormShow(Sender: TObject);
begin
  inherited;
  prc_componentes;
//  prc_totais;
end;



procedure TfrmComissoes.TabSheet1Show(Sender: TObject);
begin
  //inherited;
  //GroupBoxPesquisa.Height := 177;
  ToolBar1.Visible := true;

  gbx_totais_comissao.Visible := true;
  qry_comissao_itens.Close;
end;

procedure TfrmComissoes.tbs_custos_pedidoShow(Sender: TObject);
begin
  //inherited;
  //GroupBoxPesquisa.Height := 123;

  prc_filtra_comissao_itens(qry.FieldByName('PEDIDO_ID').AsInteger);

  lbl_nm_vendedor.Caption := qry.FieldByName('NM_VENDEDOR').AsString;
  lbl_nr_pedido.Caption   := qry.FieldByName('NOSSO_NUMERO').AsString;
  lbl_nm_cliente.Caption  := qry.FieldByName('NM_CLIENTE').AsString;
  lbl_bairro.Caption      := qry.FieldByName('BAIRRO').AsString;

  {amplia tela}
  gbx_totais_comissao.Visible := false;
  ToolBar1.Visible            := false;
  btnPesquisar.Caption        := 'Pesquisa >>';
  GroupBoxPesquisa.Height     := 0;

end;

procedure TfrmComissoes.tbs_custos_pedido_agrupadoShow(Sender: TObject);
begin
  inherited;
  uBiblioteca.FilterCds(qry_comissao_itens_agrupados, utipos.fsInteger, inttostr(qry.FieldByName('PEDIDO_ID').AsInteger));

  //lbl_Pedido_copia.Caption := lbl_numero_pedido.Caption;

  gbx_totais_comissao.Visible := false;

  ToolBar1.Visible := false;

end;

procedure TfrmComissoes.prc_filtra_comissao_itens(pedido_id : integer);
begin
  {lista outras despesas}
  //uBiblioteca.FilterCds(qry_comissao_despesas, utipos.fsInteger, inttostr(qry.FieldByName('PEDIDO_ID').AsInteger));
  uBiblioteca.FilterCds(qry_outros_lancamentos, utipos.fsInteger, inttostr(pedido_id));


  //uBiblioteca.FilterCds(qryComissao_itens, utipos.fsInteger, inttostr(qry.FieldByName('PEDIDO_ID').AsInteger));
  uBiblioteca.FilterCds(qry_comissao_itens, utipos.fsInteger, inttostr(pedido_id));
  // carregar os labels
(*  lbl_numero_pedido.Caption := qry.FieldByName('PEDIDO_ID').AsString;

  lbl_data_contabil.Caption     := DateToStr( qry.FieldByName('DATA_CONTABIL').AsDateTime );
  lbl_taxa_adm.Caption          := formatfloat('0.00', qry.FieldByName('COMISSAO_ADM_TAXA').AsFloat );
  lbl_margem_vendedor.Caption   := '50';
  lbl_valor_venda.Caption       := formatfloat('0.00', qry.FieldByName('TOTAL_VENDA').AsFloat );
  lbl_custo_pedido.Caption      := formatfloat('0.00', qry.FieldByName('TOTAL_CUSTO').AsFloat );
  lbl_outras_despesas.Caption   := formatfloat('0.00', qry.FieldByName('OUTRAS_DESPESAS').AsFloat );
  lbl_comissao_adm.Caption      := formatfloat('0.00', qry.FieldByName('COMISSAO_ADM').AsFloat );
  lbl_margem.Caption            := formatfloat('0.00', qry.FieldByName('COMISSAO_BRUTA').AsFloat );
  lbl_comissao_vendedor.Caption := formatfloat('0.00', qry.FieldByName('COMISSAO_LIQUIDA').AsFloat );
  *)
end;



procedure TfrmComissoes.tbs_customizadoShow(Sender: TObject);
begin
  inherited;
  qry.Close;

  tbs_custos_pedido.TabVisible          := not qry.IsEmpty;
  //tbs_custos_pedido_agrupado.TabVisible := not qry.IsEmpty;
  btnAlterar.Enabled  := false;
  btnImprimir.Enabled := false;
end;

procedure TfrmComissoes.tbs_pedidoShow(Sender: TObject);
begin
  inherited;
  edt_numero_pedido.Text := '';
  qry.Close;

  tbs_custos_pedido.TabVisible          := not qry.IsEmpty;
  //tbs_custos_pedido_agrupado.TabVisible := not qry.IsEmpty;

  btnAlterar.Enabled  := false;
  btnImprimir.Enabled := false;

end;

function TfrmComissoes.fnc_validar_pesquisa: boolean;
begin
  result := false;

  if pgc_pesquisa.ActivePage = tbs_pedido then
  begin

    if edt_numero_pedido.Text = '' then
    begin
      ShowMessage('informe um número valido');
      edt_numero_pedido.SetFocus;
      exit;
    end;

  end
  else
  begin
  if cb_data_contabil.Checked then
    if dtp_data_contabil_fim.Date < dtp_data_contabil_ini.Date then
    begin
      ShowMessage('Data da cotabil inicial maior que a final, corrija e tente novamente ');
      dtp_data_contabil_fim.SetFocus;
      exit;
    end;


  if cb_vendedor.Checked then
    if cbx_vendedores.Text = '' then
    begin
      ShowMessage('selecione um vendedor');
      cbx_vendedores.SetFocus;
      exit;
    end;
  end;

  result := true;

end;

procedure TfrmComissoes.prc_filtrar;
var
  loSql, condicao : string;
begin

  edt_qtde_registros.Text  := '0';
  edt_total_vendas.Text    := '0.00';
  edt_custo_pedidos.Text   := '0.00';
  edt_outras_despesas.Text := '0.00';
  edt_comissao_adm.Text    := '0.00';
  edt_margem.Text          := '0.00';
  edt_comissao_vend.Text   := '0.00';




  condicao := '';
  loSql := ssql;

  {pesquisa pelo pedido}
  if ((pgc_pesquisa.ActivePage = tbs_pedido) and
       (edt_numero_pedido.Text <> '')) then
  begin
     //condicao := ' and C.PEDIDO_ID = :PEDIDO_ID ';
     condicao := ' and P.NOSSO_NUMERO = :NOSSO_NUMERO ';
  end
  else
  begin
    {customizado}
    if cb_data_contabil.Checked then
    begin
       condicao := ' and C.DATA_CONTABIL between :DATA_INI and :DATA_FIM ';
    end;

    if cb_vendedor.Checked then
    begin
       condicao := condicao + ' and C.VENDEDOR_ID =:VENDEDOR_ID ';
    end;

    if rg_situacao.ItemIndex = 0 then
      condicao := condicao + ' and C.STATUS = ' + QuotedStr('A');

    if rg_situacao.ItemIndex = 1 then
      condicao := condicao + ' and C.STATUS = ' + QuotedStr('P');

    if rg_situacao.ItemIndex = 2 then
      condicao := condicao + ' and C.STATUS <> ' + QuotedStr('');


  end;
  loSql := loSql + condicao;
  //  ShowMessage(loSql);
  qry.SQL.Text := loSql;
  {parametros}


  if ((pgc_pesquisa.ActivePage = tbs_pedido) and
       (edt_numero_pedido.Text <> '')) then
  begin
      //qry.ParamByName('PEDIDO_ID').AsInteger := strtoint(edt_numero_pedido.Text);
      qry.ParamByName('NOSSO_NUMERO').AsString := edt_numero_pedido.Text;
  end
  else
  begin
    if cb_data_contabil.Checked then
    begin
      qry.ParamByName('DATA_INI').AsDate := dtp_data_contabil_ini.Date;
      qry.ParamByName('DATA_FIM').AsDate := dtp_data_contabil_fim.Date;
    end;

    if cb_vendedor.Checked then
    begin
      qry.ParamByName('VENDEDOR_ID').Value := cbx_vendedores.KeyValue;
    end;
  end;

  {ssql usado para ordenar as colunas}
  sSql := qry.SQL.Text;

  qry.Open;

  if qry.IsEmpty then
  begin
    ShowMessage('Nenhum registro encontrado!');
  end
  else
  begin
    prc_totais;
    {esconde o menu}
    btnPesquisar.Click;
   (*
    {controla a visualização das comissões}
    if qry.RecordCount < 13 then
      pnl_detalhes.Height := 478 - (qry.RecordCount * 27)
    else
      pnl_detalhes.Height := 214;
   *)

  end;
end;

procedure TfrmComissoes.prc_totais;
var
  total_vendas, custo_pedidos, outras_despesas, comissao_adm, margem, comissao_vend: double;
begin
  total_vendas    := 0;
  custo_pedidos   := 0;
  outras_despesas := 0;
  comissao_adm    := 0;
  margem          := 0;
  comissao_vend   := 0;


  qry.DisableControls;
  qry.First;
  while not qry.eof do
  begin

    total_vendas    := total_vendas    + qry.FieldByName('TOTAL_VENDA').AsFloat;
    custo_pedidos   := custo_pedidos   + qry.FieldByName('TOTAL_CUSTO').AsFloat;
    outras_despesas := outras_despesas + qry.FieldByName('OUTRAS_DESPESAS').AsFloat;
    comissao_adm    := comissao_adm    + qry.FieldByName('COMISSAO_ADM').AsFloat;
    margem          := margem          + qry.FieldByName('COMISSAO_BRUTA').AsFloat;
    comissao_vend   := comissao_vend   + qry.FieldByName('COMISSAO_LIQUIDA').AsFloat;

    qry.Next;

  end;

  //
  edt_qtde_registros.Text  := inttostr(qry.RecordCount);
  edt_total_vendas.Text    := formatfloat( '0.00', total_vendas );
  edt_custo_pedidos.Text   := formatfloat( '0.00', custo_pedidos );
  edt_outras_despesas.Text := formatfloat( '0.00', outras_despesas );
  edt_comissao_adm.Text    := formatfloat( '0.00', comissao_adm );
  edt_margem.Text          := formatfloat( '0.00', margem );
  edt_comissao_vend.Text   := formatfloat( '0.00', comissao_vend );



  qry.EnableControls;

end;

procedure TfrmComissoes.btn_incluir_despesaClick(Sender: TObject);
var
  outras_despesas: double;
  pedido_atual : integer;
  vendedor_id : integer;
  total_venda, total_custo : double;
begin
  inherited;
  //ufrmComissoesDespesaE.prc_incluir( qry.FieldByName('PEDIDO_ID').AsInteger );

  pedido_atual := qry.FieldByName('PEDIDO_ID').AsInteger;
  vendedor_id  := qry.FieldByName('VENDEDOR_ID').AsInteger;
  total_venda  := qry.FieldByName('TOTAL_VENDA').AsFloat;
  total_custo  := qry.FieldByName('TOTAL_CUSTO').AsFloat;

  if frmComissoesDespesasE = nil then
    frmComissoesDespesasE := TfrmComissoesDespesasE.create(application);

  frmComissoesDespesasE.Codigo    := 0;
  frmComissoesDespesasE.pedido_id := pedido_atual;
  frmComissoesDespesasE.Operacao  := OpIncluir;
  frmComissoesDespesasE.ShowModal;

  {lista outras despesas}
  uBiblioteca.FilterCds(qry_outros_lancamentos, utipos.fsInteger, inttostr(qry.FieldByName('PEDIDO_ID').AsInteger));

  {atualiza a tabela comissao, campo outras despesas e recalcula}
  if not qry_outros_lancamentos.IsEmpty then
    outras_despesas := fnc_somar_despesas(pedido_atual)
  else
    outras_despesas := 0;

  uFinanceiro.fnc_salvar_comissao(
                                  self.Conexao,
                                  opAlterar,
                                  date,
                                  date,
                                  date,
                                  pedido_atual,
                                  vendedor_id,
                                  3,
                                  total_venda,
                                  total_custo,
                                  outras_despesas,
                                  1,//0.50,
                                  50
                                  );

  {pra atualizar a tela tive que fazer tudo isso, depois melhorar}
  uBiblioteca.AtualizaQuery(qry_comissao_itens);
  uBiblioteca.AtualizaQuery(qry);
  qry.First;
  qry.Locate('pedido_id', pedido_atual,[]);
  prc_filtra_comissao_itens(pedido_atual);

  prc_totais;

  FreeAndNil( frmComissoesDespesasE );


end;

procedure TfrmComissoes.cb_vendedorClick(Sender: TObject);
begin
  inherited;
  DBGrid1.Columns[5].Visible := not cb_vendedor.Checked;
end;

function TfrmComissoes.fnc_somar_despesas(pedido_id: integer):double;
var
  qry : TFDQuery;

begin
  result := 0;
  qry := TFDQuery.Create(application);
  qry.Connection := self.Conexao;
  qry.SQL.Clear;
  qry.SQL.Add('select sum(VALOR) as VALOR from comissao_despesas where pedido_id =:pedido_id');
  qry.ParamByName('PEDIDO_ID').AsInteger := pedido_id;
  qry.Open;

  result := qry.FieldByName('VALOR').AsFloat;
  freeandnil( qry );

end;

procedure TfrmComissoes.btnImprimirClick(Sender: TObject);
begin
  inherited;
  frxReportComissoes.ShowReport();

end;

procedure TfrmComissoes.btn_excluir_despesaClick(Sender: TObject);
var
  outras_despesas: double;
  pedido_atual : integer;
  vendedor_id : integer;
  total_venda, total_custo : double;
begin
  inherited;

  pedido_atual := qry.FieldByName('PEDIDO_ID').AsInteger;
  vendedor_id  := qry.FieldByName('VENDEDOR_ID').AsInteger;
  total_venda  := qry.FieldByName('TOTAL_VENDA').AsFloat;
  total_custo  := qry.FieldByName('TOTAL_CUSTO').AsFloat;

  if frmComissoesDespesasE = nil then
    frmComissoesDespesasE := TfrmComissoesDespesasE.create(application);

  frmComissoesDespesasE.Codigo    := qry_outros_lancamentos.FieldByName('ID').AsInteger;
  frmComissoesDespesasE.pedido_id := pedido_atual;
  frmComissoesDespesasE.Operacao  := opExcluir;
  frmComissoesDespesasE.ShowModal;

  {atualiza outras despesas}
  uBiblioteca.FilterCds(qry_outros_lancamentos, utipos.fsInteger, inttostr(qry.FieldByName('PEDIDO_ID').AsInteger));

  {atualiza a tabela comissao, campo outras despesas e recalcula}
  if not qry_outros_lancamentos.IsEmpty then
    outras_despesas := fnc_somar_despesas(pedido_atual)
  else
    outras_despesas := 0;

  uFinanceiro.fnc_salvar_comissao(
                                  self.Conexao,
                                  opAlterar,
                                  date,
                                  date,
                                  date,
                                  pedido_atual,
                                  vendedor_id,
                                  3,
                                  total_venda,
                                  total_custo,
                                  outras_despesas,
                                  1,//0.50,
                                  50
                                  );

  {pra atualizar a tela tive que fazer tudo isso, depois melhorar}
  uBiblioteca.AtualizaQuery(qry);
  qry.First;
  qry.Locate('pedido_id', pedido_atual,[]);
  prc_filtra_comissao_itens(pedido_atual);

  prc_totais;


  FreeAndNil( frmComissoesDespesasE );

end;

procedure TfrmComissoes.prc_detalhes_consumidor(pedido_id : integer);
var
  qryEnd: TFDQuery;
begin
  inherited;

  qryEnd := TFDQuery.Create(Application);
  qryEnd.Connection := self.Conexao;
  qryEnd.SQL.Clear;
  qryEnd.SQL.Text := 'select * from PEDIDOS_LOCAL_ENTREGA where PEDIDO_ID =:PEDIDO_ID';
  //ShowMessage('Pedido ' + inttostr(pedido_id) );
  qryEnd.ParamByName('PEDIDO_ID').AsInteger := pedido_id;
  qryEnd.Open;

  if not qryEnd.IsEmpty then
  begin
    lbl_detalhe_consumidor.Caption :=
                        qryEnd.FieldByName('NOME').AsString + ' - Local de entrega : ' +
                        qryEnd.FieldByName('ENDERECO').AsString + ' N. ' +
                        qryEnd.FieldByName('NUMERO').AsString + ' - ' +
                        qryEnd.FieldByName('BAIRRO').AsString + ' , ' +
                        qryEnd.FieldByName('CIDADE').AsString;

  end
  else
  begin
    lbl_detalhe_consumidor.Caption :=
                                                qry.FieldByName('NM_CLIENTE').AsString + ' - Local de entrega : ' +
                                                qry.FieldByName('ENDERECO').AsString + ' N. ' +
                                                qry.FieldByName('NUMERO').AsString + ' - ' +
                                                qry.FieldByName('BAIRRO').AsString + ' , ' +
                                                qry.FieldByName('CIDADE').AsString;


  end;

  FreeAndNil( qryEnd );

end;



end.
