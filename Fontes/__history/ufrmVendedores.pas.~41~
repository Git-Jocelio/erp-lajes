unit ufrmVendedores;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseGrade, Data.DB,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,
  FireDAC.Stan.Async, FireDAC.DApt, System.Actions, Vcl.ActnList,
  System.ImageList, Vcl.ImgList, Vcl.Menus, FireDAC.Comp.DataSet,
  FireDAC.Comp.Client, Vcl.ComCtrls, Vcl.ToolWin, Vcl.Grids, Vcl.DBGrids,
  Vcl.StdCtrls, Vcl.Buttons, Vcl.ExtCtrls, Vcl.DBCtrls, unit_principal,
  unit_funcoes;

type
  TfrmVendedores = class(TfrmBaseGrade)
    cbCpfCnpj: TCheckBox;
    edCpfCnpj: TEdit;
    cbNome: TCheckBox;
    edNome: TEdit;
    rgSituacao: TRadioGroup;
    qryID: TIntegerField;
    qryNOME: TStringField;
    qryCPF_CNPJ: TStringField;
    qryCOMISSAO_VENDEDOR: TFMTBCDField;
    qryCOMISSAO_ADM: TFMTBCDField;
    qryATIVO: TStringField;
    procedure FormCreate(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);

    procedure actIncluirExecute(Sender: TObject);
    procedure actAlterarExecute(Sender: TObject);
    procedure actExcluirExecute(Sender: TObject);
    procedure actLocalizarExecute(Sender: TObject);

  private

    function ValidarPesquisa(): boolean;
    procedure Pesquisar();
    procedure ASql();
  public
    { Public declarations }
  end;

var
  loForm: TfrmVendedores;

procedure executa;

implementation

{$R *.dfm}

uses uBiblioteca, ufrmVendedoresE;


procedure executa;

begin

  if loForm = nil then
  begin
    loForm := TfrmVendedores.Create(Application);
    form_principal.prc_controla_menu(false);

    // se abrir dentro no painel principal não funciona os edites :(
    //loform.Parent := form_principal.pnl_principal;

    loform.top    :=  form_principal.pnl_Principal.Top;
    loform.Left   := form_principal.pnl_menulateral.Width;

    loForm.Width  := form_principal.pnl_principal.Width;
    loForm.Height := form_principal.pnl_principal.Height;
  end;
  loForm.Show;

end;


{ TfrmVendedores }

procedure TfrmVendedores.actAlterarExecute(Sender: TObject);
var
  id : integer;
begin
  inherited;

  id := qry.fieldbyname('ID').AsInteger;
  ufrmVendedoresE.Alterar(id);
  uBiblioteca.AtualizaQuery(qry);

  // volta pro registro editado
  qry.Locate('ID',id,[]);

end;

procedure TfrmVendedores.actExcluirExecute(Sender: TObject);
begin
  inherited;
  if not qry.IsEmpty then
  begin
    ufrmVendedoresE.Excluir(qry.fieldbyname('ID').AsInteger);
    uBiblioteca.AtualizaQuery(qry);
  end;

end;

procedure TfrmVendedores.actIncluirExecute(Sender: TObject);
begin
  inherited;
  ufrmVendedoresE.Incluir;
  uBiblioteca.AtualizaQuery(qry);

end;

procedure TfrmVendedores.actLocalizarExecute(Sender: TObject);
begin
  inherited;
  if ValidarPesquisa() then
    Pesquisar();

  // mensagem para o usuario
  StatusBar.Panels[0].Text := 'Encontrado(s) : ' + inttostr(qry.RecordCount) + ' registro(s)';

end;

procedure TfrmVendedores.ASql;
begin
  //ShowMessage('ASQL');

  sSql := 'select ' +
           '  P.ID AS CODIGO, P.CPF_CNPJ, P.NOME, V.COMISSAO_VENDEDOR, V.COMISSAO_ADM, P.ATIVO ' +
           'from ' +
              Self.Tabela + ' V, PESSOAS P ' +
           'where ' +
              'P.ID = V.PESSOA_ID ' ;

  qry.sql.add(sSql);

end;

procedure TfrmVendedores.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  inherited;

  form_principal.prc_controla_menu(true);
  FreeAndNil(loForm);

end;

procedure TfrmVendedores.FormCreate(Sender: TObject);
begin
  // property tabela no form BaseGrade
  self.Tabela := 'VENDEDORES';
  //self.Titulo := 'Cadastro de Vendedores' + '[' + self.Tabela + ']';
  Caption := Titulo;
  ASql();
  inherited;

end;

procedure TfrmVendedores.Pesquisar;
var
  Situacao, Condicao: string;
begin

  {Situação da pessoa}
  if rgSituacao.ItemIndex = 0 then
    situacao := 'P.ATIVO =' + QuotedStr('S') + ' and ';
  if rgSituacao.ItemIndex = 1 then
    situacao := 'P.ATIVO =' + QuotedStr('N') + ' and ';
  if rgSituacao.ItemIndex = 2 then
    situacao := 'P.ATIVO <>' + QuotedStr('') + ' and ';

  Condicao := '';

  if cbCpfCnpj.Checked then
    if trim(edCpfCnpj.Text) <> '' then
        Condicao := Condicao + 'and CPF_CNPJ like :CPF_CNPJ ';

  if cbNome.Checked then
    if trim(edNome.Text) <> '' then
    Condicao := Condicao + 'and NOME like :NOME ';


  if Condicao <> '' then
  begin
    Condicao := copy(Condicao,4,length(Condicao)-4);

    qry.SQL.Clear;
    qry.SQL.Add('select P.*, V.* from ' + Self.Tabela + ' V, PESSOAS P where P.ID = V.PESSOA_ID and '+ Situacao + Condicao );
    self.ssql := qry.SQL.Text;

    {Carregar parametros}
    if cbCpfCnpj.Checked then
      if trim(edCpfCnpj.Text) <> '' then
      begin
        qry.Params.ParamByName('CPF_CNPJ').AsString := '%' + EdCpfCnpj.Text + '%';
      end;

     if cbNome.Checked then
      begin
        qry.Params.ParamByName('NOME').AsString := '%' + EdNome.Text + '%';
      end;

    //ShowMessage(qry.SQL.Text);
    qry.Open;
  end
  else
  begin
    qry.SQL.Clear;
    if rgSituacao.ItemIndex = 2 then // todos
    begin
        qry.SQL.Clear;
        qry.SQL.Add('select P.*, V.* from ' + Self.Tabela + ' V, PESSOAS P where P.ID = V.PESSOA_ID');
        self.sSql := qry.SQL.Text;
    end
    else
    begin // verifica a situação selecionada
      Situacao := copy(Situacao,1,length(Situacao)-4);

      qry.SQL.Add('select P.*, V.* from ' + Self.Tabela + ' V, PESSOAS P where P.ID = V.PESSOA_ID and ' + Situacao);
      self.sSql := qry.SQL.Text;
  end;
    //ShowMessage(qry.SQL.Text);
    qry.Open;
  end;

    //ajustas as colunas do dbgrid
    prc_ajustar_colunas_grid( DBGrid1 );

    //aumenta o tamanho da linha do ddgrid
    prc_ajusta_tamanho_linha( DBGrid1 );


end;

function TfrmVendedores.ValidarPesquisa: boolean;
begin
   result := true;
end;

end.
