unit Classe.Conexao;

interface

uses
   FireDAC.Comp.Client, FireDAC.Stan.Intf, System.SysUtils,
   System.IniFiles, Vcl.Forms;
type
  Tconexao = class
  private
    Fservidor: string;
    FmsgErro : string;
    Fsenha   : string;
    Fbase    : string;
    Flogin   : string;
    Fporta   : string;
    Fconexao : TFDConnection;


  public

    constructor Create ( nomeConexao : TFDConnection );
    destructor Destroy; override;

    function fnc_conectar_banco_dados: boolean;

    procedure prc_gravar_arquivo_ini;
    function fnc_ler_arquivo_ini: boolean;

    property conexao  : TFDConnection read Fconexao write Fconexao;
    property servidor : string read Fservidor write Fservidor;
    property base     : string read Fbase write Fbase;
    property login    : string read Flogin write Flogin;
    property senha    : string read Fsenha write Fsenha;
    property porta    : string read Fporta write Fporta;
    property msgErro  : string read FmsgErro write FmsgErro;

end;


implementation

uses
 ubiblioteca;


{ Tconexao }

constructor Tconexao.Create(nomeConexao: TFDConnection);
begin
  Fconexao := nomeConexao;
end;

destructor Tconexao.Destroy;
begin
  Fconexao.Connected := false;
  inherited;
end;

function Tconexao.fnc_conectar_banco_dados: boolean;
begin
   Result := true;

   Fconexao.Params.Clear;

   if fnc_ler_arquivo_ini then
   begin
     Result := false;
     FmsgErro := 'O arquivo de configuração não foi encontrado !';
   end
   else
   begin
     Fconexao.Params.Add('server='    + Fservidor);
     Fconexao.Params.Add('user_Name=' + Flogin);
     Fconexao.Params.Add('password='  + Fsenha);
     Fconexao.Params.Add('port='      + Fporta);
     Fconexao.Params.Add('DataBase='  + Fbase);
     Fconexao.Params.Add('DriverID='  + 'FB');

     try
       Fconexao.Connected := True;
     except
       on E: Exception do
       begin
         FmsgErro := e.Message;
         Result := false;
       end;
     end;
   end;
end;

procedure Tconexao.prc_gravar_arquivo_ini;
var
  IniFile : string;
  Ini : TInifile;
begin
  {cria um arquivo com o mesmo no da aplicação e troca a extensao}
  IniFile := ChangeFileExt(application.ExeName,'.ini');
  Ini := TIniFile.Create( IniFile );


  try
    Ini.WriteString('configuracao', 'Servidor',Fservidor);
    Ini.WriteString('configuracao', 'Base'    ,Fbase   );
    Ini.WriteString('configuracao', 'Porta'   ,Fporta   );
    Ini.WriteString('acesso'      , 'Login'   ,Flogin   );
    Ini.WriteString('acesso'      , 'Senha'   ,Fsenha   );
   // FSenha := ubiblioteca.fnc_criptografia( Fsenha,'123' );


  finally
   FreeAndNil( Ini );
  end;

end;

function Tconexao.fnc_ler_arquivo_ini: boolean;
var
  IniFile : string;
  Ini : TInifile;
begin
  {cria um arquivo com o mesmo no da aplicação e troca a extensao}
  IniFile := ChangeFileExt(application.ExeName,'.ini');
  Ini := TIniFile.Create( IniFile );

  if not FileExists(IniFile) then
    result := false
  else
  begin


    try
      Fservidor := Ini.ReadString('configuracao', 'Servidor','' );
      Fsenha    := Ini.ReadString('configuracao', 'Base'    ,'' );
      Fporta    := Ini.ReadString('configuracao', 'Porta'   ,'' );
      Flogin    := Ini.ReadString('acesso'      , 'Login'   ,'' );
      Fsenha    := Ini.ReadString('acesso'      , 'Senha'   ,'');


    finally
    result := false;
     FreeAndNil( Ini );
    end;

    end;
end;


end.
