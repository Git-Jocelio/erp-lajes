{
formulario para alteração de valores de quantidade e valor unitario para vendedor
desenvolvedor: JOcelio G Silva
inicio: 07/04/2022
fim :
}

unit ufrmComissoesItensE;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseEdicao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.ExtCtrls, uTipos, uBiblioteca, uFinanceiro;

type
  TfrmComissoesItensE = class(TfrmBaseEdicao)
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    Label4: TLabel;
    edt_quantidade: TEdit;
    edt_preco_vendedor: TEdit;
    edt_preco_venda: TEdit;
    lbl_descricao: TLabel;
    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure btnOkClick(Sender: TObject);
  private
    FOperacao: uTipos.TOperacao;
    FTabela: string;
    Fp_ID: integer;
    Fp_quantidade: double;
    Fp_preco_venda: double;
    Fp_descricao: string;
    Fp_preco_vendedor: double;
    Fp_pedido_id: integer;
    Fp_vendedor_id: integer;

    procedure prc_salvar;

  protected
    function fnc_validar: boolean;
    function fnc_alterar : Boolean;

    // conf as propridades dos componestes
    procedure prc_componentes;
    procedure prc_inicializar;
    procedure prc_ler_dados;

  public
    {ID da tabela comissao_item}
    property p_ID: integer read Fp_ID write Fp_ID;
    property p_pedido_id: integer read Fp_pedido_id write Fp_pedido_id;
    property p_vendedor_id: integer read Fp_vendedor_id write Fp_vendedor_id;
    property p_descricao: string read Fp_descricao write Fp_descricao;
    property p_quantidade: double read Fp_quantidade write Fp_quantidade;
    property p_preco_vendedor: double read Fp_preco_vendedor write Fp_preco_vendedor;
    property p_preco_venda: double read Fp_preco_venda write Fp_preco_venda;

    property Operacao : uTipos.TOperacao read FOperacao write FOperacao;
    property Tabela   : string read FTabela write FTabela;
  end;

procedure prc_alterar(ACodigo, APedidoId, AVendedorId: integer; ADescricao: string; AQuantidade,
                      APrecoVendedor, APrecoVenda: double);

implementation

procedure prc_alterar(ACodigo, APedidoId, AVendedorId: integer; ADescricao: string; AQuantidade,
                      APrecoVendedor, APrecoVenda: double);
var
  loForm : TfrmComissoesItensE;
begin

  loForm := TfrmComissoesItensE.Create(Application);
  try
    loForm.Operacao:= uTipos.opAlterar;
    loForm.p_ID            := ACodigo;
    loForm.p_pedido_id     := APedidoId;
    loForm.p_vendedor_id   := AVendedorId;
    loForm.p_descricao     := ADescricao;
    loForm.p_quantidade    := AQuantidade;
    loForm.p_preco_vendedor:= APrecoVendedor;
    loForm.p_preco_venda   := APrecoVenda;

    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;

end;


{$R *.dfm}

procedure TfrmComissoesItensE.btnOkClick(Sender: TObject);
begin
  inherited;
  prc_salvar;
end;


function TfrmComissoesItensE.fnc_alterar: Boolean;
var
  loQuery : TFDQuery;
  totalCusto, totalVenda: double;
  outrosDebitos, outrosCreditos: double;
begin
  result := true;
  totalCusto := 0;
  totalVenda := 0;
  outrosDebitos := 0;
  outrosCreditos:= 0;

  try
    loQuery := TFDQuery.Create(Self);

    try
      {altera um item da comissão}
      with loQuery, loQuery.Sql do
      begin
        Connection := Self.Conexao;
        Add('update                       ');
        Add(   Tabela                      );
        Add('set                          ');
        Add('  QUANTIDADE = :QUANTIDADE,  ');
        Add('  CUSTO_VEND = :CUSTO_VEND,  ');
        Add('  PRECO_VENDA = :PRECO_VENDA ');
        Add('where                        ');
        Add('  ID = :ID                   ');
        ParamByName('ID').AsInteger        := p_ID;
        ParamByName('QUANTIDADE').AsFloat  := p_quantidade;
        ParamByName('CUSTO_VEND').AsFloat  := p_preco_vendedor;
        ParamByName('PRECO_VENDA').AsFloat := p_preco_venda;

        ExecSQL;
        //***

        {recalcula a comissão}

        {calcula o total do custo e total da venda}
        SQL.Clear;
        Add('Select                                     ');
        Add(' SUM( (quantidade * custo_forn) ) as CUSTO,');
        Add(' SUM( (quantidade * PRECO_VENDA)) as VENDA ');
        Add('                                           ');
        Add('from                                       ');
        Add(' comissao_item                             ');
        Add('where pedido_id = :PEDIDO_ID               ');
        ParamByName('PEDIDO_ID').AsInteger := p_pedido_id;
        loQuery.Open;

        totalCusto := loQuery.FieldByName('CUSTO').AsFloat;
        totalVenda := loQuery.FieldByName('VENDA').AsFloat;

ShowMessage(
           'Alterar cabeça da comissão ' + sLineBreak +
           'pedido ' + inttostr(p_pedido_id) + sLineBreak +
           'custo total ' + floattostr(totalCusto) + sLineBreak +
           'venda total ' + floattostr(totalVenda)
           );

        {calcula o total de outros lancamentos na comissão}
        {debitos}
        SQL.Clear;
        Add('select                     ');
        Add(' SUM( VALOR ) as DEBITO    ');
        Add('from                       ');
        Add(' comissao_despesas         ');
        Add('where                      ');
        Add('  DEBITO_CREDITO = ' + QuotedStr('D') + ' and ');
        Add('  pedido_id = :PEDIDO_ID          ');
        ParamByName('PEDIDO_ID').AsInteger := p_pedido_id;
        loQuery.Open;

        outrosDebitos := loQuery.FieldByName('DEBITO').AsFloat;;

        {calcula o total de outros lancamentos na comissão}
        {debitos}
        SQL.Clear;
        Add('select                     ');
        Add(' SUM( VALOR ) as CREDITO   ');
        Add('from                       ');
        Add(' comissao_despesas         ');
        Add('where                      ');
        Add('  DEBITO_CREDITO = ' + QuotedStr('C') + ' and ');
        Add('  pedido_id = :PEDIDO_ID          ');
        ParamByName('PEDIDO_ID').AsInteger := p_pedido_id;
        loQuery.Open;

        outrosCreditos := loQuery.FieldByName('CREDITO').AsFloat;;

ShowMessage(
           'Alterar cabeça da comissão ' + sLineBreak +
           'outras despesas ' + floattostr(outrosDebitos - outrosCreditos)
           );


        {Atualiza a comissão (cabeça)}
        ufinanceiro.fnc_salvar_comissao(conexao,
                                        opAlterar,
                                        date,
                                        date,
                                        date,
                                        p_pedido_id,
                                        p_vendedor_id,
                                        3,
                                        totalVenda,
                                        totalCusto,
                                        (outrosDebitos - outrosCreditos),
                                        0.5,
                                        50  );


      end;
    finally
      FreeAndNil(loQuery);
    end;


  except

    on E : Exception do
    begin
       Result := false;
       Raise Exception.Create(E.Message + ' : ufrmComissoesItensE.prc_salvar.fnc_alterar');
    end;

  end; //try/exception

end;

function TfrmComissoesItensE.fnc_validar: boolean;
begin
  result := false;

  if StrToFloatDef(edt_quantidade.Text,0) = 0 then
  begin
    ShowMessage('Informe um QUANTIDADE válida');
    edt_quantidade.SetFocus;
    exit;
  end;

  if StrToFloatDef(edt_preco_vendedor.Text,0) = 0 then
  begin
    ShowMessage('Informe um PREÇO DO VENDEDOR válido');
    edt_preco_vendedor.SetFocus;
    exit;
  end;

  if StrToFloatDef(edt_preco_venda.Text,0) = 0 then
  begin
    ShowMessage('Informe um PREÇO DE VENDA válido');
    edt_preco_venda.SetFocus;
    exit;
  end;

  {validou, atualizar as propriedades}
  p_quantidade     := StrToFloat( edt_quantidade.Text );
  p_preco_vendedor := StrToFloat( edt_preco_vendedor.Text );
  p_preco_venda    := StrToFloat( edt_preco_venda.Text );


  result := true;
end;

procedure TfrmComissoesItensE.FormCreate(Sender: TObject);
begin
  inherited;
  titulo := 'Manutenção de dados dos itens da comissão';
  self.Tabela := 'COMISSAO_ITEM';

end;

procedure TfrmComissoesItensE.FormShow(Sender: TObject);
begin
  inherited;
  prc_componentes;
  prc_inicializar;
end;

procedure TfrmComissoesItensE.prc_componentes;
begin
  lbl_sub_titulo.Caption := 'Aqui você pode alterar valores da Quantidade, preço do vendedor e preço de venda.' ;

end;

procedure TfrmComissoesItensE.prc_inicializar;
begin
  case self.Operacao of

  uTipos.opAlterar: begin
                      self.prc_ler_dados;
                      lbl_titulo.Caption  := titulo + ' [Alteração]';
                      btnOk.Caption := 'Alterar';
                    end;
  else
    begin
      pnDados.Enabled := false;
      if btnFechar.CanFocus then btnFechar.SetFocus;
    end;
  end;

end;

procedure TfrmComissoesItensE.prc_ler_dados;
begin
   lbl_descricao.Caption  := p_descricao;
   edt_quantidade.Text    := FormatFloat('0.00', p_quantidade);
   edt_preco_vendedor.Text:= FormatFloat('0.00', p_preco_vendedor);
   edt_preco_venda.Text   := FormatFloat('0.00', p_preco_venda);

end;

procedure TfrmComissoesItensE.prc_salvar;
begin
  case Self.Operacao of
    // Alteração
    uTipos.opAlterar :
    begin
      if fnc_validar then
      begin
        if not Self.Conexao.InTransaction then Self.Conexao.StartTransaction;
        //***
        if fnc_alterar then
        begin
          if Self.Conexao.InTransaction then Self.Conexao.Commit;
          ModalResult := mrOk;
        end
        else
        begin
          ShowMessage('Não foi possível alterar a comissão');
          Conexao.Rollback;
        end;
      end
      else
        ShowMessage('Dados invalidos');
    end;
  end;
end;

end.
