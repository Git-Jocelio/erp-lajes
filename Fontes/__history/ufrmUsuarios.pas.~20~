//***************************************************************************//
// Cadastro de usuário
// desenvolvida por Jocelio G Silva
// inicio : 23/02/2022
// fim :
//***************************************************************************//

unit ufrmUsuarios;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseGrade, Data.DB,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,
  FireDAC.Stan.Async, FireDAC.DApt, System.Actions, Vcl.ActnList,
  System.ImageList, Vcl.ImgList, Vcl.Menus, FireDAC.Comp.DataSet,
  FireDAC.Comp.Client, Vcl.ComCtrls, Vcl.ToolWin, Vcl.Grids, Vcl.DBGrids,
  Vcl.StdCtrls, Vcl.Buttons, Vcl.ExtCtrls, Vcl.DBCtrls, uBiblioteca,
  ufrmUsuariosE, unit_principal;

type
  TfrmUsuarios = class(TfrmBaseGrade)
    cb_cpf_cnpj: TCheckBox;
    edt_cpf_cnpj: TEdit;
    cb_nome: TCheckBox;
    edt_nome: TEdit;
    cb_telefone: TCheckBox;
    edt_telefone: TEdit;
    cb_celular: TCheckBox;
    edt_celular: TEdit;
    rg_situacao: TRadioGroup;
    procedure FormCreate(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);

    procedure actLocalizarExecute(Sender: TObject);
    procedure actIncluirExecute(Sender: TObject);
    procedure actAlterarExecute(Sender: TObject);
    procedure actExcluirExecute(Sender: TObject);

  private
    procedure prc_sql;
    function  fnc_validar_pesquisa: boolean;
    procedure prc_pesquisar;

  public
    { Public declarations }
  end;

procedure prc_executa;
var
  loForm :  TfrmUsuarios;

implementation

procedure prc_executa;

begin
  if loForm = nil then
  begin

    loForm := TfrmUsuarios.Create(Application);
    form_principal.prc_controla_menu(false);

    // se abrir dentro no painel principal não funciona os edites :(
    //loform.Parent := form_principal.pnl_principal;

    loform.top    :=  form_principal.pnl_Principal.Top;
    loform.Left   := form_principal.pnl_menulateral.Width;

    loForm.Width  := form_principal.pnl_principal.Width;
    loForm.Height := form_principal.pnl_principal.Height;
  end;
  loForm.Show;

end;

{$R *.dfm}

procedure TfrmUsuarios.prc_pesquisar;
var
  situacao, Condicao : string;
begin
  {Situação da pessoa}


  if rg_situacao.ItemIndex = 0 then
    situacao := 'X.ATIVO =' + QuotedStr('S') + ' and ';
  if rg_situacao.ItemIndex = 1 then
    situacao := 'X.ATIVO =' + QuotedStr('N') + ' and ';
  if rg_situacao.ItemIndex = 2 then
    situacao := 'X.ATIVO <>' + QuotedStr('') + ' and ';

  Condicao := '';

  if cb_cpf_cnpj.Checked then
    if StrToIntDef(edt_cpf_cnpj.Text,0) > 0 then
        Condicao := Condicao + 'and P.CPF_CNPJ like :CPF_CNPJ ';

  if cb_nome.Checked then
    if trim(edt_nome.Text) <> '' then
    Condicao := Condicao + 'and P.NOME like :NOME ';

  if cb_telefone.Checked then
    if trim(edt_telefone.Text) <> '' then
    Condicao := Condicao + 'and P.TELEFONE like :TELEFONE ';

  if cb_celular.Checked then
    if trim(edt_celular.Text) <> '' then
    Condicao := Condicao + 'and P.CELULAR like :CELULAR ';

  if Condicao <> '' then
  begin
    Condicao := copy(Condicao,4,length(Condicao)-4);

    qry.SQL.Clear;
    qry.SQL.Add('select P.CPF_CNPJ, P.NOME, P.TELEFONE, P.CELULAR, X.ATIVO, X.ID, X.PESSOA_ID, X.LOGIN, X.SENHA from PESSOAS P, ' + self.Tabela + ' X where P.ID = X.PESSOA_ID and ' + situacao + Condicao);
    self.ssql := qry.SQL.Text;

    {Carregar parametros}
    if cb_cpf_cnpj.Checked then
      if StrToIntDef(edt_cpf_cnpj.Text,0) > 0 then
      begin
        qry.ParamByName('CPF_CNPJ').AsString := '%' + edt_cpf_cnpj.Text + '%';
      end;

     if cb_nome.Checked then
      begin
        qry.ParamByName('NOME').AsString := '%' + edt_nome.Text + '%';
      end;

     if cb_telefone.Checked then
      begin
        qry.ParamByName('TELEFONE').AsString := '%' + edt_telefone.Text + '%';
      end;

     if cb_celular.Checked then
      begin
        qry.ParamByName('CELULAR').AsString := '%' + edt_celular.Text + '%';
      end;
    //ShowMessage(qry.SQL.Text);
    qry.Open;
  end
  else
  begin
    qry.SQL.Clear;
    if rg_situacao.ItemIndex = 2 then // todos
    begin
      qry.SQL.Add('select P.CPF_CNPJ, P.NOME, P.TELEFONE, P.CELULAR, X.ATIVO, X.ID, X.PESSOA_ID, X.LOGIN, X.SENHA from PESSOAS P, ' + self.Tabela + ' X where P.ID = X.PESSOA_ID');
      self.sSql := qry.SQL.Text;
    end
    else
    begin
      qry.SQL.Add('select P.CPF_CNPJ, P.NOME, P.TELEFONE, P.CELULAR, X.ATIVO, X.ID, X.PESSOA_ID, X.LOGIN, X.SENHA from PESSOAS P, ' + self.Tabela + ' X where ' + situacao + ' P.ID = X.PESSOA_ID');
      self.sSql := qry.SQL.Text;
    end;
   //ShowMessage(qry.SQL.Text);
    qry.Open;
  end;

end;


procedure TfrmUsuarios.prc_sql;
begin

  qry.Open('select P.CPF_CNPJ, P.NOME, P.TELEFONE, P.CELULAR, X.ATIVO, X.ID, X.PESSOA_ID, X.LOGIN, X.SENHA from ' + Self.Tabela + ' X, PESSOAS P where P.ID = X.PESSOA_ID and P.ID = -1');

end;

procedure TfrmUsuarios.actAlterarExecute(Sender: TObject);
begin
  inherited;
  //ShowMessage(qry.SQL.Text);
  ufrmUsuariosE.prc_alterar(qry.fieldbyname('ID').AsInteger);
  uBiblioteca.AtualizaQuery(qry);

end;

procedure TfrmUsuarios.actExcluirExecute(Sender: TObject);
begin
  inherited;
  ufrmUsuariosE.prc_excluir(qry.fieldbyname('ID').AsInteger);
  uBiblioteca.AtualizaQuery(qry);

end;

procedure TfrmUsuarios.actIncluirExecute(Sender: TObject);
begin
  inherited;
  ufrmUsuariosE.prc_incluir;
  uBiblioteca.AtualizaQuery(qry);

end;

procedure TfrmUsuarios.actLocalizarExecute(Sender: TObject);
begin
  inherited;
  if fnc_validar_pesquisa then
    prc_pesquisar;

  // mensagem para o usuario
  StatusBar.Panels[0].Text := 'Encontrado(s) : ' + inttostr(qry.RecordCount) + ' registro(s)';

end;

function TfrmUsuarios.fnc_validar_pesquisa: boolean;
begin

   result := false;

   if ( (cb_cpf_cnpj.Checked) and (edt_cpf_cnpj.Text = '') ) then
   begin
     ShowMessage('Infome um CPF ou CNPJ');
     edt_cpf_cnpj.SetFocus;
     exit;
   end;

   if ( (cb_nome.Checked) and (edt_nome.Text = '') ) then
   begin
     ShowMessage('Infome um Nome');
     edt_nome.SetFocus;
     exit;
   end;

   if ( (cb_telefone.Checked) and (edt_telefone.Text = '') ) then
   begin
     ShowMessage('Infome um Telefone');
     edt_telefone.SetFocus;
     exit;
   end;

   if ( (cb_celular.Checked) and (edt_celular.Text = '') ) then
   begin
     ShowMessage('Infome um Celular');
     edt_celular.SetFocus;
     exit;
   end;

   result := true;

end;

procedure TfrmUsuarios.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  inherited;

  form_principal.prc_controla_menu(true);
  FreeAndNil(loForm);

end;

procedure TfrmUsuarios.FormCreate(Sender: TObject);
begin
  inherited;
  // property tabela no form BaseGrade
  self.Tabela := 'USUARIOS';
  //self.Titulo := 'Cadastro de Usuários' + '[' + self.Tabela + ']';
  //Caption := Titulo;
  prc_sql;

  btnLocalizar.Click;
end;

end.
