unit ufrmProducoesVigas;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseGrade, Data.DB,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,
  FireDAC.Stan.Async, FireDAC.DApt, System.Actions, Vcl.ActnList,
  System.ImageList, Vcl.ImgList, FireDAC.Comp.DataSet, FireDAC.Comp.Client,
  Vcl.Buttons, Vcl.Grids, Vcl.DBGrids, Vcl.ExtCtrls, Vcl.ComCtrls, Vcl.ToolWin,
  Vcl.StdCtrls;

type
  TfrmProducoesVigas = class(TfrmBaseGrade)
    qryCADASTRADO_EM: TDateField;
    qryALTERADO_EM: TDateField;
    qryTIPO_FORMA: TIntegerField;
    qryQTDE_PRODUZIDA: TFMTBCDField;
    qryQTDE_CIMENTO: TFMTBCDField;
    dtp_data_ini: TDateTimePicker;
    dtp_data_fim: TDateTimePicker;
    Label1: TLabel;
    qryPRODUCAO_ID: TIntegerField;
    qryMEDIA: TBCDField;
    qryQTDE_VIGAS: TIntegerField;
    Label2: TLabel;

    procedure FormCreate(Sender: TObject);
    procedure FormActivate(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);

    procedure actIncluirExecute(Sender: TObject);
    procedure actAlterarExecute(Sender: TObject);
    procedure actExcluirExecute(Sender: TObject);
    procedure btnLocalizarClick(Sender: TObject);
    procedure actLocalizarExecute(Sender: TObject);
  private
    procedure prc_sql;
    { Private declarations }
  public
    { Public declarations }
  end;

var
  frmProducoesVigas: TfrmProducoesVigas;

implementation

{$R *.dfm}

uses unit_principal, ufrmProducoesVigasE, uBiblioteca, udmConn;

procedure TfrmProducoesVigas.actAlterarExecute(Sender: TObject);
var
  id : integer;
begin
  if DBGrid1.DataSource.DataSet.IsEmpty then exit;

  id := qry.fieldbyname('PRODUCAO_ID').AsInteger;
  ufrmProducoesVigasE.prc_alterar(id);

  uBiblioteca.AtualizaQuery(qry);
  qry.Locate('PRODUCAO_ID', id, []);

  inherited;
end;

procedure TfrmProducoesVigas.actExcluirExecute(Sender: TObject);
begin
  ufrmProducoesVigasE.prc_excluir(qry.fieldbyname('PRODUCAO_ID').AsInteger);
  uBiblioteca.AtualizaQuery(qry);
  inherited;
end;

procedure TfrmProducoesVigas.actIncluirExecute(Sender: TObject);
begin
  ufrmProducoesVigasE.prc_incluir;
  uBiblioteca.AtualizaQuery(qry);

  inherited;
end;

procedure TfrmProducoesVigas.actLocalizarExecute(Sender: TObject);
var
  condicao : string;
begin
  inherited;
  condicao := ssql + ' where CADASTRADO_EM >= :DATA_INI and CADASTRADO_EM <= :DATA_FIM';
  QRY.SQl.Clear;
  qry.SQL.Add(condicao);
  qry.ParamByName('DATA_INI').AsDate := dtp_data_ini.Date;
  qry.ParamByName('DATA_FIM').AsDate := dtp_data_fim.Date;
  qry.Open;

  // volta pro sql original
  QRY.SQl.Clear;
  qry.SQL.Add(ssql);


end;

procedure TfrmProducoesVigas.btnLocalizarClick(Sender: TObject);
var
  condicao : string;
begin
  inherited;
  condicao := ssql + ' where CADASTRADO_EM >= :DATA_INI and CADASTRADO_EM <= :DATA_FIM';
  QRY.SQl.Clear;
  qry.SQL.Add(condicao);
  qry.ParamByName('DATA_INI').AsDate := dtp_data_ini.Date;
  qry.ParamByName('DATA_FIM').AsDate := dtp_data_fim.Date;
  qry.Open;

  // volta pro sql original
  QRY.SQl.Clear;
  qry.SQL.Add(ssql);


end;

procedure TfrmProducoesVigas.FormActivate(Sender: TObject);
begin
  inherited;
  form_principal.prc_controla_menu(false);
  // posição do form
  frmProducoesVigas.Top  := form_principal.pnl_topo.Height;
  frmProducoesVigas.Left := form_principal.pnl_menulateral.Width;
  // dimensoes
  frmProducoesVigas.Width  := form_principal.pnl_Principal.Width;
  frmProducoesVigas.Height := form_principal.pnl_Principal.Height;

end;

procedure TfrmProducoesVigas.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
  inherited;
  form_principal.prc_controla_menu(true);
end;

procedure TfrmProducoesVigas.FormCreate(Sender: TObject);
begin
  dtp_data_ini.Date := date;
  dtp_data_fim.Date := date;

  self.Tabela := 'PRODUCAO_VIGAS';
  prc_sql;

  inherited;

end;

procedure TfrmProducoesVigas.prc_sql;
begin

  sSql :=
          'select                ' +
          '    P.PRODUCAO_ID,    ' +
          '    P.CADASTRADO_EM,  ' +
          '    P.ALTERADO_EM,    ' +
          '    P.TIPO_FORMA,     ' +
          '    P.QTDE_VIGAS,     ' +
          '    P.QTDE_PRODUZIDA, ' +
          '    P.QTDE_CIMENTO,    ' +
          '    P.QTDE_PRODUZIDA / P.QTDE_CIMENTO AS MEDIA ' +
          'from                  ' +
          '  PRODUCAO_VIGAS P    ' ;

  qry.sql.Clear;
  qry.sql.Add(sSql);
  QRY.Open;

end;


end.
