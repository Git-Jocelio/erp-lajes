unit ufrmContasReceber_Rel_BaixaManual;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseConexao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, Vcl.Grids, Vcl.DBGrids, Vcl.StdCtrls, Vcl.Buttons, Vcl.ComCtrls,
  Vcl.DBCtrls, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.ExtCtrls,
  frxClass, frxDBSet;

type
  TfrmContasReceber_Rel_Baixa = class(TfrmBaseConexao)
    gbx_filtrar: TGroupBox;
    gbPessoa: TGroupBox;
    cbPessoa: TCheckBox;
    gbEmissao: TGroupBox;
    Label7: TLabel;
    cbEmissao: TCheckBox;
    dtpEmissaoIni: TDateTimePicker;
    dtpEmissaoFim: TDateTimePicker;
    gbx_recibo_pagto: TGroupBox;
    gbx_baixas: TGroupBox;
    GroupBox4: TGroupBox;
    cbUsuario: TCheckBox;
    ds: TDataSource;
    dsPessoas: TDataSource;
    qryPessoas: TFDQuery;
    cbx_pessoas: TDBLookupComboBox;
    cbx_usuarios: TDBLookupComboBox;
    dsUsuarios: TDataSource;
    qryUsuarios: TFDQuery;
    btn_filtrar: TBitBtn;
    dbg_detalhes: TDBGrid;
    qryDetalhes: TFDQuery;
    dsDetalhes: TDataSource;
    pnl_rodape: TPanel;
    btn_imprimir: TBitBtn;
    btn_fechar: TBitBtn;
    pnl_titulo: TPanel;
    Label1: TLabel;
    Label2: TLabel;
    img_topo: TImage;
    gbx_descricao_pagto: TGroupBox;
    Label3: TLabel;
    dbm_historico_pagto: TDBMemo;
    dbn_principal: TDBNavigator;
    GroupBox1: TGroupBox;
    dbg_baixas: TDBGrid;
    frxDBRecibo: TfrxDBDataset;
    frxDBEmpresa: TfrxDBDataset;
    qryEmpresa: TFDQuery;
    frxDBDetalhe: TfrxDBDataset;
    frxReportRecibo: TfrxReport;
    frxDBPessoas: TfrxDBDataset;
    procedure FormShow(Sender: TObject);
    procedure btn_filtrarClick(Sender: TObject);
    procedure cbPessoaClick(Sender: TObject);
    procedure cbUsuarioClick(Sender: TObject);
    procedure btn_fecharClick(Sender: TObject);
    procedure dbg_baixasDrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure dbg_detalhesDrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure btn_imprimirClick(Sender: TObject);
  private
    FsqlPadrao: string;
    procedure prc_componentes;
    procedure prc_pesquisar;
    function fnc_validar_pesquisa: boolean;
  public
    property sqlPadrao : string read FsqlPadrao write FsqlPadrao;
  end;

procedure prc_executa;

implementation

{$R *.dfm}

uses uBiblioteca;

procedure prc_executa;
var
  loForm: TfrmContasReceber_Rel_Baixa;
begin
  try
    loForm := TfrmContasReceber_Rel_Baixa.Create(Application);
    loForm.ShowModal;
  finally
    freeandnil(loForm);
  end;
end;


procedure TfrmContasReceber_Rel_Baixa.btn_fecharClick(Sender: TObject);
begin
  inherited;
  close;
end;

procedure TfrmContasReceber_Rel_Baixa.btn_filtrarClick(Sender: TObject);
begin
  inherited;
  dbg_baixas.Columns[1].Visible := not cbPessoa.Checked;

  if fnc_validar_pesquisa then prc_pesquisar;
end;

procedure TfrmContasReceber_Rel_Baixa.btn_imprimirClick(Sender: TObject);
begin
  inherited;
  frxReportRecibo.ShowReport();

end;

procedure TfrmContasReceber_Rel_Baixa.cbPessoaClick(Sender: TObject);
begin
  inherited;
  dbg_baixas.Columns[1].Visible := NOT cbPessoa.Checked;

end;

procedure TfrmContasReceber_Rel_Baixa.cbUsuarioClick(Sender: TObject);
begin
  inherited;
//  dbg_baixas.Columns[7].Visible := NOT cbUsuario.Checked;

end;

procedure TfrmContasReceber_Rel_Baixa.dbg_baixasDrawColumnCell(Sender: TObject;
  const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  inherited;
  uBiblioteca.  prc_zebrar_dbGrid( sender as TdbGrid, rect,  TDBGrid(Sender).DataSource.DataSet.RecNo, column, state );

end;

procedure TfrmContasReceber_Rel_Baixa.dbg_detalhesDrawColumnCell(
  Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn;
  State: TGridDrawState);
begin
  inherited;
  uBiblioteca.  prc_zebrar_dbGrid( sender as TdbGrid, rect,  TDBGrid(Sender).DataSource.DataSet.RecNo, column, state );

end;

function TfrmContasReceber_Rel_Baixa.fnc_validar_pesquisa: boolean;
begin
  result := false;

  if ((cbPessoa.Checked) and (cbx_pessoas.Text = '' ))then
  begin
    ShowMessage('selecione uma pessoa ou desmarque o check box pessoas');
    cbx_pessoas.SetFocus;
    exit;
  end;

  if ((cbUsuario.Checked) and (cbx_usuarios.Text = '' ))then
  begin
    ShowMessage('selecione um usuário ou desmarque o check box usuários');
    cbx_usuarios.SetFocus;
    exit;
  end;

  result := true;
end;

procedure TfrmContasReceber_Rel_Baixa.FormShow(Sender: TObject);
begin
  inherited;
  prc_componentes;
end;

procedure TfrmContasReceber_Rel_Baixa.prc_componentes;
begin
  sqlPadrao := 'select r.id, r.cadastrado_em, r.historico, r.valor, r.usuario_id, r.pessoa_id, pc.nome as nm_pessoa, pu.nome as nm_usuario from contas_receber_baixa r, pessoas pc, pessoas pu where r.pessoa_id = pc.id and r.usuario_id = pu.id ';
  qry.sql.Clear;
  qry.SQL.Add(sqlPadrao);
  //qry.Open;

  {Empresa}
  qryEmpresa.Connection := self.Conexao;
  qryEmpresa.Close;
  qryEmpresa.SQL.Clear;
  qryEmpresa.SQL.Add('select P.*, E.*  from PESSOAS P, EMPRESA E where E.PESSOA_ID = P.ID');
  qryEmpresa.Open;


  qryPessoas.Connection := self.Conexao;
  qryPessoas.sql.Clear;
  qryPessoas.SQL.Add('select P.id, P.nome, P,CPF_CNPJ, RG_IE, P.ENDERECO, P.NUMERO, P.COLEMENTO, P.BAIRRO, P.CIDADE, P.UF from pessoas P, CONTAS_RECEBER_BAIXA R where P.ativo = ' + QuotedStr('S') + ' and P.ID = R.PESSOA_ID order by nome');
  qrypessoas.Open;

  qryUsuarios.Connection := self.Conexao;
  qryUsuarios.sql.Clear;
  qryUsuarios.SQL.Add('select p.id, p.nome from pessoas p, usuarios u where p.ativo = ' + QuotedStr('S') + 'and p.id = u.pessoa_id  order by nome');
  qryUsuarios.Open;

  qryDetalhes.Connection := self.Conexao;
  qryDetalhes.sql.Clear;
  qryDetalhes.SQL.Add('select B.id, R.DESCRICAO, b.contas_receber_valor, b.valor_pago  from CONTAS_RECEBER_BAIXA_ITENS B, contas_receber r where R.ID = B.CONTAS_RECEBER_ID and CONTAS_RECEBER_BAIXA_ID = :CONTAS_RECEBER_BAIXA_ID ');
  //qryDetalhes.Open;


  dbg_baixas.Columns[4].Visible := False;
  dbg_baixas.Columns[5].Visible := False;

  pnl_titulo.Caption := '';


end;

procedure TfrmContasReceber_Rel_Baixa.prc_pesquisar;
var
  sql: string;
begin

  QRY.SQL.Text := sqlPadrao;
  sql := '';

  if cbPessoa.Checked then
    sql := sql + ' and R.PESSOA_ID = :PESSOA';

  if cbusuario.Checked then
    sql := sql + ' and R.USUARIO_ID = :USUARIO';

  if cbEmissao.Checked then
    sql := sql + ' and CADASTRADO_EM between :dtEmissaoIni and :dtEmissaoFim';


   if sql <> '' then
   begin
     qry.SQL.Text := qry.SQL.Text + sql;
   //ShowMessage(qry.SQL.Text);

     // só passa os parametros se for para uma situação especicica
     if cbPessoa.Checked then
     begin
       qry.ParamByName('PESSOA').Value := cbx_pessoas.KeyValue;
     end;
     if cbusuario.Checked then
       qry.ParamByName('USUARIO').Value := cbx_usuarios.KeyValue;

     if cbEmissao.Checked then
     begin
       qry.Params.ParamByName('dtEmissaoIni').AsDate := dtpEmissaoIni.Date;
       qry.Params.ParamByName('dtEmissaoFim').AsDate := dtpEmissaoFim.Date;
     end;
   end
   else
   begin

   end;


   qry.Open;


   if qry.IsEmpty then
   begin
     qryDetalhes.Close;

     ShowMessage('Não foi encontrado nenhuma conta da pessoa : "' + cbx_pessoas.Text + '"');
     cbx_pessoas.SetFocus;
     exit;
   end
   else
   begin
     //ShowMessage(qryDetalhes.SQL.Text + ' ID ' + qry.FieldByName('id').AsString);
     qryDetalhes.Close;
     qryDetalhes.ParamByName('CONTAS_RECEBER_BAIXA_ID').AsInteger := qry.FieldByName('id').AsInteger;
     qryDetalhes.Open;
   end;
end;

end.
