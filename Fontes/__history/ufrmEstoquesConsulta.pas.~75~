unit ufrmEstoquesConsulta;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseConexao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.ExtCtrls, Vcl.Buttons,
  Vcl.StdCtrls, Vcl.Grids, Vcl.DBGrids, udmConn, unit_funcoes,
  ufrmEstoquesDetalhes, Vcl.ComCtrls, frxClass, frxDBSet;

type
  TfrmEstoquesConsulta = class(TfrmBaseConexao)
    pnl_fundo: TPanel;
    pnl_cabecalho: TPanel;
    lbl_titulo: TLabel;
    SpeedButton1: TSpeedButton;
    pnl_separa_topo: TPanel;
    pnTopo: TPanel;
    rg_filtar: TRadioGroup;
    ds: TDataSource;
    qryID: TIntegerField;
    qryNOME_FANTASIA: TStringField;
    qryUNIDADE: TStringField;
    qryPRECO_CUSTO: TCurrencyField;
    qryPERCA: TCurrencyField;
    qryCUSTO_LIQUIDO: TCurrencyField;
    qryPRECO_VENDEDOR: TCurrencyField;
    qryPRECO_VENDA: TCurrencyField;
    qryTEMPO_REPOSICAO: TSmallintField;
    qryQTDE_MIN: TCurrencyField;
    qryQTDE_MAX: TCurrencyField;
    qryPONTO_PEDIDO: TCurrencyField;
    qryESTOQUE_FISICO: TCurrencyField;
    qryPEDIDO_ABERTO: TCurrencyField;
    qryESTOQUE_DISPONIVEL: TCurrencyField;
    qryPEDIDO_AGUARDANDO: TCurrencyField;
    qryESTOQUE_LIQUIDO: TCurrencyField;
    pnl_rodape: TPanel;
    btn_detalhes: TBitBtn;
    pc_estoques: TPageControl;
    TabSheet1: TTabSheet;
    tbs_movimento: TTabSheet;
    dbgProdutos: TDBGrid;
    Panel5: TPanel;
    DBGrid1: TDBGrid;
    Panel1: TPanel;
    Label4: TLabel;
    ds_movimento: TDataSource;
    qry_movimento: TFDQuery;
    gb_colunas: TGroupBox;
    cb_preco_custo: TCheckBox;
    cb_perca: TCheckBox;
    cb_custo_liquido: TCheckBox;
    cb_preco_vendedor: TCheckBox;
    cb_preco_venda: TCheckBox;
    cb_estoque_fisico: TCheckBox;
    cb_pedido_aberto: TCheckBox;
    cb_estoque_disponivel: TCheckBox;
    cb_pedido_aguardando: TCheckBox;
    cb_estoque_liquido: TCheckBox;
    gbx_opcoes_pesquisa: TGroupBox;
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    cbx_coluna: TComboBox;
    cbx_operador: TComboBox;
    edt_texto: TEdit;
    btn_consultar: TBitBtn;
    btn_incluir_movimento: TBitBtn;
    rgAltura: TRadioGroup;
    rgTipoForma: TRadioGroup;
    btn_corrige_estoques: TButton;
    Panel2: TPanel;
    Label5: TLabel;
    BitBtn1: TBitBtn;
    frxReportEstoques: TfrxReport;
    frxDBEstoques: TfrxDBDataset;
    procedure SpeedButton1Click(Sender: TObject);

    procedure FormCreate(Sender: TObject);
    procedure FormActivate(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);

    procedure rg_filtarClick(Sender: TObject);
    procedure dbgProdutosDblClick(Sender: TObject);
    procedure cb_preco_custoClick(Sender: TObject);
    procedure cbx_colunaChange(Sender: TObject);
    procedure cbx_operadorChange(Sender: TObject);
    procedure btn_consultarClick(Sender: TObject);
    procedure dsDataChange(Sender: TObject; Field: TField);
    procedure btn_detalhesClick(Sender: TObject);
    procedure btn_incluir_movimentoClick(Sender: TObject);
    procedure tbs_movimentoShow(Sender: TObject);
    procedure TabSheet1Show(Sender: TObject);
    procedure btn_corrige_estoquesClick(Sender: TObject);
    procedure pnl_cabecalhoDblClick(Sender: TObject);
    procedure BitBtn1Click(Sender: TObject);
  private
    procedure prc_listar_vigas(forma, altura: integer);
    procedure filtrar_vigas;
    procedure prc_listar_lajotas(altura: integer);
    procedure filtrar_lajotas;
    procedure prc_listar_isopor(altura: integer);
    procedure filtrar_isopor;
    procedure prc_listar_revenda;
    procedure filtrar_revenda;
    procedure prc_confirurar_colunas_dbgrid;
    procedure prc_carrega_cbx_operador;
    procedure prc_limpar_parametros;
    procedure prc_gravar_arquivo_ini;
    procedure prc_ler_arquivo_ini;
    function fnc_validar_pesquisa:boolean;
    { Private declarations }
  public
    { Public declarations }
  end;

var
  frmEstoquesConsulta: TfrmEstoquesConsulta;
  sqlPadrao: string;
  campo : string;
  operador : string;

implementation

{$R *.dfm}

uses unit_principal, System.IniFiles, uBiblioteca, ufrmEstoquesMovimentacaoE,
  unit_movimenta_estoques;

procedure TfrmEstoquesConsulta.FormActivate(Sender: TObject);
begin
  inherited;
  {controla menu da tela principal}
  form_principal.prc_controla_menu(false);
  // posição do form
  frmEstoquesConsulta.Top  := form_principal.pnl_topo.Height;
  frmEstoquesConsulta.Left := form_principal.pnl_menulateral.Width;
  // dimensoes
  frmEstoquesConsulta.Width  := form_principal.pnl_Principal.Width;
  frmEstoquesConsulta.Height := form_principal.pnl_Principal.Height;

end;

procedure TfrmEstoquesConsulta.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
  inherited;
  prc_gravar_arquivo_ini;
  form_principal.prc_controla_menu(true);

end;

procedure TfrmEstoquesConsulta.FormCreate(Sender: TObject);
begin
  inherited;
  qry_movimento.Connection := conexao;

 // gb_colunas.Width := 380;
  {configuração das colunas do dbgrid}
  prc_ler_arquivo_ini;

end;

procedure TfrmEstoquesConsulta.rg_filtarClick(Sender: TObject);
begin
  inherited;
  // limpa memoria
  prc_limpar_parametros;

  // vigas
  if rg_filtar.ItemIndex = 0 then
  begin
    rgTipoForma.Visible    := true;
    rgTipoForma.ItemIndex  := 0;
    rgAltura.Visible       := true;
    rgAltura.ItemIndex     := -1;
  end;
  // lajotas
  if rg_filtar.ItemIndex = 1 then
  begin
    rgTipoForma.Visible    := false;
    rgAltura.Visible       := true;
    rgAltura.ItemIndex     := -1;
  end;
  // isopor
  if rg_filtar.ItemIndex = 2 then
  begin
    rgTipoForma.Visible    := false;
    rgAltura.Visible       := true;
    rgAltura.ItemIndex     := -1;
  end;
  // revenda
  if rg_filtar.ItemIndex = 3 then
  begin
    rgTipoForma.Visible    := false;
    rgAltura.Visible       := false;

  end;

end;

procedure TfrmEstoquesConsulta.prc_limpar_parametros;
begin
  // limpa os combox
  cbx_coluna.ItemIndex   := -1;
  cbx_operador.ItemIndex := -1;
  edt_texto.Text         := '';
  //limpa o memtable
  qry.Close;
  qry.Filter := '';
  campo      := '';
  operador   := '';
end;

procedure TfrmEstoquesConsulta.prc_gravar_arquivo_ini;
var
  IniFile : string;
  Ini : TInifile;
begin
  {cria um arquivo com o mesmo nome da aplicação e troca a extensao}
  IniFile := ChangeFileExt(application.ExeName,'.ini');
  Ini := TIniFile.Create( IniFile );


  try
    Ini.WriteString('configuracao_tela_consulta_estoques', 'mostrar_coluna_preco_custo',ubiblioteca.SeSenao(cb_preco_custo.Checked,'true','false'));
    Ini.WriteString('configuracao_tela_consulta_estoques', 'mostrar_coluna_preca',ubiblioteca.SeSenao(cb_perca.Checked,'true','false'));
    Ini.WriteString('configuracao_tela_consulta_estoques', 'mostrar_coluna_custo_liquido',ubiblioteca.SeSenao(cb_custo_liquido.Checked,'true','false'));
    Ini.WriteString('configuracao_tela_consulta_estoques', 'mostrar_coluna_preco_vendedor',ubiblioteca.SeSenao(cb_preco_vendedor.Checked,'true','false'));
    Ini.WriteString('configuracao_tela_consulta_estoques', 'mostrar_coluna_preco_venda',ubiblioteca.SeSenao(cb_preco_venda.Checked,'true','false'));
    Ini.WriteString('configuracao_tela_consulta_estoques', 'mostrar_coluna_estoque_fisico',ubiblioteca.SeSenao(cb_estoque_fisico.Checked,'true','false'));
    Ini.WriteString('configuracao_tela_consulta_estoques', 'mostrar_coluna_pedido_aberto',ubiblioteca.SeSenao(cb_pedido_aberto.Checked,'true','false'));
    Ini.WriteString('configuracao_tela_consulta_estoques', 'mostrar_coluna_estoque_disponivel',ubiblioteca.SeSenao(cb_estoque_disponivel.Checked,'true','false'));
    Ini.WriteString('configuracao_tela_consulta_estoques', 'mostrar_coluna_pedido_aguardando',ubiblioteca.SeSenao(cb_pedido_aguardando.Checked,'true','false'));
    Ini.WriteString('configuracao_tela_consulta_estoques', 'mostrar_coluna_estoque_liquido',ubiblioteca.SeSenao(cb_estoque_liquido.Checked,'true','false'));
  finally
    FreeAndNil( Ini );
  end;

end;

procedure TfrmEstoquesConsulta.prc_ler_arquivo_ini;
var
  IniFile : string;
  Ini : TInifile;
  mostrar_coluna_preco_custo,
  mostrar_coluna_preca,
  mostrar_coluna_custo_liquido,
  mostrar_coluna_preco_vendedor,
  mostrar_coluna_preco_venda,
  mostrar_coluna_estoque_fisico,
  mostrar_coluna_pedido_aberto,
  mostrar_coluna_estoque_disponivel,
  mostrar_coluna_pedido_aguardando,
  mostrar_coluna_estoque_liquido : string;
begin
  {cria um arquivo com o mesmo no da aplicação e troca a extensao para .ini}
  IniFile := ChangeFileExt(application.ExeName,'.ini');

  Ini     := TIniFile.Create( IniFile );

  if not FileExists(IniFile) then
  begin
    criarmensagem('AVISO', 'Arquivo .Ini não encontrado para configuração da tela de consulta');
  end
  else
  begin

    try
      mostrar_coluna_preco_custo        := Ini.ReadString('configuracao_tela_consulta_estoques', 'mostrar_coluna_preco_custo','' );
      mostrar_coluna_preca              := Ini.ReadString('configuracao_tela_consulta_estoques', 'mostrar_coluna_preca','' );
      mostrar_coluna_custo_liquido      := Ini.ReadString('configuracao_tela_consulta_estoques', 'mostrar_coluna_custo_liquido','' );
      mostrar_coluna_preco_vendedor     := Ini.ReadString('configuracao_tela_consulta_estoques', 'mostrar_coluna_preco_vendedor','' );
      mostrar_coluna_preco_venda        := Ini.ReadString('configuracao_tela_consulta_estoques', 'mostrar_coluna_preco_venda','' );
      mostrar_coluna_estoque_fisico     := Ini.ReadString('configuracao_tela_consulta_estoques', 'mostrar_coluna_estoque_fisico','' );
      mostrar_coluna_pedido_aberto      := Ini.ReadString('configuracao_tela_consulta_estoques', 'mostrar_coluna_pedido_aberto','');
      mostrar_coluna_estoque_disponivel := Ini.ReadString('configuracao_tela_consulta_estoques', 'mostrar_coluna_estoque_disponivel','');
      mostrar_coluna_pedido_aguardando  := Ini.ReadString('configuracao_tela_consulta_estoques', 'mostrar_coluna_pedido_aguardando','');
      mostrar_coluna_estoque_liquido    := Ini.ReadString('configuracao_tela_consulta_estoques', 'mostrar_coluna_estoque_liquido','');

      dbgProdutos.Columns[3].Visible  := uBiblioteca.SeSenao(mostrar_coluna_preco_custo = 'true', true,false);
      dbgProdutos.Columns[4].Visible  := uBiblioteca.SeSenao(mostrar_coluna_preca = 'true', true,false);
      dbgProdutos.Columns[5].Visible  := uBiblioteca.SeSenao(mostrar_coluna_custo_liquido = 'true', true,false);
      dbgProdutos.Columns[6].Visible  := uBiblioteca.SeSenao(mostrar_coluna_preco_vendedor = 'true', true,false);
      dbgProdutos.Columns[7].Visible  := uBiblioteca.SeSenao(mostrar_coluna_preco_venda = 'true', true,false);
      dbgProdutos.Columns[8].Visible  := uBiblioteca.SeSenao(mostrar_coluna_estoque_fisico = 'true', true,false);
      dbgProdutos.Columns[9].Visible  := uBiblioteca.SeSenao(mostrar_coluna_pedido_aberto = 'true', true,false);
      dbgProdutos.Columns[10].Visible := uBiblioteca.SeSenao(mostrar_coluna_estoque_disponivel = 'true', true,false);
      dbgProdutos.Columns[11].Visible := uBiblioteca.SeSenao(mostrar_coluna_pedido_aguardando = 'true', true,false);
      dbgProdutos.Columns[12].Visible := uBiblioteca.SeSenao(mostrar_coluna_estoque_liquido = 'true', true,false);

      cb_preco_custo.checked        := uBiblioteca.SeSenao(mostrar_coluna_preco_custo = 'true', true,false);
      cb_perca.checked              := uBiblioteca.SeSenao(mostrar_coluna_preca = 'true', true,false);
      cb_custo_liquido.checked      := uBiblioteca.SeSenao(mostrar_coluna_custo_liquido = 'true', true,false);
      cb_preco_vendedor.checked     := uBiblioteca.SeSenao(mostrar_coluna_preco_vendedor = 'true', true,false);
      cb_preco_venda.checked        := uBiblioteca.SeSenao(mostrar_coluna_preco_venda = 'true', true,false);
      cb_estoque_fisico.checked     := uBiblioteca.SeSenao(mostrar_coluna_estoque_fisico = 'true', true,false);
      cb_pedido_aberto.checked      := uBiblioteca.SeSenao(mostrar_coluna_pedido_aberto = 'true', true,false);
      cb_estoque_disponivel.checked := uBiblioteca.SeSenao(mostrar_coluna_estoque_disponivel = 'true', true,false);
      cb_pedido_aguardando.checked  := uBiblioteca.SeSenao(mostrar_coluna_pedido_aguardando = 'true', true,false);
      cb_estoque_liquido.checked    := uBiblioteca.SeSenao(mostrar_coluna_estoque_liquido = 'true', true,false);

    finally
      FreeAndNil( Ini );
    end;

  end;
end;



procedure TfrmEstoquesConsulta.SpeedButton1Click(Sender: TObject);
begin
  inherited;
  close;
end;

procedure TfrmEstoquesConsulta.TabSheet1Show(Sender: TObject);
begin
  inherited;

  btn_consultar.Enabled := true;

end;

procedure TfrmEstoquesConsulta.tbs_movimentoShow(Sender: TObject);
begin
  inherited;



  {lista o movimento do produto}
  qry_movimento.Close;
  qry_movimento.ParamByName('PRODUTO_ID').AsInteger := qry.FieldByName('ID').AsInteger;
  qry_movimento.Open;

  btn_consultar.Enabled := false;
end;

procedure TfrmEstoquesConsulta.filtrar_vigas;
begin
  // FORMA 130
  // listar H8
  if ( rg_filtar.ItemIndex = 0 ) and ( rgTipoForma.ItemIndex = 0 )  and ( rgAltura.ItemIndex = 0 ) then
  begin
     prc_listar_vigas( 130, 80 );
  end else
  // listar H12
  if ( rg_filtar.ItemIndex = 0 ) and ( rgTipoForma.ItemIndex = 0 )  and ( rgAltura.ItemIndex = 1 ) then
  begin
     prc_listar_vigas( 130, 120 );
  end else
  // listar H16
  if ( rg_filtar.ItemIndex = 0 ) and ( rgTipoForma.ItemIndex = 0 )  and ( rgAltura.ItemIndex = 2 ) then
  begin
     prc_listar_vigas( 130, 160 );
  end else
  // listar H20
  if ( rg_filtar.ItemIndex = 0 ) and ( rgTipoForma.ItemIndex = 0 )  and ( rgAltura.ItemIndex = 3 ) then
  begin
     prc_listar_vigas( 130, 200 );
  end else
  // listar H25
  if ( rg_filtar.ItemIndex = 0 ) and ( rgTipoForma.ItemIndex = 0 )  and ( rgAltura.ItemIndex = 4 ) then
  begin
     prc_listar_vigas( 130, 250 );
  end else
  // listar H30
  if ( rg_filtar.ItemIndex = 0 ) and ( rgTipoForma.ItemIndex = 0 )  and ( rgAltura.ItemIndex = 5 ) then
  begin
     prc_listar_vigas( 130, 300 );
  end;


  // FORMA 250
  // listar H8
  if ( rg_filtar.ItemIndex = 0 ) and ( rgTipoForma.ItemIndex = 1 )  and ( rgAltura.ItemIndex = 0 ) then
  begin
     prc_listar_vigas( 250, 80 );
  end else
  // listar H12
  if ( rg_filtar.ItemIndex = 0 ) and ( rgTipoForma.ItemIndex = 1 )  and ( rgAltura.ItemIndex = 1 ) then
  begin
     prc_listar_vigas( 250, 120 );
  end else
  // listar H16
  if ( rg_filtar.ItemIndex = 0 ) and ( rgTipoForma.ItemIndex = 1 )  and ( rgAltura.ItemIndex = 2 ) then
  begin
     prc_listar_vigas( 250, 160 );
  end else
  // listar H20
  if ( rg_filtar.ItemIndex = 0 ) and ( rgTipoForma.ItemIndex = 1 )  and ( rgAltura.ItemIndex = 3 ) then
  begin
     prc_listar_vigas( 250, 200 );
  end else
  // listar H25
  if ( rg_filtar.ItemIndex = 0 ) and ( rgTipoForma.ItemIndex = 1 )  and ( rgAltura.ItemIndex = 4 ) then
  begin
     prc_listar_vigas( 250, 250 );
  end else
  // listar H30
  if ( rg_filtar.ItemIndex = 0 ) and ( rgTipoForma.ItemIndex = 1 )  and ( rgAltura.ItemIndex = 5 ) then
  begin
     prc_listar_vigas( 250, 300 );
  end;

  // FORMA TRELIFACIL 120
  // listar H8
  if ( rg_filtar.ItemIndex = 0 ) and ( rgTipoForma.ItemIndex = 2 )  and ( rgAltura.ItemIndex = 0 ) then
  begin
     prc_listar_vigas( 120, 80 );
  end else
  // listar H12
  if ( rg_filtar.ItemIndex = 0 ) and ( rgTipoForma.ItemIndex = 2 )  and ( rgAltura.ItemIndex = 1 ) then
  begin
     prc_listar_vigas( 120, 120 );
  end else
  // listar H16
  if ( rg_filtar.ItemIndex = 0 ) and ( rgTipoForma.ItemIndex = 2 )  and ( rgAltura.ItemIndex = 2 ) then
  begin
     prc_listar_vigas( 120, 160 );
  end else
  // listar H20
  if ( rg_filtar.ItemIndex = 0 ) and ( rgTipoForma.ItemIndex = 2 )  and ( rgAltura.ItemIndex = 3 ) then
  begin
     prc_listar_vigas( 120, 200 );
  end else
  // listar H25
  if ( rg_filtar.ItemIndex = 0 ) and ( rgTipoForma.ItemIndex = 2 )  and ( rgAltura.ItemIndex = 4 ) then
  begin
     prc_listar_vigas( 120, 250 );
  end else
  // listar H30
  if ( rg_filtar.ItemIndex = 0 ) and ( rgTipoForma.ItemIndex = 2 )  and ( rgAltura.ItemIndex = 5 ) then
  begin
     prc_listar_vigas( 120, 300 );
  end;


end;

procedure TfrmEstoquesConsulta.filtrar_lajotas;
begin
  // listas lajotas
  if ( rg_filtar.ItemIndex = 1 ) and ( rgAltura.ItemIndex = 0 ) then
  begin
     prc_listar_lajotas( 80 );
  end else
  if ( rg_filtar.ItemIndex = 1 ) and ( rgAltura.ItemIndex = 1 ) then
  begin
     prc_listar_lajotas( 120 );
  end else
  if ( rg_filtar.ItemIndex = 1 ) and ( rgAltura.ItemIndex = 2 ) then
  begin
     prc_listar_lajotas( 160 );
  end else
  if ( rg_filtar.ItemIndex = 1 ) and ( rgAltura.ItemIndex = 3 ) then
  begin
     prc_listar_lajotas( 200 );
  end else
  if ( rg_filtar.ItemIndex = 1 ) and ( rgAltura.ItemIndex = 4 ) then
  begin
     prc_listar_lajotas( 250 );
  end else
  if ( rg_filtar.ItemIndex = 1 ) and ( rgAltura.ItemIndex = 5 ) then
  begin
     prc_listar_lajotas( 300 );
  end;


end;

procedure TfrmEstoquesConsulta.prc_confirurar_colunas_dbgrid;
begin
  dbgProdutos.Columns[3].Visible := cb_preco_custo.Checked;
  dbgProdutos.Columns[4].Visible := cb_perca.Checked;
  dbgProdutos.Columns[5].Visible := cb_custo_liquido.Checked;
  dbgProdutos.Columns[6].Visible := cb_preco_vendedor.Checked;
  dbgProdutos.Columns[7].Visible := cb_preco_venda.Checked;
  dbgProdutos.Columns[8].Visible := cb_estoque_fisico.Checked;
  dbgProdutos.Columns[9].Visible := cb_pedido_aberto.Checked;
  dbgProdutos.Columns[10].Visible := cb_estoque_disponivel.Checked;
  dbgProdutos.Columns[11].Visible := cb_pedido_aguardando.Checked;
  dbgProdutos.Columns[12].Visible := cb_estoque_liquido.Checked;

  //ajustas as colunas do dbgrid
  prc_ajustar_colunas_grid( dbgProdutos );

  //aumenta o tamanho da linha do ddgrid
  prc_ajusta_tamanho_linha( dbgProdutos );

end;

procedure TfrmEstoquesConsulta.cbx_operadorChange(Sender: TObject);
begin
  inherited;

  if cbx_operador.ItemIndex = 0 then operador := ' = ';
  if cbx_operador.ItemIndex = 1 then operador := ' <= ';
  if cbx_operador.ItemIndex = 2 then operador := ' >= ';
  if cbx_operador.ItemIndex = 3 then operador := ' <> ';

  edt_texto.Enabled := true;

end;

procedure TfrmEstoquesConsulta.cb_preco_custoClick(Sender: TObject);
begin
  inherited;
  prc_confirurar_colunas_dbgrid;
end;

function TfrmEstoquesConsulta.fnc_validar_pesquisa: boolean;
begin
  result := false;

  if rg_filtar.ItemIndex = -1 then
  begin
    CriarMensagem('AVISO', 'SELECIONE UM TIPO DE MATERIAL.');
    rg_filtar.SetFocus;
    EXIT;
  end;

  // selecionou viga,lajota ou isopor informar a altura
  if rg_filtar.ItemIndex < 3 then
  if rgAltura.ItemIndex = -1  then
  begin
    CriarMensagem('AVISO', 'INFORMA A ALTURA DA LAJE.');
    rgAltura.SetFocus;
    EXIT;
  end;

  result := true;
end;

procedure TfrmEstoquesConsulta.BitBtn1Click(Sender: TObject);
begin
  inherited;
  if not qry.IsEmpty then
    frxReportEstoques.ShowReport;
end;

procedure TfrmEstoquesConsulta.btn_consultarClick(Sender: TObject);
begin
  inherited;

  if not fnc_validar_pesquisa then exit;


  // FILTRAR VIGAS
  if rg_filtar.ItemIndex = 0 then
    filtrar_vigas;

  // FILTRAR LAJOTA
  if rg_filtar.ItemIndex = 1 then
    filtrar_lajotas;

  // FILTRAR ISOPOR
  if rg_filtar.ItemIndex = 2 then
    filtrar_isopor;

  // FILTRAR REVENDA
  if rg_filtar.ItemIndex = 3 then
    filtrar_revenda;

  // aplicar filtro no memtable
  qry.Filter   := '';
  qry.Filtered := TRUE;

  if cbx_operador.Text <> 'que Contenha' then
    qry.Filter :=  campo + operador + edt_texto.Text
  else
  begin
    operador := ' like ' + QuotedStr('%' + edt_texto.Text + '%');
    qry.Filter   :=  campo + operador;
  end;

  //ajustas as colunas do dbgrid
  prc_ajustar_colunas_grid( dbgProdutos );

  //aumenta o tamanho da linha do ddgrid
  prc_ajusta_tamanho_linha( dbgProdutos );


end;

procedure TfrmEstoquesConsulta.btn_incluir_movimentoClick(Sender: TObject);
begin
  inherited;
  ufrmEstoquesMovimentacaoE.Incluir(qry.FieldByName('ID').AsInteger);
  btn_consultar.Click;

end;

procedure TfrmEstoquesConsulta.btn_corrige_estoquesClick(Sender: TObject);
var
  loqry,qry  : TFDQuery;
  estoque_fisico, pedido_aberto, estoque_disponivel,
  pedido_aguardando, estoque_liquido : double;
begin
  try
    qry := TFDQuery.Create(application);
    qry.Connection := conexao;
    qry.SQL.Add('update produtos set estoque_fisico =:estoque_fisico, pedido_aberto =:pedido_aberto, estoque_disponivel =:estoque_disponivel, pedido_aguardando =:pedido_aguardando, estoque_liquido =:estoque_liquido where id =:produto_id');

    loqry := TFDQuery.Create(application);
    loqry.Connection := conexao;

    loqry.Open('select * from produtos');
    loqry.First;
    while not loqry.eof do
    begin
      estoque_fisico     := loqry.FieldByName('estoque_fisico').AsFloat;

      pedido_aberto := 0;
      pedido_aberto := fnc_somar_pedidos_aberto_aguardando('PEDIDOS_ITENS','ABERTO', loqry.FieldByName('id').AsInteger );
      pedido_aberto := pedido_aberto + fnc_somar_pedidos_aberto_aguardando('PEDIDOS_ITENS_LAJE','ABERTO', loqry.FieldByName('id').AsInteger );

      estoque_disponivel := estoque_fisico - pedido_aberto;

      pedido_aguardando  := 0;
      pedido_aguardando  := fnc_somar_pedidos_aberto_aguardando('PEDIDOS_ITENS','AGUARDANDO', loqry.FieldByName('id').AsInteger );
      pedido_aguardando  := pedido_aguardando + fnc_somar_pedidos_aberto_aguardando('PEDIDOS_ITENS_LAJE','AGUARDANDO', loqry.FieldByName('id').AsInteger );

      estoque_liquido    := estoque_disponivel - pedido_aguardando;

      qry.ParamByName('estoque_fisico').AsFloat     := estoque_fisico;
      qry.ParamByName('pedido_aberto').AsFloat      := pedido_aberto;
      qry.ParamByName('estoque_disponivel').AsFloat := estoque_disponivel;
      qry.ParamByName('pedido_aguardando').AsFloat  := pedido_aguardando;
      qry.ParamByName('estoque_liquido').AsFloat    := estoque_liquido;
      qry.ParamByName('produto_id').AsFloat         := loqry.FieldByName('id').AsInteger;

      qry.ExecSQL;

      {corrigir tabela de estoques_movimentação}
      // melhor não
      //prc_atualizar_estoque_fisico(loqry.FieldByName('id').AsInteger, estoque_fisico );

      loqry.next;
    end;
    ShowMessage('estoques corrigidos');
    btn_corrige_estoques.Visible := false;
  finally
    freeandnil(loqry);
  end;
end;

procedure TfrmEstoquesConsulta.btn_detalhesClick(Sender: TObject);
begin
  inherited;
  try
    if frmEstoquesDetalhes = nil then
      frmEstoquesDetalhes := TfrmEstoquesDetalhes.Create(application);
    // cabeçabelho
    frmEstoquesDetalhes.lbl_produto_id.Caption           := 'PRODUTO [ CÓD.: ' + qryID.AsString + ' ] ' +
    {frmEstoquesDetalhes.lbl_descricao_do_produto.Caption :=}  qryNOME_FANTASIA.AsString;
    frmEstoquesDetalhes.lbl_estoque_fisico.Caption       := qryESTOQUE_FISICO.AsString;
    frmEstoquesDetalhes.lbl_pedido_aberto.Caption        := qryPEDIDO_ABERTO.AsString;
    frmEstoquesDetalhes.lbl_estoque_Disponivel.Caption   := qryESTOQUE_DISPONIVEL.AsString;
    frmEstoquesDetalhes.lbl_pedido_aguardando.Caption    := qryPEDIDO_AGUARDANDO.AsString;
    frmEstoquesDetalhes.lbl_estoque_liquido.Caption      := qryESTOQUE_LIQUIDO.AsString;

     {carrega a variavel codigo do produto}
     frmEstoquesDetalhes.produto_id := qry.fieldbyname('ID').AsInteger;

    {filtrar as tabelas}
    frmEstoquesDetalhes.qry_detalhes_pedido.Close;
    frmEstoquesDetalhes.qry_detalhes_pedido.ParamByName('PRODUTO_ID').AsInteger := qry.fieldbyname('ID').AsInteger;
    frmEstoquesDetalhes.qry_detalhes_pedido.Open;
    frmEstoquesDetalhes.qry_detalhes_pedido.last;

    frmEstoquesDetalhes.qry_detalhes_laje.Close;
    frmEstoquesDetalhes.qry_detalhes_laje.ParamByName('PRODUTO_ID').AsInteger := qry.fieldbyname('ID').AsInteger;
    frmEstoquesDetalhes.qry_detalhes_laje.Open;
    frmEstoquesDetalhes.qry_detalhes_laje.last;


    frmEstoquesDetalhes.showmodal;

  finally
    FreeAndNil(frmEstoquesDetalhes);
  end;

end;

procedure TfrmEstoquesConsulta.cbx_colunaChange(Sender: TObject);
begin
  inherited;
  cbx_operador.Enabled := false;
  edt_texto.Text       := '';
  edt_texto.Enabled    := TRUE;

  case cbx_coluna.ItemIndex of
    0:Campo := 'ID';
    1:Campo := 'NOME_FANTASIA';
    2:Campo := 'ESTOQUE_FISICO';
    3:Campo := 'PEDIDO_ABERTO';
    4:Campo := 'ESTOQUE_DISPONIVEL';
    5:Campo := 'PEDIDO_AGUARDANDO';
    6:Campo := 'ESTOQUE_LIQUIDO';
  end;

  prc_carrega_cbx_operador;
end;

procedure TfrmEstoquesConsulta.pnl_cabecalhoDblClick(Sender: TObject);
begin
  inherited;
  btn_corrige_estoques.Visible := true;
end;

procedure TfrmEstoquesConsulta.prc_carrega_cbx_operador;
begin
  cbx_operador.Clear;

  case cbx_coluna.ItemIndex of
    0,2,3,4,5: begin
         cbx_operador.Items.Add('Igual a');
         cbx_operador.Items.Add('Menor ou Igual que');
         cbx_operador.Items.Add('Maior ou Igual que');
         cbx_operador.Items.Add('Diferente de');
       end;
    1: cbx_operador.Items.Add('que Contenha');
  end;

  cbx_operador.Enabled := true;

end;


procedure TfrmEstoquesConsulta.dbgProdutosDblClick(Sender: TObject);
begin
  inherited;
  if btn_detalhes.Enabled then btn_detalhesClick(self);

end;

procedure TfrmEstoquesConsulta.dsDataChange(Sender: TObject; Field: TField);
begin
  inherited;
  if not qry.IsEmpty then
  begin

    btn_detalhes.Enabled := ((qry.FieldByName('pedido_aberto').AsFloat <> 0) or
                            (qry.FieldByName('pedido_aguardando').AsFloat<>0));

    label4.Caption := 'Movimentação do produto : ' + qry.fieldbyname('NOME_FANTASIA').AsString;
  end;
  btn_incluir_movimento.Enabled := not qry.IsEmpty;
end;

procedure TfrmEstoquesConsulta.filtrar_isopor;
begin
  // listas isopor
  if ( rg_filtar.ItemIndex = 2 ) and ( rgAltura.ItemIndex = 0 ) then
  begin
     prc_listar_isopor( 80 );
  end else
  if ( rg_filtar.ItemIndex = 2 ) and ( rgAltura.ItemIndex = 1 ) then
  begin
     prc_listar_isopor( 120 );
  end else
  if ( rg_filtar.ItemIndex = 2 ) and ( rgAltura.ItemIndex = 2 ) then
  begin
     prc_listar_isopor( 160 );
  end else
  if ( rg_filtar.ItemIndex = 2 ) and ( rgAltura.ItemIndex = 3 ) then
  begin
     prc_listar_isopor( 200 );
  end else
  if ( rg_filtar.ItemIndex = 2 ) and ( rgAltura.ItemIndex = 4 ) then
  begin
     prc_listar_isopor( 250 );
  end else
  if ( rg_filtar.ItemIndex = 2 ) and ( rgAltura.ItemIndex = 5 ) then
  begin
     prc_listar_isopor( 300 );
  end;


end;


procedure TfrmEstoquesConsulta.filtrar_revenda;
begin
  // listas revenda
  if rg_filtar.ItemIndex = 3  then
  begin
     prc_listar_revenda;
  end;

end;


procedure TfrmEstoquesConsulta.prc_listar_vigas(forma: integer; altura:integer);
begin
  qry.Connection := conexao;
  qry.SQL.Clear;

  qry.SQL.Add('select                             ');
  qry.SQL.Add(' P.ID,                             ');
  qry.SQL.Add(' P.NOME_FANTASIA,                  ');
  qry.SQL.Add(' P.UNIDADE,                        ');
  qry.SQL.Add(' P.PRECO_CUSTO,                    ');
  qry.SQL.Add(' P.PERCA,                          ');
  qry.SQL.Add(' P.CUSTO_LIQUIDO,                  ');
  qry.SQL.Add(' P.PRECO_VENDEDOR,                 ');
  qry.SQL.Add(' P.PRECO_VENDA,                    ');
  qry.SQL.Add(' P.TEMPO_REPOSICAO,                ');
  qry.SQL.Add(' P.QTDE_MIN,                       ');
  qry.SQL.Add(' P.QTDE_MAX,                       ');
  qry.SQL.Add(' P.PONTO_PEDIDO,                   ');
  qry.SQL.Add(' P.ESTOQUE_FISICO,                 ');
  qry.SQL.Add(' P.PEDIDO_ABERTO,                  ');
  qry.SQL.Add(' P.ESTOQUE_DISPONIVEL,             ');
  qry.SQL.Add(' P.PEDIDO_AGUARDANDO,              ');
  qry.SQL.Add(' P.ESTOQUE_LIQUIDO                 ');
  qry.SQL.Add('from                               ');
  qry.SQL.Add(' PRODUTOS P,                       ');
  qry.SQL.Add(' PRODUTOS_VIGAS V                  ');
  qry.SQL.Add('where                              ');
  qry.SQL.Add(' P.ID = V.PRODUTO_ID and           ');
  qry.SQL.Add(' V.FORMA_MEDIDA =:FORMA_MEDIDA and ');
  qry.SQL.Add(' V.TRELICA_ALTURA =:TRELICA_ALTURA ');

  qry.ParamByName('FORMA_MEDIDA').AsInteger   := forma;
  qry.ParamByName('TRELICA_ALTURA').AsInteger := altura;

  //ShowMessage(qry.SQL.Text);
  qry.Open;
end;


procedure TfrmEstoquesConsulta.prc_listar_lajotas( altura: integer );
begin
  qry.Connection := conexao;
  qry.SQL.Clear;
  qry.SQL.Add('select                             ');
  qry.SQL.Add(' P.ID,                             ');
  qry.SQL.Add(' P.NOME_FANTASIA,                  ');
  qry.SQL.Add(' P.UNIDADE,                        ');
  qry.SQL.Add(' P.PRECO_CUSTO,                    ');
  qry.SQL.Add(' P.PERCA,                          ');
  qry.SQL.Add(' P.CUSTO_LIQUIDO,                  ');
  qry.SQL.Add(' P.PRECO_VENDEDOR,                 ');
  qry.SQL.Add(' P.PRECO_VENDA,                    ');
  qry.SQL.Add(' P.TEMPO_REPOSICAO,                ');
  qry.SQL.Add(' P.QTDE_MIN,                       ');
  qry.SQL.Add(' P.QTDE_MAX,                       ');
  qry.SQL.Add(' P.PONTO_PEDIDO,                   ');
  qry.SQL.Add(' P.ESTOQUE_FISICO,                 ');
  qry.SQL.Add(' P.PEDIDO_ABERTO,                  ');
  qry.SQL.Add(' P.ESTOQUE_DISPONIVEL,             ');
  qry.SQL.Add(' P.PEDIDO_AGUARDANDO,              ');
  qry.SQL.Add(' P.ESTOQUE_LIQUIDO                 ');
  qry.SQL.Add('from                               ');
  qry.SQL.Add(' PRODUTOS P,                       ');
  qry.SQL.Add(' PRODUTOS_LAJOTAS L                ');
  qry.SQL.Add('where                              ');
  qry.SQL.Add(' P.ID = L.PRODUTO_ID and           ');
  qry.SQL.Add(' L.ALTURA =:ALTURA ');

  qry.ParamByName('ALTURA').AsInteger := altura;
  qry.Open;
end;


procedure TfrmEstoquesConsulta.prc_listar_isopor( altura: integer );
begin
  qry.Connection := conexao;
  qry.SQL.Clear;
  qry.SQL.Add('select                             ');
  qry.SQL.Add(' P.ID,                             ');
  qry.SQL.Add(' P.NOME_FANTASIA,                  ');
  qry.SQL.Add(' P.UNIDADE,                        ');
  qry.SQL.Add(' P.PRECO_CUSTO,                    ');
  qry.SQL.Add(' P.PERCA,                          ');
  qry.SQL.Add(' P.CUSTO_LIQUIDO,                  ');
  qry.SQL.Add(' P.PRECO_VENDEDOR,                 ');
  qry.SQL.Add(' P.PRECO_VENDA,                    ');
  qry.SQL.Add(' P.TEMPO_REPOSICAO,                ');
  qry.SQL.Add(' P.QTDE_MIN,                       ');
  qry.SQL.Add(' P.QTDE_MAX,                       ');
  qry.SQL.Add(' P.PONTO_PEDIDO,                   ');
  qry.SQL.Add(' P.ESTOQUE_FISICO,                 ');
  qry.SQL.Add(' P.PEDIDO_ABERTO,                  ');
  qry.SQL.Add(' P.ESTOQUE_DISPONIVEL,             ');
  qry.SQL.Add(' P.PEDIDO_AGUARDANDO,              ');
  qry.SQL.Add(' P.ESTOQUE_LIQUIDO                 ');
  qry.SQL.Add('from                               ');
  qry.SQL.Add(' PRODUTOS P,                       ');
  qry.SQL.Add(' PRODUTOS_EPS E                    ');
  qry.SQL.Add('where                              ');
  qry.SQL.Add(' P.ID = E.PRODUTO_ID and           ');
  qry.SQL.Add(' E.ALTURA =:ALTURA ');
  qry.ParamByName('ALTURA').AsInteger := altura;
  qry.Open;

end;

procedure TfrmEstoquesConsulta.prc_listar_revenda;
begin
  qry.Connection := conexao;
  qry.SQL.Clear;

  qry.SQL.Add('select                             ');
  qry.SQL.Add(' P.ID,                             ');
  qry.SQL.Add(' P.NOME_FANTASIA,                  ');
  qry.SQL.Add(' P.UNIDADE,                        ');
  qry.SQL.Add(' P.PRECO_CUSTO,                    ');
  qry.SQL.Add(' P.PERCA,                          ');
  qry.SQL.Add(' P.CUSTO_LIQUIDO,                  ');
  qry.SQL.Add(' P.PRECO_VENDEDOR,                 ');
  qry.SQL.Add(' P.PRECO_VENDA,                    ');
  qry.SQL.Add(' P.TEMPO_REPOSICAO,                ');
  qry.SQL.Add(' P.QTDE_MIN,                       ');
  qry.SQL.Add(' P.QTDE_MAX,                       ');
  qry.SQL.Add(' P.PONTO_PEDIDO,                   ');
  qry.SQL.Add(' P.ESTOQUE_FISICO,                 ');
  qry.SQL.Add(' P.PEDIDO_ABERTO,                  ');
  qry.SQL.Add(' P.ESTOQUE_DISPONIVEL,             ');
  qry.SQL.Add(' P.PEDIDO_AGUARDANDO,              ');
  qry.SQL.Add(' P.ESTOQUE_LIQUIDO                 ');
  qry.SQL.Add('from                               ');
  qry.SQL.Add(' PRODUTOS P                        ');
  qry.SQL.Add('where                              ');
  qry.SQL.Add(' P.REVENDA = :REVENDA              ');

  qry.ParamByName('REVENDA').AsString := 'S';
  qry.Open;

end;


end.
