unit ufrmPedidosConsultaConcreto;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseConexao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.ExtCtrls,
  Vcl.StdCtrls, Vcl.Buttons, Vcl.DBCtrls, Vcl.ComCtrls, Vcl.Grids, Vcl.DBGrids;

type
  TfrmPedidosConsultaConcreto = class(TfrmBaseConexao)
    pnl_fundo: TPanel;
    pnl_cabecalho: TPanel;
    lbl_titulo: TLabel;
    SpeedButton1: TSpeedButton;
    pnl_separa_topo: TPanel;
    pnl_topo: TPanel;
    GroupBox2: TGroupBox;
    cbxCliente: TDBLookupComboBox;
    cbxVendedor: TDBLookupComboBox;
    GroupBox1: TGroupBox;
    cb_entrega: TCheckBox;
    dtp_entrega_ini: TDateTimePicker;
    dtp_entrega_fim: TDateTimePicker;
    GroupBox3: TGroupBox;
    cbxTipoVenda: TComboBox;
    cbxSituacao: TComboBox;
    cbxFinanceiro: TComboBox;
    btn_consultar: TButton;
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    Panel5: TPanel;
    DBGrid1: TDBGrid;
    Panel1: TPanel;
    Label4: TLabel;
    dsCliente: TDataSource;
    dsVendedor: TDataSource;
    qry_clientes: TFDQuery;
    qry_vendedores: TFDQuery;
    dsConsulta: TDataSource;
    cb_cliente: TCheckBox;
    cb_vendedor: TCheckBox;
    cb_emissao: TCheckBox;
    dtp_data_ini: TDateTimePicker;
    dtp_data_fim: TDateTimePicker;
    gb_resumo: TGroupBox;
    Label5: TLabel;
    Label6: TLabel;
    Label8: TLabel;
    Label10: TLabel;
    Label7: TLabel;
    Label11: TLabel;
    Label9: TLabel;
    Shape1: TShape;
    Shape2: TShape;
    Shape3: TShape;
    Shape4: TShape;
    lbl_qtde_pedidos: TLabel;
    lbl_qtde_concreto: TLabel;
    lbl_venda_concreto: TLabel;
    lbl_qtde_faltante: TLabel;
    lbl_venda_faltante: TLabel;
    lbl_qtde_bombas: TLabel;
    lbl_venda_bomba: TLabel;
    btn_detalhes: TBitBtn;
    qryID: TIntegerField;
    qryPEDIDO_ID: TIntegerField;
    qryID_1: TIntegerField;
    qryNOME: TStringField;
    qryDATA_ENTREGA: TDateField;
    qrySITUACAO: TStringField;
    qryVENDEDOR_ID: TIntegerField;
    qryNOME_FANTASIA: TStringField;
    qryUNIDADE: TStringField;
    qryQTDE: TCurrencyField;
    qryTOTAL: TBCDField;
    qryPAGO: TStringField;
    Panel2: TPanel;
    Label12: TLabel;
    Label15: TLabel;
    lbl_dataFim: TLabel;
    lbl_dataIni: TLabel;
    Panel3: TPanel;
    btn_fechar: TButton;
    procedure btn_consultarClick(Sender: TObject);
    procedure SpeedButton1Click(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure dsConsultaDataChange(Sender: TObject; Field: TField);
    procedure FormCreate(Sender: TObject);
    procedure btn_detalhesClick(Sender: TObject);
    procedure btn_fecharClick(Sender: TObject);
  private
    procedure prc_componentes;
    function TotalizaConcreto: double;
    { Private declarations }
  public
   sql: string;
   pedido_id : integer;
  end;

var
  frmPedidosConsultaConcreto: TfrmPedidosConsultaConcreto;
  condicao, orcamento, situacao, pago: string;

implementation

{$R *.dfm}

uses udmConn;

procedure TfrmPedidosConsultaConcreto.btn_consultarClick(
  Sender: TObject);

//var coloquei como variaveis global
// condicao, orcamento, situacao, pago: string;
begin
  condicao := '';
  {pedido, orçamento ou todos}
  if cbxTipoVenda.ItemIndex = 0 then
    orcamento := 'N'
  else
  if cbxTipoVenda.ItemIndex = 1 then
    orcamento := 'S'
  else
  if (cbxTipoVenda.ItemIndex = -1) or (cbxTipoVenda.ItemIndex = 2) then
    orcamento := '';


  {aberto, entregue, retirou ou todos}
  if (cbxSituacao.ItemIndex = -1) or (cbxSituacao.ItemIndex = 4) then
    situacao := ''
  else
    situacao := cbxSituacao.Text;


  {pago, receber ou todos}
  if cbxFinanceiro.ItemIndex = 0 then
    pago := 'S'
  else
  if cbxFinanceiro.ItemIndex = 1 then
    pago := 'N'
  else
  if (cbxFinanceiro.ItemIndex = -1) or (cbxFinanceiro.ItemIndex = 2) then
    pago := '';

  {cliente}
  if cb_cliente.Checked then
    condicao := '  and ped.cliente_id = :cliente_ID ';

  {vendedor}
  if cb_vendedor.Checked then
    condicao := condicao + ' and ped.vendedor_id = :vendedor_ID ';

  {data entrega}
  if cb_entrega.Checked then
    //condicao := condicao + ' and i.data_entrega >= :data_ini and i.data_entrega <= :data_fim ';
    condicao := condicao + ' and ped.data_entrega >= :data_ini and ped.data_entrega <= :data_fim ';

  {data emissao}
  if cb_emissao.Checked then
    //condicao := condicao + ' and i.data_entrega >= :data_ini and i.data_entrega <= :data_fim ';
    condicao := condicao + ' and ped.data_emissao >= :data_ini_emi and ped.data_emissao <= :data_fim_emi ';

  {pedido, orçamento ou todos}
  if cbxTipoVenda.Text <> '' then
    condicao := condicao + ' and ped.orcamento =:orcamento '
  else
    condicao := condicao + ' and ped.orcamento <> :orcamento ';

  {aberto, entregue, retirou ou todos}
  if (cbxSituacao.Text <> '') and (situacao <> '') then
    condicao := condicao + ' and i.situacao =:situacao '
  else
    condicao := condicao + ' and i.situacao <> :situacao ';

  {pago, receber ou todos}
  if (cbxFinanceiro.ItemIndex <> -1) and (cbxFinanceiro.ItemIndex <> 2) then
    condicao := condicao + ' and ped.pago =:pago '
  else
    condicao := condicao + ' and ped.pago <> :pago ';

  {monta a instrução sql}
  qry.SQL.Clear;
  qry.SQL.Add( sql + condicao  + ' order by i.pedido_id, i.id') ;


  {parametros}
  {cliente}
  if (cb_cliente.Checked) then
    if (cbxCliente.Text <> '') then
      qry.ParamByName('CLIENTE_ID').AsInteger := cbxCliente.KeyValue
    else
      qry.ParamByName('CLIENTE_ID').AsInteger := -1;

  {vendedor}
  if (cb_vendedor.Checked) then
    if  (cbxVendedor.Text <> '') then
      qry.ParamByName('VENDEDOR_ID').AsInteger := cbxVendedor.KeyValue
    else
      qry.ParamByName('VENDEDOR_ID').AsInteger := -1;

  {data entrega}
  if cb_entrega.Checked then
  begin
    qry.ParamByName('DATA_INI').AsDate := dtp_entrega_ini.date;
    qry.ParamByName('DATA_FIM').AsDate := dtp_entrega_fim.date;
  end;

  {data emissao}
  if cb_emissao.Checked then
  begin
    qry.ParamByName('DATA_INI_EMI').AsDate := dtp_data_ini.date;
    qry.ParamByName('DATA_FIM_EMI').AsDate := dtp_data_fim.date;
  end;


  {pedido ou orcamento}
  qry.ParamByName('orcamento').AsString := orcamento;

  {entregue/aguardando/aberto}
  qry.ParamByName('SITUACAO').AsString  := cbxSituacao.Text;

  {pago ou receber}
  qry.ParamByName('PAGO').AsString := PAGO ;

  //ShowMessage(qry.SQL.text) ;
  QRY.Open;


end;

procedure TfrmPedidosConsultaConcreto.btn_detalhesClick(Sender: TObject);
begin
  inherited;
  if cb_emissao.Checked  then
  begin
    gb_resumo.Caption := 'Filtro : ' + cb_emissao.Caption;
    lbl_dataIni.Caption := datetostr(dtp_data_ini.date);
    lbl_dataFim.Caption := datetostr(dtp_data_fim.date);
  end;
  if cb_entrega.Checked  then
  begin
    gb_resumo.Caption := 'Filtro : ' + cb_entrega.Caption;
    lbl_dataIni.Caption := datetostr(dtp_entrega_ini.date);
    lbl_dataFim.Caption := datetostr(dtp_entrega_fim.date);
  end;

  gb_resumo.Visible := true;
  TotalizaConcreto;
end;

procedure TfrmPedidosConsultaConcreto.btn_fecharClick(Sender: TObject);
begin
  inherited;
  gb_resumo.visible := false;
end;

procedure TfrmPedidosConsultaConcreto.dsConsultaDataChange(Sender: TObject;
  Field: TField);
begin
  inherited;
  pedido_id := qry.FieldByName('PEDIDO_ID').AsInteger;
  btn_detalhes.Enabled := not qry.IsEmpty;
end;

procedure TfrmPedidosConsultaConcreto.FormCreate(Sender: TObject);
begin
  inherited;
  pedido_id := -1;
end;

procedure TfrmPedidosConsultaConcreto.FormShow(Sender: TObject);
begin
  inherited;
  prc_componentes;
end;

procedure  TfrmPedidosConsultaConcreto.prc_componentes;

begin

  sql :=
        'select                                                         '+
        //'    i.id, i.pedido_id, pes.id,  pes.nome, i.data_entrega, i.situacao,'+
        '    i.id, i.pedido_id, pes.id,  pes.nome, ped.data_emissao, ped.data_entrega, i.situacao,'+
        //'    ped.vendedor_id, p.nome_fantasia, p.unidade, i.qtde, ped.pago        '+
        '    ped.vendedor_id, p.nome_fantasia, p.unidade, i.qtde, (i.qtde*i.venda) as total, ped.pago        '+
        'from                                                           '+
        '    pedidos_itens i, produtos p, PEDIDOS PED, PESSOAS PES      '+
        'where                                                          '+
        '  PED.id = I.pedido_id and                                     '+
        '  I.produto_id = P.id AND                                      '+
        '  ped.cliente_id = pes.id and                                  '+
        '  (P.concreto = ' + QuotedStr('S') +' or p.bomba =' + QuotedStr('S') +' )';

  qry_clientes.connection := conexao;
  qry_vendedores.connection := conexao;
  qry_clientes.Open;
  qry_vendedores.Open;

  cbxTipoVenda.ItemIndex := 0;
  dtp_entrega_ini.Date := date;
  dtp_entrega_fim.Date := date;

  dtp_data_ini.Date := date;
  dtp_data_fim.Date := date;

end;

procedure TfrmPedidosConsultaConcreto.SpeedButton1Click(Sender: TObject);
begin
  inherited;
  close;
end;

function TfrmPedidosConsultaConcreto.TotalizaConcreto: double;
var
  loqry : TFDQuery;
  loSql : string;
  qtde_concreto : double;
  vr_venda_concreto : double;
  qtde_faltante : double;
  vr_venda_faltante : double;
  qtde_pedidos : integer;
    qtde_bomba : integer;
    vr_venda_bomba : double;

begin
  // function para filtrar as vendas de concreto conforme parametro selecionados
  // aproveitei a sql da qry padrão(que filtra concreto faltante e bomba
  // tudo junto.
  // este function visa separa concreto, bomba e faltante
  try
    loqry := TFDQuery.Create(application);
    loqry.Connection := conexao;

    // filtra só o CONCRETO
    loSql :=
        'select                                                         '+
        '    i.venda, i.qtde        '+
        'from                                                           '+
        '    pedidos_itens i, produtos p, PEDIDOS PED, PESSOAS PES      '+
        'where                                                          '+
        '  PED.id = I.pedido_id and                                     '+
        '  I.produto_id = P.id AND                                      '+
        '  ped.cliente_id = pes.id and                                  '+
        '  (P.concreto = ' + QuotedStr('S') +' and (not (p.nome_fantasia =' + QuotedStr('FALTANTE DE CONCRETO') + ')) )';
    {monta a instrução sql}
    loqry.SQL.Clear;
    loqry.SQL.Add( losql + condicao ) ;


    {parametros}
    {cliente}
    if (cb_cliente.Checked) then
      if (cbxCliente.Text <> '') then
        loqry.ParamByName('CLIENTE_ID').AsInteger := cbxCliente.KeyValue
      else
        loqry.ParamByName('CLIENTE_ID').AsInteger := -1;

    {vendedor}
    if (cb_vendedor.Checked) then
      if  (cbxVendedor.Text <> '') then
        loqry.ParamByName('VENDEDOR_ID').AsInteger := cbxVendedor.KeyValue
      else
        loqry.ParamByName('VENDEDOR_ID').AsInteger := -1;

    {data entrega}
    if cb_entrega.Checked then
    begin
      loqry.ParamByName('DATA_INI').AsDate := dtp_entrega_ini.date;
      loqry.ParamByName('DATA_FIM').AsDate := dtp_entrega_fim.date;
    end;

  {data emissao}
  if cb_emissao.Checked then
  begin
    loqry.ParamByName('DATA_INI_EMI').AsDate := dtp_data_ini.date;
    loqry.ParamByName('DATA_FIM_EMI').AsDate := dtp_data_fim.date;
  end;


    {pedido ou orcamento}
    loqry.ParamByName('orcamento').AsString := orcamento;

    {entregue/aguardando/aberto}
    loqry.ParamByName('SITUACAO').AsString  := cbxSituacao.Text;

    {pago ou receber}
    loqry.ParamByName('PAGO').AsString := PAGO ;

    //ShowMessage(qry.SQL.text) ;
    loQRY.Open;

    // totais
    qtde_concreto := 0;
    vr_venda_concreto := 0;
    loqry.First;
    while not loqry.Eof do
    begin
      qtde_concreto     := qtde_concreto + loqry.FieldByName('qtde').AsFloat;
      vr_venda_concreto := vr_venda_concreto + loqry.FieldByName('qtde').AsFloat * loqry.FieldByName('venda').AsFloat;
      loqry.Next;
    end;
    // fim da parte do concreto


    // filtra só o FALTANTE
    loSql :=
        'select                                                         '+
        '    i.venda, i.qtde  '+
        'from                                                           '+
        '    pedidos_itens i, produtos p, PEDIDOS PED, PESSOAS PES      '+
        'where                                                          '+
        '  PED.id = I.pedido_id and                                     '+
        '  I.produto_id = P.id AND                                      '+
        '  ped.cliente_id = pes.id and                                  '+
        '  (P.concreto = ' + QuotedStr('S') +' and  (p.nome_fantasia =' + QuotedStr('FALTANTE DE CONCRETO') + ') )';
    {monta a instrução sql}
    loqry.SQL.Clear;
    loqry.SQL.Add( losql + condicao  ) ;


    {parametros}
    {cliente}
    if (cb_cliente.Checked) then
      if (cbxCliente.Text <> '') then
        loqry.ParamByName('CLIENTE_ID').AsInteger := cbxCliente.KeyValue
      else
        loqry.ParamByName('CLIENTE_ID').AsInteger := -1;

    {vendedor}
    if (cb_vendedor.Checked) then
      if  (cbxVendedor.Text <> '') then
        loqry.ParamByName('VENDEDOR_ID').AsInteger := cbxVendedor.KeyValue
      else
        loqry.ParamByName('VENDEDOR_ID').AsInteger := -1;

    {data entrega}
    if cb_entrega.Checked then
    begin
      loqry.ParamByName('DATA_INI').AsDate := dtp_entrega_ini.date;
      loqry.ParamByName('DATA_FIM').AsDate := dtp_entrega_fim.date;
    end;

  {data emissao}
  if cb_emissao.Checked then
  begin
    loqry.ParamByName('DATA_INI_EMI').AsDate := dtp_data_ini.date;
    loqry.ParamByName('DATA_FIM_EMI').AsDate := dtp_data_fim.date;
  end;

    {pedido ou orcamento}
    loqry.ParamByName('orcamento').AsString := orcamento;

    {entregue/aguardando/aberto}
    loqry.ParamByName('SITUACAO').AsString  := cbxSituacao.Text;

    {pago ou receber}
    loqry.ParamByName('PAGO').AsString := PAGO ;

    //ShowMessage(qry.SQL.text) ;
    loQRY.Open;

    // totais
    qtde_faltante := 0;
    vr_venda_faltante := 0;
    loqry.First;
    while not loqry.Eof do
    begin
      qtde_faltante     := qtde_faltante + loqry.FieldByName('qtde').AsFloat;
      vr_venda_faltante := vr_venda_faltante + loqry.FieldByName('qtde').AsFloat * loqry.FieldByName('venda').AsFloat;
      loqry.Next;
    end;

    // qtde de PEDIDOS
    loSql :=
        'select                                                         '+
        '   DISTINCT (ped.id )       '+
        'from                                                           '+
        '    pedidos_itens i, produtos p, PEDIDOS PED, PESSOAS PES      '+
        'where                                                          '+
        '  PED.id = I.pedido_id and                                     '+
        '  I.produto_id = P.id AND                                      '+
        '  ped.cliente_id = pes.id and                                  '+
        '  (P.concreto = ' + QuotedStr('S') +' or p.bomba =' + QuotedStr('S') +' )';

    {monta a instrução sql}
    loqry.SQL.Clear;
    loqry.SQL.Add( losql + condicao) ;


    {parametros}
    {cliente}
    if (cb_cliente.Checked) then
      if (cbxCliente.Text <> '') then
        loqry.ParamByName('CLIENTE_ID').AsInteger := cbxCliente.KeyValue
      else
        loqry.ParamByName('CLIENTE_ID').AsInteger := -1;

    {vendedor}
    if (cb_vendedor.Checked) then
      if  (cbxVendedor.Text <> '') then
        loqry.ParamByName('VENDEDOR_ID').AsInteger := cbxVendedor.KeyValue
      else
        loqry.ParamByName('VENDEDOR_ID').AsInteger := -1;

    {data entrega}
    if cb_entrega.Checked then
    begin
      loqry.ParamByName('DATA_INI').AsDate := dtp_entrega_ini.date;
      loqry.ParamByName('DATA_FIM').AsDate := dtp_entrega_fim.date;
    end;

  {data emissao}
  if cb_emissao.Checked then
  begin
    loqry.ParamByName('DATA_INI_EMI').AsDate := dtp_data_ini.date;
    loqry.ParamByName('DATA_FIM_EMI').AsDate := dtp_data_fim.date;
  end;

    {pedido ou orcamento}
    loqry.ParamByName('orcamento').AsString := orcamento;

    {entregue/aguardando/aberto}
    loqry.ParamByName('SITUACAO').AsString  := cbxSituacao.Text;

    {pago ou receber}
    loqry.ParamByName('PAGO').AsString := PAGO ;

    loQRY.Open;

    // totais
    qtde_pedidos := loqry.RecordCount;

    // filtra só o BOMBA
    loSql :=
        'select                                                         '+
        '    i.venda, i.qtde        '+
        'from                                                           '+
        '    pedidos_itens i, produtos p, PEDIDOS PED, PESSOAS PES      '+
        'where                                                          '+
        '  PED.id = I.pedido_id and                                     '+
        '  I.produto_id = P.id AND                                      '+
        '  ped.cliente_id = pes.id and                                  '+
        '  (P.BOMBA = ' + QuotedStr('S') + ' )';
    {monta a instrução sql}
    loqry.SQL.Clear;
    loqry.SQL.Add( losql + condicao ) ;


    {parametros}
    {cliente}
    if (cb_cliente.Checked) then
      if (cbxCliente.Text <> '') then
        loqry.ParamByName('CLIENTE_ID').AsInteger := cbxCliente.KeyValue
      else
        loqry.ParamByName('CLIENTE_ID').AsInteger := -1;

    {vendedor}
    if (cb_vendedor.Checked) then
      if  (cbxVendedor.Text <> '') then
        loqry.ParamByName('VENDEDOR_ID').AsInteger := cbxVendedor.KeyValue
      else
        loqry.ParamByName('VENDEDOR_ID').AsInteger := -1;

    {data entrega}
    if cb_entrega.Checked then
    begin
      loqry.ParamByName('DATA_INI').AsDate := dtp_entrega_ini.date;
      loqry.ParamByName('DATA_FIM').AsDate := dtp_entrega_fim.date;
    end;

  {data emissao}
  if cb_emissao.Checked then
  begin
    loqry.ParamByName('DATA_INI_EMI').AsDate := dtp_data_ini.date;
    loqry.ParamByName('DATA_FIM_EMI').AsDate := dtp_data_fim.date;
  end;

    {pedido ou orcamento}
    loqry.ParamByName('orcamento').AsString := orcamento;

    {entregue/aguardando/aberto}
    loqry.ParamByName('SITUACAO').AsString  := cbxSituacao.Text;

    {pago ou receber}
    loqry.ParamByName('PAGO').AsString := PAGO ;
 //   ShowMessage(loqry.SQL.Text);
    loQRY.Open;

    // totais
    qtde_bomba := 0;
    vr_venda_bomba := 0;
    loqry.First;
    while not loqry.Eof do
    begin
      qtde_bomba     := qtde_bomba + loqry.FieldByName('qtde').AsInteger;
      vr_venda_bomba := vr_venda_bomba + loqry.FieldByName('qtde').AsFloat * loqry.FieldByName('venda').AsFloat;
      loqry.Next;
    end;
    // fim da parte do concreto








    // atualiza painel
    lbl_qtde_pedidos.Caption := inttostr( qtde_pedidos );

    lbl_qtde_concreto.Caption := FormatFloat('0.00', qtde_concreto);
    lbl_venda_concreto.Caption := FormatFloat('R$ 0.00', vr_venda_concreto);

    lbl_qtde_faltante.Caption  := FormatFloat('0.00', qtde_faltante);
    lbl_venda_faltante.Caption := FormatFloat('R$ 0.00', vr_venda_faltante);

    lbl_qtde_bombas.Caption  := FormatFloat('0.00', qtde_bomba);
    lbl_venda_bomba.Caption := FormatFloat('R$ 0.00', vr_venda_bomba);

  finally
    freeandnil(loqry);
  end;

end;

end.
