unit ufrmCompras;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseGrade, Data.DB,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,
  FireDAC.Stan.Async, FireDAC.DApt, System.Actions, Vcl.ActnList,
  System.ImageList, Vcl.ImgList, Vcl.Menus, FireDAC.Comp.DataSet,
  FireDAC.Comp.Client, Vcl.Grids, Vcl.DBGrids, Vcl.ExtCtrls, Vcl.ComCtrls,
  Vcl.DBCtrls, Vcl.ToolWin, Vcl.StdCtrls, Vcl.Buttons;


type
  TfrmCompras = class(TfrmBaseGrade)
    ds_fornecedor: TDataSource;
    qry_fornecedores: TFDQuery;
    qryCOMPRAS_ID: TIntegerField;
    qryDATA_CONTABIL: TDateField;
    qryNUMERO_DOCUMENTO: TStringField;
    qryABERTO_ENTREGUE: TStringField;
    qryFORNECEDOR_ID: TIntegerField;
    qryNOME: TStringField;
    qryVALOR_COMPRA: TFMTBCDField;
    qryRECEBEMOS_EM: TDateField;
    gb_fornecedor: TGroupBox;
    cb_fornecedor: TCheckBox;
    cbx_fornecedor: TDBLookupComboBox;
    gb_data_compra: TGroupBox;
    Label1: TLabel;
    cb_data_compra: TCheckBox;
    dtp_data_ini: TDateTimePicker;
    dtp_data_fim: TDateTimePicker;
    rg_situacao: TRadioGroup;

    procedure FormCreate(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);

    procedure actIncluirExecute(Sender: TObject);
    procedure actAlterarExecute(Sender: TObject);
    procedure actExcluirExecute(Sender: TObject);

    procedure edt_consultaKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure qryABERTO_ENTREGUEGetText(Sender: TField; var Text: string;
      DisplayText: Boolean);
    procedure actPesquisarExecute(Sender: TObject);
    procedure actLocalizarExecute(Sender: TObject);
  private
    Ffornecedor_id: integer;
    procedure prc_sql;
    function  fnc_validar_pesquisa: boolean;
    procedure prc_pesquisar;

  public
    { Public declarations }
    property fornecedor_id :integer read Ffornecedor_id write Ffornecedor_id;
  end;

  var
 loForm : TfrmCompras;

  procedure prc_executa;

implementation

uses unit_principal, uBiblioteca, ufrmComprasE, ufrmFornecedores, unit_funcoes;

procedure prc_executa;
begin

  if loForm = nil then
  begin
    loForm := TfrmCompras.Create(Application);
    form_principal.prc_controla_menu(false);

    // se abrir dentro no painel principal não funciona os edites :(
    //loform.Parent := form_principal.pnl_principal;

    loform.top    :=  form_principal.pnl_Principal.Top;
    loform.Left   := form_principal.pnl_menulateral.Width;

    loForm.Width  := form_principal.pnl_principal.Width;
    loForm.Height := form_principal.pnl_principal.Height;
  end;
  loForm.Show;

end;


{$R *.dfm}

procedure TfrmCompras.prc_pesquisar;
begin

   qry.close;
   QRY.SQL.Clear;
   QRY.SQL.Add(sSql);

   if cb_fornecedor.Checked then
   begin
     qry.SQL.ADD(' and FORNECEDOR_ID =:FORNECEDOR_ID ');
     qry.ParamByName('FORNECEDOR_ID').AsInteger := cbx_fornecedor.KeyValue;
   end;

   if cb_data_compra.Checked then
   begin

     qry.SQL.ADD(' and DATA_CONTABIL >=:DATA_INI ');
     qry.SQL.ADD(' and DATA_CONTABIL <=:DATA_FIM ');
     qry.ParamByName('DATA_INI').AsDate := dtp_data_ini.Date;
     qry.ParamByName('DATA_FIM').AsDate := dtp_data_fim.Date;

   end;

   qry.SQL.ADD(' and ABERTO_ENTREGUE =:ABERTO_ENTREGUE ');
   qry.ParamByName('ABERTO_ENTREGUE').AsString := ubiblioteca.SeSenao(rg_situacao.ItemIndex = 0, 'A','E');

   QRY.Open;

   if qry.IsEmpty then
   begin
     CriarMensagem('AVISO','NÃO FOI ENCONTRADO NENHUM REGISTRO COM OS PARAMETROS INFORMADOS!')
   end;

end;

procedure TfrmCompras.prc_sql;
begin

  sSql :=
          'select                    ' +
          '    C.COMPRAS_ID,         ' +
          '    C.DATA_CONTABIL,      ' +
          '    C.NUMERO_DOCUMENTO,   ' +
          '    C.ABERTO_ENTREGUE,    ' +
          '    C.FORNECEDOR_ID,      ' +
          '    P.NOME,               ' +
          '    C.VALOR_COMPRA,       ' +
          '    C.RECEBEMOS_EM        ' +
          'from                      ' +
          '    COMPRAS C,PESSOAS P   ' +
          'where                     ' +
          '  P.ID = C.FORNECEDOR_ID  ';

  qry.sql.Clear;
  qry.sql.Add(sSql);

end;


procedure TfrmCompras.qryABERTO_ENTREGUEGetText(Sender: TField;
  var Text: string; DisplayText: Boolean);
begin
  inherited;
  if qry.FieldByName('ABERTO_ENTREGUE').AsString = 'E' then
    Text := 'ENTREGUE'
  else if qry.FieldByName('ABERTO_ENTREGUE').AsString = 'A' then
    Text := 'ABERTO'
end;

procedure TfrmCompras.actAlterarExecute(Sender: TObject);
var
  id : integer;
begin
  if DBGrid1.DataSource.DataSet.IsEmpty then exit;

  id := qry.fieldbyname('COMPRAS_ID').AsInteger;
  ufrmComprasE.prc_alterar(id);

  uBiblioteca.AtualizaQuery(qry);
  qry.Locate('COMPRAS_ID', id, []);

  inherited;
end;

procedure TfrmCompras.actExcluirExecute(Sender: TObject);
begin
  ufrmComprasE.prc_excluir(qry.fieldbyname('COMPRAS_ID').AsInteger);
  uBiblioteca.AtualizaQuery(qry);
  inherited;

end;

procedure TfrmCompras.actIncluirExecute(Sender: TObject);
begin

  ufrmComprasE.prc_incluir;
  uBiblioteca.AtualizaQuery(qry);

  inherited;

end;

procedure TfrmCompras.actLocalizarExecute(Sender: TObject);
begin
  inherited;
 if fnc_validar_pesquisa then
   prc_pesquisar;
end;

procedure TfrmCompras.actPesquisarExecute(Sender: TObject);
begin
 // inherited;
  if btnPesquisar.Caption = 'Pesquisa >>' then
  begin
    btnPesquisar.Caption := '<< Ocultar Pesquisa';
    GroupBoxPesquisa.Height := 88;

  end
  else
   begin
     btnPesquisar.Caption := 'Pesquisa >>';
     GroupBoxPesquisa.Height := 0;
   end;


end;

procedure TfrmCompras.edt_consultaKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
//  inherited;

end;

function TfrmCompras.fnc_validar_pesquisa: boolean;
begin
   result := FALSE;

   if cb_fornecedor.Checked then
   begin
     if cbx_fornecedor.Text = '' then
     begin
       CriarMensagem('AVISO','INFORME UM FORNECEDOR.');
       cbx_fornecedor.SetFocus;
       exit;
     end;
   end;

   if cb_data_compra.Checked then
   begin
     if dtp_data_ini.Date > dtp_data_fim.Date then
     begin
       CriarMensagem('AVISO','INFORME UM PERIODO VÁLIDO');
       dtp_data_fim.SetFocus;
       exit;
     end;
   end;

   if rg_situacao.ItemIndex = -1 then
   begin
       CriarMensagem('AVISO','INFORME A SITUAÇÃO DA COMPRA');
       rg_situacao.SetFocus;
       exit;
   end;

   result := TRUE;
end;

procedure TfrmCompras.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  inherited;

  form_principal.prc_controla_menu(true);
  FreeAndNil(loForm);

end;

procedure TfrmCompras.FormCreate(Sender: TObject);
begin


  self.Tabela := 'COMPRAS';
  prc_sql;

  inherited;

  qry_fornecedores.Connection := conexao;
  qry_fornecedores.Open;


  dtp_data_ini.Date := date;
  dtp_data_fim.Date := date;

  DBGrid1.Columns[0].Visible := FALSE;// COMPRAS ID
  DBGrid1.Columns[2].Visible := FALSE;// COD FORNECEDOR



end;

end.
