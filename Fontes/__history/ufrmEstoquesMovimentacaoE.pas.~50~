unit ufrmEstoquesMovimentacaoE;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseEdicao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.ExtCtrls, uTipos, Vcl.DBCtrls, Vcl.Mask;

type
  TfrmEstoquesMovimentacaoE = class(TfrmBaseEdicao)
    Label13: TLabel;
    edt_quantidade: TEdit;
    rg_movimento: TRadioGroup;
    Label2: TLabel;
    edt_historico: TEdit;
    Label1: TLabel;
    lbl_Id: TLabel;
    Label3: TLabel;
    lbl_cadastrado_em: TLabel;
    Label4: TLabel;
    lbl_alterado_em: TLabel;
    cbx_produto: TDBLookupComboBox;
    Label5: TLabel;
    edt_id_produto: TDBEdit;
    btn_produto: TSpeedButton;
    edt_unidade: TDBEdit;

    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);

    procedure btnOkClick(Sender: TObject);
    procedure btn_produtoClick(Sender: TObject);
  private
    FOperacao: uTipos.TOperacao;
    FTitulo: string;
    FTabela: string;
    FCodigo: integer;
    FProduto: integer;
    procedure prc_componentes;
    procedure prc_inicializar;
    procedure prc_ler_dados;
    function prc_validar: boolean;
    procedure prc_salvar;
(*    procedure prc_incluir_alterar(operacao: TOperacao;
                estoque_id, produto: integer; historico: string; quantidade: double);
*)
    { Private declarations }
  public
    // quando a operação for alterar, guardo o valor inicial da qtde
    var qtde_na_edicao: double;

    property Codigo   :integer read FCodigo write FCodigo;
    property Operacao :uTipos.TOperacao read FOperacao write FOperacao;
    property Tabela   :string read FTabela write FTabela;
    property Titulo   :string read FTitulo write FTitulo;
    property Produto  :integer read FProduto write FProduto;
  end;

  procedure Incluir(Produto_id :integer);
  procedure Alterar(ACodigo :integer);
  procedure Excluir(ACodigo :integer);

implementation

uses uBiblioteca, ufrmPesquisaProdutos, unit_funcoes, unit_controle_estoques;



procedure Incluir(Produto_id :integer);
var
  loForm : TfrmEstoquesMovimentacaoE;
begin
  loForm := TfrmEstoquesMovimentacaoE.Create(Application);
  try
    loForm.Operacao := uTipos.opIncluir;
    loForm.Produto  := Produto_id;
    loform.Codigo   := -1;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

procedure Alterar(ACodigo :integer);
var
  loForm : TfrmEstoquesMovimentacaoE;
begin
  loForm := TfrmEstoquesMovimentacaoE.Create(Application);
  try
    loForm.Operacao := uTipos.opAlterar;
    loForm.Codigo   := ACodigo;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

procedure Excluir(ACodigo :integer);
var
  loForm : TfrmEstoquesMovimentacaoE;
begin
  loForm := TfrmEstoquesMovimentacaoE.Create(Application);
  try
    loForm.Operacao := uTipos.opExcluir;
    loForm.Codigo   := ACodigo;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;


{$R *.dfm}

procedure TfrmEstoquesMovimentacaoE.btnOkClick(Sender: TObject);
begin
  inherited;
  prc_salvar;
end;

procedure TfrmEstoquesMovimentacaoE.btn_produtoClick(Sender: TObject);
begin
  try
    if frmPesquisaProdutos = nil then
      frmPesquisaProdutos := TfrmPesquisaProdutos.Create(application);

    // esconde paineis de preços
    frmPesquisaProdutos.gb_Preco_vendedor.Visible   := false;
    frmPesquisaProdutos.gb_preco_fornecedor.Visible := false;
    frmPesquisaProdutos.gbPrecoVenda.Visible        := false;
    frmPesquisaProdutos.gbItemPedido.Visible        := false;
    frmPesquisaProdutos.gbQtde.Visible              := false;
    frmPesquisaProdutos.btnConfirma.Caption         := 'Selecionar';
    frmPesquisaProdutos.lbl_forma_pagamento.Visible := false;
    frmPesquisaProdutos.ShowModal;
    // posiciona no produto escolhido
    cbx_produto.KeyValue := frmPesquisaProdutos.Produto;
  finally
     frmPesquisaProdutos.qry.Close;
     FreeAndNil(frmPesquisaProdutos);
  end;
end;

procedure TfrmEstoquesMovimentacaoE.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
  inherited;
  qry.close;;

end;

procedure TfrmEstoquesMovimentacaoE.FormCreate(Sender: TObject);
begin
  inherited;
  qry.Connection := self.Conexao;
  self.Tabela    := 'ESTOQUES_MOVIMENTACAO';

end;

procedure TfrmEstoquesMovimentacaoE.FormShow(Sender: TObject);
begin
  inherited;
  prc_componentes;
  prc_inicializar;

end;

procedure TfrmEstoquesMovimentacaoE.prc_componentes;
begin
  {qry de principal estou usando pra listar os produtos}
  qry.Connection := Conexao;
  qry.Close;
  qry.SQL.Clear;
  qry.SQL.Add('select ID, NOME_FANTASIA, UNIDADE from PRODUTOS where REVENDA = ' + QuotedStr('S') + ' or VIGA = ' + QuotedStr('S') +  ' order by NOME_FANTASIA');
  qry.Open;

end;

procedure TfrmEstoquesMovimentacaoE.prc_inicializar;
begin

  pnTitulo.Caption := 'MANUTENÇÃO DE ESTOQUES';

  case self.Operacao of
  uTipos.opIncluir: begin

                       lbl_sub_titulo.Caption := 'INCLUSÃO';
                       pnDados.Enabled        := true;
                       cbx_produto.KeyValue   := produto;
                       // se tiver um produto seleciona é
                       // pq o usuario escolheu o produto na tela
                       // anterior. então trava
                       if cbx_produto.Text <> '' then
                       begin
                         cbx_produto.Enabled := false;
                         btn_produto.Enabled := false;
                       end;
                       lbl_Id.Caption := '-1';
                       lbl_cadastrado_em.Caption := DateToStr(Date);
                       btnOk.Caption := 'Incluir';

                     end;
  uTipos.opAlterar: begin

                      prc_ler_dados;
                      lbl_sub_titulo.Caption := 'ALTERAÇÃO';
                      btnOk.Caption    := 'Alterar';
                      //
                      btnOk.SetFocus;

                    end;
  uTipos.opExcluir: begin

                      prc_ler_dados;
                      lbl_sub_titulo.Caption := 'EXCLUIR';
                      pnDados.Enabled     := false;
                      btnOk.Caption       := 'Excluir';
                      btnFechar.SetFocus;

                    end;
  else
    begin
      pnDados.Enabled   := false;
      if btnFechar.CanFocus then btnFechar.SetFocus;
    end;
  end;


end;

procedure TfrmEstoquesMovimentacaoE.prc_ler_dados;
var
 loQry: TFDQuery;
begin

  try

    loQry := TFDQuery.Create(Self);
    try
      with loQry, loQry.Sql do
      begin
        Connection := Self.Conexao;
        Add('SELECT * FROM ' + Self.Tabela + ' WHERE ESTOQUES_ID =:ID');
        ParamByName('ID').AsInteger := Codigo;
        Open;
      end;
      if not loQry.IsEmpty then
      begin
        //não será permitido alterar o produto
        cbx_produto.Enabled := false;
        btn_produto.Enabled := false;

        lbl_Id.Caption             := loQry.FieldByName('ESTOQUES_ID').AsString;
        lbl_cadastrado_em.Caption  := loQry.FieldByName('DATA').AsString;
        lbl_alterado_em.Caption    := loQry.FieldByName('ALTERADO_EM').AsString;
        cbx_produto.KeyValue       := loQry.FieldByName('PRODUTO_ID').AsInteger;
        edt_quantidade.Text        := uBiblioteca.SeSenao( loQry.FieldByName('ENTRADA').AsFloat > 0, loQry.FieldByName('ENTRADA').AsFloat, loQry.FieldByName('SAIDA').AsFloat  );
        rg_movimento.ItemIndex     := ubiblioteca.SeSenao(loQry.FieldByName('ENTRADA').AsFloat > 0, 0, 1 );
        edt_historico.Text         := loQry.FieldByName('HISTORICO').AsString;

        // após carregar o edt_quantidade, carrego a var qtde_na_edicao
        qtde_na_edicao := strtofloat(edt_quantidade.Text);

      end
      else
      begin
        criarMensagem('AVISO','LANÇAMENTO NÃO ENCONTRADO!');

      end;
    finally
      loQry.Close;
      FreeAndNil(loQry);
    end;
  except
    on E : Exception do
       Raise Exception.Create(E.Message + ' [ ' + Self.Name + '.prc_ler_dados ]');
  end;
end;

function TfrmEstoquesMovimentacaoE.prc_validar: boolean;
begin
  result := false;

  if cbx_produto.Text = '' then
  begin
    criarMensagem('AVISO','Selecione um PRODUTO');
    cbx_produto.SetFocus;
    exit;
  end;



  if StrToFloatDef( edt_quantidade.text, 0 ) <= 0 then
  begin
    criarMensagem('AVISO','informe uma QUANTIDADE VÁLIDA maior que zero');
    edt_quantidade.SetFocus;
    exit;
  end;

  if rg_movimento.ItemIndex = -1 then
  begin
    criarMensagem('AVISO','selecione o TIPO DE MOVIMENTO');
    rg_movimento.SetFocus;
    exit;
  end;

  if edt_historico.text = '' then
  begin
    criarMensagem('AVISO','descreva a MOVIMENTAÇÃO');
    edt_historico.SetFocus;
    exit;
  end;

  result := true;
end;

procedure TfrmEstoquesMovimentacaoE.prc_salvar;
var
  tipo_movimento: string;
begin
  if not prc_validar then Exit;

  if not Self.Conexao.InTransaction then Self.Conexao.StartTransaction;
  //***
  try
    tipo_movimento := ubiblioteca.SeSenao(rg_movimento.ItemIndex = 0, 'ENTRADA','SAIDA');

    {atualiza os saldos de estoque na tabela de produtos}
    unit_controle_estoques.prc_atualizar_estoque(
                                                 cbx_produto.KeyValue,
                                                 tipo_movimento,
                                                 'ENTREGUE', // coloco esse valor para procedure funcionar corretamente
                                                 strtofloat(edt_quantidade.Text)
                                                );
    {lança o registro na tabela de estoques_movimentacao}
    unit_controle_estoques.prc_incluir_alterar(
                                               Operacao,
                                               tipo_movimento,
                                               'ESTOQUES_MOVIMENTACAO',
                                               -1,
                                               cbx_produto.KeyValue,
                                               edt_historico.Text,
                                               strtofloat(edt_quantidade.Text)
                                               );

    if Self.Conexao.InTransaction then Self.Conexao.Commit;
    close;
  except
   conexao.Rollback;
   criarMensagem('AVISO','Não foi possível salvar o registro');
 //   on E : Exception do
 //      Raise Exception.Create(E.Message );
  end;

end;
(*
procedure TfrmEstoquesMovimentacaoE.prc_incluir_alterar(operacao: TOperacao;
                estoque_id, produto: integer; historico: string; quantidade: double);
var
  loQry : TFDQuery;
  estoque_atual : double;
begin
  try
    loQry := TFDQuery.Create(application);
    loqry.Connection := conexao;

    {buscar último saldo atual do produto}
    loQry.sql.clear;
    loqry.SQL.Add(' select * from ESTOQUES_MOVIMENTACAO where PRODUTO_ID =:PRODUTO_ID order by ESTOQUES_ID' );
    loQry.ParamByName('PRODUTO_ID').AsInteger := produto;
    loqry.Open;
    if not loQry.IsEmpty then
    begin
      loQry.Last;
      estoque_atual := loQry.FieldByName('ESTOQUE_FISICO').AsFloat;
    end
    else if loQry.IsEmpty then
    begin
      estoque_atual := 0;
    end;

    // limpa a query
    loQry.sql.clear;
    if operacao = opExcluir then
    begin
      //loQry.SQL.Add('update '+ self.Tabela + ' set ATIVO = ''N'' where id =:id');
      //loQry.ParamByName('id').AsInteger := Codigo;
      //loQry.ExecSQL;
      exit;
    end;

    if operacao = OpIncluir then
    begin
      loQry.SQL.Add('insert into ' + self.Tabela );
      loQry.SQL.Add('(');
      //loQry.SQL.Add('  ESTOQUES_ID,  ');
      loQry.SQL.Add('  PRODUTO_ID,     ');
      loQry.SQL.Add('  DATA,           ');
      loQry.SQL.Add('  HISTORICO,      ');
      loQry.SQL.Add('  ENTRADA,        ');
      loQry.SQL.Add('  SAIDA,          ');
      loQry.SQL.Add('  ESTOQUE_FISICO  ');
      loQry.SQL.Add(')                 ');
      loQry.SQL.Add('VALUES            ');
      loQry.SQL.Add('(                 ');
      //loQry.SQL.Add('  ESTOQUES_ID,  ');
      loQry.SQL.Add('  :PRODUTO_ID,    ');
      loQry.SQL.Add('  :DATA,          ');
      loQry.SQL.Add('  :HISTORICO,     ');
      loQry.SQL.Add('  :ENTRADA,       ');
      loQry.SQL.Add('  :SAIDA,         ');
      loQry.SQL.Add('  :ESTOQUE_FISICO ');
      loQry.SQL.Add(')                 ');
     // loQry.SQL.Add('returning ID  ');

      loQry.ParamByName('DATA').AsDate := Date;
    end
    else if operacao = opAlterar then
    begin

      //devolvo as quantidades e atualizo com a quantidade atual
      if rg_movimento.ItemIndex = 0 then
         estoque_atual := estoque_atual - qtde_na_edicao
      else if rg_movimento.ItemIndex = 1 then
         estoque_atual := estoque_atual + qtde_na_edicao;


      loQry.SQL.Add('UPDATE                             ');
      loQry.SQL.Add(Tabela);
      loQry.SQL.Add('SET                                ');
      loQry.SQL.Add('  PRODUTO_ID     = :PRODUTO_ID,    ');
      loQry.SQL.Add('  ALTERADO_EM    = :ALTERADO_EM,   ');
      loQry.SQL.Add('  HISTORICO      = :HISTORICO,     ');
      loQry.SQL.Add('  ENTRADA        = :ENTRADA,       ');
      loQry.SQL.Add('  SAIDA          = :SAIDA,         ');
      loQry.SQL.Add('  ESTOQUE_FISICO = :ESTOQUE_FISICO ');
      loQry.SQL.Add('WHERE                              ');
      loQry.SQL.Add('  ESTOQUES_ID = :ID                ');
      //
      //loQry.ParamByName('ID').AsInteger          := Codigo;
      loQry.ParamByName('ID').AsInteger          := estoque_id;
      loQry.ParamByName('ALTERADO_EM').AsDate    := Date;

    end;
    //ShowMessage(loQry.SQL.Text);

    loQry.ParamByName('PRODUTO_ID').AsInteger   := produto;
    loQry.ParamByName('HISTORICO').AsString     := historico;// edt_historico.Text;
    //loQry.ParamByName('ENTRADA').AsFloat        := uBiblioteca.SeSenao(rg_movimento.ItemIndex = 0, strtofloat(edt_quantidade.Text), 0 ) ;
    //loQry.ParamByName('SAIDA').AsFloat          := uBiblioteca.SeSenao(rg_movimento.ItemIndex = 1, strtofloat(edt_quantidade.Text), 0 ) ;
    loQry.ParamByName('ENTRADA').AsFloat        := uBiblioteca.SeSenao(rg_movimento.ItemIndex = 0, quantidade, 0 ) ;
    loQry.ParamByName('SAIDA').AsFloat          := uBiblioteca.SeSenao(rg_movimento.ItemIndex = 1, quantidade, 0 ) ;

    loQry.ParamByName('ESTOQUE_FISICO').AsFloat := uBiblioteca.SeSenao(rg_movimento.ItemIndex = 0,
                                                                       estoque_atual + strtofloat(edt_quantidade.Text),
                                                                       estoque_atual - strtofloat(edt_quantidade.Text) );

    loQry.ExecSQL;
    (*
    //exemplo de como pegar o id do registro gerado
    if operacao = OpIncluir then
    begin
      loQry.Open;
      Codigo := loQry.FieldByName('id').AsInteger;

    end
    else
    begin
      loQry.ExecSQL;
    end;
    *)
 // finally
  //  FreeAndNil(loQry);
//  end;
//end;




end.
