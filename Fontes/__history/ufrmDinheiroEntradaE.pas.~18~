unit ufrmDinheiroEntradaE;
// 30/04/2025
// esta unit vou usar para cadastrar entradas em dinheiro avulsas e
// tambem entradas em dinheiro da unit de recibos
// a idéia é quando for entrada avulsa salve no banco de dados a entrada
// na tabela de entrada em dinheiro e na tabela de movimentação de dinheiro
// quando for no recibo esta tela só servira pra pegar o valor a gravação
// no banco de dados se dará na confirmação do recibo.

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseEdicao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.ExtCtrls, uTipos, uBiblioteca, unit_funcoes, uFinanceiro;

type
  TfrmDinheiroEntradaE = class(TfrmBaseEdicao)
    Label2: TLabel;
    Label3: TLabel;
    Label7: TLabel;
    edt_id: TPanel;
    edt_cadastrado_em: TPanel;
    edt_valor: TEdit;
    edt_observacao: TEdit;
    Label1: TLabel;
    cb_contas_pagar: TCheckBox;

    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);

    procedure edt_valorKeyPress(Sender: TObject; var Key: Char);
    procedure edt_valorExit(Sender: TObject);
    procedure btnOkClick(Sender: TObject);
  private
    FOperacao: uTipos.TOperacao;
    FTitulo: string;
    FTabela: string;
    FCodigo: integer;

    procedure prc_componentes;
    procedure prc_inicializar;
    function fnc_validar: boolean;
    procedure prc_ler_dados;
    procedure prc_salvar;
    procedure prc_incluir_alterar(_operacao: TOperacao);

  public
    property Codigo   :integer read FCodigo write FCodigo;
    property Operacao :uTipos.TOperacao read FOperacao write FOperacao;
    property Tabela   :string read FTabela write FTabela;
    //property Titulo   :string read FTitulo write FTitulo;

  end;

var
  frmDinheiroEntradaE: TfrmDinheiroEntradaE;

implementation

{$R *.dfm}

procedure TfrmDinheiroEntradaE.btnOkClick(Sender: TObject);
begin
  inherited;
  prc_salvar;

end;

procedure TfrmDinheiroEntradaE.edt_valorExit(Sender: TObject);
begin
  inherited;
  prc_formata_dinheiro(sender);
end;

procedure TfrmDinheiroEntradaE.edt_valorKeyPress(Sender: TObject;
  var Key: Char);
begin
  inherited;
  prc_somente_numeros(sender, key);
end;

function TfrmDinheiroEntradaE.fnc_validar: boolean;
begin

  result := false;
  if strtofloatdef(edt_valor.Text, 0) <= 0 then
  begin
    CriarMensagem('ERRO','INFORME UM VALOR VÁLIDO');
    edt_valor.setfocus;
    exit;
  end;

  if edt_observacao.Text = '' then
  begin
    CriarMensagem('AVISO','DESCREVA A ENTRADA EM DINHEIRO');
    edt_observacao.setfocus;
    exit;
  end;

  result := true;
end;

procedure TfrmDinheiroEntradaE.FormCreate(Sender: TObject);
begin
  inherited;
  qry.Connection := self.Conexao;
  Tabela := 'DINHEIRO_ENTRADA';
  titulo := 'ENTRADA EM DINHEIRO'

end;

procedure TfrmDinheiroEntradaE.FormShow(Sender: TObject);
begin
  inherited;
  prc_componentes;
  prc_inicializar;

end;

procedure TfrmDinheiroEntradaE.prc_componentes;
begin
  {qry de entrada de dinheiro}
  qry.SQL.Clear;
  qry.SQL.Add('select ID, CADASTRADO_EM, VALOR, OBS, RECIBO_ID from DINHEIRO_ENTRADA where ID =:ID');
end;

procedure TfrmDinheiroEntradaE.prc_inicializar;
begin
  case self.Operacao of
  uTipos.opIncluir: begin
                       pnDados.Enabled        := true;
                       lbl_sub_titulo.Caption := 'Incluir uma nova entrada em dinheiro';

                       edt_Id.Caption            := '-1';
                       edt_cadastrado_em.Caption := DateToStr(Date);
                       btnOk     .Caption        := 'Incluir';
                       qry.Close;
                     end;
  uTipos.opAlterar: begin
                      prc_ler_dados;
                      lbl_sub_titulo.Caption := 'Alterar um lançamento em dinheiro.';
                      btnOk.Caption          := 'Alterar';
                      //
                      btnOk.SetFocus;
                    end;
  uTipos.opExcluir: begin
                      prc_ler_dados;
                      lbl_sub_titulo.Caption := 'Excluir um lançamento em dinheiro.';
                      btnOk.Caption          := 'Excluir';
                      btnFechar.SetFocus;
                    end;
  else
    begin
      pnDados.Enabled       := false;
      if btnFechar.CanFocus then btnFechar.SetFocus;
    end;
  end;

end;


procedure TfrmDinheiroEntradaE.prc_ler_dados;
var
  loQry: TFDQuery;
begin
  try

    loQry:= TFDQuery.Create(self);
    loQry.Connection := conexao;
    loQry.SQL.Clear;
    loqry.sql.Add('select * from ' + tabela + ' where ID = :ID');
    loQry.Params.ParamByName('ID').AsInteger := Codigo;
    loQry.Open;
    // preencher dados da produção
    edt_id.Caption              := loQry.FieldByName('ID').AsString;
    edt_Cadastrado_em.Caption   := loQry.FieldByName('CADASTRADO_EM').AsString;
    edt_valor.Text              := formatfloat('0.00',loQry.FieldByName('VALOR').Asfloat);
    edt_observacao.Text         := loQry.FieldByName('OBS').AsString;

  finally
    loQry.Close;
    FreeAndNil(loQry) ;
  end;
end;

procedure TfrmDinheiroEntradaE.prc_salvar;
begin
  if not fnc_validar then Exit;

  {enviar lançameto ao contas a pagar}
  if cb_contas_pagar.Checked then
  begin
    if criarmensagem('CONFIRMACAO', 'DESEJA ENVIAR ESTE LANÇAMENTO AO CONTAS A PAGAR?')  then
    begin
      // chamar tela seleçao de contas



    end;
  end;


  if not conexao.InTransaction then conexao.StartTransaction;
  //***
  try
    prc_incluir_alterar(Operacao);

    if conexao.InTransaction then conexao.Commit;

    CriarMensagem('AVISO',' ENTRADA CADASTRADA COM SUCESSO! ');

    Close;
  except
    on E : Exception do
       begin
         CriarMensagem('AVISO','NÃO FOI POSSIVEL SALVAR O REGISTRO.' + slinebreak + slinebreak + E.Message);
         if conexao.InTransaction then
           conexao.Rollback;
         //***
         Raise;
       end;
  end;

end;

procedure TfrmDinheiroEntradaE.prc_incluir_alterar(_operacao: TOperacao);
begin
//ShowMessage('ENTREI');
  qry.sql.clear;
  if _operacao = opExcluir then
  begin
    (*
    qry.SQL.Add('update ' + Tabela + ' set ATIVO = ''N'' where ID =:ID');
    qry.ParamByName('ID').AsInteger := Codigo;
    qry.ExecSQL;
    exit;
    *)
    if CriarMensagem('DELETE','DESEJA EXCLUIR ESTE LANÇAMENTO?') then
    begin
      qry.SQL.Add('delete from ' + Tabela + ' where ID =:ID');
      qry.ParamByName('ID').AsInteger := Codigo;
      qry.ExecSQL;
    end;
    exit;

  end;

  if _operacao = OpIncluir then
  begin
//ShowMessage('incluir');
    qry.SQL.Add('insert into ' + Tabela );  // DINHEIRO_ENTRADA
    qry.SQL.Add('(');
    qry.SQL.Add('  CADASTRADO_EM, ');
    qry.SQL.Add('  VALOR,         ');
    qry.SQL.Add('  OBS,           ');
    qry.SQL.Add('  RECIBO_ID      ');
    qry.SQL.Add(')                ');
    qry.SQL.Add('VALUES           ');
    qry.SQL.Add('(                ');
    qry.SQL.Add(' :CADASTRADO_EM, ');
    qry.SQL.Add(' :VALOR,         ');
    qry.SQL.Add(' :OBS,           ');
    qry.SQL.Add(' :RECIBO_ID      ');
    qry.SQL.Add(')                ');
    qry.SQL.Add('returning ID     ');

    qry.ParamByName('CADASTRADO_EM').AsDate := Date;
  end
  else
  if _operacao = opAlterar then
  begin
    qry.SQL.Add('UPDATE                   ');
    qry.SQL.Add(Tabela);
    qry.SQL.Add('SET                      ');
    qry.SQL.Add('  VALOR     = :VALOR,    ');
    qry.SQL.Add('  OBS       = :OBS,      ');
    qry.SQL.Add('  RECIBO_ID = :RECIBO_ID ');
    qry.SQL.Add('WHERE                    ');
    qry.SQL.Add('  ID = :ID               ');
    //
    qry.ParamByName('ID').AsInteger := Codigo;

  end;

  qry.ParamByName('VALOR').AsFloat       := StrToFloatDef(edt_valor.Text,0);
  qry.ParamByName('OBS').AsString        := edt_observacao.Text;
  {-1 será o valor default para entradas avulsas, pois não será viculada a
   nenhum recibo de pagamento}
  qry.ParamByName('RECIBO_ID').AsInteger := -1;

  //ShowMessage(qry.SQL.Text);

  if _operacao = opincluir then
  begin
    QRY.Open;
    codigo := qry.FieldByName('ID').AsInteger;
  end
  else
  if (_operacao = opalterar) or (_operacao = opExcluir) then
  begin
    qry.ExecSQL;
  end;

  {incluir lançamento na tabela de dinheiro_movimentacao}
  ufinanceiro.prc_incluir_movimento_caixa(Tabela, Codigo, 'ENTRADA', edt_observacao.Text, StrToFloatDef(edt_valor.Text,0));

  {incluir lançamento no contas a pagar}
  if cb_contas_pagar.Checked then
  begin

  end;

end;





end.
