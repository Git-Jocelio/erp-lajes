//***************************************************************************//
// Cadastro de Contas a Pagar
// desenvolvida por Jocelio G Silva
// inicio : 01/11/2023 Deus seja louvado.
// fim :
//***************************************************************************//

unit ufrmContasPagar;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseGrade, Data.DB,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,
  FireDAC.Stan.Async, FireDAC.DApt, System.Actions, Vcl.ActnList,
  System.ImageList, Vcl.ImgList, Vcl.Menus, FireDAC.Comp.DataSet,
  FireDAC.Comp.Client, Vcl.Grids, Vcl.DBGrids, Vcl.ExtCtrls, Vcl.ComCtrls,
  Vcl.ToolWin, Vcl.DBCtrls, Vcl.StdCtrls, Vcl.Buttons, uBiblioteca,
  ufrmContasPagarE, ufrmContasPagar_Baixa, frxClass, frxDBSet;

type
  TfrmContasPagar = class(TfrmBaseGrade)
    qryPlanoContas: TFDQuery;
    dsPessoas: TDataSource;
    qryPessoas: TFDQuery;
    ds_plano_contas: TDataSource;
    btn_baixar: TToolButton;
    actBaixar: TAction;
    qryID: TIntegerField;
    qryPESSOA_NOME: TStringField;
    qryDESCRICAO_PLANO_CONTAS: TStringField;
    qryCADASTRADO_EM: TDateField;
    qryNR_DOCUMENTO: TStringField;
    qryDESCRICAO: TStringField;
    qryPESSOA_ID: TIntegerField;
    qryTABELA_ORIGEM: TStringField;
    qryTABELA_ID: TIntegerField;
    qryDATA_VENC: TDateField;
    qryTOTAL_PARCELA: TFMTBCDField;
    qryVALOR_PAGO: TFMTBCDField;
    qrySALDO_ABERTO: TFMTBCDField;
    qryPAGO: TStringField;
    frxReportContaPagar: TfrxReport;
    frxDBContasPagar: TfrxDBDataset;
    frxDBEmpresa: TfrxDBDataset;
    qryEmpresa: TFDQuery;
    frxDBImagem: TfrxDBDataset;
    qryImagemRelatorio: TFDQuery;
    gb_ver_coluna: TGroupBox;
    cb_coluna_plano_contas: TCheckBox;
    cb_coluna_pessoa: TCheckBox;
    gbEmissao: TGroupBox;
    Label7: TLabel;
    cb_cadatrado_em: TCheckBox;
    dtp_emissao_ini: TDateTimePicker;
    dtp_emissao_fim: TDateTimePicker;
    gb_data_contabil: TGroupBox;
    Label5: TLabel;
    cb_data_vencimento: TCheckBox;
    dtp_data_vencimento_ini: TDateTimePicker;
    dtp_data_vencimento_fim: TDateTimePicker;
    gb_plano_contas: TGroupBox;
    cb_plano_contas: TCheckBox;
    cbx_plano_contas: TDBLookupComboBox;
    gbValor: TGroupBox;
    Label6: TLabel;
    cb_valor: TCheckBox;
    edt_valor1: TEdit;
    edt_valor2: TEdit;
    gb_tipo_conta: TGroupBox;
    edt_historico: TEdit;
    cb_historico: TCheckBox;
    rg_situacao: TRadioGroup;
    gbPessoa: TGroupBox;
    cbx_pessoas: TDBLookupComboBox;
    cb_pessoa: TCheckBox;
    rg_pessoas: TRadioGroup;

    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);

    procedure actIncluirExecute(Sender: TObject);
    procedure actAlterarExecute(Sender: TObject);
    procedure actExcluirExecute(Sender: TObject);
    procedure actPesquisarExecute(Sender: TObject);
    procedure actLocalizarExecute(Sender: TObject);
    procedure actBaixarExecute(Sender: TObject);

    procedure cb_coluna_plano_contasClick(Sender: TObject);
    procedure cb_coluna_pessoaClick(Sender: TObject);

    procedure dsDataChange(Sender: TObject; Field: TField);

    procedure DBGrid1TitleClick(Column: TColumn);
    procedure rg_pessoasClick(Sender: TObject);
    procedure actImprimirExecute(Sender: TObject);
  private
    //procedure sSql;
    function  fnc_validar_pesquisa: boolean;
    procedure prc_pesquisar;
  public


    //pega o nome do campo dessa coluna
    NomeCampo : string ;
    // pega o tipo do campo da coluna (integer, string, etc)
    TipoCampo : TFieldType;

    procedure prc_componentes;
    procedure prc_sql;
  end;

var
  loForm :  TfrmContasPagar;

  procedure prc_executa;

implementation

uses unit_principal, udmConn, unit_funcoes;

procedure prc_executa;
begin

  if loForm = nil then
  begin

    loForm := TfrmContasPagar.Create(Application);
    form_principal.prc_controla_menu(false);

    // se abrir dentro no painel principal não funciona os edites :(
    //loform.Parent := form_principal.pnl_principal;

    loform.top    :=  form_principal.pnl_Principal.Top;
    loform.Left   := form_principal.pnl_menulateral.Width;

    loForm.Width  := form_principal.pnl_principal.Width;
    loForm.Height := form_principal.pnl_principal.Height;

  end;
  loForm.Show;

end;

{$R *.dfm}

procedure TfrmContasPagar.actAlterarExecute(Sender: TObject);
begin
  inherited;
  ufrmContasPagarE.prc_alterar(qry.fieldbyname('ID').AsInteger);
  uBiblioteca.AtualizaQuery(qry);

end;

procedure TfrmContasPagar.actBaixarExecute(Sender: TObject);
begin
  inherited;
  ufrmContasPagar_Baixa.executa(qry.FieldByName('ID').AsInteger,
                                qry.FieldByName('PESSOA_NOME').AsString,
                                qry.FieldByName('SALDO_ABERTO').AsFloat);

  uBiblioteca.AtualizaQuery(qry);

end;

procedure TfrmContasPagar.actExcluirExecute(Sender: TObject);
begin
  inherited;
  ufrmContasPagarE.prc_excluir(qry.fieldbyname('ID').AsInteger);
  uBiblioteca.AtualizaQuery(qry);

end;

procedure TfrmContasPagar.actImprimirExecute(Sender: TObject);
begin
  inherited;
  frxReportContaPagar.ShowReport();

end;

procedure TfrmContasPagar.actIncluirExecute(Sender: TObject);
begin
  inherited;
  ufrmContasPagarE.prc_incluir;
  uBiblioteca.AtualizaQuery(qry);

end;

procedure TfrmContasPagar.actLocalizarExecute(Sender: TObject);
begin
  inherited;
  if fnc_validar_pesquisa then
  begin
    prc_pesquisar;
  end;

  //ajustas as colunas do dbgrid
  prc_ajustar_colunas_grid( DBGrid1 );

  //aumenta o tamanho da linha do ddgrid
  prc_ajusta_tamanho_linha( DBGrid1 );


end;

procedure TfrmContasPagar.actPesquisarExecute(Sender: TObject);
begin
  //inherited;
  if btnPesquisar.Caption = 'Pesquisa >>' then
  begin
    btnPesquisar.Caption := '<< Ocultar Pesquisa';
    GroupBoxPesquisa.Height := 170;

  end
  else
   begin
     btnPesquisar.Caption := 'Pesquisa >>';
     GroupBoxPesquisa.Height := 0;
   end;

end;

procedure TfrmContasPagar.cb_coluna_pessoaClick(Sender: TObject);
begin
  inherited;
  DBGrid1.Columns[3].Visible := cb_coluna_pessoa.Checked;

end;

procedure TfrmContasPagar.cb_coluna_plano_contasClick(Sender: TObject);
begin
  inherited;
  DBGrid1.Columns[2].Visible := cb_coluna_plano_contas.Checked;
end;

procedure TfrmContasPagar.DBGrid1TitleClick(Column: TColumn);
begin
 // não usarei a herança do formBAse padrao
 // inherited;

 prc_ordenar_dgrid( ds, DBGrid1, column ) ;

end;

procedure TfrmContasPagar.dsDataChange(Sender: TObject; Field: TField);
begin
  inherited;
  btn_baixar.Enabled := ((qry.IsEmpty) or ( qry.FieldByName('PAGO').AsString = 'N'));
end;

function TfrmContasPagar.fnc_validar_pesquisa: boolean;
begin
  result := false;

  if (cb_pessoa.Checked) and (cbx_pessoas.Text = '') then
  begin
    criarmensagem('AVISO','INFORME UMA PESSOA OU DESMARQUE O CHECKBOX');
    cbx_pessoas.SetFocus;
    exit;
  end;

  if (cb_plano_contas.Checked) and (cbx_plano_contas.Text = '') then
  begin
    criarmensagem('AVISO','INFORME UM PLANO DE CONTAS OU DESMARQUE O CHECKBOX.');
    cbx_plano_contas.SetFocus;
    exit;
  end;

  if (cb_valor.Checked) and (StrToFloatDef(edt_valor2.text,0) = 0) then
  begin
    criarmensagem('AVISO','INFORME UM VÁLIDO OU DESCARQUE O CHECKBOX');
    edt_valor2.SetFocus;
    exit;
  end;

  result := true;
end;

procedure TfrmContasPagar.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  inherited;

  // libera o formulario da memória
  form_principal.prc_controla_menu(true);
  FreeAndNil(loForm);


end;

procedure TfrmContasPagar.FormCreate(Sender: TObject);
begin
  // não vou usar a pesquisa no frmBaseGrade(não usar o inherited)
  //inherited;
  // então vou ter que trazer a conexao do frmBase pra ca

  Conexao        := dmConn.FDConnection;
  qry.Connection := self.Conexao;

  // property tabela no form BaseGrade
  self.Tabela := 'CONTAS_PAGAR';

end;

procedure TfrmContasPagar.FormShow(Sender: TObject);
begin
  inherited;
  prc_componentes;
  prc_sql;
end;

procedure TfrmContasPagar.prc_componentes;
begin
  qryPessoas.Connection := Conexao;
  qryPessoas.Close; qrypessoas.Open('select p.id, p.nome from pessoas p, fornecedores c where p.id = c.pessoa_id order by p.nome');

  qryPlanoContas.Connection := Conexao;
  qryPlanoContas.Close; qryPlanoContas.Open('select ID,DESCRICAO from PLANO_CONTAS order by DESCRICAO');

  dtp_emissao_ini.Date := Date;
  dtp_emissao_fim.Date := Date;

  dtp_data_vencimento_ini.Date := Date;
  dtp_data_vencimento_fim.Date := Date;
  // relatorio
  qryempresa.Connection := conexao;
  qryEmpresa.Open;
  qryImagemRelatorio.Connection := conexao;
  qryImagemRelatorio.Open;

end;

procedure TfrmContasPagar.prc_pesquisar;
var
  situacao, Condicao, fluxo, balanco : string;
begin

  {Situação da pessoa}
  if rg_situacao.ItemIndex = 0 then
    situacao := ' and CP.PAGO = ' + QuotedStr('S');
  if rg_situacao.ItemIndex = 1 then
    situacao := ' and CP.PAGO = ' + QuotedStr('N');
  if rg_situacao.ItemIndex = 2 then
    situacao := ' and CP.PAGO <> ' + QuotedStr('');

  //21/08/2023 15:32

  Condicao := '';

  if cb_pessoa.Checked then
    Condicao := Condicao + ' and P.NOME = :NOME ';

  if cb_plano_contas.Checked then
    Condicao := Condicao + ' and CP.PLANO_CONTAS_ID = :PLANO_CONTAS_ID ';

  if cb_data_vencimento.Checked then
    Condicao := Condicao + ' and CP.DATA_VENC >= :DATAVENCINI and CP.DATA_VENC <= :DATAVENCFIM ';

  if cb_valor.Checked then
    Condicao := Condicao + ' and CP.TOTAL_PARCELA >= :VALORINI and CP.TOTAL_PARCELA <= :VALORFIM ';

  if cb_historico.Checked then
    Condicao := Condicao + ' and CP.DESCRICAO LIKE :HISTORICO ';


  if Condicao <> '' then
  begin

    //Condicao := copy(Condicao,4,length(Condicao)-4);
    //Condicao := copy(Condicao,4,length(Condicao));

    with qry.sql do
    begin
      Clear;
      Add('select                     ');
      Add('CP.ID,                     ');
      Add('P.NOME as PESSOA_NOME,     ');
      Add('C.DESCRICAO as DESCRICAO_PLANO_CONTAS,');
      Add('CP.CADASTRADO_EM,          ');
      Add('CP.NR_DOCUMENTO,           ');
      Add('CP.DESCRICAO,              ');
      Add('CP.PESSOA_ID,              ');
      Add('CP.TABELA_ORIGEM,          ');
      Add('CP.TABELA_ID,              ');
      Add('CP.DATA_VENC,              ');
      Add('CP.TOTAL_PARCELA,          ');
      Add('CP.VALOR_PAGO,             ');
      Add('CP.SALDO_ABERTO,           ');
      Add('CP.PAGO                    ');
      Add('from                       ');
      Add('  CONTAS_PAGAR CP,         ');
      Add('  PESSOAS P,               ');
      Add('  PLANO_CONTAS C           ');
      Add('where                      ');
      Add('  CP.PESSOA_ID = P.ID and  ');
      Add('  CP.PLANO_CONTAS_ID = C.ID');
    end;
    qry.SQL.Text := qry.SQL.Text + situacao + Condicao + fluxo + balanco;



    self.sSql := qry.SQL.Text;
    //ShowMessage(qry.SQL.Text);

    {Carregar parametros}
    if cb_pessoa.Checked then
      qry.Params.ParamByName('NOME').AsString := cbx_pessoas.Text;
     if cb_plano_contas.Checked then
      qry.Params.ParamByName('PLANO_CONTAS_ID').AsInteger := cbx_plano_contas.KeyValue;

     if cb_cadatrado_em.Checked then
      begin
        qry.ParamByName('CADASTRADO_EM').AsDate := dtpEmissaoIni.Date;
        qry.ParamByName('CADASTRADO_EM').AsDate := dtpEmissaoFim.Date;
      end;

     if cb_data_vencimento.Checked then
      begin
        qry.ParamByName('DATAVENCINI').AsDate := dtp_data_vencimento_ini.Date;
        qry.ParamByName('DATAVENCFIM').AsDate := dtp_data_vencimento_fim.Date;
      end;

     if cb_valor.Checked then
      begin
        qry.ParamByName('VALORINI').AsFloat := StrToFloatDef(edt_valor1.Text,0);
        qry.ParamByName('VALORFIM').AsFloat := StrToFloatDef(edt_valor2.Text,0);
      end;

     if cb_historico.Checked then
      begin
        qry.Params.ParamByName('HISTORICO').AsString := '%' +edt_historico.Text + '%';
      end;
    qry.Open;

  end
  else
  begin
    with qry.sql do
    begin
      Clear;
      Add('select ');
      Add('CP.ID,');
      Add('P.NOME as PESSOA_NOME,');
      Add('C.DESCRICAO as DESCRICAO_PLANO_CONTAS,');
      Add('CP.CADASTRADO_EM,');
      Add('CP.NR_DOCUMENTO,');
      Add('CP.DESCRICAO,');
      Add('CP.PESSOA_ID,');
      Add('CP.TABELA_ORIGEM,');
      Add('CP.TABELA_ID,');
      Add('CP.DATA_VENC,');
      Add('CP.TOTAL_PARCELA,');
      Add('CP.VALOR_PAGO,');
      Add('CP.SALDO_ABERTO, ');
      Add('CP.PAGO ');
      Add('from');
      Add('  CONTAS_PAGAR CP,');
      Add('  PESSOAS P,');
      Add('  PLANO_CONTAS C');
      Add('where');
      Add('  CP.PESSOA_ID = P.ID and ');
      Add('  CP.PLANO_CONTAS_ID = C.ID');
    end;
    qry.SQL.Text := qry.SQL.Text + situacao + fluxo + balanco;


    Self.sSql := qry.SQL.Text;
    //ShowMessage('2a' + qry.SQL.Text);
    qry.Open;

  end;

  StatusBar.Panels[0].Text := 'TOTAL DE REGISTROS "' + inttostr(qry.RecordCount)  + '"';
end;

procedure TfrmContasPagar.prc_sql;
begin

    sSql :=
        'select' +
        ' cp.id,' +
        ' cp.cadastrado_em,' +
        ' pc.descricao as descricao_plano_contas,' +
        ' p.nome as pessoa_nome,' +
        ' cp.nr_documento,' +
        ' cp.descricao,' +
        ' cp.data_venc,' +
        ' cp.total_parcela,' +
        ' cp.saldo_aberto,' +
        ' cp.tabela_origem,' +
        ' cp.pago ' +
        'from ' +
        ' contas_pagar cp, pessoas p, plano_contas pc ' +
        'where ' +
        ' cp.pessoa_id = p.id and cp.plano_contas_id = pc.id ';

  qry.Close;
  qry.SQL.Clear;
  QRY.SQL.Text := sSql;

  StatusBar.Panels[0].Text := 'TOTAL DE REGISTROS "' + inttostr(qry.RecordCount)  + '"';


end;

procedure TfrmContasPagar.rg_pessoasClick(Sender: TObject);
begin
  inherited;
  if rg_pessoas.ItemIndex = 0 then
  begin
    qryPessoas.Close;
    qrypessoas.SQL.Clear;
    qrypessoas.SQL.Add('select p.id, p.nome from pessoas p, clientes c where p.id = c.pessoa_id order by p.nome')
  end else
  if rg_pessoas.ItemIndex = 1 then
  begin
    qryPessoas.Close;
    qrypessoas.SQL.Clear;
    qrypessoas.SQL.Add('select p.id, p.nome from pessoas p, fornecedores c where p.id = c.pessoa_id order by p.nome')
  end else
  if rg_pessoas.ItemIndex = 2 then
  begin
    qryPessoas.Close;
    qrypessoas.SQL.Clear;
    qrypessoas.SQL.Add('select p.id, p.nome from pessoas p, vendedores c where p.id = c.pessoa_id order by p.nome')
  end;
  qrypessoas.Open;


end;

end.
