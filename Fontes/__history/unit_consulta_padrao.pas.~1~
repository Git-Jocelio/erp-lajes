unit unit_consulta_padrao;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Data.DB, Vcl.Grids, Vcl.DBGrids,
  Vcl.StdCtrls, Vcl.Buttons, Vcl.ExtCtrls, FireDAC.Comp.Client;

type
  Tform_consulta_padrao = class(TForm)
    pnl_principal: TPanel;
    pnl_cabecalho: TPanel;
    btn_fechar: TSpeedButton;
    pnl_separa_topo: TPanel;
    pnl_Rodape: TPanel;
    lbl_duplo_clique: TLabel;
    lbl_excluir: TLabel;
    pnl_pesquisa: TPanel;
    lbl_texto: TLabel;
    edt_consulta: TEdit;
    btn_inserir: TButton;
    pnl_dbgrid: TPanel;
    dbg_registros: TDBGrid;
    pnl_resultado: TPanel;
    lbl_resultado: TLabel;
    ds_consulta: TDataSource;
    lbl_titulo: TLabel;
    btn_Selecionar: TButton;
    procedure btn_fecharClick(Sender: TObject);
    procedure btn_inserirClick(Sender: TObject);
    procedure dbg_registrosDrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure dbg_registrosKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure edt_consultaKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure dbg_registrosTitleClick(Column: TColumn);
    procedure FormCreate(Sender: TObject);
    procedure dbg_registrosDblClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
  private
    { Private declarations }
    sSQL : TStrings;
    NomeCampo : String;
    TipoCampo : TFieldType;
  public
    sTipoOperacao: String;
    { Public declarations }
  end;

var
  form_consulta_padrao: Tform_consulta_padrao;

implementation

{$R *.dfm}

uses unit_funcoes, unit_principal;

procedure Tform_consulta_padrao.btn_fecharClick(Sender: TObject);
begin
  //FECHA O FORM
  Self.Close;
end;

procedure Tform_consulta_padrao.btn_inserirClick(Sender: TObject);
begin
  //ATRIBUI A OPERACAO DE INSERCAO PARA A VARIAVEL
  sTipoOperacao :=  'INSERIR';
end;

procedure Tform_consulta_padrao.dbg_registrosDblClick(Sender: TObject);
begin
  //ATRIBUI A OPERACAO DE ALTERACAO PARA A VARIAVEL
  sTipoOperacao :=  'ALTERAR';
end;

procedure Tform_consulta_padrao.dbg_registrosDrawColumnCell(Sender: TObject;
  const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  //funcao que da um layout diferente ao dbgrid
  prcDrawColumnCell( Sender, Rect, DataCol, Column, State );
end;

procedure Tform_consulta_padrao.dbg_registrosKeyDown(Sender: TObject;
  var Key: Word; Shift: TShiftState);
begin
  //se pressionou a tecla delete dentro do dbgrid entao chama o delete do dataset
  if ( Key = VK_DELETE ) and ( not ( ds_consulta.DataSet.IsEmpty ) ) and
     ( CriarMensagem('CONFIRMAÇÃO','Tem Certeza que deseja EXCLUIR essa Informação?') ) then
    ds_consulta.DataSet.Delete;
end;

procedure Tform_consulta_padrao.dbg_registrosTitleClick( Column: TColumn );
var
  Key : Word;

begin
  //quando clica no titulo da coluna do dbgrid muda a ordenação e
  //o campo que a consulta é feita

  //se trocou a coluna de busca entao tem que limpar query e chamar o metodo
  //edt_consultaKeyDown manualmente que é onde a consulta é montada
  if ( NomeCampo <> '' ) and ( NomeCampo <> Column.FieldName ) then
  begin
    edt_consulta.Clear;
    Key := VK_RETURN;
    edt_consultaKeyDown( edt_consulta, Key, [] );
  end;


  NomeCampo := Column.FieldName ; //pega o nome do campo dessa coluna
  TipoCampo := Column.Field.DataType; // pega o tipo do campo da coluna (integer, string, etc)

  //pinta o titulo da coluna que foi clicada
  prc_pintar_titulo_coluna( dbg_registros, Column );

  //trocar o texto do edt_consulta
  lbl_texto.Caption := 'Digite o(a) '+ Column.Title.Caption +
                       ' que dejesa encontrar e aperte ENTER.';


  if ( not ( ds_consulta.DataSet.IsEmpty ) ) then
  begin
    //ao inves de usar o order by, pode ser ordenado usando a propriedade
    // IndexFieldNames nos componentes TFDQuery - :D corresponde ao decrescente
    if ( ds_consulta.DataSet as TFDQuery ).IndexFieldNames = Column.FieldName Then
      ( ds_consulta.DataSet as TFDQuery ).IndexFieldNames := Column.FieldName + ':D'
    else
      ( ds_consulta.DataSet as TFDQuery ).IndexFieldNames := Column.FieldName;

    //apos realizar a ordenação, coloca o cursor no primeiro campo
    ( ds_consulta.DataSet as TFDQuery ).First;

    //aumenta o tamanho da linha do ddgrid
    prc_ajusta_tamanho_linha( dbg_registros );
  end;

end;

procedure Tform_consulta_padrao.edt_consultaKeyDown(Sender: TObject;
  var Key: Word; Shift: TShiftState);
var
  sWhere,
  sFiltro : String;

begin
  //se for pressionada a tecla enter dentro do edtConsulta
  if ( key = VK_RETURN ) and ( ds_consulta.DataSet <> nil ) then
  begin

    //limpa o sql existente na query da ultima consulta realizada
    //e atribui o sql Padrao Salvo na Variavel
    ( ds_consulta.DataSet as TFDQuery ).Close;
    ( ds_consulta.DataSet as TFDQuery ).SQL.Clear;
    ( ds_consulta.DataSet as TFDQuery ).SQL.AddStrings( sSql );

    //remove os caracteres do edt_consulta.text se o campo escolhido for do tipo inteiro
    if ( TipoCampo = ftInteger ) then
      edt_consulta.Text := SomenteNumeros( edt_consulta.Text );

    //se for diferente de vazio tenho que buscar utilizando parametros
    if Trim ( edt_consulta.Text ) <> '' then
    begin
      //testo pra ver se já existe um where no sql
      if Pos ('WHERE', AnsiUpperCase( ( ds_consulta.DataSet as TFDQuery ).SQL.Text ) ) > 0 then
        sWhere := ' AND '
      else
        sWhere :=  ' WHERE ';

      if ( TipoCampo = ftInteger ) or  ( TipoCampo = ftDate ) then
        sFiltro := sWhere + NomeCampo + ' = :TEXTO '
      else
        sFiltro := sWhere + NomeCampo + ' LIKE ''%'' || :TEXTO || ''%''  ';

      //Adiciona o Filtro montado ao sql da query
      ( ds_consulta.DataSet as TFDQuery ).SQL.Add ( sFiltro );

      //manda o parametro texto receber o conteudo do edit que deve ser encontrado
      ( ds_consulta.DataSet as TFDQuery ).ParamByName('TEXTO').AsString := edt_consulta.Text;
    end;

    //abre a consulta apos a manipulação do sql
    ( ds_consulta.DataSet as TFDQuery ).open;
    ( ds_consulta.DataSet as TFDQuery ).IndexFieldNames := NomeCampo;
    ( ds_consulta.DataSet as TFDQuery ).First;


    //ajustas as colunas do dbgrid
    prc_ajustar_colunas_grid( dbg_registros );

    //aumenta o tamanho da linha do ddgrid
    prc_ajusta_tamanho_linha( dbg_registros );
  end;
end;

procedure Tform_consulta_padrao.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
  //libera o sql padrao da memoria
  sSQL.Destroy;

  //fecha a query do dbgrid
  if ds_consulta.DataSet <> nil then
    ds_consulta.DataSet.Close;

  //Libera o Form da Memoria
  FreeAndNil ( Self );


end;

procedure Tform_consulta_padrao.FormCreate(Sender: TObject);
begin
  sSQL := TStringList.Create;

  if ds_consulta.DataSet <> nil then
  begin
    sSQL.Assign( ( ds_consulta.DataSet as TFDQuery ).SQL );

    //ordena inicialmente pela coluna numero 0, ou seja, a primeira coluna do dbgrid
    dbg_registrosTitleClick( dbg_registros.Columns[0] );
  end;
end;

procedure Tform_consulta_padrao.FormShow(Sender: TObject);
begin
  //Seta o focus no edit de consulta
  edt_consulta.SetFocus;
end;

end.
