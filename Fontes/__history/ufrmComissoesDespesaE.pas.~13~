unit ufrmComissoesDespesaE;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseEdicao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.ExtCtrls, uTipos, uBiblioteca, Vcl.ComCtrls;

type
  TfrmComissao_DespesasE = class(TfrmBaseEdicao)
    Panel1: TPanel;
    Label32: TLabel;
    Label1: TLabel;
    lbl_id: TLabel;
    Label2: TLabel;
    lbl_cadastrado_em: TLabel;
    Label4: TLabel;
    Label3: TLabel;
    lbl_numero_pedido: TLabel;
    Label7: TLabel;
    dtp_data_contabil: TDateTimePicker;
    mm_obs: TMemo;
    lbl_alterado_em: TLabel;
    rg_operacao: TRadioGroup;
    Label5: TLabel;
    edt_valor: TEdit;
    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure btnOkClick(Sender: TObject);
  private
    FOperacao: uTipos.TOperacao;
    FTabela: string;
    FCodigo: integer;

    function  fnc_validar: Boolean;

    function  fnc_incluir: boolean;
    function  fnc_alterar: boolean;
    function  fnc_excluir: boolean;

    procedure prc_salvar;

  protected

    procedure prc_componentes;
    procedure prc_inicializar;
    procedure prc_ler_dados;

  public

    property Codigo   :integer read FCodigo write FCodigo;
    property Operacao :uTipos.TOperacao read FOperacao write FOperacao;
    property Tabela   :string read FTabela write FTabela;

  end;

  procedure prc_incluir(ACodigo :integer);
  procedure prc_alterar(ACodigo :integer);
  procedure prc_excluir(ACodigo :integer);

implementation

procedure prc_incluir(ACodigo :integer);
var
  loForm : TfrmComissao_DespesasE;
begin
  loForm := TfrmComissao_DespesasE.Create(Application);
  try
    loForm.Operacao := uTipos.opIncluir;
    loForm.Codigo   := ACodigo;// número do pedido
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

procedure prc_alterar(ACodigo :integer);
var
  loForm : TfrmComissao_DespesasE;
begin
  loForm := TfrmComissao_DespesasE.Create(Application);
  try
    loForm.Operacao := uTipos.opAlterar;
    loForm.Codigo   := ACodigo;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;

procedure prc_excluir(ACodigo :integer);
var
  loForm : TfrmComissao_DespesasE;
begin
  loForm := TfrmComissao_DespesasE.Create(Application);
  try
    loForm.Operacao := uTipos.opExcluir;
    loForm.Codigo   := ACodigo;
    loForm.ShowModal;
  finally
    FreeAndNil(loForm);
  end;
end;


{$R *.dfm}

procedure TfrmComissao_DespesasE.btnOkClick(Sender: TObject);
begin
  inherited;
  prc_salvar;
end;

function TfrmComissao_DespesasE.fnc_alterar: boolean;
begin

end;

function TfrmComissao_DespesasE.fnc_excluir: boolean;
begin

end;

function TfrmComissao_DespesasE.fnc_incluir: boolean;
var
  qry : TFDQuery;
begin
  // Incluir
  try
    qry := TFDQuery.Create(Self);
    try
      with qry, qry.Sql do
      begin
        Connection := Conexao;
        Add('INSERT INTO         ');
        Add('   COMISSAO_DESPESAS ');
        Add('  (ID,              ');
        Add('   PEDIDO_ID,       ');
        Add('   CADASTRADO_EM,   ');
        //Add('   ALTERADO_EM,   ');
        Add('   DATA_CONTABIL,   ');
        Add('   HISTORICO,       ');
        Add('   DEBITO_CREDITO,  ');
        Add('   VALOR)           ');
        Add('VALUES              ');
        Add('  (:ID,             ');
        Add('   :PEDIDO_ID,      ');
        Add('   :CADASTRADO_EM,  ');
        //Add('   :ALTERADO_EM,  ');
        Add('   :DATA_CONTABIL,  ');
        Add('   :HISTORICO,      ');
        Add('   :DEBITO_CREDITO, ');
        Add('   :VALOR)          ');

        ParamByName('ID').AsInteger            := strtoint(lbl_id.Caption);
        ParamByName('PEDIDO_ID').AsInteger     := self.Codigo;
        ParamByName('CADASTRADO_EM').AsDate    := date;
        //ParamByName('ALTERADO_EM').Asdate    := date;
        ParamByName('DATA_CONTABIL').Asdate    := dtp_data_contabil.date;
        ParamByName('HISTORICO').AsString      := mm_obs.Lines.Text;
        ParamByName('DEBITO_CREDITO').AsString := uBiblioteca.SeSenao (rg_operacao.ItemIndex = 0, 'D','C');
        ParamByName('VALOR').AsFloat           := StrToFloat(edt_valor.Text);
        ExecSQL;
        //***
        Result := ( qry.RowsAffected > 0 );
      end;



    finally
      FreeAndNil(qry);
    end;
  except
    on E : Exception do
       Raise Exception.Create(E.Message + ' : ufrmComissoesDespesaE.prc_salvar.fnc_incluir');
    end;
end;

function TfrmComissao_DespesasE.fnc_validar: Boolean;
begin
  Result := false;

  if dtp_data_contabil.Date < StrToDate(lbl_cadastrado_em.Caption) then
  begin
    ShowMessage('informe uma DATA CONTABIL válida');
    dtp_data_contabil.SetFocus;
    exit;
  end;

  if rg_operacao.ItemIndex = -1 then
  begin
    ShowMessage('informe uma operação DÉBITO/CRÉDITO');
    rg_operacao.SetFocus;
    exit;
  end;

  if StrToFloatDef(edt_valor.Text,0) = 0 then
  begin
    ShowMessage('informe um VALOR válido');
    edt_valor.SetFocus;
    exit;
  end;

  if trim(mm_obs.Lines.Text) = '' then
  begin
    ShowMessage('informe um HISTÓRICO');
    mm_obs.SetFocus;
    exit;
  end;


  result := true;
end;

procedure TfrmComissao_DespesasE.FormCreate(Sender: TObject);
begin

  inherited;
  self.Tabela := 'COMISSAO_DESPESAS';
  titulo      := 'Manutenção de outras despesas da comissão';

end;

procedure TfrmComissao_DespesasE.FormShow(Sender: TObject);
begin
  inherited;
  prc_componentes;
  prc_inicializar;

end;

procedure TfrmComissao_DespesasE.prc_componentes;
begin

end;

procedure TfrmComissao_DespesasE.prc_inicializar;
begin
  case self.Operacao of
  uTipos.opIncluir: begin

                       {Novo id usuario}
                       lbl_id.Caption := inttostr( ubiblioteca.AutoIncremento(self.Conexao,self.Tabela));
                       lbl_numero_pedido.Caption := inttostr( self.Codigo );

                       lbl_titulo.Caption        := titulo + pnTitulo.Caption + ' [Incluir]';
                       lbl_sub_titulo.Caption    := ' Incluir outras despesas/crédito dentro comissão de um pedido ';

                       lbl_cadastrado_em.Caption := datetostr(date);
                       dtp_data_contabil.Date    := date;
                       lbl_cadastrado_em.caption := DateToStr(Date);

                       pnDados.Enabled := true;

                       rg_operacao.SetFocus;
                       btnOk     .Caption := 'Incluir';

                     end;
  uTipos.opAlterar: begin

                      prc_ler_dados;
                      pnDados.Enabled  := false;
                      lbl_titulo.Caption  := titulo + ' [Alteração]';
                      lbl_sub_titulo.Caption  := 'Alterar outras despesas/crédito dentro comissão de um pedido ';
                      btnOk.Caption    := 'Alterar';
                      //
                      btnOk.SetFocus;

                    end;
  uTipos.opExcluir: begin

                      prc_ler_dados;
                      pnTitulo.Caption  := titulo + pnTitulo.Caption + ' [Exclusão]';
                      lbl_sub_titulo.Caption  := 'Excluir outras despesas/crédito dentro comissão de um pedido ';
                      pnDados.Enabled     := false;
                      btnOk.Caption       := 'Excluir';
                      btnFechar.SetFocus;

                    end;
  else
    begin
      pnDados.Enabled   := false;
      //pnCliente.Enabled   := false;
      if btnFechar.CanFocus then btnFechar.SetFocus;
    end;
  end;
end;

procedure TfrmComissao_DespesasE.prc_ler_dados;
begin

end;

procedure TfrmComissao_DespesasE.prc_salvar;
begin
  case Self.Operacao of

    // Inclusão
    uTipos.opIncluir :
    begin
      if not fnc_validar then Exit;

      if not Self.Conexao.InTransaction then Self.Conexao.StartTransaction;
      //***
      if fnc_incluir then
      begin
        if Self.Conexao.InTransaction then Self.Conexao.Commit;
        if Application.MessageBox('Deseja continuar incluindo?','Inclusão...',MB_YESNO) = mrYES then
          prc_inicializar
        else
          ModalResult := mrOk;
      end
      else
      begin
        ShowMessage('Não foi possível incluir a comissão');
      end;
    end;

    // Alteração
    uTipos.opAlterar :
    begin
      if not fnc_validar then Exit;
      if not Self.Conexao.InTransaction then Self.Conexao.StartTransaction;
      //***
      if fnc_alterar then
      begin
        if Self.Conexao.InTransaction then Self.Conexao.Commit;
        ModalResult := mrOk;
      end
      else
      begin
        ShowMessage('Não foi possível alterar a comissão');
      end;
    end;

    //Exclusão
    uTipos.opExcluir :
    begin
      if Application.MessageBox('Deseja excluir este registro?','Atenção',MB_OKCANCEL) = mrOK then
      begin
        if not Self.Conexao.InTransaction then Self.Conexao.StartTransaction;
        if fnc_excluir then
        begin
          if Self.Conexao.InTransaction then Self.Conexao.Commit;
          ModalResult := mrOk;
        end
        else
        begin
          ShowMessage('Não foi possível excluir a comissão');
        end;
      end; // if
    end;
  end;// case

end;

end.
