unit ufrmPedidosTotais;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmBaseConexao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.ExtCtrls, Vcl.StdCtrls,
  Vcl.Grids, Vcl.DBGrids, uBiblioteca, Vcl.ComCtrls, Vcl.Buttons;

type
  TfrmPedidosTotais = class(TfrmBaseConexao)
    pnl_topo: TPanel;
    gb_pedidos_emitidos: TGroupBox;
    Label2: TLabel;
    Label9: TLabel;
    Label13: TLabel;
    Label14: TLabel;
    Label16: TLabel;
    Label17: TLabel;
    label22: TLabel;
    Label19: TLabel;
    Label20: TLabel;
    Label21: TLabel;
    lbl_qtde_pedidos: TLabel;
    lbl_qtde_pedidos_pagos: TLabel;
    lbl_qtde_orcamentos: TLabel;
    lbl_qtde_pedidos_abertos: TLabel;
    lbl_qtde_pedidos_aguardando: TLabel;
    lbl_qtde_pedidos_cancelado: TLabel;
    lbl_qtde_pedidos_entregue: TLabel;
    lbl_qtde_pedidos_retirou: TLabel;
    ds: TDataSource;
    Label6: TLabel;
    Label7: TLabel;
    Label8: TLabel;
    Label11: TLabel;
    lbl_valor_pedidos: TLabel;
    lbl_valor_pago: TLabel;
    lbl_valor_receber: TLabel;
    lbl_valor_comissoes: TLabel;
    Label15: TLabel;
    qryPRODUTO_ID: TIntegerField;
    qryQTDE: TFMTBCDField;
    qryCUSTO: TBCDField;
    qryNOME_FANTASIA: TStringField;
    lbl_nome_vendedor: TLabel;
    lbl_periodo_contabil: TLabel;
    Label3: TLabel;
    Label4: TLabel;
    lbl_custos_produtos: TLabel;
    Label10: TLabel;
    lbl_valor_comissao_adm: TLabel;
    qryUNIDADE: TStringField;
    PageControl1: TPageControl;
    tbs_produtos: TTabSheet;
    tbs_itens_laje: TTabSheet;
    ds_itens_laje: TDataSource;
    FDMemTable1: TFDMemTable;
    FDMemTable1unidade: TStringField;
    FDMemTable1total: TFloatField;
    FDMemTable1nome_fantasia: TStringField;
    Panel1: TPanel;
    btn_fechar: TSpeedButton;
    lbl_titulo: TLabel;
    pnl_separa_topo: TPanel;
    Panel5: TPanel;
    dbg_produtos_vendidos: TDBGrid;
    pnl_resultado: TPanel;
    lbl_resultado: TLabel;
    Panel2: TPanel;
    dbg_itens_laje: TDBGrid;
    Panel3: TPanel;
    Label1: TLabel;
    procedure FormShow(Sender: TObject);
    procedure tbs_itens_lajeShow(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure btn_fecharClick(Sender: TObject);
    procedure dbg_produtos_vendidosTitleClick(Column: TColumn);
    procedure dbg_itens_lajeTitleClick(Column: TColumn);
  private
    Fp_pago: string;
    Fp_emissao_fim: string;
    Fp_contabil_ini: string;
    Fp_orcamento: string;
   // Fp_pedido: string;
    Fp_entregue: string;
    Fp_contabil_fim: string;
    Fp_cliente: integer;
    Fp_emissao_ini: string;
    Fp_vendedor: integer;
    Fp_qtde_pedidos_retirou: integer;
    Fp_qtde_pedidos_aguardando: integer;
    Fp_qtde_orcamento: integer;
    Fp_qtde_pedidos_entregue: integer;
    Fp_qtde_pedidos_pagos: integer;
    Fp_qtde_pedidos: integer;
    Fp_qtde_pedidos_abertos: integer;
    Fp_qtde_pedidos_cancelado: integer;
    Fp_valor_total_pedidos: double;
    Fp_valor_a_receber: double;
    Fp_valor_comissoes: double;
    Fp_valor_pago: double;
    Fp_nome_vendedor: string;

    procedure prc_componentes;
    function fnc_calcular_custos_produtos: double;
    procedure prc_totais_itens_laje;

  public
    property p_qtde_pedidos: integer read Fp_qtde_pedidos write Fp_qtde_pedidos;
    property p_qtde_pedidos_pagos: integer read Fp_qtde_pedidos_pagos write Fp_qtde_pedidos_pagos;
    property p_qtde_orcamentos: integer read Fp_qtde_orcamento write Fp_qtde_orcamento;
    property p_qtde_pedidos_abertos: integer read Fp_qtde_pedidos_abertos write Fp_qtde_pedidos_abertos;
    property p_qtde_pedidos_entregue: integer read Fp_qtde_pedidos_entregue write Fp_qtde_pedidos_entregue;
    property p_qtde_pedidos_retirou: integer read Fp_qtde_pedidos_retirou write Fp_qtde_pedidos_retirou;
    property p_qtde_pedidos_aguardando: integer read Fp_qtde_pedidos_aguardando write Fp_qtde_pedidos_aguardando;
    property p_qtde_pedidos_canceldo: integer read Fp_qtde_pedidos_cancelado write Fp_qtde_pedidos_cancelado;

    property p_valor_total_pedidos: double read Fp_valor_total_pedidos write Fp_valor_total_pedidos;
    property p_valor_pago: double read Fp_valor_pago write Fp_valor_pago;
    property p_valor_a_receber: double read Fp_valor_a_receber write Fp_valor_a_receber;
    property p_valor_comissoes: double read Fp_valor_comissoes write Fp_valor_comissoes;


    {parametros para a formação do sql}

    property p_cliente: integer read Fp_cliente write Fp_cliente;
    property p_vendedor: integer read Fp_vendedor write Fp_vendedor;
    property p_nome_vendedor: string read Fp_nome_vendedor write Fp_nome_vendedor;

    {periodo}
    property p_emissao_ini: string read Fp_emissao_ini write Fp_emissao_ini;
    property p_emissao_fim: string read Fp_emissao_fim write Fp_emissao_fim;
    property p_contabil_ini: string read Fp_contabil_ini write Fp_contabil_ini;
    property p_contabil_fim: string read Fp_contabil_fim write Fp_contabil_fim;

    {situação}
   // property p_pedido: string read Fp_pedido write Fp_pedido;
    property p_orcamento: string read Fp_orcamento write Fp_orcamento;
    property p_entregue: string read Fp_entregue write Fp_entregue;
    property p_pago: string read Fp_pago write Fp_pago;


  end;
var
  loForm : TfrmPedidosTotais;

procedure prc_executa( nome_vendedor :string; qtde_pedidos, qtde_pedidos_pagos, qtde_orcamentos,
                       qtde_pedidos_abertos, qtde_pedidos_entregue, qtde_pedidos_retirou,
                       qtde_pedidos_aguardando,qtde_pedidos_cancelados: integer;
                       valor_tota_pedidos, valor_pago, valor_a_receber, valor_comissoes: double;
                       cliente, vendedor: integer;  dtEmiIni, dtEmiFim, dtContIni,
                       dtContFim, orcamento, Entregue, Pago : string);
var
 sSql: string;

implementation

{$R *.dfm}

uses unit_principal, unit_funcoes;

procedure prc_executa( nome_vendedor :string; qtde_pedidos, qtde_pedidos_pagos, qtde_orcamentos,
                       qtde_pedidos_abertos, qtde_pedidos_entregue, qtde_pedidos_retirou,
                       qtde_pedidos_aguardando,qtde_pedidos_cancelados: integer;
                       valor_tota_pedidos, valor_pago, valor_a_receber, valor_comissoes: double;
                       cliente, vendedor: integer;  dtEmiIni, dtEmiFim, dtContIni,
                       dtContFim, orcamento, Entregue, Pago : string);

begin
  if loForm = nil then
  begin

    loForm := TfrmPedidosTotais.Create(Application);
    form_principal.prc_controla_menu(false);

    // se abrir dentro no painel principal no funciona os edites
    //loform.Parent := form_principal.pnl_principal;

    loform.top    :=  form_principal.pnl_Principal.Top;
    loform.Left   := form_principal.pnl_menulateral.Width;

    loForm.Width  := form_principal.pnl_principal.Width;
    loForm.Height := form_principal.pnl_principal.Height;

  end;

  loForm.p_nome_vendedor := nome_vendedor;
  loForm.p_qtde_pedidos := qtde_pedidos;
  loForm.p_qtde_pedidos_pagos := qtde_pedidos_pagos;
  loForm.p_qtde_orcamentos := qtde_orcamentos;
  loForm.p_qtde_pedidos_abertos := qtde_pedidos_abertos;
  loForm.p_qtde_pedidos_entregue := qtde_pedidos_entregue;
  loForm.p_qtde_pedidos_retirou := qtde_pedidos_retirou;
  loForm.p_qtde_pedidos_aguardando := qtde_pedidos_aguardando;
  loForm.p_qtde_pedidos_canceldo := qtde_pedidos_cancelados;
  loForm.p_valor_total_pedidos := valor_tota_pedidos;
  loForm.p_valor_pago := valor_pago;
  loForm.p_valor_a_receber := valor_a_receber;
  loForm.p_valor_comissoes := valor_comissoes;
  //***
  loForm.p_cliente      := cliente;
  loForm.p_vendedor     := vendedor;
  loForm.p_emissao_ini  := dtEmiIni;
  loForm.p_emissao_fim  := dtEmiFim;
  loForm.p_contabil_ini := dtContIni;
  loForm.p_contabil_fim := dtContFim;
  //loForm.p_pedido       := Pedido;
  loForm.p_orcamento    := orcamento;
  loForm.p_entregue     := Entregue;
  loForm.p_pago         := Pago;
  loForm.Show;


end;

{ TfrmPedidosTotais }

procedure TfrmPedidosTotais.btn_fecharClick(Sender: TObject);
begin
  inherited;
  CLOSE;
end;

procedure TfrmPedidosTotais.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
  inherited;

  form_principal.prc_controla_menu(true);
  freeandnil ( loForm );

end;

procedure TfrmPedidosTotais.FormShow(Sender: TObject);
begin
  inherited;
  prc_componentes;
end;

procedure TfrmPedidosTotais.prc_componentes;
var
  loQry : TFDQuery;

begin



  {preencher cabeçalho}
  {periodo}
  if p_contabil_ini = '-1' then
  begin
    lbl_periodo_contabil.Caption := 'Periodo contábil não informado';
  end
  else
  begin
    lbl_periodo_contabil.Caption := 'Periodo contábil : ' + p_contabil_ini + ' à ' + p_contabil_fim ;

  end;

  lbl_nome_vendedor.Caption := p_nome_vendedor;
  lbl_qtde_pedidos.Caption := inttostr(p_qtde_pedidos);
  lbl_qtde_pedidos_pagos.Caption := inttostr(p_qtde_pedidos_pagos);
  lbl_qtde_orcamentos.Caption := inttostr(p_qtde_orcamentos);

  lbl_qtde_pedidos_abertos.Caption := inttostr(p_qtde_pedidos_abertos);
  lbl_qtde_pedidos_entregue.Caption := inttostr(p_qtde_pedidos_entregue);
  lbl_qtde_pedidos_retirou.Caption := inttostr(p_qtde_pedidos_retirou);
  lbl_qtde_pedidos_aguardando.Caption := inttostr(p_qtde_pedidos_aguardando);
  lbl_qtde_pedidos_cancelado.Caption := inttostr(p_qtde_pedidos_canceldo);

  lbl_valor_pedidos.Caption := FormatFloat('###,##0.00', p_valor_total_pedidos);
  lbl_valor_pago.Caption := FormatFloat('###,##0.00', p_valor_pago);
  lbl_valor_receber.Caption := FormatFloat('###,##0.00', p_valor_a_receber);
  lbl_valor_comissoes.Caption := FormatFloat('###,##0.00', p_valor_comissoes);

  qry.SQL.Clear;
  qry.SQL.Add('select ');
  qry.SQL.Add('   i.produto_id, ');
  qry.SQL.Add('   pr.nome_fantasia, ');
  qry.SQL.Add('   pr.unidade, ');
  qry.SQL.Add('   sum(i.quantidade) as qtde, ');
  qry.SQL.Add('   sum(i.quantidade* i.custo_forn) as custo ');
  qry.SQL.Add('from         ');
  qry.SQL.Add('    comissao_item i, ');
  qry.SQL.Add('    pedidos p,   ');
  qry.SQL.Add('    produtos pr  ');
  qry.SQL.Add('where         ');
  qry.SQL.Add('    p.id = i.pedido_id and  ');
  qry.SQL.Add('    i.produto_id = pr.id  ');

  // orcamento = S ou N
  if p_orcamento <> '-1' then
  begin
   qry.SQL.Add('  and p.orcamento = :orcamento  ');
   qry.Params.ParamByName('orcamento').AsString := p_orcamento;;
  end;

  // aberto/entregue/retirou/cancelado
  if p_entregue <> '-1' then
  begin
    qry.SQL.Add('   and p.situacao = :situacao  ');
    qry.Params.ParamByName('situacao').AsString := p_entregue;;
  end;

  // pago/receber/todos
  if p_pago <> '-1' then
  begin
    qry.SQL.Add('   and p.pago = :pago  ');
    qry.Params.ParamByName('pago').AsString := p_pago;
  end;

  // cliente
  if p_cliente > 0 then
  begin
    qry.SQL.Add('   and p.cliente_id = :cliente ');
    qry.Params.ParamByName('cliente').AsInteger := p_cliente;
  end;
  // vendedor
  if p_vendedor > 0 then
  begin
    qry.SQL.Add('   and p.vendedor_id = :vendedor ');
    qry.Params.ParamByName('vendedor').AsInteger := p_vendedor;
  end;

  // emissão
  if p_emissao_ini <> '-1' then
  begin
    qry.SQL.Add(' and p.data_emissao >= :em1 and p.data_emissao <= :em2 ');
    qry.Params.ParamByName('em1').AsDate := strtodate(p_emissao_ini)  ;
    qry.Params.ParamByName('em2').AsDate := strtodate(p_emissao_fim);
  end;
  // contabil
  if p_contabil_ini <> '-1' then
  begin
    qry.SQL.Add(' and p.data_contabil >= :co1 and p.data_contabil <= :co2 ');
    qry.Params.ParamByName('co1').AsDate := strtodate(p_contabil_ini);
    qry.Params.ParamByName('co2').AsDate := strtodate(p_contabil_fim);
  end;

  qry.SQL.Add('  group by   ');
  qry.SQL.Add('    i.produto_id,  ');
  qry.SQL.Add('    pr.unidade,  ');
  qry.SQL.Add('    pr.nome_fantasia  ');
 // qry.SQL.Add('  order by pr.nome_fantasia  ');
  // sql padrão
  sSql := qry.SQL.Text;

  qry.Open;

 //  ShowMessage( 'reg ' + inttostr(qry.RecordCount)) ;
  {soma o campo custo da qry filtrada}
  lbl_custos_produtos.Caption := FormatFloat('###,##0.00', fnc_calcular_custos_produtos);

  {comissões do periodo}
  try
    loQry := TFDQuery.Create(self);
    loQry.Connection := Conexao;

    loQry.SQL.Clear;
    loQry.SQL.Add('select ');
    loQry.SQL.Add('  sum(c.comissao_liquida) as comissao_vendedor,');
    loQry.SQL.Add('  sum(c.comissao_adm) as comissao_adm');
    loQry.SQL.Add('from         ');
    loQry.SQL.Add('  comissao c,');
    loQry.SQL.Add('  pedidos p   ');
    loQry.SQL.Add('where         ');
    loQry.SQL.Add('  c.pedido_id = p.id');

    // orcamento = S ou N
    if p_orcamento <> '-1' then
    begin
     loQry.SQL.Add('  and p.orcamento = :orcamento  ');
     loQry.Params.ParamByName('orcamento').AsString := p_orcamento;;
    end;

    // aberto/entregue/retirou/cancelado
    if p_entregue <> '-1' then
    begin
      loQry.SQL.Add('   and p.situacao = :situacao  ');
      loQry.Params.ParamByName('situacao').AsString := p_entregue;;
    end;

    // pago/receber/todos
    if p_pago <> '-1' then
    begin
      loQry.SQL.Add('   and p.pago = :pago  ');
      loQry.Params.ParamByName('pago').AsString := p_pago;
    end;

    // cliente
    if p_cliente > 0 then
    begin
      loQry.SQL.Add('   and p.cliente_id = :cliente ');
      loQry.Params.ParamByName('cliente').AsInteger := p_cliente;
    end;
    // vendedor
    if p_vendedor > 0 then
    begin
      loQry.SQL.Add('   and p.vendedor_id = :vendedor ');
      loQry.Params.ParamByName('vendedor').AsInteger := p_vendedor;
    end;

    // emissão
    if p_emissao_ini <> '-1' then
    begin
      loQry.SQL.Add(' and p.data_emissao >= :em1 and p.data_emissao <= :em2 ');
      loQry.Params.ParamByName('em1').AsDate := strtodate(p_emissao_ini)  ;
      loQry.Params.ParamByName('em2').AsDate := strtodate(p_emissao_fim);
    end;
    // contabil
    if p_contabil_ini <> '-1' then
    begin
      loQry.SQL.Add(' and p.data_contabil >= :co1 and p.data_contabil <= :co2 ');
      loQry.Params.ParamByName('co1').AsDate := strtodate(p_contabil_ini);
      loQry.Params.ParamByName('co2').AsDate := strtodate(p_contabil_fim);
    end;
    //ShowMessage( loQry.SQL.Text );
    loQry.Open;

    //ajustas as colunas do dbgrid
    prc_ajustar_colunas_grid( dbg_produtos_vendidos );

    //aumenta o tamanho da linha do ddgrid
    prc_ajusta_tamanho_linha( dbg_produtos_vendidos );



    lbl_valor_comissoes.Caption := FormatFloat('###,##0.00', loQry.FieldByName('comissao_vendedor').AsFloat);
    lbl_valor_comissao_adm.Caption :=  FormatFloat('###,##0.00', loQry.FieldByName('comissao_adm').AsFloat);
    loQry.close;
  finally
    freeandnil(loqry);
  end;
end;

procedure TfrmPedidosTotais.dbg_itens_lajeTitleClick(Column: TColumn);
begin
  inherited;
  if not FDMemTable1.IsEmpty then
  begin
    if FDMemTable1.IndexFieldNames = Column.FieldName Then
      FDMemTable1.IndexFieldNames := Column.FieldName + ':D'
    else
      FDMemTable1.IndexFieldNames := Column.FieldName;
    FDMemTable1.First;

    prc_pintar_titulo_coluna( dbg_itens_laje,  Column );

    //ajustas as colunas do dbgrid
    prc_ajustar_colunas_grid( dbg_itens_laje );

    //aumenta o tamanho da linha do ddgrid
    prc_ajusta_tamanho_linha( dbg_itens_laje );

  end;
end;

procedure TfrmPedidosTotais.dbg_produtos_vendidosTitleClick(Column: TColumn);
begin
  inherited;
  prc_ordenar_dgrid( ds, dbg_produtos_vendidos, Column );
end;

function TfrmPedidosTotais.fnc_calcular_custos_produtos: double;
var
  total: double;
begin
  qry.DisableControls;
  total := 0;
  qry.First;
  while not qry.Eof do
  begin
    total := total + qry.FieldByName('CUSTO').AsFloat;
    qry.Next;
  end;

  result := total;
  qry.EnableControls;
end;

procedure TfrmPedidosTotais.prc_totais_itens_laje;
var
  loQry : TFDQuery;
begin
  try
    loQry := TFDQuery.Create(self);
    loQry.Connection := conexao;

    loQry.SQL.Clear;
    loQry.SQL.Add('select ');
    loQry.SQL.Add(' I.PRODUTO_ID,  p.nome_fantasia, p.unidade, sum(i.qtde) as total ');
    loQry.SQL.Add('from         ');
    loQry.SQL.Add('  pedidos_itens_laje I,');
    loQry.SQL.Add('  produtos p,  ');
    loQry.SQL.Add('  pedidos ped   ');
    loQry.SQL.Add('where         ');
    loQry.SQL.Add('  P.ID = I.produto_id AND PED.ID = I.pedido_id');
    // orcamento = S ou N
    if p_orcamento <> '-1' then
    begin
     loQry.SQL.Add('  and ped.orcamento = :orcamento  ');
     loQry.Params.ParamByName('orcamento').AsString := p_orcamento;;
    end;

    // aberto/entregue/retirou/cancelado
    if p_entregue <> '-1' then
    begin
      loQry.SQL.Add('   and ped.situacao = :situacao  ');
      loQry.Params.ParamByName('situacao').AsString := p_entregue;;
    end;

    // pago/receber/todos
    if p_pago <> '-1' then
    begin
      loQry.SQL.Add('   and ped.pago = :pago  ');
      loQry.Params.ParamByName('pago').AsString := p_pago;
    end;

    // cliente
    if p_cliente > 0 then
    begin
      loQry.SQL.Add('   and ped.cliente_id = :cliente ');
      loQry.Params.ParamByName('cliente').AsInteger := p_cliente;
    end;
    // vendedor
    if p_vendedor > 0 then
    begin
      loQry.SQL.Add('   and ped.vendedor_id = :vendedor ');
      loQry.Params.ParamByName('vendedor').AsInteger := p_vendedor;
    end;

    // emissão
    if p_emissao_ini <> '-1' then
    begin
      loQry.SQL.Add(' and ped.data_emissao >= :em1 and ped.data_emissao <= :em2 ');
      loQry.Params.ParamByName('em1').AsDate := strtodate(p_emissao_ini)  ;
      loQry.Params.ParamByName('em2').AsDate := strtodate(p_emissao_fim);
    end;
    // contabil
    if p_contabil_ini <> '-1' then
    begin
      loQry.SQL.Add(' and ped.data_contabil >= :co1 and ped.data_contabil <= :co2 ');
      loQry.Params.ParamByName('co1').AsDate := strtodate(p_contabil_ini);
      loQry.Params.ParamByName('co2').AsDate := strtodate(p_contabil_fim);
    end;
    loQry.SQL.Add('  group by   ');
    loQry.SQL.Add('    i.produto_id,  ');
    loQry.SQL.Add('    p.nome_fantasia,  ');
    loQry.SQL.Add('    p.unidade  ');
    // sql padrão

    loQry.Open;
    FDMemTable1.Close;
    FDMemTable1.open;
    FDMemTable1.CopyDataSet(loQry);

    //ajustas as colunas do dbgrid
    prc_ajustar_colunas_grid( dbg_itens_laje );

    //aumenta o tamanho da linha do ddgrid
    prc_ajusta_tamanho_linha( dbg_itens_laje );




  finally
    freeAndNil(loQry);
  end;
end;

procedure TfrmPedidosTotais.tbs_itens_lajeShow(Sender: TObject);
begin
  inherited;
  prc_totais_itens_laje;
end;

end.
